<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión de Compra - Oceantreasure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f2f2f5;
      color: #222;
    }

    /* ------------ LOGIN ------------ */
    .login-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #3f4c6b 0, #1f1f2b 40%, #000 100%);
      z-index: 999;
      color: #fff;
    }
    .login-card {
      background: #ffffff;
      color: #222;
      border-radius: 16px;
      padding: 24px 22px 20px;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.35);
    }
    .login-card h1 {
      margin: 0 0 4px;
      font-size: 1.05rem;
      font-weight: 700;
      text-align: center;
    }
    .login-card p {
      margin: 0 0 16px;
      font-size: 0.8rem;
      text-align: center;
      color: #555;
      line-height: 1.35;
    }
    .login-card label {
      display: block;
      font-size: 0.78rem;
      font-weight: 600;
      margin-bottom: 3px;
    }
    .login-card input {
      width: 100%;
      padding: 6px 8px;
      font-size: 0.85rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }
    .login-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }
    .login-btn {
      background: #2d6cdf;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 16px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .login-btn:hover { background: #2455aa; }
    .login-error {
      display: none;
      margin-top: 8px;
      font-size: 0.78rem;
      color: #b00020;
      text-align: center;
      background: rgba(176,0,32,.08);
      border: 1px solid rgba(176,0,32,.25);
      padding: 8px 10px;
      border-radius: 10px;
    }

    /* ------------ APP PRINCIPAL ------------ */
    .app {
      max-width: 1200px;
      margin: 16px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,.08);
      overflow: hidden;
    }
    header {
      background: #555c6d;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }
    header .title {
      font-weight: 600;
      font-size: 0.9rem;
    }
    header .user-info {
      font-size: 0.85rem;
      text-align: center;
      flex: 1;
    }
    header .meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .logout-btn {
      background: transparent;
      color: #fff;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.8);
      padding: 4px 12px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .logout-btn:hover { background: rgba(0,0,0,.2); }

    .role-badge{
      display:inline-block;
      margin-left:8px;
      padding:2px 8px;
      border-radius:999px;
      font-size:.72rem;
      font-weight:700;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.22);
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      background: #f8f8fb;
    }
    .tabs button {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      border-bottom: 3px solid transparent;
      transition: background 0.15s, border-color 0.15s;
    }
    .tabs button.active {
      background: #fff;
      border-bottom-color: #2d6cdf;
      color: #2d6cdf;
    }
    .tab { display: none; padding: 16px 20px 20px 20px; }
    .tab.active { display: block; }

    .form-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }
    .form-row label { font-size: 0.8rem; font-weight: 600; display: block; }
    .form-row input,
    .form-row select {
      width: 100%;
      padding: 4px 6px;
      font-size: 0.85rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .actions { margin-top: 8px; display: flex; justify-content: flex-end; gap: 8px; }
    .actions-backup { margin-top: 4px; margin-bottom: 4px; justify-content: flex-start; }

    button.primary {
      background: #2d6cdf;
      color: #fff;
      border-radius: 6px;
      border: none;
      padding: 6px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    button.secondary {
      background: #e0e0e5;
      color: #333;
      border-radius: 6px;
      border: none;
      padding: 6px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-export {
      background: #0c9f6a;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-export:hover { background: #0a7c52; }
    .btn-import {
      background: #f4a000;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-import:hover { background: #c88200; }
    button.primary:hover { background: #2455aa; }
    button.secondary:hover { background: #d0d0d6; }

    /* BARRA DE BÚSQUEDA */
    .search-container {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .search-container input {
      padding: 6px 10px;
      font-size: 0.85rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 250px;
    }

    .table-wrapper {
      margin-top: 12px;
      max-height: 420px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      background: #fff;
      table-layout: fixed;
    }
    thead { position: sticky; top: 0; z-index: 1; }
    thead tr { background: #ececf4; }
    th, td {
      padding: 2px 4px;
      border-bottom: 1px solid #eee;
      text-align: left;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
    }
    th.numeric, td.numeric { text-align: right; }
    tr:nth-child(even) td { background: #fafafa; }
    tr.group-header td { background: #dde3f5; font-weight: 600; }
    tr.subtotal-row td { background: #f4f4f9; font-weight: 700; border-top: 1px solid #ccc; }
    td.actions-cell { text-align: center; }
    td.actions-cell button { font-size: 0.75rem; padding: 2px 6px; }

    .totals-footer {
      margin-top: 10px;
      font-size: 0.8rem;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      color: #444;
    }
    .actions-report { display: flex; justify-content: flex-end; margin-bottom: 8px; gap: 8px; }
    .pdf-header-info { font-size: 0.75rem; margin-bottom: 4px; }

    .catalog-section {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 12px;
      background: #fafafa;
    }
    .catalog-section h3 { margin: 0 0 6px 0; font-size: 0.9rem; }
    .catalog-section .catalog-form { display: flex; gap: 8px; margin-bottom: 6px; }
    .catalog-section .catalog-form input { flex: 1; }
    .catalog-section .catalog-form select { width: 130px; font-size: 0.8rem; padding: 4px 6px; }
    .catalog-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      max-height: 140px;
      overflow-y: auto;
      font-size: 0.8rem;
    }
    .catalog-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
      border-bottom: 1px dashed #e0e0e0;
    }
    .catalog-list li button { font-size: 0.7rem; padding: 1px 6px; }

    /* ---- Anchos tabla INGRESO ---- */
    #tab-entrada table th:nth-child(1), #tab-entrada table td:nth-child(1) { width: 22%; }
    #tab-entrada table th:nth-child(2), #tab-entrada table td:nth-child(2) { width: 12%; }
    #tab-entrada table th:nth-child(3), #tab-entrada table td:nth-child(3) { width: 18%; }
    #tab-entrada table th:nth-child(4), #tab-entrada table td:nth-child(4) { width: 10%; }
    #tab-entrada table th:nth-child(5), #tab-entrada table td:nth-child(5) { width: 8%; }
    #tab-entrada table th:nth-child(6), #tab-entrada table td:nth-child(6) { width: 8%; }
    #tab-entrada table th:nth-child(7), #tab-entrada table td:nth-child(7) { width: 10%; }
    #tab-entrada table th:nth-child(8), #tab-entrada table td:nth-child(8) { width: 10%; }
    #tab-entrada table th:nth-child(9), #tab-entrada table td:nth-child(9) { width: 7%; }

    @media (max-width: 900px) {
      .form-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      header { flex-direction: column; align-items: flex-start; }
      header .user-info { text-align: left; }
    }
  </style>
</head>
<body>

<div id="login-screen" class="login-screen">
  <div class="login-card">
    <h1>Sistema de Gestión de Compra</h1>
    <p>
      Inicia sesión para continuar.<br>
      <b>Accesos permitidos:</b><br>
      • <b>jeffersonfigueroa</b> → acceso completo<br>
      • <b>gerenciageneral</b> → solo vista (Reporte agrupado)
    </p>

    <form id="login-form">
      <label for="login-username">Usuario</label>
      <input type="text" id="login-username" autocomplete="username" placeholder="jeffersonfigueroa / gerenciageneral" />

      <label for="login-password">Contraseña</label>
      <input type="password" id="login-password" autocomplete="current-password" />

      <div class="login-actions">
        <button type="submit" class="login-btn">Ingresar</button>
      </div>

      <div id="login-error" class="login-error">
        Usuario o contraseña incorrectos.
      </div>
    </form>
  </div>
</div>

<div class="app" id="main-app" style="display:none;">
  <header>
    <div class="title">Fecha: <span id="header-date-text"></span></div>
    <div class="user-info">
      Usuario: <span id="header-user">-</span>
      <span id="header-role" class="role-badge" style="display:none;"></span>
    </div>
    <div class="meta">
      <span>SISTEMA DE GESTIÓN DE COMPRA OCEANTREASURE</span>
      <button type="button" id="btn-logout" class="logout-btn">Cerrar sesión</button>
    </div>
  </header>

  <nav class="tabs" id="tabs-nav">
    <button class="active" data-tab="entrada">1. Ingreso de datos</button>
    <button data-tab="reporte">2. Reporte agrupado</button>
    <button data-tab="creacion">3. Creación</button>
  </nav>

  <section id="tab-entrada" class="tab active">
    <form id="entrada-form">
      <div class="form-row">
        <div>
          <label for="fecha">Fecha</label>
          <input type="date" id="fecha" required />
        </div>
        <div>
          <label for="comprador">Comprador</label>
          <input type="text" id="comprador" list="datalist-compradores" placeholder="KEVIN, PATRICIO..." required />
          <datalist id="datalist-compradores"></datalist>
        </div>
        <div>
          <label for="proveedor">Proveedor / Cliente</label>
          <input type="text" id="proveedor" list="datalist-proveedores" placeholder="HENGXING 6C, GOLD CAMARON..." required />
          <datalist id="datalist-proveedores"></datalist>
        </div>
        <div>
          <label for="sector">Sector</label>
          <input type="text" id="sector" list="datalist-sectores" placeholder="ISLA PUNA, TENGUEL..." required />
          <datalist id="datalist-sectores"></datalist>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="kilos">Libras</label>
          <input type="number" step="0.01" id="kilos" required />
        </div>
        <div>
          <label for="lotes">Gramaje</label>
          <input type="number" step="0.01" id="lotes" required />
        </div>
        <div>
          <label for="monto">Cola aproximada</label>
          <input type="number" step="0.01" id="monto" readonly />
        </div>
      </div>

      <div class="actions actions-backup" id="backup-actions">
        <button type="button" class="btn-export" onclick="exportarJSON()">Exportar datos</button>
        <button type="button" class="btn-import" onclick="document.getElementById('file-import-json').click()">Importar datos</button>
        <input type="file" id="file-import-json" accept="application/json" style="display:none" />
      </div>

      <div class="actions" id="entrada-actions">
        <button type="button" class="secondary" id="btn-limpiar">Limpiar todo</button>
        <button type="submit" class="primary">Agregar fila</button>
      </div>
    </form>

    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

    <div class="search-container">
      <label style="font-size: 0.85rem; font-weight: 600;">Filtrar tabla:</label>
      <input type="text" id="search-input" placeholder="Buscar por Comprador o Proveedor..." oninput="renderEntrada()" />
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>Fecha</th>
          <th>Comprador</th>
          <th>Proveedor</th>
          <th>Sector</th>
          <th class="numeric">Libras</th>
          <th class="numeric">Gramaje</th>
          <th class="numeric">Cola aprox</th>
          <th>Usuario</th>
          <th>Acciones</th>
        </tr>
        </thead>
        <tbody id="entrada-tbody"></tbody>
      </table>
    </div>
  </section>

  <section id="tab-reporte" class="tab">
    <div class="actions-report">
      <button type="button" class="primary" onclick="exportarPDF()">Exportar PDF</button>
    </div>
    <div id="reporte-contenedor">
      <div id="pdf-header-info" class="pdf-header-info"></div>
      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>Fecha</th>
            <th>Comprador</th>
            <th>Proveedor</th>
            <th>Sector</th>
            <th class="numeric">Libras</th>
            <th class="numeric">Gramaje</th>
            <th class="numeric">Cola aprox</th>
          </tr>
          </thead>
          <tbody id="reporte-tbody"></tbody>
        </table>
      </div>
      <div class="totals-footer">
        <span><strong>Volumen de compra con cabeza:</strong> <span id="footer-total-kilos">0,00</span></span>
        <span><strong>Gramaje promedio:</strong> <span id="footer-gramaje-promedio">0,00</span></span>
        <span><strong>Total Cola aprox:</strong> <span id="footer-total-monto">0,00</span></span>
      </div>
    </div>
  </section>

  <section id="tab-creacion" class="tab">
    <div class="catalog-section">
      <h3>Catálogo de Compradores</h3>
      <div class="catalog-form">
        <input type="text" id="nuevo-comprador" placeholder="Nombre de comprador" />
        <button type="button" class="primary" onclick="agregarCatalogo('comprador')">Agregar</button>
      </div>
      <ul id="lista-compradores-admin" class="catalog-list"></ul>
    </div>

    <div class="catalog-section">
      <h3>Catálogo de Proveedores / Clientes</h3>
      <div class="catalog-form">
        <input type="text" id="nuevo-proveedor" placeholder="Nombre de proveedor / cliente" />
        <button type="button" class="primary" onclick="agregarCatalogo('proveedor')">Agregar</button>
      </div>
      <ul id="lista-proveedores-admin" class="catalog-list"></ul>
    </div>

    <div class="catalog-section">
      <h3>Catálogo de Sectores</h3>
      <div class="catalog-form">
        <input type="text" id="nuevo-sector" placeholder="Nombre de sector" />
        <button type="button" class="primary" onclick="agregarCatalogo('sector')">Agregar</button>
      </div>
      <ul id="lista-sectores-admin" class="catalog-list"></ul>
    </div>
  </section>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase (Compat) - Para GitHub Pages -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* =========================================================
   FIREBASE CONFIG
   ========================================================= */
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCMoLkSnnLowMagRNL7O6ttPo1FXd1URac",
  authDomain: "oceantreasure-app.firebaseapp.com",
  projectId: "oceantreasure-app",
  storageBucket: "oceantreasure-app.firebasestorage.app",
  messagingSenderId: "553014659258",
  appId: "1:553014659258:web:cfc30844a88433b7b79a83",
  measurementId: "G-HMMQKJY8NJ"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const FieldValue = firebase.firestore.FieldValue;

// === Colecciones/Documentos ===
const REGISTROS_COL = "sgc_compra_registros";
const META_COL = "sgc_compra_meta";
const CATALOGOS_DOC = "catalogos";

// === Control de acceso por EMAIL (a nivel de página) ===
// ✅ Jefferson: acceso completo
// ✅ Gerencia General: solo vista (solo Reporte agrupado)
// ❌ Cualquier otro usuario: no entra (se expulsa)
const ADMIN_EMAIL  = "jeffersonfigueroa@oceantreasure.local";
const VIEW_EMAIL   = "gerenciageneral@oceantreasure.local";
const ALLOWED_EMAILS = [ADMIN_EMAIL, VIEW_EMAIL];

const getRoleByEmail = (email) => {
  const e = String(email || "").toLowerCase();
  if (e === ADMIN_EMAIL) return "admin";
  if (e === VIEW_EMAIL) return "viewer";
  return "denied";
};

// === Estado en memoria ===
let loggedInUser = null;          // username (sin dominio)
let loggedInEmail = null;         // email real en Firebase
let loggedInRole = null;          // admin | viewer
let registros = [];               // {id, ...}
let compradores = [];
let proveedores = [];
let sectores = [];

// Unsubscribe listeners
let unsubRegistros = null;
let unsubCatalogos = null;

// === Helpers ===
const usernameToEmail = (username) => {
  const u = String(username || "").trim();
  return u.includes("@") ? u : `${u}@oceantreasure.local`;
};

const formatoFechaLargo = (iso) => {
  if (!iso) return "";
  const date = new Date(iso + "T00:00:00");
  return date.toLocaleDateString("es-EC", { weekday: "long", year: "numeric", month: "long", day: "numeric" });
};

const formatoFechaCorta = (iso) => {
  if (!iso) return "";
  const date = new Date(iso + "T00:00:00");
  return date.toLocaleDateString("es-EC", { day: "2-digit", month: "2-digit", year: "numeric" });
};

const formatNumber = (value, decimals) => {
  const num = Number(value) || 0;
  return num.toLocaleString("es-EC", { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
};

const stopListeners = () => {
  if (typeof unsubRegistros === "function") { unsubRegistros(); unsubRegistros = null; }
  if (typeof unsubCatalogos === "function") { unsubCatalogos(); unsubCatalogos = null; }
};

const showLoginError = (msg) => {
  const le = document.getElementById("login-error");
  if (!le) return;
  le.textContent = msg || "Error.";
  le.style.display = "block";
};

const setRoleUI = (role) => {
  const badge = document.getElementById("header-role");
  if (!badge) return;

  if (role === "admin") {
    badge.style.display = "inline-block";
    badge.textContent = "ADMIN";
  } else if (role === "viewer") {
    badge.style.display = "inline-block";
    badge.textContent = "SOLO VISTA";
  } else {
    badge.style.display = "none";
    badge.textContent = "";
  }
};

const applyRoleRestrictions = (role) => {
  // Viewer: solo Reporte agrupado, ocultar tabs y secciones.
  const tabsNav = document.getElementById("tabs-nav");
  const tabEntrada = document.getElementById("tab-entrada");
  const tabCreacion = document.getElementById("tab-creacion");
  const tabReporte = document.getElementById("tab-reporte");

  if (role === "viewer") {
    if (tabsNav) tabsNav.style.display = "none"; // sin navegación
    if (tabEntrada) tabEntrada.style.display = "none";
    if (tabCreacion) tabCreacion.style.display = "none";
    if (tabReporte) {
      tabReporte.style.display = "block";
      tabReporte.classList.add("active");
    }
    // Asegurar que NO quede active en otro
    document.querySelectorAll(".tab").forEach(t => {
      if (t.id !== "tab-reporte") t.classList.remove("active");
    });
    document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
  } else {
    // Admin: UI normal
    if (tabsNav) tabsNav.style.display = "flex";
    if (tabEntrada) tabEntrada.style.display = "block";
    if (tabCreacion) tabCreacion.style.display = "block";
    // Re-activar entrada por defecto
    document.querySelectorAll(".tabs button, .tab").forEach(el => el.classList.remove("active"));
    const btnEntrada = document.querySelector('.tabs button[data-tab="entrada"]');
    if (btnEntrada) btnEntrada.classList.add("active");
    const secEntrada = document.getElementById("tab-entrada");
    if (secEntrada) secEntrada.classList.add("active");
  }
};

// ====== Reglas de acción en cliente (extra, además de tus rules) ======
const assertAdmin = () => {
  if (loggedInRole !== "admin") {
    alert("Acción no permitida (solo administrador).");
    return false;
  }
  return true;
};

// ----------------- RENDER TAB 1 (CON ORDENAMIENTO Y FILTRO) -----------------
const renderEntrada = () => {
  const tbody = document.getElementById("entrada-tbody");
  if (!tbody) return;
  const searchTerm = (document.getElementById("search-input").value || "").toLowerCase();
  tbody.innerHTML = "";

  const registrosProcesados = [...registros].sort((a, b) => String(a.fecha || "").localeCompare(String(b.fecha || "")));

  registrosProcesados.forEach((reg) => {
    if (searchTerm && !String(reg.comprador || "").toLowerCase().includes(searchTerm) && !String(reg.proveedor || "").toLowerCase().includes(searchTerm)) {
      return;
    }

    const tr = document.createElement("tr");
    const celdas = [
      formatoFechaLargo(reg.fecha),
      reg.comprador || "",
      reg.proveedor || "",
      reg.sector || "",
      formatNumber(reg.kilos, 2),
      formatNumber(reg.gramaje, 2),
      formatNumber(reg.monto, 2),
      reg.usuario || ""
    ];

    celdas.forEach((valor, i) => {
      const td = document.createElement("td");
      if (i >= 4 && i <= 6) td.classList.add("numeric");
      td.textContent = valor;
      tr.appendChild(td);
    });

    const tdAcc = document.createElement("td");
    tdAcc.className = "actions-cell";

    if (loggedInRole === "admin") {
      const btnDel = document.createElement("button");
      btnDel.textContent = "Borrar";
      btnDel.className = "secondary";
      btnDel.onclick = async () => {
        if (!reg.id) return;
        try {
          await db.collection(REGISTROS_COL).doc(reg.id).delete();
        } catch (e) {
          console.error(e);
          alert("No se pudo borrar (permisos o conexión).");
        }
      };
      tdAcc.appendChild(btnDel);
    } else {
      tdAcc.textContent = "-";
    }

    tr.appendChild(tdAcc);
    tbody.appendChild(tr);
  });
};

// ----------------- RENDER TAB 2 -----------------
const renderReporte = () => {
  const tbody = document.getElementById("reporte-tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  const ordenados = [...registros].sort((a, b) => String(a.fecha || "").localeCompare(String(b.fecha || "")));

  let fAct = null, sLib = 0, sGrS = 0, sGrC = 0, sCol = 0, tLib = 0, tGrS = 0, tGrC = 0, tCol = 0;

  const insSub = () => {
    if (fAct === null || sGrC === 0) return;
    const tr = document.createElement("tr"); tr.className = "subtotal-row";
    const td1 = document.createElement("td"); td1.colSpan = 4; td1.textContent = "Subtotal:"; tr.appendChild(td1);
    const td2 = document.createElement("td"); td2.className = "numeric"; td2.textContent = formatNumber(sLib, 2); tr.appendChild(td2);
    const td3 = document.createElement("td"); td3.className = "numeric"; td3.textContent = formatNumber(sGrS / sGrC, 2); tr.appendChild(td3);
    const td4 = document.createElement("td"); td4.className = "numeric"; td4.textContent = formatNumber(sCol, 2); tr.appendChild(td4);
    tbody.appendChild(tr);
  };

  ordenados.forEach(reg => {
    if (fAct !== reg.fecha) {
      insSub();
      fAct = reg.fecha; sLib = 0; sGrS = 0; sGrC = 0; sCol = 0;

      const trG = document.createElement("tr"); trG.className = "group-header";
      const tdG = document.createElement("td"); tdG.colSpan = 7; tdG.textContent = formatoFechaLargo(reg.fecha);
      trG.appendChild(tdG); tbody.appendChild(trG);
    }
    sLib += Number(reg.kilos) || 0; sGrS += Number(reg.gramaje) || 0; sGrC++; sCol += Number(reg.monto) || 0;
    tLib += Number(reg.kilos) || 0; tGrS += Number(reg.gramaje) || 0; tGrC++; tCol += Number(reg.monto) || 0;

    const tr = document.createElement("tr");
    [formatoFechaCorta(reg.fecha), reg.comprador || "", reg.proveedor || "", reg.sector || "", formatNumber(reg.kilos, 2), formatNumber(reg.gramaje, 2), formatNumber(reg.monto, 2)]
      .forEach((v,i)=>{
        const td = document.createElement("td"); if(i>=4) td.className="numeric"; td.textContent=v; tr.appendChild(td);
      });
    tbody.appendChild(tr);
  });

  insSub();
  document.getElementById("footer-total-kilos").textContent = formatNumber(tLib, 2);
  document.getElementById("footer-gramaje-promedio").textContent = formatNumber(tGrC > 0 ? tGrS / tGrC : 0, 2);
  document.getElementById("footer-total-monto").textContent = formatNumber(tCol, 2);
};

const renderCatalogos = () => {
  ["compradores", "proveedores", "sectores"].forEach(tipo => {
    const dl = document.getElementById("datalist-" + tipo); if (dl) dl.innerHTML = "";
    const admin = document.getElementById("lista-" + tipo + "-admin"); if (admin) admin.innerHTML = "";

    const lista = tipo === "compradores" ? compradores : tipo === "proveedores" ? proveedores : sectores;

    lista.forEach((n) => {
      if (dl) { const opt = document.createElement("option"); opt.value = n; dl.appendChild(opt); }

      if (admin) {
        const li = document.createElement("li"); li.textContent = n;
        if (loggedInRole === "admin") {
          const btn = document.createElement("button");
          btn.textContent="X"; btn.className="secondary";
          btn.onclick = async () => {
            if (!assertAdmin()) return;
            const ref = db.collection(META_COL).doc(CATALOGOS_DOC);
            try {
              if (tipo === "compradores") await ref.update({ compradores: FieldValue.arrayRemove(n) });
              if (tipo === "proveedores") await ref.update({ proveedores: FieldValue.arrayRemove(n) });
              if (tipo === "sectores")   await ref.update({ sectores:   FieldValue.arrayRemove(n) });
            } catch (e) {
              console.error(e);
              alert("No se pudo eliminar del catálogo (permisos o conexión).");
            }
          };
          li.appendChild(btn);
        }
        admin.appendChild(li);
      }
    });
  });
};

const actualizarTodo = () => {
  if (loggedInRole === "admin") renderEntrada();
  renderReporte();
  if (loggedInRole === "admin") renderCatalogos();
};

// Cálculo "Cola aprox" en vivo (solo admin usa esta pantalla, pero no estorba)
document.getElementById("kilos").addEventListener("input", e => {
  document.getElementById("monto").value = (Number(e.target.value) * 0.66).toFixed(2);
});

// Agregar fila (Firestore) - SOLO ADMIN
document.getElementById("entrada-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!assertAdmin()) return;

  const docData = {
    fecha: document.getElementById("fecha").value,
    comprador: document.getElementById("comprador").value,
    proveedor: document.getElementById("proveedor").value,
    sector: document.getElementById("sector").value,
    kilos: Number(document.getElementById("kilos").value),
    gramaje: Number(document.getElementById("lotes").value),
    monto: Number(document.getElementById("kilos").value) * 0.66,
    usuario: loggedInUser || "-"
  };

  try {
    await db.collection(REGISTROS_COL).add(docData);
    e.target.reset();
    document.getElementById("fecha").value = new Date().toISOString().slice(0,10);
  } catch (err) {
    console.error(err);
    alert("No se pudo guardar (permisos o conexión).");
  }
});

// Limpiar TODO (Firestore) - SOLO ADMIN
document.getElementById("btn-limpiar").onclick = async () => {
  if (!assertAdmin()) return;
  if (!confirm("¿Borrar TODO en la nube?")) return;

  try {
    const snap = await db.collection(REGISTROS_COL).get();
    const docs = snap.docs;

    const chunks = [];
    for (let i = 0; i < docs.length; i += 450) chunks.push(docs.slice(i, i + 450));

    for (const part of chunks) {
      const batch = db.batch();
      part.forEach(d => batch.delete(d.ref));
      await batch.commit();
    }
  } catch (err) {
    console.error(err);
    alert("No se pudo limpiar (permisos o conexión).");
  }
};

// Tabs (solo admin)
document.querySelectorAll(".tabs button").forEach(btn => {
  btn.onclick = () => {
    if (loggedInRole === "viewer") return;
    document.querySelectorAll(".tabs button, .tab").forEach(el => el.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("tab-" + btn.dataset.tab).classList.add("active");
  };
});

// LOGIN (Firebase Auth)
const loginForm = document.getElementById("login-form");
loginForm.onsubmit = async (e) => {
  e.preventDefault();
  document.getElementById("login-error").style.display = "none";

  const username = document.getElementById("login-username").value.trim();
  const pass = document.getElementById("login-password").value;
  const email = usernameToEmail(username);

  try {
    await auth.signInWithEmailAndPassword(email, pass);
  } catch (err) {
    console.error(err);
    showLoginError("Usuario o contraseña incorrectos.");
  }
};

// LOGOUT
document.getElementById("btn-logout").onclick = async () => {
  await auth.signOut();
};

// Backup JSON (EXPORT) - SOLO ADMIN
function exportarJSON() {
  if (!assertAdmin()) return;
  const payload = { registros, compradores, proveedores, sectores };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type: "application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `backup_sgc_compra_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}
window.exportarJSON = exportarJSON;

// Import JSON (IMPORT) - SOLO ADMIN
document.getElementById("file-import-json").onchange = async (e) => {
  if (!assertAdmin()) return;

  const file = e.target.files?.[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (ev) => {
    try {
      const d = JSON.parse(ev.target.result);

      if (!confirm("Esto REEMPLAZARÁ los datos actuales en la nube. ¿Continuar?")) return;

      // 1) Reemplazar catálogos
      await db.collection(META_COL).doc(CATALOGOS_DOC).set({
        compradores: Array.isArray(d.compradores) ? d.compradores : [],
        proveedores: Array.isArray(d.proveedores) ? d.proveedores : [],
        sectores: Array.isArray(d.sectores) ? d.sectores : []
      }, { merge: true });

      // 2) Borrar registros actuales
      const snap = await db.collection(REGISTROS_COL).get();
      const docs = snap.docs;

      const delChunks = [];
      for (let i = 0; i < docs.length; i += 450) delChunks.push(docs.slice(i, i + 450));
      for (const part of delChunks) {
        const batch = db.batch();
        part.forEach(x => batch.delete(x.ref));
        await batch.commit();
      }

      // 3) Insertar registros importados
      const regs = Array.isArray(d.registros) ? d.registros : [];
      const addChunks = [];
      for (let i = 0; i < regs.length; i += 450) addChunks.push(regs.slice(i, i + 450));

      for (const part of addChunks) {
        const batch = db.batch();
        part.forEach(r => {
          const ref = db.collection(REGISTROS_COL).doc();
          batch.set(ref, {
            fecha: r.fecha || "",
            comprador: r.comprador || "",
            proveedor: r.proveedor || "",
            sector: r.sector || "",
            kilos: Number(r.kilos) || 0,
            gramaje: Number(r.gramaje) || 0,
            monto: Number(r.monto) || (Number(r.kilos) || 0) * 0.66,
            usuario: r.usuario || "-"
          });
        });
        await batch.commit();
      }

      alert("Importado en la nube.");
    } catch (err) {
      console.error(err);
      alert("Error importando JSON. Revisa el archivo.");
    }
  };
  reader.readAsText(file);
};

// Agregar catálogos (Firestore) - SOLO ADMIN
async function agregarCatalogo(tipo) {
  if (!assertAdmin()) return;

  const input = document.getElementById("nuevo-" + tipo);
  const val = (input.value || "").trim();
  if (!val) return;

  const ref = db.collection(META_COL).doc(CATALOGOS_DOC);
  try {
    if (tipo === "comprador") await ref.update({ compradores: FieldValue.arrayUnion(val) });
    if (tipo === "proveedor") await ref.update({ proveedores: FieldValue.arrayUnion(val) });
    if (tipo === "sector")    await ref.update({ sectores:   FieldValue.arrayUnion(val) });
    input.value = "";
  } catch (err) {
    console.error(err);
    alert("No se pudo agregar al catálogo (permisos o conexión).");
  }
}
window.agregarCatalogo = agregarCatalogo;

// PDF (permitido para admin y viewer)
async function exportarPDF() {
  const info = document.getElementById("pdf-header-info");
  const now = new Date();
  info.textContent = `Fecha: ${now.toLocaleString("es-EC")} | Usuario: ${loggedInUser || "-"}`;

  const original = document.getElementById("reporte-contenedor");
  const clone = original.cloneNode(true);

  clone.style.position = "fixed";
  clone.style.left = "-10000px";
  clone.style.top = "0";
  clone.style.width = original.offsetWidth + "px";
  clone.style.maxHeight = "none";
  clone.style.overflow = "visible";
  document.body.appendChild(clone);

  const wrappers = clone.querySelectorAll(".table-wrapper");
  wrappers.forEach(w => {
    w.style.maxHeight = "none";
    w.style.overflow = "visible";
    w.style.borderRadius = "0";
  });

  const canvas = await html2canvas(clone, {
    scale: 2,
    backgroundColor: "#ffffff",
    useCORS: true,
    width: clone.scrollWidth,
    height: clone.scrollHeight,
    windowWidth: clone.scrollWidth,
    windowHeight: clone.scrollHeight
  });

  document.body.removeChild(clone);

  const pdf = new jspdf.jsPDF("l", "mm", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  const margin = 10;
  const imgWidth = pageWidth - margin * 2;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;
  const imgData = canvas.toDataURL("image/png");

  const usableHeight = pageHeight - margin * 2;
  let heightLeft = imgHeight;
  let position = margin;

  pdf.addImage(imgData, "PNG", margin, position, imgWidth, imgHeight);
  heightLeft -= usableHeight;

  while (heightLeft > 0) {
    pdf.addPage();
    position = margin - (imgHeight - heightLeft);
    pdf.addImage(imgData, "PNG", margin, position, imgWidth, imgHeight);
    heightLeft -= usableHeight;
  }

  const pad = (n) => String(n).padStart(2, "0");
  const stamp = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;
  pdf.save(`SGC Gestion de compra_${stamp}.pdf`);
}
window.exportarPDF = exportarPDF;

// ==== Sync Firestore -> UI ====
// ADMIN: catálogos + registros (con ensure)
// VIEWER: solo registros (sin ensureCatalogosDoc, para evitar write)
const ensureCatalogosDoc = async () => {
  const ref = db.collection(META_COL).doc(CATALOGOS_DOC);
  const snap = await ref.get();
  if (!snap.exists) {
    // Esto escribe: SOLO ADMIN debería ejecutarlo
    await ref.set({ compradores: [], proveedores: [], sectores: [] }, { merge: true });
  }
};

const startRealtimeSyncAdmin = async () => {
  stopListeners();
  await ensureCatalogosDoc();

  unsubRegistros = db.collection(REGISTROS_COL).orderBy("fecha").onSnapshot((snap) => {
    registros = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    actualizarTodo();
  });

  unsubCatalogos = db.collection(META_COL).doc(CATALOGOS_DOC).onSnapshot((snap) => {
    const d = snap.data() || {};
    compradores = Array.isArray(d.compradores) ? d.compradores : [];
    proveedores = Array.isArray(d.proveedores) ? d.proveedores : [];
    sectores = Array.isArray(d.sectores) ? d.sectores : [];
    renderCatalogos();
  });
};

const startRealtimeSyncViewer = async () => {
  stopListeners();

  unsubRegistros = db.collection(REGISTROS_COL).orderBy("fecha").onSnapshot((snap) => {
    registros = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    // Viewer: solo reporte
    renderReporte();
  });
};

// Auth state
auth.onAuthStateChanged(async (user) => {
  if (user) {
    const emailLower = String(user.email || "").toLowerCase();
    loggedInRole = getRoleByEmail(emailLower);

    if (loggedInRole === "denied" || !ALLOWED_EMAILS.includes(emailLower)) {
      console.warn("Acceso bloqueado para:", emailLower);
      showLoginError("Acceso denegado: usuario no autorizado.");
      await auth.signOut();
      return;
    }

    loggedInEmail = emailLower || "-";
    loggedInUser = (loggedInEmail.split("@")[0]) || "-";

    // UI base
    document.getElementById("login-screen").style.display = "none";
    document.getElementById("main-app").style.display = "block";
    document.getElementById("header-user").textContent = loggedInUser;
    setRoleUI(loggedInRole);
    document.getElementById("header-date-text").textContent = formatoFechaLargo(new Date().toISOString().slice(0,10));

    applyRoleRestrictions(loggedInRole);

    try {
      if (loggedInRole === "admin") {
        await startRealtimeSyncAdmin();
        document.getElementById("fecha").value = new Date().toISOString().slice(0,10);
      } else {
        // viewer
        await startRealtimeSyncViewer();
      }
    } catch (e) {
      console.error(e);
      alert("Error al cargar datos (permisos o conexión).");
    }

  } else {
    // Logout / no auth
    stopListeners();
    loggedInUser = null;
    loggedInEmail = null;
    loggedInRole = null;
    registros = [];
    compradores = [];
    proveedores = [];
    sectores = [];

    document.getElementById("main-app").style.display = "none";
    document.getElementById("login-screen").style.display = "flex";
    document.getElementById("login-form").reset();
    const le = document.getElementById("login-error");
    if (le) { le.style.display = "none"; le.textContent = "Usuario o contraseña incorrectos."; }
  }
});

// Por defecto fecha de hoy (admin lo usa)
document.getElementById("fecha").value = new Date().toISOString().slice(0,10);
</script>

</body>
</html>
