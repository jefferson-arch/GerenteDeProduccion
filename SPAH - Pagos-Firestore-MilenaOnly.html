<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oceantreasure | Pagos Avance Hora 2025</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --panel2:#0d172b;
      --line:rgba(255,255,255,.10);
      --text:#e5e7eb; --muted:rgba(229,231,235,.72);
      --btn:#1f4fd6; --btn2:#123aa7;
      --navy:#0b1b3a;
      --white:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:radial-gradient(1200px 700px at 50% 0%, #101f3f 0%, var(--bg) 55%, #070b13 100%);color:var(--text)}
    header{padding:18px 18px;border-bottom:1px solid var(--line);background:rgba(0,0,0,.25);display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;flex-direction:column;gap:4px}
    .brand b{font-size:14px;letter-spacing:.4px}
    .brand span{font-size:12px;color:var(--muted)}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid var(--line);background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;font-size:12px}
    .btn{border:1px solid rgba(255,255,255,.14);background:linear-gradient(180deg,var(--btn) 0%, var(--btn2) 100%);color:#fff;padding:7px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn:active{transform:translateY(1px)}
    .btn.out{background:rgba(255,255,255,.06)}
    main{max-width:1280px;margin:0 auto;padding:14px 16px 18px}
    .gridTop{display:grid;grid-template-columns:380px 1fr 360px;gap:12px;align-items:start}
    .box{background:linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.03) 100%);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .box h3{margin:0;padding:12px 12px;border-bottom:1px solid var(--line);font-size:13px;letter-spacing:.4px}
    .box .body{padding:12px}
    .row{display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin-bottom:8px}
    .row label{font-size:12px;color:var(--muted)}
    .cell{width:100%;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:13px}
    .cell:disabled{opacity:.55;cursor:not-allowed}
    .cell::placeholder{color:rgba(229,231,235,.38)}
    .inline2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .hint{font-size:11px;color:rgba(229,231,235,.60);margin-top:8px;line-height:1.25}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.18);font-size:12px;cursor:pointer}
    .tab.on{background:rgba(31,79,214,.22);border-color:rgba(31,79,214,.45);font-weight:700}
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .stat{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:10px}
    .stat b{display:block;font-size:12px;color:rgba(229,231,235,.78);margin-bottom:5px}
    .stat span{font-size:18px;font-weight:800}
    .hr{height:1px;background:var(--line);margin:10px 0}
    /* Table */
    .tableWrap{margin-top:12px;background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      position:sticky;top:0;z-index:2;
      background:rgba(0,0,0,.35);
      border-bottom:1px solid var(--line);
      font-size:12px;color:rgba(229,231,235,.85);
      text-align:left;padding:9px 8px;white-space:nowrap
    }
    tbody td{
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:12px;padding:7px 8px;vertical-align:middle;white-space:nowrap
    }
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .cell-in{
      width:100%;
      padding:6px 8px;border-radius:9px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:var(--text);outline:none;font-size:12px
    }
    .cell-in:disabled{border-color:transparent;background:transparent;padding:0}
    .actions{display:flex;gap:8px;align-items:center}
    .del{color:#cbd5e1;text-decoration:underline;cursor:pointer;font-size:12px}
    .chk{transform:scale(1.05)}
    /* Login */
    .center{min-height:calc(100vh - 64px);display:flex;align-items:center;justify-content:center;padding:18px}
    .card{width:min(560px, calc(100% - 30px));background:linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.03) 100%);border:1px solid var(--line);border-radius:16px;padding:16px}
    .card h2{margin:0 0 6px 0;font-size:16px}
    .card p{margin:0 0 12px 0;font-size:12px;color:var(--muted)}
    .error{margin-top:10px;color:#fecaca;font-size:12px;white-space:pre-wrap}
    .ok{margin-top:10px;color:#bbf7d0;font-size:12px}
    /* Requested UX: Focus highlight */
    .box .cell:focus,
    .box .cell:focus-visible,
    .card .cell:focus,
    .card .cell:focus-visible,
    .tableWrap .cell-in:focus,
    .tableWrap .cell-in:focus-visible{
      background:var(--white) !important;
      color:var(--navy) !important;
      border-color:rgba(11,27,58,.55) !important;
      outline:2px solid rgba(11,27,58,.20);
      outline-offset:1px;
    }
    .box .cell::placeholder, .card .cell::placeholder{color:rgba(11,27,58,.55)}
    /* Requested UX: Row highlight when editing */
    tr.row-editing td{background:var(--white) !important;color:var(--navy) !important}
    tr.row-editing td .cell-in{background:transparent !important;color:var(--navy) !important;border-color:rgba(11,27,58,.35) !important}
    tr.row-editing td .del{color:var(--navy) !important}
    tr.row-editing td input[type="checkbox"]{accent-color:var(--navy)}
  
    /* ===== Excel-like grouped header (AVANCE DESCABEZADO) ===== */
    thead th.g{ text-align:center; font-weight:900; padding:8px 6px; }
    thead th.h-left{ font-weight:900; }
    .ghTitle{font-size:12px; letter-spacing:.4px}
    .ghTotals{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:4px}
    .ghTotals span{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.18);font-size:11px;font-weight:800}
    /* Group colors */
    thead th.g-planta{background:#374151;color:#ffffff}
    thead th.g-mare{background:#f3d4c6;color:#b91c1c}
    thead th.g-vik{background:#f1e0bf;color:#111827}
    thead th.g-fel{background:#cfe3f7;color:#1f3b67}
    thead th.sub{font-weight:900;text-align:center;padding:8px 6px}
    thead th.sub-planta{background:#2b3442;color:#ffffff}
    thead th.sub-mare{background:#f7e2d9;color:#b91c1c}
    thead th.sub-vik{background:#f6edd6;color:#111827}
    thead th.sub-fel{background:#d8ebff;color:#1f3b67}
    /* Slightly tighter table to look like Excel */
    thead th, tbody td{ line-height:1.15 }
    tbody td.num{ text-align:right }

  </style>
</head>
<body>
  <header>
    <div class="brand">
      <b>Oceantreasure</b>
      <span>PAGOS • AVANCE • HORA • 2025 (Firestore)</span>
    </div>
    <div class="right" id="topRight" style="display:none">
      <span class="pill" id="pillUser">Usuario: —</span>
      <span class="pill" id="pillNow">Fecha: —</span>
      <button class="btn out" id="btnSignOut">Salir</button>
    </div>
  </header>

  <!-- LOGIN -->
  <section class="center" id="viewLogin">
    <div class="card">
      <h2>OCEANTREASURE | Login</h2>
      <p>Acceso en la nube (Firebase). Ingrese correo y contraseña.</p>

      <div class="row">
        <label>Usuario</label>
        <input class="cell" id="loginEmail" type="email" autocomplete="username" />
      </div>
      <div class="row">
        <label>Clave</label>
        <input class="cell" id="loginPass" type="password" autocomplete="current-password" />
      </div>

      <button class="btn" id="btnLogin" style="width:100%;margin-top:8px">INGRESAR</button>
      <div class="error" id="loginErr"></div>

      <div class="hint">
        Nota: por seguridad, esta página <b>NO</b> debe tener la contraseña “quemada” en el código. La clave se escribe aquí al iniciar sesión.
      </div>
    </div>
  </section>

  <!-- APP -->
  <main id="viewApp" style="display:none">
    <div class="tabs" style="margin-bottom:12px">
      <div class="tab on" data-tab="DESC">AVANCE DESCABEZADO</div>
      <div class="tab" data-tab="HORA">HORA</div>
      <div class="tab" data-tab="PAN">AVANCE PAÑALEO</div>
      <div class="tab" data-tab="LAV">AVANCE LAVADO DE SACOS</div>
    </div>

    <div class="gridTop">
      <div class="box" id="boxIngreso">
        <h3>INGRESAR</h3>
        <div class="body" id="formArea"></div>
      </div>

      <div class="box">
        <h3>CONTROL</h3>
        <div class="body">
          <div class="stats" id="statsArea"></div>
          <div class="hr"></div>
          <div class="hint" id="hintArea">Los totales se calculan con los registros guardados en Firestore.</div>
        </div>
      </div>

      <div class="box">
        <h3>PRESENTAR TABLA</h3>
        <div class="body">
          <div class="row">
            <label>Desde</label>
            <input class="cell" id="fltFrom" type="date" />
          </div>
          <div class="row">
            <label>Hasta</label>
            <input class="cell" id="fltTo" type="date" />
          </div>
          <button class="btn out" id="btnClearFilter" style="width:100%;margin-top:8px">Limpiar Filtro</button>
          <div class="hint">Filtra por FECHA (inclusive).</div>
        </div>
      </div>
    </div>

    <div class="tableWrap" style="margin-top:12px">
      <table>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <script type="module">
    /***********************
     * 1) Firebase Config
     *    (Pegar aquí tu config de Firebase)
     ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyCMoLkSnnLowMagRNL7O6ttPo1FXd1URac",
      authDomain: "oceantreasure-app.firebaseapp.com",
      projectId: "oceantreasure-app",
      storageBucket: "oceantreasure-app.firebasestorage.app",
      messagingSenderId: "553014659258",
      appId: "1:553014659258:web:cfc30844a88433b7b79a83",
      measurementId: "G-HMMQKJY8NJ"
    };

    // Login único (solo este correo)
    const ALLOWED_EMAIL = "milenalmeida@oceantreasure.local";

    /***********************
     * 2) Firebase Imports
     ***********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, deleteDoc,
      onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /***********************
     * 3) Helpers
     ***********************/
    const $ = (s)=>document.querySelector(s);
    const fmt = (n, dec=2)=>{
      if(n===null || n===undefined || n==="") return "";
      const x = Number(n);
      if(!Number.isFinite(x)) return "";
      return x.toLocaleString("es-EC", {minimumFractionDigits:dec, maximumFractionDigits:dec});
    };
    const num = (v)=>{
      if(v===null || v===undefined) return 0;
      if(typeof v === "number") return v;
      const s = String(v).replace(/\./g,"").replace(",",".").trim();
      const x = Number(s);
      return Number.isFinite(x) ? x : 0;
    };
    const iso = (d)=> {
      if(!d) return "";
      const dt = new Date(d);
      if(Number.isNaN(dt.getTime())) return "";
      return dt.toISOString().slice(0,10);
    };
    const diaES = (dateISO)=>{
      const d = new Date(dateISO+"T00:00:00");
      const days=["DOMINGO","LUNES","MARTES","MIERCOLES","JUEVES","VIERNES","SABADO"];
      return days[d.getDay()] || "";
    };

    const nowTicker = ()=>{
      const dt = new Date();
      const f = dt.toLocaleString("es-EC",{year:"numeric",month:"2-digit",day:"2-digit", hour:"2-digit",minute:"2-digit",second:"2-digit"});
      $("#pillNow").textContent = "Fecha: " + f;
    };

    /***********************
     * 4) Sheet Definitions (según el Excel)
     ***********************/
    const SHEETS = {
      DESC: {
        title: "AVANCE DESCABEZADO",
        coll: "PAGOS_AVANCE_HORA_2025_DESCABEZADO",
        columns: [
          {k:"dia", t:"DÍA"},
          {k:"fecha", t:"FECHA"},
          {k:"plantaCupo", t:"PLANTA CUPO", type:"n0"},
          {k:"plantaLibras", t:"PLANTA LIBRAS", type:"n2"},
          {k:"plantaRate", t:"PLANTA TARIFA", type:"n3", def:0.08},
          {k:"plantaDolares", t:"PLANTA DÓLARES", type:"n2", calc:(r)=>num(r.plantaLibras)*num(r.plantaRate)},
          {k:"mareCupo", t:"MAREPREX CUPO", type:"n0"},
          {k:"mareLibras", t:"MAREPREX LIBRAS", type:"n2"},
          {k:"mareRate", t:"MAREPREX TARIFA", type:"n3", def:0.10},
          {k:"mareDolares", t:"MAREPREX DÓLARES", type:"n2", calc:(r)=>num(r.mareLibras)*num(r.mareRate)},
          {k:"vikCupo", t:"VIKTOSAN CUPO", type:"n0"},
          {k:"vikLibras", t:"VIKTOSAN LIBRAS", type:"n2"},
          {k:"vikRate", t:"VIKTOSAN TARIFA", type:"n3", def:0.10},
          {k:"vikDolares", t:"VIKTOSAN DÓLARES", type:"n2", calc:(r)=>num(r.vikLibras)*num(r.vikRate)},
          {k:"felCupo", t:"FELESMAR CUPO", type:"n0"},
          {k:"felLibras", t:"FELESMAR LIBRAS", type:"n2"},
          {k:"felRate", t:"FELESMAR TARIFA", type:"n3", def:0.10},
          {k:"felDolares", t:"FELESMAR DÓLARES", type:"n2", calc:(r)=>num(r.felLibras)*num(r.felRate)},
        ],
        stats: (rows)=> {
          const totalL = rows.reduce((a,r)=>a+num(r.plantaLibras)+num(r.mareLibras)+num(r.vikLibras)+num(r.felLibras),0);
          const total$ = rows.reduce((a,r)=>a+(num(r.plantaLibras)*num(r.plantaRate))+(num(r.mareLibras)*num(r.mareRate))+(num(r.vikLibras)*num(r.vikRate))+(num(r.felLibras)*num(r.felRate)),0);
          return [
            {label:"TOTAL LIBRAS", value: fmt(totalL,2)},
            {label:"TOTAL DÓLARES", value: fmt(total$,2)},
            {label:"PLANTA $", value: fmt(rows.reduce((a,r)=>a+num(r.plantaLibras)*num(r.plantaRate),0),2)},
            {label:"MAREPREX $", value: fmt(rows.reduce((a,r)=>a+num(r.mareLibras)*num(r.mareRate),0),2)},
          ];
        },
        defaultRow: ()=>({
          fecha: iso(new Date()),
          dia: diaES(iso(new Date())),
          plantaRate:0.08, mareRate:0.10, vikRate:0.10, felRate:0.10
        })
      },

      HORA: {
        title: "HORA",
        coll: "PAGOS_AVANCE_HORA_2025_HORA",
        columns: [
          {k:"dia", t:"DÍA"},
          {k:"fecha", t:"FECHA"},
          {k:"cupo", t:"CUPO", type:"n0"},
          {k:"dolares", t:"DÓLARES", type:"n2"},
          {k:"libras", t:"LIBRAS", type:"n2"},
          {k:"costo", t:"COSTO", type:"n6", calc:(r)=> (num(r.libras)===0?0: num(r.dolares)/num(r.libras))}
        ],
        stats: (rows)=> {
          const t$ = rows.reduce((a,r)=>a+num(r.dolares),0);
          const tL = rows.reduce((a,r)=>a+num(r.libras),0);
          const avg = (tL===0)?0:(t$/tL);
          return [
            {label:"TOTAL DÓLARES", value: fmt(t$,2)},
            {label:"TOTAL LIBRAS", value: fmt(tL,2)},
            {label:"PROMEDIO COSTO", value: fmt(avg,6)},
            {label:"REGISTROS", value: String(rows.length)},
          ];
        },
        defaultRow: ()=>({fecha: iso(new Date()), dia: diaES(iso(new Date()))})
      },

      PAN: {
        title: "AVANCE PAÑALEO",
        coll: "PAGOS_AVANCE_HORA_2025_PANALEO",
        columns: [
          {k:"dia", t:"DÍA"},
          {k:"fecha", t:"FECHA"},
          {k:"cupo", t:"CUPO", type:"n0"},
          {k:"unidades", t:"TOTAL DE UNIDADES", type:"n0"},
          {k:"precio", t:"PRECIO", type:"n6", def:0.005},
          {k:"pagar", t:"V. APAGAR", type:"n2", calc:(r)=>num(r.unidades)*num(r.precio)},
        ],
        stats: (rows)=> {
          const u = rows.reduce((a,r)=>a+num(r.unidades),0);
          const p = rows.reduce((a,r)=>a+(num(r.unidades)*num(r.precio)),0);
          return [
            {label:"TOTAL UNIDADES", value: fmt(u,0)},
            {label:"TOTAL A PAGAR", value: fmt(p,2)},
            {label:"PRECIO BASE", value: fmt(0.005,6)},
            {label:"REGISTROS", value: String(rows.length)},
          ];
        },
        defaultRow: ()=>({fecha: iso(new Date()), dia: diaES(iso(new Date())), precio:0.005})
      },

      LAV: {
        title: "AVANCE LAVADO DE SACOS",
        coll: "PAGOS_AVANCE_HORA_2025_LAVADO_SACOS",
        columns: [
          {k:"dia", t:"DÍA"},
          {k:"fecha", t:"FECHA"},
          {k:"cupo", t:"CUPO", type:"n0"},
          {k:"unidades", t:"TOTAL DE UNIDADES", type:"n0"},
          {k:"precio", t:"PRECIO", type:"n3", def:0.015},
          {k:"pagar", t:"V. APAGAR", type:"n2", calc:(r)=>num(r.unidades)*num(r.precio)},
        ],
        stats: (rows)=> {
          const u = rows.reduce((a,r)=>a+num(r.unidades),0);
          const p = rows.reduce((a,r)=>a+(num(r.unidades)*num(r.precio)),0);
          return [
            {label:"TOTAL UNIDADES", value: fmt(u,0)},
            {label:"TOTAL A PAGAR", value: fmt(p,2)},
            {label:"PRECIO BASE", value: fmt(0.015,3)},
            {label:"REGISTROS", value: String(rows.length)},
          ];
        },
        defaultRow: ()=>({fecha: iso(new Date()), dia: diaES(iso(new Date())), precio:0.015})
      },
    };

    let activeTab = localStorage.getItem("PAH25_TAB") || "DESC";
    let unsub = null;
    let rows = []; // current sheet rows
    let filterFrom = "";
    let filterTo = "";

    /***********************
     * 5) Login / Auth
     ***********************/
    $("#loginEmail").value = ALLOWED_EMAIL;

    async function doLogin(){
      $("#loginErr").textContent = "";
      const email = ($("#loginEmail").value||"").trim();
      const pass  = ($("#loginPass").value||"").trim();

      try{
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        const u = cred.user;
        if((u.email||"").toLowerCase() !== ALLOWED_EMAIL.toLowerCase()){
          await signOut(auth);
          $("#loginErr").textContent = "Usuario no autorizado.";
          return;
        }
      }catch(err){
        $("#loginErr").textContent = "Error (" + (err?.code||"") + "): " + (err?.message||String(err));
      }
    }

    $("#btnLogin").addEventListener("click", doLogin);
    $("#loginPass").addEventListener("keydown",(e)=>{ if(e.key==="Enter") doLogin(); });

    $("#btnSignOut").addEventListener("click", ()=>signOut(auth));

    onAuthStateChanged(auth, (user)=>{
      if(user && (user.email||"").toLowerCase() === ALLOWED_EMAIL.toLowerCase()){
        $("#viewLogin").style.display="none";
        $("#viewApp").style.display="block";
        $("#topRight").style.display="flex";
        $("#pillUser").textContent = "Usuario: " + user.email;
        nowTicker(); setInterval(nowTicker, 1000);
        mountTabs();
        switchTab(activeTab);
      }else{
        $("#viewLogin").style.display="flex";
        $("#viewApp").style.display="none";
        $("#topRight").style.display="none";
        if(user) signOut(auth);
      }
    });

    /***********************
     * 6) UI: Tabs + Form + Table
     ***********************/
    function mountTabs(){
      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("on", t.dataset.tab===activeTab);
        t.onclick = ()=>{
          activeTab = t.dataset.tab;
          localStorage.setItem("PAH25_TAB", activeTab);
          document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("on", x.dataset.tab===activeTab));
          switchTab(activeTab);
        };
      });
    }

    function buildForm(){
      const sheet = SHEETS[activeTab];
      const r = sheet.defaultRow();
      const area = $("#formArea");
      area.innerHTML = "";

      // Basic: fecha + dia
      area.appendChild(formRow("Fecha", input("date","f_fecha", r.fecha, (v)=>{
        const d = iso(v);
        $("#f_fecha").value = d;
        $("#f_dia").value = diaES(d);
      })));
      area.appendChild(formRow("Día", input("text","f_dia", r.dia)));

      // Dynamic fields
      const fields = sheet.columns.filter(c=>!["dia","fecha"].includes(c.k));
      for(const col of fields){
        // hide calc-only fields (those with calc and no def) from the entry form
        const isCalc = typeof col.calc === "function";
        const hasDef = col.def !== undefined || (r[col.k] !== undefined);
        if(isCalc && !hasDef) continue;

        const val = (r[col.k] !== undefined) ? r[col.k] : (col.def !== undefined ? col.def : "");
        const type = (col.k.toLowerCase().includes("rate") || col.k==="precio" || col.k==="costo") ? "number" : "number";
        const step = (col.type==="n6") ? "0.000001" : (col.type==="n3" ? "0.001" : (col.type==="n2" ? "0.01" : "1"));
        area.appendChild(formRow(col.t, input(type, "f_"+col.k, val, null, step)));
      }

      const btn = document.createElement("button");
      btn.className="btn";
      btn.style.width="100%";
      btn.textContent="GUARDAR (Firestore)";
      btn.onclick = ()=>saveFromForm();
      area.appendChild(document.createElement("div")).style.height="8px";
      area.appendChild(btn);

      const note = document.createElement("div");
      note.className="hint";
      note.textContent = "Tip: En fecha, el día se calcula automático. Guardar crea/actualiza el registro por FECHA.";
      area.appendChild(note);
    }

    function formRow(labelText, inputEl){
      const wrap = document.createElement("div");
      wrap.className="row";
      const lab = document.createElement("label");
      lab.textContent = labelText;
      wrap.appendChild(lab);
      wrap.appendChild(inputEl);
      return wrap;
    }

    function input(type,id,value,onchange,step){
      const el = document.createElement("input");
      el.className="cell";
      el.type=type;
      el.id=id;
      el.value = (value ?? "");
      if(step) el.step=step;
      if(onchange) el.addEventListener("change", e=>onchange(e.target.value));
      return el;
    }

        function visibleCols(sheet){
      // En AVANCE DESCABEZADO, la tabla debe verse como el Excel (sin TARIFAS en columnas)
      if(activeTab==="DESC"){
        return sheet.columns.filter(c=>!String(c.k).toLowerCase().includes("rate"));
      }
      return sheet.columns;
    }

    function buildTableHeader(listForTotals){
      const sheet = SHEETS[activeTab];
      const head = $("#thead");
      head.innerHTML="";

      const cols = visibleCols(sheet);

      // Default header (simple)
      if(activeTab!=="DESC"){
        const tr=document.createElement("tr");
        for(const col of cols){
          const th=document.createElement("th");
          th.textContent = col.t;
          tr.appendChild(th);
        }
        const thM=document.createElement("th"); thM.textContent="Modificar"; tr.appendChild(thM);
        const thQ=document.createElement("th"); thQ.textContent="Quitar"; tr.appendChild(thQ);
        head.appendChild(tr);
        return;
      }

      // ===== DESC: Excel-like grouped headers =====
      const list = Array.isArray(listForTotals) ? listForTotals : applyFilters(rows);

      const sum = (k)=> list.reduce((a,r)=>a+num(r[k]),0);
      const sum$ = (lk, rk)=> list.reduce((a,r)=>a+num(r[lk])*num(r[rk]),0);

      const totals = {
        plantaL: sum("plantaLibras"),
        planta$: sum$("plantaLibras","plantaRate"),
        mareL:   sum("mareLibras"),
        mare$:   sum$("mareLibras","mareRate"),
        vikL:    sum("vikLibras"),
        vik$:    sum$("vikLibras","vikRate"),
        felL:    sum("felLibras"),
        fel$:    sum$("felLibras","felRate"),
      };

      const groupTH = (label, cls, lbs, dol)=>{
        const th=document.createElement("th");
        th.colSpan=3;
        th.className = "g " + cls;
        th.innerHTML = `
          <div class="ghTitle">${label}</div>
          <div class="ghTotals">
            <span>${fmt(lbs,2)}</span>
            <span>$ ${fmt(dol,2)}</span>
          </div>`;
        return th;
      };

      const subTH = (txt, cls)=>{
        const th=document.createElement("th");
        th.className = "sub " + cls;
        th.textContent = txt;
        return th;
      };

      // Row 1: Group titles
      const tr1=document.createElement("tr");

      const thDia=document.createElement("th");
      thDia.rowSpan=2; thDia.className="h-left";
      thDia.textContent="DÍA";
      tr1.appendChild(thDia);

      const thFecha=document.createElement("th");
      thFecha.rowSpan=2; thFecha.className="h-left";
      thFecha.textContent="FECHA";
      tr1.appendChild(thFecha);

      tr1.appendChild(groupTH("PLANTA","g-planta", totals.plantaL, totals.planta$));
      tr1.appendChild(groupTH("MAREPREX","g-mare", totals.mareL, totals.mare$));
      tr1.appendChild(groupTH("VIKTOSAN","g-vik", totals.vikL, totals.vik$));
      tr1.appendChild(groupTH("FELESMAR","g-fel", totals.felL, totals.fel$));

      const thM=document.createElement("th");
      thM.rowSpan=2; thM.textContent="Modificar";
      tr1.appendChild(thM);

      const thQ=document.createElement("th");
      thQ.rowSpan=2; thQ.textContent="Quitar";
      tr1.appendChild(thQ);

      head.appendChild(tr1);

      // Row 2: Sub headers
      const tr2=document.createElement("tr");
      // PLANTA
      tr2.appendChild(subTH("CUPO","sub-planta"));
      tr2.appendChild(subTH("LIBRAS","sub-planta"));
      tr2.appendChild(subTH("$","sub-planta"));
      // MAREPREX
      tr2.appendChild(subTH("CUPO","sub-mare"));
      tr2.appendChild(subTH("LIBRAS","sub-mare"));
      tr2.appendChild(subTH("$","sub-mare"));
      // VIKTOSAN
      tr2.appendChild(subTH("CUPO","sub-vik"));
      tr2.appendChild(subTH("LIBRAS","sub-vik"));
      tr2.appendChild(subTH("$","sub-vik"));
      // FELESMAR
      tr2.appendChild(subTH("CUPO","sub-fel"));
      tr2.appendChild(subTH("LIBRAS","sub-fel"));
      tr2.appendChild(subTH("$","sub-fel"));

      head.appendChild(tr2);
    }

    function applyFilters(list){
      if(!filterFrom && !filterTo) return list;
      return list.filter(r=>{
        const f = (r.fecha||"");
        if(filterFrom && f < filterFrom) return false;
        if(filterTo && f > filterTo) return false;
        return true;
      });
    }

    function renderStats(){
      const sheet = SHEETS[activeTab];
      const list = applyFilters(rows);
      const stats = sheet.stats(list);

      const area = $("#statsArea");
      area.innerHTML="";
      for(const s of stats){
        const d=document.createElement("div");
        d.className="stat";
        const b=document.createElement("b");
        b.textContent=s.label;
        const v=document.createElement("span");
        v.textContent=s.value;
        d.appendChild(b); d.appendChild(v);
        area.appendChild(d);
      }
      $("#hintArea").textContent = sheet.title + " • Guardado en Firestore • Colección: " + sheet.coll;
    }

        function renderTable(){
      const sheet = SHEETS[activeTab];
      const body = $("#tbody");
      body.innerHTML="";

      const list = applyFilters(rows);

      // Header (en DESC es "tipo Excel" y muestra totales por grupo)
      buildTableHeader(list);

      const cols = visibleCols(sheet);

      for(const r of list){
        const tr=document.createElement("tr");
        tr.classList.toggle("row-editing", !!r._editing);

        for(const col of cols){
          const td=document.createElement("td");

          const isCalc = typeof col.calc === "function";
          const isLeft = (col.k==="dia" || col.k==="fecha");

          if(!isCalc){
            const inp=document.createElement("input");
            inp.className="cell-in";
            inp.value = (col.k==="fecha") ? (r[col.k]||"") : (col.k==="dia" ? (r[col.k]||"") : (r[col.k] ?? ""));
            inp.disabled = !r._editing;

            if(!isLeft) { td.classList.add("num"); inp.style.textAlign="right"; }

            if(col.k==="fecha"){
              inp.type="date";
              inp.addEventListener("change",(e)=>{
                const v = iso(e.target.value);
                r.fecha = v;
                r.dia = diaES(v);
                saveRow(r);
              });
            }else{
              inp.type = (col.k==="dia") ? "text" : "number";
              inp.step = (col.type==="n6") ? "0.000001" : (col.type==="n3" ? "0.001" : (col.type==="n2" ? "0.01" : "1"));
              inp.addEventListener("change",(e)=>{
                const v = (inp.type==="text") ? e.target.value : num(e.target.value);
                r[col.k] = v;
                saveRow(r);
              });
            }
            td.appendChild(inp);
          }else{
            const val = col.calc(r);
            const txt = (col.type==="n6") ? fmt(val,6) : (col.type==="n3"?fmt(val,3):(col.type==="n2"?fmt(val,2):fmt(val,0)));
            td.textContent = (activeTab==="DESC" && col.k.toLowerCase().includes("dolares")) ? ("$ " + txt) : txt;
            if(!isLeft) td.classList.add("num");
          }

          tr.appendChild(td);
        }

        // Modificar
        const tdM=document.createElement("td");
        const chk=document.createElement("input");
        chk.type="checkbox"; chk.className="chk";
        chk.checked=!!r._editing;
        chk.addEventListener("change",()=>{
          r._editing = chk.checked;
          tr.classList.toggle("row-editing", !!r._editing);
          renderTable(); // refresh disabled state + header totals
        });
        tdM.appendChild(chk);
        tr.appendChild(tdM);

        // Quitar
        const tdQ=document.createElement("td");
        const a=document.createElement("span");
        a.className="del";
        a.textContent="Eliminar";
        a.onclick=()=>removeRow(r);
        tdQ.appendChild(a);
        tr.appendChild(tdQ);

        body.appendChild(tr);
      }

      renderStats();
    }

    async function saveFromForm(){
      const sheet = SHEETS[activeTab];
      const row = {};
      row.fecha = iso($("#f_fecha").value);
      row.dia = ($("#f_dia").value||"").trim().toUpperCase();

      for(const col of sheet.columns){
        if(["dia","fecha"].includes(col.k)) continue;
        const el = $("#f_"+col.k);
        if(!el) continue;
        row[col.k] = (el.type==="text") ? (el.value||"") : num(el.value);
      }

      if(!row.fecha){
        alert("Ingrese una FECHA válida.");
        return;
      }

      // DocID por fecha (1 registro por día). Si quieres varios por día, se puede cambiar.
      row._id = row.fecha;
      await saveRow(row);

      // limpiar parcial (mantener tarifas/precios)
      const fresh = sheet.defaultRow();
      $("#f_fecha").value = fresh.fecha;
      $("#f_dia").value = fresh.dia;
    }

    function computedForStorage(sheet, r){
      const out = {...r};
      // store computed fields too, for consistency
      for(const col of sheet.columns){
        if(typeof col.calc === "function"){
          out[col.k] = col.calc(r);
        }
        if(col.def !== undefined && (out[col.k]===undefined || out[col.k]==="")) out[col.k] = col.def;
      }
      // housekeeping
      delete out._editing;
      return out;
    }

    async function saveRow(r){
      const sheet = SHEETS[activeTab];
      const id = r._id || r.fecha;
      const ref = doc(collection(db, sheet.coll), String(id));
      const payload = computedForStorage(sheet, r);
      payload.fecha = r.fecha;
      payload.dia = r.dia || diaES(r.fecha);
      payload._updatedAt = Date.now();
      await setDoc(ref, payload, {merge:true});
    }

    async function removeRow(r){
      const sheet = SHEETS[activeTab];
      if(!confirm("¿Eliminar este registro?")) return;
      const id = r._id || r.fecha;
      await deleteDoc(doc(collection(db, sheet.coll), String(id)));
    }

    function listenSheet(){
      const sheet = SHEETS[activeTab];
      if(unsub) unsub();
      const q = query(collection(db, sheet.coll), orderBy("fecha","asc"));
      unsub = onSnapshot(q, (snap)=>{
        rows = snap.docs.map(d=>({ _id:d.id, _editing:false, ...d.data() }));
        renderTable();
      });
    }

    function switchTab(tab){
      activeTab = tab;
      buildForm();
      buildTableHeader();
      listenSheet();
      renderStats();
    }

    // Filters
    $("#fltFrom").addEventListener("change", (e)=>{ filterFrom = iso(e.target.value); renderTable(); });
    $("#fltTo").addEventListener("change", (e)=>{ filterTo = iso(e.target.value); renderTable(); });
    $("#btnClearFilter").addEventListener("click", ()=>{
      filterFrom=""; filterTo="";
      $("#fltFrom").value=""; $("#fltTo").value="";
      renderTable();
    });
  </script>
</body>
</html>
