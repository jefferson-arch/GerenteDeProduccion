<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oceantreasure | Pagos Avance Hora 2025</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --panel2:#0d172b;
      --line:rgba(255,255,255,.10);
      --text:#e5e7eb; --muted:rgba(229,231,235,.72);
      --btn:#1f4fd6; --btn2:#123aa7;
      --navy:#0b1b3a;
      --white:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:radial-gradient(1200px 700px at 50% 0%, #101f3f 0%, var(--bg) 55%, #070b13 100%);color:var(--text)}
    header{padding:18px 18px;border-bottom:1px solid var(--line);background:rgba(0,0,0,.25);display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;flex-direction:column;gap:4px}
    .brand b{font-size:14px;letter-spacing:.4px}
    .brand span{font-size:12px;color:var(--muted)}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid var(--line);background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;font-size:12px}
    .btn{border:1px solid rgba(255,255,255,.14);background:linear-gradient(180deg,var(--btn) 0%, var(--btn2) 100%);color:#fff;padding:7px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn:active{transform:translateY(1px)}
    .btn.out{background:rgba(255,255,255,.06)}
    main{max-width:1280px;margin:0 auto;padding:14px 16px 18px}
    .gridTop{display:grid;grid-template-columns:380px 1fr 360px;gap:12px;align-items:start}
    .box{background:linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.03) 100%);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .box h3{margin:0;padding:12px 12px;border-bottom:1px solid var(--line);font-size:13px;letter-spacing:.4px}
    .box .body{padding:12px}
    .row{display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin-bottom:8px}
    .row label{font-size:12px;color:var(--muted)}
    .cell{width:100%;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:13px}
    .cell:disabled{opacity:.55;cursor:not-allowed}
    .cell::placeholder{color:rgba(229,231,235,.38)}
    .inline2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .hint{font-size:11px;color:rgba(229,231,235,.60);margin-top:8px;line-height:1.25}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.18);font-size:12px;cursor:pointer}
    .tab.on{background:rgba(31,79,214,.22);border-color:rgba(31,79,214,.45);font-weight:700}
    .stats{display:flex;flex-wrap:wrap;gap:10px}
.stats.statsCols{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.statCol{display:flex;flex-direction:column;gap:10px}
.stats.statsCols .stat{flex:unset;min-width:unset}
    .stat{flex:1;min-width:180px}
    .stat{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:10px}
    .stat b{display:block;font-size:12px;color:rgba(229,231,235,.78);margin-bottom:5px}
    .stat span{font-size:18px;font-weight:800}
    .hr{height:1px;background:var(--line);margin:10px 0}
    /* Table */
    .tableWrap{margin-top:12px;background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      position:sticky;top:0;z-index:2;
      background:rgba(0,0,0,.35);
      border-bottom:1px solid var(--line);
      font-size:12px;color:rgba(229,231,235,.85);
      text-align:left;padding:9px 8px;white-space:nowrap
    }
    tbody td{
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:12px;padding:7px 8px;vertical-align:middle;white-space:nowrap
    }
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .cell-in{
      width:100%;
      padding:6px 8px;border-radius:9px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:var(--text);outline:none;font-size:12px
    }
    .cell-in:disabled{border-color:transparent;background:transparent;padding:0}
    .actions{display:flex;gap:8px;align-items:center}
    .del{color:#cbd5e1;text-decoration:underline;cursor:pointer;font-size:12px}
    .chk{transform:scale(1.05)}
    /* Login */
    .center{min-height:calc(100vh - 64px);display:flex;align-items:center;justify-content:center;padding:18px}
    .card{width:min(560px, calc(100% - 30px));background:linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.03) 100%);border:1px solid var(--line);border-radius:16px;padding:16px}
    .card h2{margin:0 0 6px 0;font-size:16px}
    .card p{margin:0 0 12px 0;font-size:12px;color:var(--muted)}
    .error{margin-top:10px;color:#fecaca;font-size:12px;white-space:pre-wrap}
    .ok{margin-top:10px;color:#bbf7d0;font-size:12px}
    /* Requested UX: Focus highlight */
    .box .cell:focus,
    .box .cell:focus-visible,
    .card .cell:focus,
    .card .cell:focus-visible,
    .tableWrap .cell-in:focus,
    .tableWrap .cell-in:focus-visible{
      background:var(--white) !important;
      color:var(--navy) !important;
      border-color:rgba(11,27,58,.55) !important;
      outline:2px solid rgba(11,27,58,.20);
      outline-offset:1px;
    }
    .box .cell::placeholder, .card .cell::placeholder{color:rgba(11,27,58,.55)}
    /* Requested UX: Row highlight when editing */
    tr.row-editing td{background:var(--white) !important;color:var(--navy) !important}
    tr.row-editing td .cell-in{background:transparent !important;color:var(--navy) !important;border-color:rgba(11,27,58,.35) !important}
    tr.row-editing td .del{color:var(--navy) !important}
    tr.row-editing td input[type="checkbox"]{accent-color:var(--navy)}
  
    /* ===== Excel-like grouped header (AVANCE DESCABEZADO) ===== */
    thead th.g{ text-align:center; font-weight:900; padding:8px 6px; }
    thead th.h-left{ font-weight:900; }
    .ghTitle{font-size:12px; letter-spacing:.4px}
    .ghTotals{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:4px}
    .ghTotals span{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.18);font-size:11px;font-weight:800}
    /* Group colors */
    thead th.g-planta{background:#374151;color:#ffffff}
    thead th.g-mare{background:#f3d4c6;color:#b91c1c}
    thead th.g-vik{background:#f1e0bf;color:#111827}
    thead th.g-fel{background:#cfe3f7;color:#1f3b67}
    thead th.sub{font-weight:900;text-align:center;padding:8px 6px}
    thead th.sub-planta{background:#2b3442;color:#ffffff}
    thead th.sub-mare{background:#f7e2d9;color:#b91c1c}
    thead th.sub-vik{background:#f6edd6;color:#111827}
    thead th.sub-fel{background:#d8ebff;color:#1f3b67}
    /* Slightly tighter table to look like Excel */
    thead th, tbody td{ line-height:1.15 }
    tbody td.num{ text-align:right }

  
    /* --- Compact INGRESAR (Beneficiarios dinámicos) --- */
    .beneBar{display:grid;grid-template-columns:1fr;gap:8px}
    .beneLine{display:flex;gap:8px;align-items:center}
    .beneLine .cell{flex:1;min-width:180px}
    .beneBtns{display:flex;gap:8px;align-items:center;flex:0 0 auto}
    .beneBar .miniBtn{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer;font-weight:800}
    .beneBar .miniBtn:hover{filter:brightness(1.06)}
    .subhint{font-size:11px;color:rgba(229,231,235,.72);margin-top:6px}
    /* Make INGRESAR look smaller */
    #boxIngreso .row{grid-template-columns:110px 1fr}
    #boxIngreso h3{margin-bottom:8px}

  </style>
</head>
<body>
  <header>
    <div class="brand">
      <b>Oceantreasure</b>
      <span>PAGOS • AVANCE • HORA • 2025 (Firestore)</span>
    </div>
    <div class="right" id="topRight" style="display:none">
      <span class="pill" id="pillUser">Usuario: —</span>
      <span class="pill" id="pillNow">Fecha: —</span>
      <button class="btn out" id="btnSignOut">Salir</button>
    </div>
  </header>

  <!-- LOGIN -->
  <section class="center" id="viewLogin">
    <div class="card">
      <h2>OCEANTREASURE | Login</h2>
      <p>Acceso en la nube (Firebase). Ingrese correo y contraseña.</p>

      <div class="row">
        <label>Usuario</label>
        <input class="cell" id="loginEmail" type="email" autocomplete="username" />
      </div>
      <div class="row">
        <label>Clave</label>
        <input class="cell" id="loginPass" type="password" autocomplete="current-password" />
      </div>

      <button class="btn" id="btnLogin" style="width:100%;margin-top:8px">INGRESAR</button>
      <div class="error" id="loginErr"></div>

      <div class="hint">
        Nota: por seguridad, esta página <b>NO</b> debe tener la contraseña “quemada” en el código. La clave se escribe aquí al iniciar sesión.
      </div>
    </div>
  </section>

  <!-- APP -->
  <main id="viewApp" style="display:none">
    <div class="tabs" style="margin-bottom:12px">
      <div class="tab on" data-tab="DESC">AVANCE DESCABEZADO</div>
      <div class="tab" data-tab="HORA">HORA</div>
      <div class="tab" data-tab="PAN">AVANCE PAÑALEO</div>
      <div class="tab" data-tab="LAV">AVANCE LAVADO DE SACOS</div>
    </div>

    <div class="gridTop">
      <div class="box" id="boxIngreso">
        <h3>INGRESAR</h3>
        <div class="body" id="formArea"></div>
      </div>

      <div class="box">
        <h3>CONTROL</h3>
        <div class="body">
          <div class="stats" id="statsArea"></div>
          <div class="hr"></div>
          <div class="hint" id="hintArea">Los totales se calculan con los registros guardados en Firestore.</div>
        </div>
      </div>

      <div class="box">
        <h3>PRESENTAR TABLA</h3>
        <div class="body">
          <div class="row">
            <label>Desde</label>
            <input class="cell" id="fltFrom" type="date" />
          </div>
          <div class="row">
            <label>Hasta</label>
            <input class="cell" id="fltTo" type="date" />
          </div>
          <button class="btn out" id="btnClearFilter" style="width:100%;margin-top:8px">Limpiar Filtro</button>
          <button class="btn" id="btnPDF" style="width:100%;margin-top:8px">GENERAR PDF</button>
          <div class="hint">Filtra por FECHA (inclusive).</div>
        </div>
      </div>
    </div>

    <div class="tableWrap" style="margin-top:12px">
      <table>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <script type="module">
    /***********************
     * 1) Firebase Config
     *    (Pegar aquí tu config de Firebase)
     ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyCMoLkSnnLowMagRNL7O6ttPo1FXd1URac",
      authDomain: "oceantreasure-app.firebaseapp.com",
      projectId: "oceantreasure-app",
      storageBucket: "oceantreasure-app.firebasestorage.app",
      messagingSenderId: "553014659258",
      appId: "1:553014659258:web:cfc30844a88433b7b79a83",
      measurementId: "G-HMMQKJY8NJ"
    };

    // Login único (solo este correo)
    const ALLOWED_EMAIL = "milenalmeida@oceantreasure.local";

    /***********************
     * 2) Firebase Imports
     ***********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, deleteDoc,
      onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /***********************
     * 3) Helpers
     ***********************/
    const $ = (s)=>document.querySelector(s);
    const fmt = (n, dec=2)=>{
      if(n===null || n===undefined || n==="") return "";
      const x = Number(n);
      if(!Number.isFinite(x)) return "";
      return x.toLocaleString("es-EC", {minimumFractionDigits:dec, maximumFractionDigits:dec});
    };
    const num = (v)=>{
      if(v===null || v===undefined) return 0;
      if(typeof v === "number") return Number.isFinite(v) ? v : 0;
      let s = String(v).trim();
      if(!s) return 0;
      // Remove spaces
      s = s.replace(/\s+/g, "");
      const hasComma = s.includes(",");
      const hasDot = s.includes(".");
      if(hasComma && hasDot){
        const lastComma = s.lastIndexOf(",");
        const lastDot = s.lastIndexOf(".");
        if(lastComma > lastDot){
          // es-EC style: thousands "." and decimal ","
          s = s.replace(/\./g, "").replace(",", ".");
        }else{
          // en style: thousands "," and decimal "."
          s = s.replace(/,/g, "");
        }
      }else if(hasComma){
        // decimal comma
        s = s.replace(/\./g, "").replace(",", ".");
      }else{
        // decimal dot (or plain)
        s = s.replace(/,/g, "");
      }
      const x = Number(s);
      return Number.isFinite(x) ? x : 0;
    };
    const iso = (d)=> {
      if(!d) return "";
      const dt = new Date(d);
      if(Number.isNaN(dt.getTime())) return "";
      return dt.toISOString().slice(0,10);
    };
    const diaES = (dateISO)=>{
      const d = new Date(dateISO+"T00:00:00");
      const days=["DOMINGO","LUNES","MARTES","MIERCOLES","JUEVES","VIERNES","SABADO"];
      return days[d.getDay()] || "";
    };

    const nowTicker = ()=>{
      const dt = new Date();
      const f = dt.toLocaleString("es-EC",{year:"numeric",month:"2-digit",day:"2-digit", hour:"2-digit",minute:"2-digit",second:"2-digit"});
      $("#pillNow").textContent = "Fecha: " + f;
    };

    /***********************
     * 4) Sheet Definitions (según el Excel)
     ***********************/
    const SHEETS = {
      DESC: {
        title: "AVANCE DESCABEZADO",
        coll: "PAGOS_AVANCE_HORA_2025_DESCABEZADO",
        columns: [
          {k:"dia", t:"DÍA"},
          {k:"fecha", t:"FECHA"},
          {k:"plantaCupo", t:"PLANTA CUPO", type:"n0"},
          {k:"plantaLibras", t:"PLANTA LIBRAS", type:"n2"},
          {k:"plantaRate", t:"PLANTA TARIFA", type:"n3", def:0.08},
          {k:"plantaDolares", t:"PLANTA DÓLARES", type:"n2", calc:(r)=>num(r.plantaLibras)*num(r.plantaRate)},
          {k:"mareCupo", t:"MAREPREX CUPO", type:"n0"},
          {k:"mareLibras", t:"MAREPREX LIBRAS", type:"n2"},
          {k:"mareRate", t:"MAREPREX TARIFA", type:"n3", def:0.10},
          {k:"mareDolares", t:"MAREPREX DÓLARES", type:"n2", calc:(r)=>num(r.mareLibras)*num(r.mareRate)},
          {k:"vikCupo", t:"VIKTOSAN CUPO", type:"n0"},
          {k:"vikLibras", t:"VIKTOSAN LIBRAS", type:"n2"},
          {k:"vikRate", t:"VIKTOSAN TARIFA", type:"n3", def:0.10},
          {k:"vikDolares", t:"VIKTOSAN DÓLARES", type:"n2", calc:(r)=>num(r.vikLibras)*num(r.vikRate)},
          {k:"felCupo", t:"FELESMAR CUPO", type:"n0"},
          {k:"felLibras", t:"FELESMAR LIBRAS", type:"n2"},
          {k:"felRate", t:"FELESMAR TARIFA", type:"n3", def:0.10},
          {k:"felDolares", t:"FELESMAR DÓLARES", type:"n2", calc:(r)=>num(r.felLibras)*num(r.felRate)},
        ],
        stats: (rows)=> {
          const totalL = rows.reduce((a,r)=>a+num(r.plantaLibras)+num(r.mareLibras)+num(r.vikLibras)+num(r.felLibras),0);
          const total$ = rows.reduce((a,r)=>a+(num(r.plantaLibras)*num(r.plantaRate))+(num(r.mareLibras)*num(r.mareRate))+(num(r.vikLibras)*num(r.vikRate))+(num(r.felLibras)*num(r.felRate)),0);
          return [
            {label:"TOTAL LIBRAS", value: fmt(totalL,2)},
            {label:"TOTAL DÓLARES", value: fmt(total$,2)},
            {label:"PLANTA $", value: fmt(rows.reduce((a,r)=>a+num(r.plantaLibras)*num(r.plantaRate),0),2)},
            {label:"MAREPREX $", value: fmt(rows.reduce((a,r)=>a+num(r.mareLibras)*num(r.mareRate),0),2)},
          ];
        },
        defaultRow: ()=>({
          fecha: iso(new Date()),
          dia: diaES(iso(new Date())),
          plantaRate:0.08, mareRate:0.10, vikRate:0.10, felRate:0.10
        })
      },

      HORA: {
        title: "HORA",
        coll: "PAGOS_AVANCE_HORA_2025_HORA",
        columns: [
          {k:"dia", t:"DÍA"},
          {k:"fecha", t:"FECHA"},
          {k:"cupo", t:"CUPO", type:"n0"},
          {k:"dolares", t:"DÓLARES", type:"n2"},
          {k:"libras", t:"LIBRAS", type:"n2"},
          {k:"costo", t:"COSTO", type:"n6", calc:(r)=> (num(r.libras)===0?0: num(r.dolares)/num(r.libras))}
        ],
        stats: (rows)=> {
          const t$ = rows.reduce((a,r)=>a+num(r.dolares),0);
          const tL = rows.reduce((a,r)=>a+num(r.libras),0);
          const avg = (tL===0)?0:(t$/tL);
          return [
            {label:"TOTAL DÓLARES", value: fmt(t$,2)},
            {label:"TOTAL LIBRAS", value: fmt(tL,2)},
            {label:"PROMEDIO COSTO", value: fmt(avg,6)},
            {label:"REGISTROS", value: String(rows.length)},
          ];
        },
        defaultRow: ()=>({fecha: iso(new Date()), dia: diaES(iso(new Date()))})
      },

      PAN: {
        title: "AVANCE PAÑALEO",
        coll: "PAGOS_AVANCE_HORA_2025_PANALEO",
        columns: [
          {k:"dia", t:"DÍA"},
          {k:"fecha", t:"FECHA"},
          {k:"cupo", t:"CUPO", type:"n0"},
          {k:"unidades", t:"TOTAL DE UNIDADES", type:"n0"},
          {k:"precio", t:"PRECIO", type:"n3", def:0.005},
          {k:"pagar", t:"V. APAGAR", type:"n2", calc:(r)=>num(r.unidades)*num(r.precio)},
        ],
        stats: (rows)=> {
          const u = rows.reduce((a,r)=>a+num(r.unidades),0);
          const p = rows.reduce((a,r)=>a+(num(r.unidades)*num(r.precio)),0);
          return [
            {label:"TOTAL DÓLARES", value: fmt(p,2)},
            {label:"TOTAL UNIDADES", value: fmt(u,0)},
            {label:"PRECIO", value: fmt(0.005,3)},
            {label:"REGISTROS", value: String(rows.length)},
          ];
        },
        defaultRow: ()=>({fecha: iso(new Date()), dia: diaES(iso(new Date())), precio:0.005})
      },

      LAV: {
        title: "AVANCE LAVADO DE SACOS",
        coll: "PAGOS_AVANCE_HORA_2025_LAVADO_SACOS",
        columns: [
          {k:"dia", t:"DÍA"},
          {k:"fecha", t:"FECHA"},
          {k:"cupo", t:"CUPO", type:"n0"},
          {k:"unidades", t:"TOTAL DE UNIDADES", type:"n0"},
          {k:"precio", t:"PRECIO", type:"n3", def:0.015},
          {k:"pagar", t:"V. APAGAR", type:"n2", calc:(r)=>num(r.unidades)*num(r.precio)},
        ],
        stats: (rows)=> {
          const u = rows.reduce((a,r)=>a+num(r.unidades),0);
          const p = rows.reduce((a,r)=>a+(num(r.unidades)*num(r.precio)),0);
          return [
            {label:"TOTAL DÓLARES", value: fmt(p,2)},
            {label:"TOTAL UNIDADES", value: fmt(u,0)},
            {label:"PRECIO", value: fmt(0.015,3)},
            {label:"REGISTROS", value: String(rows.length)},
          ];
        },
        defaultRow: ()=>({fecha: iso(new Date()), dia: diaES(iso(new Date())), precio:0.015})
      },
    };

    let activeTab = localStorage.getItem("PAH25_TAB") || "DESC";
    let unsub = null;
    let rows = []; // current sheet rows
    let filterFrom = "";
    let filterTo = "";

    let beneficiaries = []; // dynamic beneficiaries (DESC)
    let activeBeneficiary = "";
    let unsubCfg = null;
    const CONFIG_COLL = "PAGOS_AVANCE_HORA_2025_CONFIG";
    const DEFAULT_BENEFICIARIES = ["OCEANTREASURE","MAREPREX","VIKTOSAN","FELESMAR"];

    function normName(s){ return (s||"").trim().replace(/\s+/g," "); }
    function safeKey(name){
      // key stable for css class and ids
      return normName(name).toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    }
    function currentConfigDocId(){ return "BENEFICIARIOS_"+activeTab; }

    function listenConfig(){
      if(unsubCfg){ unsubCfg(); unsubCfg=null; }
      if(activeTab!=="DESC"){ beneficiaries=[]; activeBeneficiary=""; return; }

      const ref = doc(collection(db, CONFIG_COLL), currentConfigDocId());
      unsubCfg = onSnapshot(ref, async (snap)=>{
        if(!snap.exists()){
          beneficiaries = [...DEFAULT_BENEFICIARIES];
          activeBeneficiary = beneficiaries[0] || "";
          await setDoc(ref, { list: beneficiaries, updatedAt: Date.now() }, {merge:true});
          buildForm(); renderTable(); renderStats();
          return;
        }
        const data = snap.data() || {};
        beneficiaries = Array.isArray(data.list) ? data.list.map(normName).filter(Boolean) : [...DEFAULT_BENEFICIARIES];
        if(!beneficiaries.length) beneficiaries = [...DEFAULT_BENEFICIARIES];
        if(!activeBeneficiary || !beneficiaries.includes(activeBeneficiary)){
          activeBeneficiary = beneficiaries[0];
        }
        buildForm(); renderTable(); renderStats();
      });
    }

    async function setBeneficiaries(list){
      const ref = doc(collection(db, CONFIG_COLL), currentConfigDocId());
      await setDoc(ref, { list, updatedAt: Date.now() }, {merge:true});
    }

    function getRowByDate(dateIso){
      const id = String(dateIso||"");
      return rows.find(r => String(r._id||r.fecha||"")===id) || null;
    }

    function getBeneObj(r){
      // New model: r.beneficiarios is object
      if(r && typeof r.beneficiarios==="object" && r.beneficiarios) return r.beneficiarios;

      // Backward compatibility: map old fields
      const o = {};
      const map = [
        ["OCEANTREASURE","planta"],
        ["MAREPREX","mareprex"],
        ["VIKTOSAN","viktosan"],
        ["FELESMAR","felesmar"],
      ];
      for(const [bn,prefix] of map){
        const cupo = r?.[prefix+"Cupo"];
        const libras = r?.[prefix+"Libras"];
        const tarifa = r?.[prefix+"Rate"];
        if(cupo!=null || libras!=null || tarifa!=null){
          o[bn] = {
            cupo: num(cupo),
            libras: num(libras),
            tarifa: num(tarifa)
          };
        }
      }
      return o;
    }

    function beneTotals(list){
      const totals = {};
      for(const bn of beneficiaries){
        totals[bn] = {libras:0, dolares:0};
      }
      for(const r of list){
        const obj = getBeneObj(r);
        for(const bn of Object.keys(obj||{})){
          if(!totals[bn]) totals[bn] = {libras:0,dolares:0};
          const it = obj[bn] || {};
          const libras = num(it.libras);
          const tarifa = num(it.tarifa);
          totals[bn].libras += libras;
          totals[bn].dolares += libras*tarifa;
        }
      }
      return totals;
    }


    /***********************
     * 5) Login / Auth
     ***********************/
    $("#loginEmail").value = ALLOWED_EMAIL;

    async function doLogin(){
      $("#loginErr").textContent = "";
      const email = ($("#loginEmail").value||"").trim();
      const pass  = ($("#loginPass").value||"").trim();

      try{
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        const u = cred.user;
        if((u.email||"").toLowerCase() !== ALLOWED_EMAIL.toLowerCase()){
          await signOut(auth);
          $("#loginErr").textContent = "Usuario no autorizado.";
          return;
        }
      }catch(err){
        $("#loginErr").textContent = "Error (" + (err?.code||"") + "): " + (err?.message||String(err));
      }
    }

    $("#btnLogin").addEventListener("click", doLogin);
    $("#loginPass").addEventListener("keydown",(e)=>{ if(e.key==="Enter") doLogin(); });

    $("#btnSignOut").addEventListener("click", ()=>signOut(auth));

    onAuthStateChanged(auth, (user)=>{
      if(user && (user.email||"").toLowerCase() === ALLOWED_EMAIL.toLowerCase()){
        $("#viewLogin").style.display="none";
        $("#viewApp").style.display="block";
        $("#topRight").style.display="flex";
        $("#pillUser").textContent = "Usuario: " + user.email;
        nowTicker(); setInterval(nowTicker, 1000);
        mountTabs();
        switchTab(activeTab);
      }else{
        $("#viewLogin").style.display="flex";
        $("#viewApp").style.display="none";
        $("#topRight").style.display="none";
        if(user) signOut(auth);
      }
    });

    /***********************
     * 6) UI: Tabs + Form + Table
     ***********************/
    function mountTabs(){
      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("on", t.dataset.tab===activeTab);
        t.onclick = ()=>{
          activeTab = t.dataset.tab;
          localStorage.setItem("PAH25_TAB", activeTab);
          document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("on", x.dataset.tab===activeTab));
          switchTab(activeTab);
        };
      });
    }

    
    function buildForm(){
      const sheet = SHEETS[activeTab];
      const area = $("#formArea");
      area.innerHTML="";

      // ---- Compact form for DESC (Beneficiarios dinámicos) ----
      if(activeTab==="DESC"){
        const wrap = document.createElement("div");

        // Fecha
        wrap.appendChild(formRow("Fecha", input("date","f_fecha", sheet.defaultRow().fecha)));
        // Día
        wrap.appendChild(formRow("Día", input("text","f_dia", sheet.defaultRow().dia)));

        // Beneficiary management bar
        const beneRow = document.createElement("div");
        beneRow.className = "row";
        const lab = document.createElement("label");
        lab.textContent = "Beneficiario";
        beneRow.appendChild(lab);

        const right = document.createElement("div");
        right.className = "beneBar";

        const sel = document.createElement("select");
        sel.className = "cell";
        sel.id = "f_benef";
        for(const bn of (beneficiaries.length?beneficiaries:DEFAULT_BENEFICIARIES)){
          const opt = document.createElement("option");
          opt.value = bn;
          opt.textContent = bn;
          sel.appendChild(opt);
        }
        sel.value = activeBeneficiary || sel.value;
        activeBeneficiary = sel.value;

        sel.addEventListener("change", ()=>{
          activeBeneficiary = sel.value;
          fillBeneInputs();
        });

        const btnDel = document.createElement("button");
        btnDel.type="button";
        btnDel.className="miniBtn";
        btnDel.textContent="Eliminar";
        btnDel.title="Eliminar beneficiario seleccionado";
        btnDel.addEventListener("click", async ()=>{
          const bn = normName(sel.value);
          if(!bn) return;
          if(!confirm("¿Eliminar beneficiario: "+bn+" ? (Solo se oculta de la vista; los datos antiguos quedan guardados.)")) return;
          const next = (beneficiaries.length?beneficiaries:[...DEFAULT_BENEFICIARIES]).filter(x=>x!==bn);
          beneficiaries = next;
          activeBeneficiary = beneficiaries[0] || "";
          await setBeneficiaries(beneficiaries);
        });

        const txtNew = document.createElement("input");
        txtNew.className="cell";
        txtNew.placeholder="Agregar beneficiario...";
        txtNew.id="f_benef_new";

        const btnAdd = document.createElement("button");
        btnAdd.type="button";
        btnAdd.className="miniBtn";
        btnAdd.textContent="Agregar";
        btnAdd.addEventListener("click", async ()=>{
          const name = normName(txtNew.value);
          if(!name) return;
          const cur = (beneficiaries.length?beneficiaries:[...DEFAULT_BENEFICIARIES]).slice();
          if(cur.includes(name)){
            alert("Ya existe ese beneficiario.");
            return;
          }
          cur.push(name);
          beneficiaries = cur;
          activeBeneficiary = name;
          txtNew.value="";
          await setBeneficiaries(beneficiaries);
        });

        const line1 = document.createElement("div");
        line1.className = "beneLine";
        line1.appendChild(sel);

        const line2 = document.createElement("div");
        line2.className = "beneLine";

        const btns = document.createElement("div");
        btns.className = "beneBtns";
        btns.appendChild(btnAdd);
        btns.appendChild(btnDel);

        line2.appendChild(txtNew);
        line2.appendChild(btns);

        right.appendChild(line1);
        right.appendChild(line2);
        beneRow.appendChild(right);
        wrap.appendChild(beneRow);

        // Inputs shared (apply to selected beneficiary)
        wrap.appendChild(formRow("CUPO", input("number","f_cupo","")));
        wrap.appendChild(formRow("LIBRAS", input("number","f_libras","")));
        wrap.appendChild(formRow("TARIFA", input("number","f_tarifa","0.08", "0.001")));

        const sub = document.createElement("div");
        sub.className="subhint";
        sub.textContent = "Tip: Selecciona el beneficiario y registra CUPO/LIBRAS/TARIFA. Guardar crea/actualiza el registro por FECHA.";
        wrap.appendChild(sub);

        // Guardar button
        const btn = document.createElement("button");
        btn.className="btn";
        btn.id="btnSave";
        btn.textContent="GUARDAR (Firestore)";
        btn.addEventListener("click", saveFromForm);
        wrap.appendChild(btn);

        area.appendChild(wrap);

        // Auto day + load values on date change
        $("#f_fecha").addEventListener("change", ()=>{
          $("#f_dia").value = diaES(iso($("#f_fecha").value));
          fillBeneInputs();
        });
        $("#f_dia").addEventListener("change", ()=>{ $("#f_dia").value = ($("#f_dia").value||"").toUpperCase(); });

        function fillBeneInputs(){
          const f = iso($("#f_fecha").value);
          const r = getRowByDate(f);
          const obj = getBeneObj(r)||{};
          const bn = activeBeneficiary || $("#f_benef").value;
          const it = obj[bn] || {};
          $("#f_cupo").value = (it.cupo!=null && it.cupo!==0) ? String(it.cupo) : "";
          $("#f_libras").value = (it.libras!=null && it.libras!==0) ? String(it.libras) : "";
          $("#f_tarifa").value = (it.tarifa!=null && it.tarifa!==0) ? String(it.tarifa) : "0.08";
        }
        // initial
        $("#f_dia").value = $("#f_dia").value || diaES(iso($("#f_fecha").value));
        fillBeneInputs();
        return;
      }

      // ---- Original form (other tabs) ----
      for(const col of sheet.columns){
        // Para PRECIO (PAÑALEO / LAVADO), usar texto para permitir coma decimal (0,005) en cualquier PC
        const isPrecio = (col.k === "precio");
        const baseType = (col.k==="dia") ? "text" : (isPrecio ? "text" : "number");
        const el = input(baseType, "f_"+col.k, col.def ?? "");

        if(col.k==="fecha"){ el.type="date"; el.value = sheet.defaultRow().fecha; }
        if(col.k==="dia"){ el.type="text"; el.value = sheet.defaultRow().dia; }

        if(isPrecio){
          el.inputMode = "decimal";
          el.placeholder = "0,005";
          el.value = fmt(num(col.def ?? 0), 3);
          el.addEventListener("blur", ()=>{
            if(el.value==="") return;
            el.value = fmt(num(el.value), 3);
          });
        }else{
          if(col.type==="n3"||col.type==="n2"||col.type==="n6"){
            el.step = col.type==="n6"?"0.000001":(col.type==="n3"?"0.001":"0.01");
          }
        }

        area.appendChild(formRow(col.t, el));
      }
      const btn = document.createElement("button");
      btn.className="btn";
      btn.id="btnSave";
      btn.textContent="GUARDAR (Firestore)";
      btn.addEventListener("click", saveFromForm);
      area.appendChild(btn);
    }

function formRow(labelText, inputEl){
      const wrap = document.createElement("div");
      wrap.className="row";
      const lab = document.createElement("label");
      lab.textContent = labelText;
      wrap.appendChild(lab);
      wrap.appendChild(inputEl);
      return wrap;
    }

    function input(type,id,value,onchange,step){
      const el = document.createElement("input");
      el.className="cell";
      el.type=type;
      el.id=id;
      el.value = (value ?? "");
      if(step) el.step=step;
      if(onchange) el.addEventListener("change", e=>onchange(e.target.value));
      return el;
    }

        function visibleCols(sheet){
      // En AVANCE DESCABEZADO, la tabla debe verse como el Excel (sin TARIFAS en columnas)
      if(activeTab==="DESC"){
        return sheet.columns.filter(c=>!String(c.k).toLowerCase().includes("rate"));
      }
      return sheet.columns;
    }

    
    function buildTableHeader(listForTotals=null){
      const sheet = SHEETS[activeTab];
      const thead = $("#thead");
      thead.innerHTML="";

      if(activeTab==="DESC"){
        const list = listForTotals || applyFilters(rows);
        const totals = beneTotals(list);

        // Row 1: Groups
        const tr1=document.createElement("tr");
        const thDia=document.createElement("th"); thDia.rowSpan=2; thDia.textContent="DÍA"; tr1.appendChild(thDia);
        const thFecha=document.createElement("th"); thFecha.rowSpan=2; thFecha.textContent="FECHA"; tr1.appendChild(thFecha);

        for(const bn of beneficiaries){
          const th=document.createElement("th");
          th.colSpan=3;
          const key = safeKey(bn);
          // class per known names
          if(key.includes("mareprex")) th.className="b-mare";
          else if(key.includes("viktosan")) th.className="b-vik";
          else if(key.includes("felesmar")) th.className="b-fel";
          else th.className="b-planta";

          const t = totals[bn] || {libras:0,dolares:0};
          th.innerHTML = `
            <div style="font-weight:900">${bn}</div>
            <div style="font-size:11px;opacity:.9">LIBRAS: <b>${fmt(t.libras,2)}</b> &nbsp; $: <b>${fmt(t.dolares,2)}</b></div>
          `;
          tr1.appendChild(th);
        }

        const thM=document.createElement("th"); thM.rowSpan=2; thM.textContent="Modificar"; tr1.appendChild(thM);
        const thQ=document.createElement("th"); thQ.rowSpan=2; thQ.textContent="Quitar"; tr1.appendChild(thQ);

        // Row 2: sub columns
        const tr2=document.createElement("tr");
        for(const bn of beneficiaries){
          const key = safeKey(bn);
          const mk = (txt)=>{
            const th=document.createElement("th");
            if(key.includes("mareprex")) th.className="b-mare";
            else if(key.includes("viktosan")) th.className="b-vik";
            else if(key.includes("felesmar")) th.className="b-fel";
            else th.className="b-planta";
            th.textContent=txt;
            return th;
          };
          tr2.appendChild(mk("CUPO"));
          tr2.appendChild(mk("LIBRAS"));
          tr2.appendChild(mk("$"));
        }

        thead.appendChild(tr1);
        thead.appendChild(tr2);
        return;
      }

      // Original header for other tabs
      const tr=document.createElement("tr");
      for(const col of visibleCols(sheet)){
        const th=document.createElement("th"); th.textContent=col.t; tr.appendChild(th);
      }
      const thM=document.createElement("th"); thM.textContent="Modificar"; tr.appendChild(thM);
      const thQ=document.createElement("th"); thQ.textContent="Quitar"; tr.appendChild(thQ);
      thead.appendChild(tr);
    }

function applyFilters(list){
      if(!filterFrom && !filterTo) return list;
      return list.filter(r=>{
        const f = (r.fecha||"");
        if(filterFrom && f < filterFrom) return false;
        if(filterTo && f > filterTo) return false;
        return true;
      });
    }

    
    function renderStats(){
      const sheet = SHEETS[activeTab];
      const stats = $("#statsArea");
      stats.innerHTML="";

      const list = applyFilters(rows);

      // DESC: 2-column (Libras | Dólares) por beneficiario
      if(activeTab==="DESC"){
        stats.classList.add("statsCols");

        const totals = beneTotals(list);
        let totalL = 0, total$ = 0;
        for(const bn of Object.keys(totals)){
          totalL += totals[bn].libras;
          total$ += totals[bn].dolares;
        }

        const make = (label, value)=>{
          const d=document.createElement("div");
          d.className="stat";
          const b=document.createElement("b"); b.textContent=label;
          const h=document.createElement("div"); h.style.fontSize="18px"; h.style.fontWeight="900"; h.textContent=value;
          d.appendChild(b); d.appendChild(h);
          return d;
        };

        const colL=document.createElement("div"); colL.className="statCol";
        const colD=document.createElement("div"); colD.className="statCol";

        colL.appendChild(make("TOTAL LIBRAS", fmt(totalL,2)));
        colD.appendChild(make("TOTAL DÓLARES", fmt(total$,2)));

        for(const bn of beneficiaries){
          const t = totals[bn] || {libras:0,dolares:0};
          colL.appendChild(make(bn+" — LIBRAS", fmt(t.libras,2)));
          colD.appendChild(make(bn+" — $", fmt(t.dolares,2)));
        }

        stats.appendChild(colL);
        stats.appendChild(colD);

        $("#hintArea").textContent = "AVANCE DESCABEZADO — Totales según el filtro de fecha.";
        return;
      }

      // Other tabs
      stats.classList.remove("statsCols");
      const tot = sheet.stats ? sheet.stats(list) : [];
      for(const s of tot){
        const d=document.createElement("div");
        d.className="stat";
        const b=document.createElement("b"); b.textContent=s.label;
        const h=document.createElement("div");
        h.style.fontSize="18px"; h.style.fontWeight="900";
        h.textContent = (s.value ?? "");
        d.appendChild(b); d.appendChild(h);
        stats.appendChild(d);
      }
      $("#hintArea").textContent = (sheet.title || "") + " — Totales según el filtro de fecha.";
    }


    function renderTable(){
      const sheet = SHEETS[activeTab];
      const body = $("#tbody");
      body.innerHTML="";

      const list = applyFilters(rows);

      // Header
      buildTableHeader(list);

      if(activeTab==="DESC"){
        for(const r of list){
          const tr=document.createElement("tr");
          tr.classList.toggle("row-editing", !!r._editing);

          // Día
          let td=document.createElement("td");
          if(r._editing){
            const inp=document.createElement("input");
            inp.className="cell-in";
            inp.type="text";
            inp.value = r.dia || "";
            inp.addEventListener("change", (e)=>{ r.dia=(e.target.value||"").toUpperCase(); saveRow(r); });
            td.appendChild(inp);
          }else{
            td.textContent = (r.dia||"").toString();
          }
          tr.appendChild(td);

          // Fecha
          td=document.createElement("td");
          if(r._editing){
            const inp=document.createElement("input");
            inp.className="cell-in";
            inp.type="date";
            inp.value = iso(r.fecha);
            inp.addEventListener("change", (e)=>{
              const v=iso(e.target.value);
              if(!v) return;
              // doc id is fecha; to keep simple, we write to same doc id (rename not handled)
              r.fecha=v; r._id=v;
              saveRow(r);
            });
            td.appendChild(inp);
          }else{
            td.textContent = iso(r.fecha);
          }
          tr.appendChild(td);

          const obj = getBeneObj(r) || {};

          for(const bn of beneficiaries){
            const it = obj[bn] || {};
            const mkCell = (field, type, step, valueFmt)=>{
              const td=document.createElement("td");
              if(r._editing){
                const inp=document.createElement("input");
                inp.className="cell-in";
                inp.type="number";
                inp.step=step;
                inp.value = (it[field]!=null && it[field]!==0) ? String(it[field]) : "";
                inp.addEventListener("change", (e)=>{
                  const v=num(e.target.value);
                  r.beneficiarios = getBeneObj(r); // ensure object
                  if(!r.beneficiarios[bn]) r.beneficiarios[bn] = {cupo:0,libras:0,tarifa:0.08};
                  r.beneficiarios[bn][field]=v;
                  // keep dollars derived
                  saveRow(r);
                });
                td.appendChild(inp);
              }else{
                const txt = valueFmt(it[field]||0);
                td.textContent = txt;
              }
              return td;
            };

            tr.appendChild(mkCell("cupo","n0","1",(v)=>fmt(num(v),0)));
            tr.appendChild(mkCell("libras","n2","0.01",(v)=>fmt(num(v),2)));

            // Dollars derived
            const tdDol=document.createElement("td");
            const dol = num(it.libras)*num(it.tarifa);
            tdDol.textContent = fmt(dol,2);
            if(r._editing){
              tdDol.title="Dólares calculados: LIBRAS * TARIFA";
              tdDol.style.opacity="0.9";
            }
            tr.appendChild(tdDol);
          }

          // Modificar
          const tdM=document.createElement("td");
          const chk=document.createElement("input");
          chk.type="checkbox";
          chk.checked=!!r._editing;
          chk.addEventListener("change", ()=>{
            r._editing = chk.checked;
            tr.classList.toggle("row-editing", !!r._editing);
            renderTable();
          });
          tdM.appendChild(chk);
          tr.appendChild(tdM);

          // Quitar
          const tdQ=document.createElement("td");
          const a=document.createElement("span");
          a.className="del";
          a.textContent="Eliminar";
          a.onclick=()=>removeRow(r);
          tdQ.appendChild(a);
          tr.appendChild(tdQ);

          body.appendChild(tr);
        }

        renderStats();
        return;
      }

      // Original render for other tabs
      const cols = visibleCols(sheet);
      for(const r of list){
        const tr=document.createElement("tr");
        tr.classList.toggle("row-editing", !!r._editing);

        for(const col of cols){
          const td=document.createElement("td");
          if(r._editing && !col.calc){
            const inp=document.createElement("input");
            inp.className="cell-in";
            const isPrecio = (col.k === "precio");
            inp.type = (col.k==="dia") ? "text" : (col.k==="fecha" ? "date" : (isPrecio ? "text" : "number"));
            if(isPrecio){ inp.inputMode = "decimal"; }

            if(inp.type==="date") inp.value = iso(r[col.k]);
            else if(isPrecio) inp.value = fmt(num(r[col.k]), 3);
            else inp.value = (r[col.k]??"");
            inp.step = (col.type==="n6") ? "0.000001" : (col.type==="n3" ? "0.001" : (col.type==="n2" ? "0.01" : "1"));
            inp.addEventListener("change",(e)=>{
              if(col.k==="dia"){
                r[col.k] = (e.target.value||"").toUpperCase();
              }else if(col.k==="precio"){
                r[col.k] = num(e.target.value);
                inp.value = fmt(num(r[col.k]), 3);
              }else if(inp.type==="date"){
                r[col.k] = iso(e.target.value);
              }else{
                r[col.k] = num(e.target.value);
              }
              saveRow(r);
            });
            td.appendChild(inp);
          }else{
            const val = col.calc ? col.calc(r) : r[col.k];
            if(col.type==="n6") td.textContent = fmt(val,6);
            else if(col.type==="n3") td.textContent = fmt(val,3);
            else if(col.type==="n2") td.textContent = fmt(val,2);
            else td.textContent = (col.k==="fecha")? iso(val) : (val??"");
          }
          tr.appendChild(td);
        }

        const tdM=document.createElement("td");
        const chk=document.createElement("input");
        chk.type="checkbox";
        chk.checked=!!r._editing;
        chk.addEventListener("change", ()=>{
          r._editing = chk.checked;
          tr.classList.toggle("row-editing", !!r._editing);
          renderTable();
        });
        tdM.appendChild(chk);
        tr.appendChild(tdM);

        const tdQ=document.createElement("td");
        const a=document.createElement("span");
        a.className="del";
        a.textContent="Eliminar";
        a.onclick=()=>removeRow(r);
        tdQ.appendChild(a);
        tr.appendChild(tdQ);

        body.appendChild(tr);
      }

      renderStats();
    }


    async function saveFromForm(){
      const sheet = SHEETS[activeTab];

      // New flow for DESC: selected beneficiary fields in a single row per date
      if(activeTab==="DESC"){
        const fecha = iso($("#f_fecha").value);
        if(!fecha){ alert("Ingrese una FECHA válida."); return; }
        const dia = ($("#f_dia").value||"").trim().toUpperCase() || diaES(fecha);

        const bn = normName($("#f_benef").value);
        if(!bn){ alert("Seleccione un beneficiario."); return; }

        const cupo = num($("#f_cupo").value);
        const libras = num($("#f_libras").value);
        const tarifa = num($("#f_tarifa").value) || 0;

        const existing = getRowByDate(fecha) || {};
        const row = {
          _id: fecha,
          fecha,
          dia,
          beneficiarios: getBeneObj(existing)
        };
        if(!row.beneficiarios[bn]) row.beneficiarios[bn] = {cupo:0,libras:0,tarifa:0.08};
        row.beneficiarios[bn].cupo = cupo;
        row.beneficiarios[bn].libras = libras;
        row.beneficiarios[bn].tarifa = tarifa;

        await saveRow(row);

        // keep date & beneficiary, clear cupo/libras
        $("#f_cupo").value="";
        $("#f_libras").value="";
        return;
      }

      // Original flow (other tabs)
      const row = {};
      row.fecha = iso($("#f_fecha").value);
      row.dia = ($("#f_dia").value||"").trim().toUpperCase();

      for(const col of sheet.columns){
        if(["dia","fecha"].includes(col.k)) continue;
        const el = $("#f_"+col.k);
        if(!el) continue;
        row[col.k] = (col.k==="precio") ? num(el.value) : ((el.type==="text") ? (el.value||"") : num(el.value));
      }

      if(!row.fecha){
        alert("Ingrese una FECHA válida.");
        return;
      }
      row._id = row.fecha;
      await saveRow(row);

      const fresh = sheet.defaultRow();
      $("#f_fecha").value = fresh.fecha;
      $("#f_dia").value = fresh.dia;
    }


    function computedForStorage(sheet, r){
      // DESC uses dynamic beneficiaries object
      if(activeTab==="DESC" || sheet===SHEETS.DESC){
        const obj = getBeneObj(r) || {};
        const out = { beneficiarios: {}, _beneficiariosList: beneficiaries };

        for(const bn of Object.keys(obj)){
          const it = obj[bn] || {};
          const cupo = num(it.cupo);
          const libras = num(it.libras);
          const tarifa = num(it.tarifa) || 0;
          out.beneficiarios[bn] = { cupo, libras, tarifa, dolares: libras*tarifa };
        }

        // Also keep legacy fields for compatibility (optional)
        const legacyMap = {
          "OCEANTREASURE":"planta",
          "MAREPREX":"mareprex",
          "VIKTOSAN":"viktosan",
          "FELESMAR":"felesmar"
        };
        for(const [bn,prefix] of Object.entries(legacyMap)){
          if(out.beneficiarios[bn]){
            out[prefix+"Cupo"] = out.beneficiarios[bn].cupo;
            out[prefix+"Libras"] = out.beneficiarios[bn].libras;
            out[prefix+"Rate"] = out.beneficiarios[bn].tarifa;
            out[prefix+"Dolares"] = out.beneficiarios[bn].dolares;
          }
        }

        // store a total
        let totalD=0,totalL=0;
        for(const bn of Object.keys(out.beneficiarios)){
          totalD += num(out.beneficiarios[bn].dolares);
          totalL += num(out.beneficiarios[bn].libras);
        }
        out.totalLibras = totalL;
        out.totalDolares = totalD;
        return out;
      }

      // Original: apply computed columns
      const out = {};
      for(const c of sheet.columns){
        if(c.calc) out[c.k] = c.calc(r);
        else out[c.k] = r[c.k];
      }
      return out;
    }

async function saveRow(r){
      const sheet = SHEETS[activeTab];
      const id = r._id || r.fecha;
      const ref = doc(collection(db, sheet.coll), String(id));
      const payload = computedForStorage(sheet, r);
      payload.fecha = r.fecha;
      payload.dia = r.dia || diaES(r.fecha);
      payload._updatedAt = Date.now();
      await setDoc(ref, payload, {merge:true});
    }

    async function removeRow(r){
      const sheet = SHEETS[activeTab];
      if(!confirm("¿Eliminar este registro?")) return;
      const id = r._id || r.fecha;
      await deleteDoc(doc(collection(db, sheet.coll), String(id)));
    }

    function listenSheet(){
      const sheet = SHEETS[activeTab];
      if(unsub) unsub();
      const q = query(collection(db, sheet.coll), orderBy("fecha","asc"));
      unsub = onSnapshot(q, (snap)=>{
        rows = snap.docs.map(d=>({ _id:d.id, _editing:false, ...d.data() }));
        renderTable();
      });
    }

    
    function switchTab(tab){
      activeTab = tab;
      buildForm();
      buildTableHeader();
      listenSheet();
      listenConfig();
      renderStats();
    }

// Filters
    $("#fltFrom").addEventListener("change", (e)=>{ filterFrom = iso(e.target.value); renderTable(); });
    $("#fltTo").addEventListener("change", (e)=>{ filterTo = iso(e.target.value); renderTable(); });
    $("#btnClearFilter").addEventListener("click", ()=>{
      filterFrom=""; filterTo="";
      $("#fltFrom").value=""; $("#fltTo").value="";
      renderTable();
    });

    // PDF (tabla actual / filtro actual)
    $("#btnPDF").addEventListener("click", ()=>{
      const list = applyFilters(rows);
      if(!list.length){ alert("No hay registros para imprimir con el filtro actual."); return; }
      const title = (SHEETS[activeTab]?.title || "Reporte");
      const w = window.open("", "_blank");
      const totals = (activeTab==="DESC") ? beneTotals(list) : null;

      const esc = (s)=>String(s).replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
      const styles = `
        <style>
          body{font-family:Arial,Helvetica,sans-serif;margin:24px;color:#111}
          h1{font-size:18px;margin:0 0 6px}
          .meta{font-size:12px;color:#444;margin:0 0 14px}
          table{width:100%;border-collapse:collapse;font-size:11px}
          th,td{border:1px solid #999;padding:6px 6px}
          th{background:#eee}
          .grp{background:#d9d9d9;font-weight:900;text-align:center}
          .right{text-align:right}
          @media print{ @page{size:landscape;margin:10mm} }
        </style>
      `;

      let htmlOut = `<!doctype html><html><head><meta charset="utf-8">${styles}</head><body>`;
      htmlOut += `<h1>${esc(title)} — ${esc(activeTab==="DESC"?"AVANCE DESCABEZADO":title)}</h1>`;
      const from = $("#fltFrom").value || "—";
      const to = $("#fltTo").value || "—";
      htmlOut += `<div class="meta">Filtro FECHA: ${esc(from)} a ${esc(to)} | Generado: ${new Date().toLocaleString()}</div>`;

      if(activeTab==="DESC"){
        // header 2 rows
        htmlOut += `<table><thead><tr>
          <th rowspan="2">DÍA</th><th rowspan="2">FECHA</th>`;
        for(const bn of beneficiaries){
          const t = totals[bn]||{libras:0,dolares:0};
          htmlOut += `<th class="grp" colspan="3">${esc(bn)}<br><span style="font-weight:600">LIBRAS ${fmt(t.libras,2)} | $ ${fmt(t.dolares,2)}</span></th>`;
        }
        htmlOut += `</tr><tr>`;
        for(const bn of beneficiaries){
          htmlOut += `<th>CUPO</th><th>LIBRAS</th><th>$</th>`;
        }
        htmlOut += `</tr></thead><tbody>`;

        for(const r of list){
          const obj = getBeneObj(r)||{};
          htmlOut += `<tr><td>${esc(r.dia||"")}</td><td>${esc(iso(r.fecha))}</td>`;
          for(const bn of beneficiaries){
            const it = obj[bn]||{};
            const cupo = fmt(num(it.cupo),0);
            const lib = fmt(num(it.libras),2);
            const dol = fmt(num(it.libras)*num(it.tarifa),2);
            htmlOut += `<td class="right">${cupo}</td><td class="right">${lib}</td><td class="right">${dol}</td>`;
          }
          htmlOut += `</tr>`;
        }
        htmlOut += `</tbody></table>`;
      } else {
        // simple table for other tabs
        const cols = visibleCols(SHEETS[activeTab]);
        htmlOut += `<table><thead><tr>${cols.map(c=>`<th>${esc(c.t)}</th>`).join("")}</tr></thead><tbody>`;
        for(const r of list){
          htmlOut += "<tr>";
          for(const c of cols){
            const v = c.calc ? c.calc(r) : r[c.k];
            const txt = (c.type==="n2")?fmt(v,2):(c.type==="n3")?fmt(v,3):(c.type==="n6")?fmt(v,6): (c.k==="fecha"?iso(v): (v??""));
            htmlOut += `<td class="${(c.type && c.type.startsWith("n"))?'right':''}">${esc(txt)}</td>`;
          }
          htmlOut += "</tr>";
        }
        htmlOut += `</tbody></table>`;
      }

      htmlOut += `</body></html>`;
      w.document.open(); w.document.write(htmlOut); w.document.close();
      w.focus();
      w.print();
    });

  </script>
</body>
</html>
