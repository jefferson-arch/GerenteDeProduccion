<!doctype html>
<!-- SID - Informe-Firestore-DescabezadoOnly.html -->
<!-- BUILD_SID_INFORME_DESCABEZADO v1.4.0 BTN_WORKFLOW_SIGN_AFTER_SAVE 2026-01-31 -->
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SID | Informe Descabezado</title>

  <link rel="icon" href="favicon.ico?v=1">

  <style>
    :root{
      --navy:#0d2f4f;
      --blue:#1e88e5;
      --grid:#b9c3cf;
      --hdr:#163a63;
      --hdr2:#1b4b7a;
      --white:#fff;
      --text:#111;
      --muted:#666;
      --danger:#b00020;
      --ok:#0b7a2a;
      --cellH:28px;
      --font: "Times New Roman", Times, serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:var(--text);font-family:var(--font)}
    .wrap{max-width:1180px;margin:0 auto;padding:10px 12px 18px}

    .view{display:none}
    .view.active{display:block}

    .topline{font-family:Arial,Helvetica,sans-serif;font-size:13px;padding:6px 0 10px;border-bottom:1px solid #ddd}
    .topline .email{color:var(--blue);text-decoration:underline}

    /* Banner conexión */
    #netBanner{display:none; position:sticky; top:0; z-index:9999; padding:10px 12px; font-family:Arial,Helvetica,sans-serif; font-weight:800; font-size:13px;}
    #netBanner.offline{background:#ffe5e5;color:#8a0016;border-bottom:1px solid #ffb3b3}
    #netBanner.online{background:#e8fff0;color:#0b5a2a;border-bottom:1px solid #b8f0c9}
    #netBanner .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle;}
    #netBanner.offline .dot{background:#d4001a}
    #netBanner.online .dot{background:#00a63a}

    /* Login */
    .loginBox{max-width:420px;margin:18px auto 0;border:1px solid #ddd;padding:14px}
    .loginTitle{font-family:Arial,Helvetica,sans-serif;text-align:center;color:var(--blue);font-weight:900;margin:0 0 10px}
    .row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center;margin:10px 0}
    label{font-family:Arial,Helvetica,sans-serif;font-size:14px}
    input[type="text"],input[type="password"],select,input[type="date"]{
      width:100%;padding:8px 10px;border:1px solid #ccc;background:#eee;outline:none;font-size:14px;min-height:38px;font-family:Arial,Helvetica,sans-serif;
    }
    select{background:#fff}
    .btn{
      display:inline-block;padding:8px 12px;border:1px solid #444;background:#efefef;cursor:pointer;
      font-family:Arial,Helvetica,sans-serif;font-weight:800;text-align:center;user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{background:#cfefff;color:#0b5aa5;border-color:#2a2a2a}
    .btn.danger{border-color:var(--danger);color:var(--danger)}
    .btn.disabled{opacity:.55;pointer-events:none;filter:grayscale(40%);}

    .pickBox{max-width:520px;margin:14px auto 0;border:1px solid #ddd;padding:14px}
    .brandCenter{text-align:center;margin:8px 0 12px}
    .logo{width:96px;height:96px;object-fit:contain;display:block;margin:0 auto}
    .brand{font-family:Arial,Helvetica,sans-serif;font-weight:900;margin:6px 0 0}
    .tagline{font-family:Arial,Helvetica,sans-serif;font-size:11px;letter-spacing:1px;margin:2px 0 0}

    /* Chips multi-cuadrilla */
    .chipWrap{margin-top:6px;display:flex;flex-wrap:wrap;gap:6px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid #999;background:#f7f7f7;
      padding:6px 10px;font-family:Arial,Helvetica,sans-serif;font-size:12px;font-weight:900;
      cursor:pointer; user-select:none;
    }
    .chip .x{
      display:inline-block;
      width:16px;height:16px;line-height:14px;
      border:1px solid #777;border-radius:3px;
      text-align:center;font-weight:900;
      background:#fff;
    }
    .chip:hover{background:#eee}
    .hint{margin-top:8px;line-height:1.35}

    .sheet{margin:10px auto 0;border:1px solid #ddd;padding:10px;background:#fff;}

    .topGrid{
      display:grid;
      grid-template-columns: 240px 1fr 120px 360px;
      gap:10px;
      align-items:start;
    }

    .logoBox{
      display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:flex-start;
      padding:4px 6px;
    }
    .logoBox .logoSmall{width:120px;height:70px;object-fit:contain;display:block}
    .logoBox .txt1{font-family:Arial,Helvetica,sans-serif;font-size:12px;font-weight:900;margin:0}
    .logoBox .txt2{font-family:Arial,Helvetica,sans-serif;font-size:10px;letter-spacing:1px;margin:0}

    .firmaBox{
      padding:4px 6px;
      min-height:90px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }
    .firmaImg{
      width:100%;
      max-width:520px;
      height:auto;
      display:none;
    }
    .firmaPlaceholder{
      width:100%;
      border:1px dashed #bbb;
      padding:10px;
      text-align:center;
      color:#666;
      font-family:Arial,Helvetica,sans-serif;
      font-size:12px;
    }

    .btnCol{display:flex;flex-direction:column;gap:10px;align-items:stretch}
    .btnCol .btn{width:100%;background:#efefef}

    .panel{border:1px solid #333;font-family:var(--font);}
    .panel table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:16px;}
    .panel td{border:1px solid #333;padding:4px 6px;height:var(--cellH);vertical-align:middle;}
    .panel .k{background:var(--hdr);color:#fff;font-weight:900}
    .panel .k2{background:#7d7d7d;color:#fff;font-weight:900}
    .panel .v{background:#fff;text-align:right;font-weight:900}
    .panel .vBlue{background:var(--hdr);color:#fff;text-align:right;font-weight:900}
    .panel .vRed{color:#d4001a;font-weight:900;text-align:right}
    .panel .small{font-size:14px}

    .metaRow{
      display:flex;justify-content:space-between;align-items:center;
      margin-top:6px;font-family:var(--font);font-size:18px;font-weight:900;
    }
    .metaRow .left{display:flex;gap:10px;align-items:center;}
    .metaRow .inf{font-weight:900}
    .metaRow .infNum{font-weight:900;letter-spacing:1px}
    .metaRow .right{
      font-family:Arial,Helvetica,sans-serif;
      font-size:13px;color:#333;display:flex;gap:10px;align-items:center;
    }

    .tblWrap{margin-top:10px;overflow:auto;border:1px solid #999}
    table.report{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      min-width:1120px;
      font-size:16px;
      font-family:var(--font);
    }
    table.report th, table.report td{
      border:1px solid #333;
      padding:3px 6px;
      height:var(--cellH);
      vertical-align:middle;
    }
    table.report thead th{
      background:var(--hdr);
      color:#fff;
      font-weight:900;
      text-align:center;
    }
    table.report thead .subHdr{
      background:var(--hdr2);
      color:#fff;
      font-weight:900;
    }

    .colNo{width:48px;text-align:center;font-weight:900}
    .colNomina{width:240px;text-align:left;font-weight:900}
    .colCuadrilla{width:160px;text-align:center;font-weight:900}
    .num{text-align:right;font-weight:900}
    .descuentoNeg{color:#d4001a;font-weight:900}
    .muted{color:#666;font-family:Arial,Helvetica,sans-serif;font-size:12px}
    .subRow td{background:#f2f2f2;font-weight:900;}

    @media (max-width:980px){
      .topGrid{grid-template-columns: 200px 1fr 120px 320px;}
      table.report{min-width:1200px}
    }
    @media (max-width:720px){
      .topGrid{grid-template-columns: 1fr; }
      .btnCol{flex-direction:row}
      .btnCol .btn{width:auto;flex:1}
      .panel{margin-top:6px}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- LOGIN -->
    <section id="vLogin" class="view active">
      <div class="loginBox">
        <div class="loginTitle">SID | INFORME DESCABEZADO</div>
        <div class="brandCenter">
          <img class="logo" src="logo.png" alt="Oceantreasure" onerror="this.style.display='none'">
          <p class="brand">OCEANTREASURE S.A.</p>
          <p class="tagline">100% ECUADORIAN QUALITY</p>
        </div>

        <div class="row">
          <label>Usuario:</label>
          <input id="loginEmail" type="text" autocomplete="username" />
        </div>
        <div class="row">
          <label>Contraseña:</label>
          <input id="loginPass" type="password" autocomplete="current-password" />
        </div>

        <div class="btn primary" id="btnLogin">ACCEDER</div>
        <div id="loginMsg" style="min-height:18px;margin-top:8px;color:#b00020;font-family:Arial,Helvetica,sans-serif;font-size:13px;"></div>
        <div id="bootMsg" style="min-height:18px;color:#555;font-family:Arial,Helvetica,sans-serif;font-size:12px;"></div>
      </div>
    </section>

    <!-- HEADER -->
    <div id="authHeader" style="display:none;">
      <div class="topline">
        Usuario: <span class="email" id="userEmail"></span>
        &nbsp; | &nbsp; <span class="muted" id="userNameLabel"></span>
      </div>
    </div>

    <!-- NET BANNER -->
    <div id="netBanner"><span class="dot"></span><span id="netText"></span></div>

    <!-- SELECCIÓN CUADRILLA -->
    <section id="vPick" class="view">
      <div class="pickBox">
        <div class="brandCenter">
          <img class="logo" src="logo.png" alt="Oceantreasure" onerror="this.style.display='none'">
          <p class="brand">OCEANTREASURE S.A.</p>
          <p class="tagline">100% ECUADORIAN QUALITY</p>
        </div>

        <!-- Cuadrilla + -->
        <div class="row" style="grid-template-columns:120px 1fr 44px;">
          <label>Cuadrilla</label>
          <select id="selCuadrilla">
            <option value=""></option>
            <option>OCEANTREASURE</option>
            <option>MAREPREX</option>
            <option>FELESMAR</option>
          </select>
          <div class="btn" id="btnAddCuadrilla" title="Agregar cuadrilla">+</div>
        </div>

        <!-- Chips -->
        <div id="cuadrillaChips" class="chipWrap"></div>
        <div class="muted hint" id="cuadrillaHint">
          Nota: Selecciona una cuadrilla y presiona <b>+</b> para agregarla al informe (máx. 10).
          Si no agregas ninguna, se usará solo la cuadrilla del selector.
          <br>Tip: Haz clic en una etiqueta para quitarla.
        </div>

        <div class="row" style="grid-template-columns:120px 1fr;">
          <label>Fecha</label>
          <input id="selFecha" type="date" />
        </div>

        <div class="row" style="grid-template-columns:120px 1fr;">
          <label>Circuito</label>
          <select id="selCircuito">
            <option value="1" selected>Circuito 1</option>
            <option value="2">Circuito 2</option>
          </select>
        </div>

        <!-- BUSCAR INFORME (pantalla Pick) -->
        <div style="margin-top:12px;border-top:1px dashed #cfcfcf;padding-top:10px;">
          <div style="font-family:Arial,Helvetica,sans-serif;font-weight:900;color:#333;margin-bottom:8px;">
            BUSCAR INFORME
          </div>

          <div class="row" style="grid-template-columns:120px 1fr;">
            <label>N° Informe</label>
            <input id="findNumero" type="text" inputmode="numeric" />
          </div>

          <div class="row" style="grid-template-columns:120px 1fr;">
            <label>Fecha</label>
            <input id="findFecha" type="date" />
          </div>

          <div class="row" style="grid-template-columns:120px 1fr;">
            <label>Circuito</label>
            <select id="findCircuito">
              <option value="1" selected>Circuito 1</option>
              <option value="2">Circuito 2</option>
            </select>
          </div>

          <div class="btn" id="btnBuscarPick">BUSCAR</div>

          <div class="muted" style="margin-top:8px;line-height:1.35;">
            Tip: Si llenas <b>N° Informe</b>, se busca por número. Si lo dejas vacío, se busca por <b>Fecha + Circuito</b>.
          </div>
        </div>

        <div class="btn primary" id="btnCrear" style="margin-top:12px;">CREAR INFORME</div>
        <div class="btn" id="btnLogoutPick" style="margin-top:10px;">CERRAR SESIÓN</div>

        <div class="muted" style="margin-top:10px;line-height:1.35;">
          Nota: El informe carga automáticamente las pesadas del día seleccionado desde SDA (Firestore).
        </div>
      </div>
    </section>

    <!-- REPORTE -->
    <section id="vReport" class="view">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px;font-family:Arial,Helvetica,sans-serif;">
        <div style="display:flex;gap:12px;align-items:center;">
          <span class="btn" id="btnBackPick">VOLVER</span>
          <span class="btn" id="btnLogoutReport">CERRAR SESIÓN</span>
        </div>
        <div class="muted" id="reportStatus">—</div>
      </div>

      <!-- Área imprimible -->
      <div id="reportSheet" class="sheet">
        <div class="topGrid">

          <!-- Logo -->
          <div class="logoBox">
            <img class="logoSmall" src="logo.png" alt="Oceantreasure" onerror="this.style.display='none'">
            <p class="txt1">OCEANTREASURE S.A.</p>
            <p class="txt2">100% ECUADORIAN QUALITY</p>
          </div>

          <!-- Firma -->
          <div class="firmaBox">
            <div id="firmaPlaceholder" class="firmaPlaceholder">
              FIRMA ELECTRÓNICA<br>
              (Presione <b>FIRMAR</b>)
            </div>
            <img id="firmaImg" class="firmaImg" alt="Firma electrónica" />
          </div>

          <!-- Botones -->
          <div class="btnCol">
            <div class="btn" id="btnFirmar">FIRMAR</div>
            <div class="btn" id="btnGuardar">GUARDAR</div>
            <div class="btn" id="btnPdf">PDF</div>
            <div class="btn" id="btnXls">EXCEL</div>
            <div class="btn" id="btnBuscar">BUSCAR</div>
          </div>

          <!-- Panel derecho -->
          <div class="panel">
            <table>
              <tr>
                <td class="k">Peso Cola:</td>
                <td class="v">
                  <input id="pesoCola" type="text"
                    style="width:100%;border:none;outline:none;text-align:right;font-weight:900;font-family:var(--font);font-size:16px;background:#fff" value="">
                </td>
              </tr>
              <tr><td class="k">Elevado a Entero:</td><td class="vBlue" id="elevadoEntero">0,000</td></tr>
              <tr><td class="k">Cabeza posible:</td><td class="vBlue" id="cabezaPosible">0,000</td></tr>
              <tr><td class="k">Pesada de Cabezas:</td><td class="vBlue" id="pesadaCabezas">0,000</td></tr>
              <tr><td class="k2">Descuento</td><td class="v" id="descuentoTotal">0</td></tr>
              <tr><td class="k2">N° personas:</td><td class="v" id="numPersonas">0</td></tr>
              <tr><td class="k2">Descuento individual:</td><td class="v" id="descuentoIndividual">0</td></tr>
              <tr><td class="k small">Informe:</td><td class="vBlue" id="infoCircuito">Circuito 1</td></tr>
              <tr><td class="k small">Responsable:</td><td class="vBlue" id="infoResponsable">—</td></tr>
            </table>
          </div>
        </div>

        <div class="metaRow">
          <div class="left">
            <span class="inf">Informe N°:</span>
            <span class="infNum" id="infoNumero">—</span>
          </div>
          <div class="right">
            <span><b>Cuadrilla:</b> <span id="metaCuadrilla">—</span></span>
            <span><b>Fecha:</b> <span id="metaFecha">—</span></span>
          </div>
        </div>

        <div class="tblWrap">
          <table class="report" id="tblReport">
            <thead id="theadReport"></thead>
            <tbody id="tbodyReport"></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <!-- JS libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, EmailAuthProvider, reauthenticateWithCredential }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs, doc, setDoc, getDoc, updateDoc,
      runTransaction, serverTimestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMoLkSnnLowMagRNL7O6ttPo1FXd1URac",
      authDomain: "oceantreasure-app.firebaseapp.com",
      projectId: "oceantreasure-app",
      storageBucket: "oceantreasure-app.firebasestorage.app",
      messagingSenderId: "553014659258",
      appId: "1:553014659258:web:cfc30844a88433b7b79a83",
      measurementId: "G-HMMQKJY8NJ"
    };

    // Helpers
    const $ = (id)=>document.getElementById(id);
    const safe = (id)=>document.getElementById(id) || null;

    function uiError(msg){
      const el = safe("loginMsg") || safe("bootMsg");
      if(el) el.textContent = msg;
    }
    window.addEventListener("error", (e)=>{
      uiError("Error de la página. Abre F12 > Console para ver el detalle.");
      console.error("JS Error:", e.error || e.message, e);
    });
    window.addEventListener("unhandledrejection", (e)=>{
      uiError("Error inesperado. Abre F12 > Console para ver el detalle.");
      console.error("Promise rejection:", e.reason, e);
    });

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const COL_SDA = "sda_avance_cabezas";
    const COL_SID = "sid_informe_descabezado";
    const COL_SID_COUNTER = "sid_informe_counters";

    const ALLOWED = new Set([
      "aracellytomala@oceantreasure.local",
      "keniacruz@oceantreasure.local",
      "gingervaldiviezo@oceantreasure.local",
      "pesadoradesalojo@oceantreasure.local",
      "vanesapacheco@oceantreasure.local",
      "jeffersonfigueroa@oceantreasure.local"
    ]);

    // ✅ Supervisores (regla de botones)
    const SUPERVISORS = new Set([
      "gingervaldiviezo@oceantreasure.local",
      "aracellytomala@oceantreasure.local"
    ]);

    const PESO_COLA_ALLOWED = new Set([
      "gingervaldiviezo@oceantreasure.local",
      "aracellytomala@oceantreasure.local",
      "jeffersonfigueroa@oceantreasure.local"
    ]);

    const SIGN_ADMIN = "jeffersonfigueroa@oceantreasure.local";

    /**
     * FIRMA:
     * Coloca "firma.png" en la misma carpeta del HTML (en tu repo).
     */
    const SIGNATURE_DATA_URI = "";
    const SIGNATURE_FALLBACK_URL = "firma.png";

    function todayKey(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function nowStamp(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    }
    function fmt3(n){
      const x = Number(n)||0;
      return x.toLocaleString("es-EC",{minimumFractionDigits:3,maximumFractionDigits:3});
    }
    function fmt0(n){
      const x = Number(n)||0;
      return x.toLocaleString("es-EC",{minimumFractionDigits:0,maximumFractionDigits:0});
    }
    function parseEsNumber(s){
      const raw = String(s||"").trim();
      if(!raw) return NaN;
      const norm = raw.replaceAll(".","").replaceAll(","," .").replace(" .",".").replaceAll(" ","");
      const v = Number(norm);
      return Number.isFinite(v) ? v : NaN;
    }
    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    const views = { login:$("vLogin"), pick:$("vPick"), report:$("vReport") };
    function showView(name){
      Object.values(views).forEach(v=>v.classList.remove("active"));
      views[name].classList.add("active");
    }

    let currentUserEmail = "";
    let currentUserName = "";

    // MULTI CUADRILLAS
    let selectedCuadrillas = [];
    let currentCuadrillas = [];

    let currentFecha = "";
    let currentCircuito = "1";

    // ✅ Estados del flujo
    let reportSaved = false;      // ya tiene N° y doc creado
    let reportSigned = false;     // firmado en Firestore
    let reportNumber = "";
    let reportDocId = "";

    let signedBy = "";
    let signedAt = "";

    let pesadasCols = [];
    let rows = [];
    let subtotalPorPesada = new Map();
    let subtotal2Total = 0;

    let pesoCola = 0;
    let elevadoEntero = 0;
    let cabezaPosible = 0;
    let pesadaCabezas = 0;
    let descuentoTotal = 0;
    let numPersonas = 0;
    let descuentoIndividual = 0;

    // ✅ Listener en vivo del informe (para habilitar PDF/EXCEL a todos)
    let unsubReport = null;

    // ✅ Internet detector
    let hasInternet = true;
    let lastInternetState = null;

    function isAdmin(){ return currentUserEmail === SIGN_ADMIN; }
    function isSupervisor(){ return SUPERVISORS.has(currentUserEmail); }

    function setBtnEnabled(id, enabled){
      const el = safe(id);
      if(!el) return;
      el.classList.toggle("disabled", !enabled);
    }

    function updateButtons(){
      // BUSCAR siempre visible (aunque su handler valida internet)
      setBtnEnabled("btnBuscar", true);

      // GUARDAR: solo si NO se ha guardado aún y hay internet
      setBtnEnabled("btnGuardar", !reportSaved && hasInternet);

      // FIRMAR: solo ADMIN, solo si está guardado y NO firmado, y con internet
      setBtnEnabled("btnFirmar", reportSaved && !reportSigned && isAdmin() && hasInternet);

      // PDF/EXCEL: solo cuando ya está firmado (para todos)
      setBtnEnabled("btnPdf", reportSigned);
      setBtnEnabled("btnXls", reportSigned);

      // Si es supervisor y está creando, debe ver PDF/EXCEL/FIRMAR deshabilitados (ya lo cubre arriba)
    }

    function applyPesoColaPermission(){
      const can = PESO_COLA_ALLOWED.has(currentUserEmail);
      const inp = $("pesoCola");
      // solo editable antes de guardar y si tiene permiso
      inp.readOnly = !can || reportSaved || reportSigned;
      inp.style.background = (inp.readOnly ? "#f3f3f3" : "#fff");
      inp.title = inp.readOnly ? "Bloqueado (solo antes de guardar y con permiso)" : "Ingrese Peso Cola";
    }

    function setSignatureImg(){
      const img = $("firmaImg");
      const ph  = $("firmaPlaceholder");
      if(!img || !ph) return;

      const src = (SIGNATURE_DATA_URI && SIGNATURE_DATA_URI.startsWith("data:image/"))
        ? SIGNATURE_DATA_URI
        : SIGNATURE_FALLBACK_URL;

      img.onerror = ()=>{
        img.style.display = "none";
        ph.style.display  = "block";
      };
      img.src = src;
    }

    function applySignatureUI(){
      if(reportSigned){
        setSignatureImg();
        $("firmaImg").style.display = "block";
        $("firmaPlaceholder").style.display = "none";
      }else{
        $("firmaImg").style.display = "none";
        $("firmaPlaceholder").style.display = "block";
      }
    }

    function watchReportDoc(docId){
      if(!docId) return;
      if(unsubReport){ try{unsubReport();}catch(_){}
        unsubReport = null;
      }
      const ref = doc(db, COL_SID, docId);
      unsubReport = onSnapshot(ref, (snap)=>{
        if(!snap.exists()) return;
        const data = snap.data() || {};
        reportSigned = !!data.signed;
        signedBy = data.signedBy || "";
        signedAt = data.signedAt || "";

        // si ya firmó, muestro firma y habilito PDF/EXCEL para todos
        applySignatureUI();

        // status
        if(reportSaved && !reportSigned){
          $("reportStatus").textContent = "Guardado. Pendiente de firma (Jefferson).";
        }
        if(reportSigned){
          $("reportStatus").textContent = "Firmado. PDF/EXCEL habilitados.";
        }

        updateButtons();
      });
    }

    function showNetBanner(state, msg){
      const b = $("netBanner");
      const t = $("netText");
      if(!b || !t) return;
      b.style.display = "block";
      b.classList.toggle("offline", state==="offline");
      b.classList.toggle("online", state==="online");
      t.textContent = msg;
    }
    function hideNetBanner(){
      const b = $("netBanner");
      if(b) b.style.display = "none";
    }
    async function pingInternet(){
      const url = `https://www.gstatic.com/generate_204?ts=${Date.now()}`;
      try{
        const controller = new AbortController();
        const to = setTimeout(()=>controller.abort(), 3500);
        await fetch(url, {method:"GET", mode:"no-cors", signal: controller.signal});
        clearTimeout(to);
        return true;
      }catch(_){
        return false;
      }
    }
    async function refreshInternetStatus(){
      const netUp = navigator.onLine;
      if(!netUp) hasInternet = false;
      else hasInternet = await pingInternet();

      if(lastInternetState === hasInternet) return;
      lastInternetState = hasInternet;

      if(!hasInternet){
        showNetBanner("offline","SIN CONEXIÓN A INTERNET. No se puede GUARDAR/FIRMAR. Conéctate a datos/Wi-Fi y espera…");
      }else{
        showNetBanner("online","CONEXIÓN RESTABLECIDA.");
        setTimeout(()=>hideNetBanner(), 1800);
      }
      updateButtons();
    }
    window.addEventListener("offline", ()=>refreshInternetStatus());
    window.addEventListener("online",  ()=>refreshInternetStatus());
    setInterval(()=>refreshInternetStatus(), 8000);

    // Render chips
    function renderCuadrillaChips(){
      const wrap = $("cuadrillaChips");
      if(!wrap) return;
      wrap.innerHTML = "";
      selectedCuadrillas.forEach((c)=>{
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.innerHTML = `<span>${esc(c)}</span><span class="x">×</span>`;
        chip.title = "Quitar";
        chip.onclick = ()=>{
          selectedCuadrillas = selectedCuadrillas.filter(x=>x!==c);
          renderCuadrillaChips();
        };
        wrap.appendChild(chip);
      });
    }

    // Botón +
    $("btnAddCuadrilla").onclick = ()=>{
      const val = ($("selCuadrilla").value || "").trim();
      if(!val){ alert("Seleccione una CUADRILLA para agregar."); return; }
      if(selectedCuadrillas.length >= 10){
        alert("Máximo 10 cuadrillas por informe (límite Firestore 'in').");
        return;
      }
      if(selectedCuadrillas.includes(val)){
        alert("Esa cuadrilla ya fue agregada.");
        return;
      }
      selectedCuadrillas.push(val);
      renderCuadrillaChips();
    };

    // Login
    const boot = $("bootMsg");
    if(boot) boot.textContent = "Cargando Firebase…";

    $("btnLogin").onclick = async ()=>{
      $("loginMsg").textContent = "";
      try{
        const email = $("loginEmail").value.trim();
        const pass  = $("loginPass").value;
        if(!email || !pass){
          $("loginMsg").textContent = "Ingrese usuario y contraseña.";
          return;
        }
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(e){
        const code = (e && e.code) ? ` (${e.code})` : "";
        $("loginMsg").textContent = "Error: usuario o contraseña incorrectos." + code;
        console.error(e);
      }
    };
    ["loginEmail","loginPass"].forEach(id=>{
      $(id).addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("btnLogin").click(); });
    });

    async function doLogout(){ await signOut(auth); }
    $("btnLogoutPick").onclick = doLogout;
    $("btnLogoutReport").onclick = doLogout;

    function resetAll(){
      if(unsubReport){ try{unsubReport();}catch(_){}
        unsubReport = null;
      }

      selectedCuadrillas = [];
      currentCuadrillas = [];
      renderCuadrillaChips();

      reportSaved = false;
      reportSigned = false;
      reportNumber = "";
      reportDocId = "";
      signedBy = "";
      signedAt = "";

      currentFecha = "";
      currentCircuito = "1";

      rows=[]; pesadasCols=[]; subtotalPorPesada=new Map(); subtotal2Total=0;
      pesoCola=0;

      $("reportStatus").textContent = "—";
      $("infoNumero").textContent = "—";
      $("pesoCola").value = "";

      applySignatureUI();
      applyPesoColaPermission();
      updateButtons();
    }

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUserEmail = (user.email||"").toLowerCase();
        if(!ALLOWED.has(currentUserEmail)){
          alert("Acceso no autorizado.");
          await doLogout();
          return;
        }

        $("authHeader").style.display = "block";
        $("userEmail").textContent = currentUserEmail;

        currentUserName = (user.displayName || currentUserEmail.split("@")[0] || "").replaceAll("."," ");
        $("userNameLabel").textContent = `(${currentUserName})`;

        $("selFecha").value = todayKey();
        $("findFecha").value = todayKey();

        // no reseteo todo si ya estás viendo un informe
        if(!reportDocId){
          selectedCuadrillas = [];
          renderCuadrillaChips();
        }

        showView("pick");
        await refreshInternetStatus();
        updateButtons();

        if(boot) boot.textContent = "";
      }else{
        currentUserEmail = "";
        $("authHeader").style.display = "none";
        hideNetBanner();
        resetAll();
        showView("login");
        if(boot) boot.textContent = "";
      }
    });

    $("btnCrear").onclick = async ()=>{
      const cSingle = ($("selCuadrilla").value || "").trim();
      const effective = (selectedCuadrillas.length > 0)
        ? [...selectedCuadrillas]
        : (cSingle ? [cSingle] : []);

      if(effective.length === 0){
        alert("Seleccione la CUADRILLA (y/o agréguela con +).");
        return;
      }

      currentCuadrillas = effective;
      currentFecha = $("selFecha").value || todayKey();
      currentCircuito = $("selCircuito").value || "1";

      const labelCuadrilla = (effective.length === 1)
        ? effective[0]
        : effective.join(" + ");

      $("metaCuadrilla").textContent = labelCuadrilla;
      $("metaFecha").textContent = currentFecha;
      $("infoCircuito").textContent = `Circuito ${currentCircuito}`;
      $("infoResponsable").textContent = currentUserName || currentUserEmail;

      // ✅ Nuevo informe (no guardado / no firmado)
      reportSaved = false;
      reportSigned = false;
      reportNumber = "";
      reportDocId = "";
      $("infoNumero").textContent = "—";
      applySignatureUI();

      // detener listener si existía otro doc
      if(unsubReport){ try{unsubReport();}catch(_){}
        unsubReport = null;
      }

      showView("report");
      $("reportStatus").textContent = "Cargando pesadas del día…";

      try{
        await loadFromSDA(currentCuadrillas, currentFecha);
        $("reportStatus").textContent = "Listo. Verifica y, si aplica, ingresa Peso Cola.";
      }catch(err){
        console.error(err);
        $("reportStatus").textContent = "No se pudo cargar SDA. Revisa conexión/permisos/índices.";
        alert("No se pudo cargar la información de SDA. Revisa conexión/permisos o índices en Firestore.");
      }

      applyPesoColaPermission();
      updateButtons();
    };

    $("btnBackPick").onclick = ()=>{ showView("pick"); };

    async function loadFromSDA(cuadrillasArr, fechaKey){
      rows = [];
      pesadasCols = [];
      subtotalPorPesada = new Map();
      subtotal2Total = 0;

      const cuadrillas = (Array.isArray(cuadrillasArr) ? cuadrillasArr : [])
        .map(x=>String(x||"").trim()).filter(Boolean);

      let q;
      if(cuadrillas.length === 1){
        q = query(
          collection(db, COL_SDA),
          where("cuadrilla","==", cuadrillas[0]),
          where("fecha","==", fechaKey)
        );
      }else{
        if(cuadrillas.length > 10){
          throw new Error("Demasiadas cuadrillas (máx. 10 para where-in).");
        }
        q = query(
          collection(db, COL_SDA),
          where("cuadrilla","in", cuadrillas),
          where("fecha","==", fechaKey)
        );
      }

      const snap = await getDocs(q);

      const docs = [];
      snap.forEach(d=>{
        const x = d.data()||{};
        const lbs = (typeof x.libras === "number") ? x.libras : Number(x.libras||0);
        if(!(Number.isFinite(lbs) && lbs > 0)) return;

        docs.push({
          cuadrilla: String(x.cuadrilla || "").trim(),
          pesadaNumero: Number(x.pesadaNumero||0),
          hora: x.hora || "",
          usuario: x.usuario || "",
          personId: x.personId || "",
          apellidos: x.apellidos || "",
          nombres: x.nombres || "",
          libras: lbs
        });
      });

      const pesadaMap = new Map();
      for(const r of docs){
        const n = r.pesadaNumero || 0;
        if(!pesadaMap.has(n)){
          pesadaMap.set(n, {hora:r.hora||"", usuario:r.usuario||""});
        }
      }

      const pesadaNums = Array.from(pesadaMap.keys()).filter(n=>n>0).sort((a,b)=>a-b);
      pesadasCols = pesadaNums.map(n=>{
        const m = pesadaMap.get(n)||{};
        return { pesadaNumero:n, hora:m.hora||"", usuario:m.usuario||"" };
      });

      const isMulti = (cuadrillas.length > 1);

      const personMap = new Map();
      for(const r of docs){
        const pid = String(r.personId || "");
        if(!pid) continue;

        const key = isMulti ? `${r.cuadrilla}::${pid}` : pid;

        if(!personMap.has(key)){
          personMap.set(key,{
            personId: pid,
            cuadrilla: r.cuadrilla || "",
            apellidos: r.apellidos||"",
            nombres: r.nombres||"",
            byPesada: {}
          });
        }
        personMap.get(key).byPesada[r.pesadaNumero] = r.libras;
      }

      rows = Array.from(personMap.values()).sort((a,b)=>
        (a.cuadrilla||"").localeCompare(b.cuadrilla||"","es") ||
        (a.apellidos||"").localeCompare(b.apellidos||"","es") ||
        (a.nombres||"").localeCompare(b.nombres||"","es")
      );

      for(const n of pesadaNums) subtotalPorPesada.set(n, 0);

      for(const row of rows){
        let s2 = 0;
        for(const n of pesadaNums){
          const v = Number(row.byPesada[n]||0);
          s2 += v;
          subtotalPorPesada.set(n, (subtotalPorPesada.get(n)||0) + v);
        }
        row.subtotal2 = s2;
      }

      subtotal2Total = rows.reduce((a,b)=>a+(Number(b.subtotal2||0)),0);

      renderReportTable();
      recalcAll();
    }

    function renderReportTable(){
      const thead = $("theadReport");
      const tbody = $("tbodyReport");
      thead.innerHTML = "";
      tbody.innerHTML = "";

      const tr1 = document.createElement("tr");
      tr1.innerHTML = `
        <th class="colNo" rowspan="2">N°</th>
        <th class="colNomina" rowspan="2">NOMINA</th>
        <th class="colCuadrilla" rowspan="2">CUADRILLA</th>
      `;

      for(const c of pesadasCols){
        tr1.innerHTML += `
          <th>
            <div style="font-weight:900;">${esc(c.hora||"—")}</div>
            <div class="subHdr" style="margin-top:3px;padding:3px 0;">${esc((c.usuario||"").split("@")[0]||"")}</div>
            <div style="margin-top:3px;">PESADA ${c.pesadaNumero}</div>
          </th>`;
      }

      tr1.innerHTML += `<th rowspan="2">SUBTOTAL 2</th><th rowspan="2">DESCUENTO</th><th rowspan="2">TOTAL</th>`;
      thead.appendChild(tr1);
      thead.appendChild(document.createElement("tr"));

      const descInd = descuentoIndividual;
      const applyDesc = (Number.isFinite(descInd) && descInd < 0) ? descInd : 0;

      rows.forEach((r, idx)=>{
        const tr = document.createElement("tr");
        const nom = `${esc(r.apellidos)} ${esc(r.nombres)}`.trim();
        const cuad = esc((r.cuadrilla || "").trim());

        tr.innerHTML = `
          <td class="colNo">${idx+1}</td>
          <td class="colNomina">${nom}</td>
          <td class="colCuadrilla">${cuad}</td>
        `;

        for(const c of pesadasCols){
          const v = Number(r.byPesada[c.pesadaNumero]||0);
          tr.innerHTML += `<td class="num">${v ? fmt0(v) : ""}</td>`;
        }

        const subtotal2 = Number(r.subtotal2||0);
        const dVal = applyDesc;
        const total = subtotal2 + dVal;

        tr.innerHTML += `<td class="num">${fmt0(subtotal2)}</td>`;
        tr.innerHTML += `<td class="num ${dVal<0?'descuentoNeg':''}">${dVal<0?fmt0(dVal):""}</td>`;
        tr.innerHTML += `<td class="num">${fmt0(total)}</td>`;
        tbody.appendChild(tr);
      });

      const trS = document.createElement("tr");
      trS.className = "subRow";
      trS.innerHTML = `<td class="colNo" colspan="3">SUBTOTAL 1</td>`;

      for(const c of pesadasCols){
        trS.innerHTML += `<td class="num">${fmt0(subtotalPorPesada.get(c.pesadaNumero)||0)}</td>`;
      }

      trS.innerHTML += `<td class="num">${fmt0(subtotal2Total)}</td>`;
      trS.innerHTML += `<td class="num ${descuentoIndividual<0?'descuentoNeg':''}">${descuentoIndividual<0?fmt0(descuentoIndividual):""}</td>`;
      const totFinal = subtotal2Total + ((descuentoIndividual<0)? descuentoIndividual * (rows.length||0) : 0);
      trS.innerHTML += `<td class="num">${fmt0(totFinal)}</td>`;
      tbody.appendChild(trS);
    }

    function recalcAll(){
      numPersonas = rows.length || 0;
      pesadaCabezas = subtotal2Total || 0;

      const inpVal = parseEsNumber($("pesoCola").value);
      pesoCola = Number.isFinite(inpVal) ? inpVal : 0;

      elevadoEntero = (pesoCola > 0) ? (pesoCola / 0.66) : 0;
      cabezaPosible = (pesoCola > 0) ? (elevadoEntero - pesoCola) : 0;
      descuentoTotal = cabezaPosible - pesadaCabezas;
      descuentoIndividual = (numPersonas > 0) ? (descuentoTotal / numPersonas) : 0;

      $("elevadoEntero").textContent = fmt3(elevadoEntero);
      $("cabezaPosible").textContent = fmt3(cabezaPosible);
      $("pesadaCabezas").textContent = fmt3(pesadaCabezas);
      $("descuentoTotal").textContent = fmt0(descuentoTotal);
      $("numPersonas").textContent = fmt0(numPersonas);

      const diEl = $("descuentoIndividual");
      diEl.textContent = fmt0(descuentoIndividual);
      diEl.classList.toggle("vRed", descuentoIndividual < 0);

      renderReportTable();
    }

    $("pesoCola").addEventListener("input", ()=>{
      if(reportSaved || reportSigned) return;
      recalcAll();
    });

    async function reauthForSensitiveAction(){
      const user = auth.currentUser;
      if(!user || !user.email) throw new Error("No hay sesión activa.");
      const pass = prompt("Para confirmar FIRMA, ingrese su contraseña de Firebase:");
      if(!pass) throw new Error("Acción cancelada.");
      const cred = EmailAuthProvider.credential(user.email, pass);
      await reauthenticateWithCredential(user, cred);
      return true;
    }

    async function allocateNextReportNumber(){
      const yyyy = String(new Date().getFullYear());
      const ref = doc(db, COL_SID_COUNTER, yyyy);
      const n = await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        let last = 0;
        if(snap.exists()){
          last = Number((snap.data()||{}).last || 0);
          if(!Number.isFinite(last)) last = 0;
        }
        const next = last + 1;
        tx.set(ref, { last: next, year: yyyy, updatedAt: serverTimestamp() }, { merge:true });
        return next;
      });
      return String(n).padStart(7,"0");
    }

    // ✅ GUARDAR: ahora NO requiere firma. Guarda "pendiente de firma".
    $("btnGuardar").onclick = async ()=>{
      await refreshInternetStatus();
      if(!hasInternet){
        alert("⚠️ Sin internet: no se puede GUARDAR.");
        return;
      }
      if(reportSaved){
        alert("Este informe ya fue guardado.");
        return;
      }
      if(!currentCuadrillas || currentCuadrillas.length === 0 || !currentFecha){
        alert("Falta cuadrilla(s) o fecha.");
        return;
      }

      const num = await allocateNextReportNumber();
      reportNumber = num;
      reportDocId = `SID_${reportNumber}`;
      $("infoNumero").textContent = reportNumber;

      const stamp = nowStamp();

      const data = {
        reportNumber,
        circuito: Number(currentCircuito||1),
        cuadrilla: (currentCuadrillas.length === 1) ? currentCuadrillas[0] : "MULTI",
        cuadrillas: currentCuadrillas,
        fecha: currentFecha,
        responsableEmail: currentUserEmail,
        responsableNombre: currentUserName,

        pesoCola,
        elevadoEntero,
        cabezaPosible,
        pesadaCabezas,
        descuentoTotal,
        numPersonas,
        descuentoIndividual,

        pesadasCols,
        rows,

        // ✅ pendiente de firma
        signed: false,
        signedBy: "",
        signedAt: "",

        createdAt: serverTimestamp(),
        createdStamp: stamp
      };

      try{
        await setDoc(doc(db, COL_SID, reportDocId), data, { merge:false });

        reportSaved = true;
        reportSigned = false;

        $("reportStatus").textContent = "Guardado. Pendiente de firma (Jefferson).";

        // bloquear edición peso cola
        applyPesoColaPermission();

        // escuchar firma en tiempo real
        watchReportDoc(reportDocId);

        // aplicar botones
        updateButtons();

        alert(`Informe guardado: ${reportNumber}\nPendiente de firma (Jefferson).`);
      }catch(err){
        console.error(err);
        alert("No se pudo guardar el informe. Revisa permisos/conexión.");
      }
    };

    // ✅ FIRMAR: ahora firma un informe ya guardado (admin) y habilita PDF/EXCEL para todos
    $("btnFirmar").onclick = async ()=>{
      await refreshInternetStatus();
      if(!hasInternet){
        alert("Sin internet: no se puede firmar.");
        return;
      }
      if(!isAdmin()){
        alert("Solo Jefferson puede firmar electrónicamente este informe.");
        return;
      }
      if(!reportSaved || !reportDocId){
        alert("Primero debe GUARDAR el informe (generar N°) o BUSCAR un informe guardado.");
        return;
      }
      if(reportSigned){
        alert("Este informe ya está firmado.");
        return;
      }

      try{
        await reauthForSensitiveAction();

        signedBy = currentUserEmail;
        signedAt = new Date().toISOString();

        await updateDoc(doc(db, COL_SID, reportDocId), {
          signed: true,
          signedBy,
          signedAt,
          signedAtServer: serverTimestamp()
        });

        // el onSnapshot actualizará UI y botones para todos
        $("reportStatus").textContent = "Firmando…";

      }catch(err){
        console.error(err);
        alert("No se pudo firmar. Verifica contraseña/conexión.");
      }
    };

    // ✅ PDF: solo si firmado
    $("btnPdf").onclick = async ()=>{
      if(!reportSigned){
        alert("Este informe aún NO está firmado. PDF se habilita después de la firma.");
        return;
      }

      const sheet = $("reportSheet");
      if(!sheet){ alert("No se encontró el reporte."); return; }

      const { jsPDF } = window.jspdf || {};
      if(!jsPDF){ alert("No se pudo cargar PDF."); return; }

      const tblWrapEl = sheet.querySelector(".tblWrap");
      const _old = tblWrapEl ? {overflow: tblWrapEl.style.overflow, maxHeight: tblWrapEl.style.maxHeight} : null;
      if(tblWrapEl){ tblWrapEl.style.overflow = "visible"; tblWrapEl.style.maxHeight = "none"; }

      const canvas = await html2canvas(sheet, {scale:2, useCORS:true, backgroundColor:"#ffffff"});
      if(tblWrapEl && _old){ tblWrapEl.style.overflow = _old.overflow; tblWrapEl.style.maxHeight = _old.maxHeight; }

      const pdf = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const margin = 18;
      const printableW = pageW - margin*2;
      const printableH = pageH - margin*2;

      const imgW = canvas.width;
      const imgH = canvas.height;

      const ratio = printableW / imgW;
      let sliceHpx = Math.floor(printableH / ratio);
      if(!Number.isFinite(sliceHpx) || sliceHpx <= 0) sliceHpx = imgH;

      let pageIndex = 0;
      for(let y=0; y<imgH; y += sliceHpx){
        const sliceCanvas = document.createElement("canvas");
        sliceCanvas.width = imgW;
        sliceCanvas.height = Math.min(sliceHpx, imgH - y);

        const ctx = sliceCanvas.getContext("2d");
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0,0,sliceCanvas.width,sliceCanvas.height);
        ctx.drawImage(canvas, 0, y, imgW, sliceCanvas.height, 0, 0, imgW, sliceCanvas.height);

        const imgData = sliceCanvas.toDataURL("image/png");
        const sliceHpt = sliceCanvas.height * ratio;

        if(pageIndex > 0) pdf.addPage();
        pdf.addImage(imgData, "PNG", margin, margin, printableW, sliceHpt);
        pageIndex++;
      }

      const who = (currentUserEmail || "usuario").split("@")[0];
      const fname = `SID_${(reportNumber||"SIN_NUMERO")}_${who}_${nowStamp()}.pdf`.replaceAll(" ","_");
      pdf.save(fname);
    };

    // ✅ EXCEL: solo si firmado
    $("btnXls").onclick = ()=>{
      if(!reportSigned){
        alert("Este informe aún NO está firmado. Excel se habilita después de la firma.");
        return;
      }

      try{
        const XLSX = window.XLSX;
        if(!XLSX){ alert("No se pudo cargar la librería de Excel."); return; }

        const headers = ["N°","NOMINA","CUADRILLA"];
        for(const c of pesadasCols){
          headers.push(`PESADA ${c.pesadaNumero}`);
        }
        headers.push("SUBTOTAL 2","DESCUENTO","TOTAL");

        const descInd = descuentoIndividual;
        const applyDesc = (Number.isFinite(descInd) && descInd < 0) ? descInd : 0;

        const aoa = [];
        aoa.push(["SID | INFORME DESCABEZADO"]);

        const cuadrillaLabel = (currentCuadrillas && currentCuadrillas.length > 1)
          ? currentCuadrillas.join(" + ")
          : (currentCuadrillas[0] || "");

        aoa.push(["Informe N°", reportNumber||"", "Cuadrilla", cuadrillaLabel, "Fecha", currentFecha||"", "Circuito", `Circuito ${currentCircuito||"1"}`]);
        aoa.push(["Responsable", currentUserName||currentUserEmail||""]);
        aoa.push([]);
        aoa.push(headers);

        rows.forEach((r, idx)=>{
          const nom = `${(r.apellidos||"").trim()} ${(r.nombres||"").trim()}`.trim();
          const cuad = (r.cuadrilla || "").trim();
          const line = [idx+1, nom, cuad];

          for(const c of pesadasCols){
            const v = Number((r.byPesada||{})[c.pesadaNumero] || 0);
            line.push(v ? v : "");
          }

          const subtotal2 = Number(r.subtotal2||0);
          const total = subtotal2 + applyDesc;

          line.push(subtotal2 || 0);
          line.push(applyDesc ? applyDesc : "");
          line.push(total || 0);

          aoa.push(line);
        });

        const sub = ["SUBTOTAL 1","", ""];
        for(const c of pesadasCols){
          sub.push(Number(subtotalPorPesada.get(c.pesadaNumero)||0) || 0);
        }
        sub.push(Number(subtotal2Total||0) || 0);
        sub.push(applyDesc ? applyDesc : "");
        sub.push(Number(subtotal2Total + (applyDesc * (rows.length||0))) || 0);
        aoa.push(sub);

        const ws = XLSX.utils.aoa_to_sheet(aoa);

        const cols = [];
        cols.push({wch:6});
        cols.push({wch:32});
        cols.push({wch:16});
        for(let i=0;i<pesadasCols.length;i++) cols.push({wch:10});
        cols.push({wch:12},{wch:12},{wch:12});
        ws["!cols"] = cols;

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Informe");

        const who = (currentUserEmail || "usuario").split("@")[0];
        const fname = `SID_${(reportNumber||"SIN_NUMERO")}_${who}_${nowStamp()}.xlsx`.replaceAll(" ","_");
        XLSX.writeFile(wb, fname);
      }catch(err){
        console.error(err);
        alert("No se pudo exportar Excel.");
      }
    };

    // ✅ BUSCAR (Reporte) - mantiene prompts
    $("btnBuscar").onclick = async ()=>{
      const n = prompt("Ingrese N° de Informe (7 dígitos).\n\nDeje vacío para buscar por FECHA + Circuito.");
      await refreshInternetStatus();
      if(!hasInternet){
        alert("Sin internet: no se puede buscar.");
        return;
      }

      try{
        let foundDoc = null;

        if(n && n.trim()){
          const num = n.trim().replace(/\D+/g,"").padStart(7,"0");
          const id = `SID_${num}`;
          const snap = await getDoc(doc(db, COL_SID, id));
          if(snap.exists()){
            foundDoc = { id, ...snap.data() };
          }else{
            alert("No existe ese informe.");
            return;
          }
        }else{
          const f = prompt("Ingrese FECHA (YYYY-MM-DD):", todayKey());
          if(!f) return;
          const c = prompt("Ingrese Circuito (1 o 2):", "1");
          if(!c) return;

          const q = query(
            collection(db, COL_SID),
            where("fecha","==", f),
            where("circuito","==", Number(c))
          );

          const snap = await getDocs(q);
          if(snap.empty){
            alert("No se encontró informe para esa fecha+circuito.");
            return;
          }
          const d = snap.docs[0];
          foundDoc = { id: d.id, ...d.data() };
        }

        loadReportFromDoc(foundDoc);
      }catch(err){
        console.error(err);
        alert("Error buscando informe. Puede requerir índice en Firestore.");
      }
    };

    // ✅ BUSCAR desde pantalla Pick (sin prompts)
    $("btnBuscarPick").onclick = async ()=>{
      await refreshInternetStatus();
      if(!hasInternet){
        alert("Sin internet: no se puede buscar.");
        return;
      }

      try{
        const nRaw = ($("findNumero").value || "").trim();
        let foundDoc = null;

        if(nRaw){
          const clean = nRaw.replace(/\D+/g,"");
          if(!clean){
            alert("Ingrese un N° de informe válido.");
            return;
          }
          const num = clean.padStart(7,"0");
          const id = `SID_${num}`;
          const snap = await getDoc(doc(db, COL_SID, id));
          if(!snap.exists()){
            alert("No existe ese informe.");
            return;
          }
          foundDoc = { id, ...snap.data() };
        }

        if(!foundDoc){
          const f = ($("findFecha").value || "").trim() || todayKey();
          const c = ($("findCircuito").value || "1");

          const q = query(
            collection(db, COL_SID),
            where("fecha","==", f),
            where("circuito","==", Number(c))
          );

          const snap = await getDocs(q);
          if(snap.empty){
            alert("No se encontró informe para esa fecha+circuito.");
            return;
          }

          let best = null;
          snap.forEach(d=>{
            const data = d.data() || {};
            const rn = Number(data.reportNumber || 0);
            if(!best || rn > best.rn){
              best = { rn, id: d.id, data };
            }
          });

          foundDoc = { id: best.id, ...best.data };
        }

        loadReportFromDoc(foundDoc);
      }catch(err){
        console.error(err);
        alert("Error buscando informe. Puede requerir índice en Firestore.");
      }
    };

    function loadReportFromDoc(docData){
      // set estados
      reportDocId = docData.id;
      reportNumber = docData.reportNumber || "";
      reportSaved = true;
      reportSigned = !!docData.signed;
      signedBy = docData.signedBy || "";
      signedAt = docData.signedAt || "";

      currentCuadrillas = Array.isArray(docData.cuadrillas) && docData.cuadrillas.length
        ? docData.cuadrillas
        : [docData.cuadrilla || ""].filter(Boolean);

      currentFecha = docData.fecha || "";
      currentCircuito = String(docData.circuito || "1");

      const cuadrillaLabel = (currentCuadrillas.length > 1)
        ? currentCuadrillas.join(" + ")
        : (currentCuadrillas[0] || "");

      $("metaCuadrilla").textContent = cuadrillaLabel || "—";
      $("metaFecha").textContent = currentFecha;
      $("infoCircuito").textContent = `Circuito ${currentCircuito}`;
      $("infoResponsable").textContent = docData.responsableNombre || docData.responsableEmail || "—";
      $("infoNumero").textContent = reportNumber || "—";

      pesadasCols = docData.pesadasCols || [];
      rows = docData.rows || [];
      pesoCola = Number(docData.pesoCola||0);

      const fallbackCuad = (Array.isArray(docData.cuadrillas) && docData.cuadrillas.length)
        ? docData.cuadrillas[0]
        : (docData.cuadrilla || "");

      rows = rows.map(r => ({
        ...r,
        cuadrilla: (r.cuadrilla || fallbackCuad || "").trim()
      }));

      $("pesoCola").value = pesoCola ? pesoCola.toLocaleString("es-EC",{minimumFractionDigits:3,maximumFractionDigits:3}) : "";

      subtotalPorPesada = new Map();
      subtotal2Total = 0;

      const nums = pesadasCols.map(x=>Number(x.pesadaNumero||0)).filter(n=>n>0);
      for(const n of nums) subtotalPorPesada.set(n, 0);

      rows.forEach(r=>{
        let s2=0;
        nums.forEach(n=>{
          const v = Number((r.byPesada||{})[n]||0);
          s2 += v;
          subtotalPorPesada.set(n,(subtotalPorPesada.get(n)||0)+v);
        });
        r.subtotal2 = s2;
      });
      subtotal2Total = rows.reduce((a,b)=>a+(Number(b.subtotal2||0)),0);

      // recalcular panel con valores guardados
      $("elevadoEntero").textContent = fmt3(docData.elevadoEntero||0);
      $("cabezaPosible").textContent = fmt3(docData.cabezaPosible||0);
      $("pesadaCabezas").textContent = fmt3(docData.pesadaCabezas||0);
      $("descuentoTotal").textContent = fmt0(docData.descuentoTotal||0);
      $("numPersonas").textContent = fmt0(docData.numPersonas||0);
      $("descuentoIndividual").textContent = fmt0(docData.descuentoIndividual||0);
      $("descuentoIndividual").classList.toggle("vRed", Number(docData.descuentoIndividual||0) < 0);

      renderReportTable();

      // UI firma + permisos
      applySignatureUI();
      applyPesoColaPermission();

      if(reportSigned){
        $("reportStatus").textContent = "Firmado. PDF/EXCEL habilitados.";
      }else{
        $("reportStatus").textContent = "Guardado. Pendiente de firma (Jefferson).";
      }

      showView("report");

      // escuchar cambios (firma en vivo)
      watchReportDoc(reportDocId);

      updateButtons();
    }

    // Inicial
    $("selFecha").value = todayKey();
    $("findFecha").value = todayKey();
    updateButtons();

  </script>
</body>
</html>
