<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SISTEMA DE PROGRAMACIÃ“N DIARIO DE PLANTA</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel2:#0b1326;
      --grid:#1f2a44;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#1d4ed8;
      --hdr:#2b3a59;
      --hdr2:#1b2740;
      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;
      --cell:#0e1a33;
      --white:#fff;
    }

    *{box-sizing:border-box}
    body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  position:relative;
}

/* âœ… Fondo exclusivo para SPC (en la raÃ­z del repo) */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background-image:url("./bg-spc.jpg?v=1");
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  z-index:-2;
  transform:scale(1.02);
  filter:saturate(.95) contrast(1.05);
}

/* âœ… Capa oscura para legibilidad */
body::after{
  content:"";
  position:fixed;
  inset:0;
  background:rgba(3, 7, 18, 0.88);
  z-index:-1;
}

    .hidden{display:none !important}

    /* Login */
    .login-wrap{min-height:100vh;display:grid;place-items:center;padding:24px}
    .login-card{
      width:min(560px, 92vw);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .login-title{font-size:16px;font-weight:800;margin:0 0 8px}
    .login-sub{font-size:12px;opacity:.8;margin:0 0 14px}
    .row{display:flex;gap:10px;align-items:center;margin:10px 0}
    .row label{width:90px;font-size:12px;color:var(--muted)}
    .in{
      flex:1;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 10px;
      border-radius:8px;
      outline:none;
    }
    .btn{
      width:100%;
      margin-top:10px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(29,78,216,.95), rgba(29,78,216,.70));
      color:white;
      font-weight:800;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .err{margin-top:10px;color:#fecaca;font-size:12px;min-height:16px}

    /* App */
    header{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.22);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .h-left{display:flex;align-items:flex-end;gap:12px}
    /* Logo 25% mÃ¡s grande, sin distorsiÃ³n */
    .h-logo{height:43px;width:auto;object-fit:contain;display:block}
    .h-title{margin:0;font-size:18px;font-weight:900;letter-spacing:.3px}
    .h-mini{font-size:12px;color:var(--muted);margin:0 0 1px}
    .h-right{display:flex;align-items:center;gap:10px}
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--text);
      white-space:nowrap;
    }
    .linkbtn{
      font-size:12px;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
    }

    /* Excel-like sheet area */
    .sheet{padding:12px 12px 0}
    .top-grid{
      display:grid;
      grid-template-columns: 320px 460px 360px 250px;
      gap:12px;
      align-items:start;
    }
    .box{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:10px;
      overflow:hidden;
    }
    .box .box-h{
      background:rgba(255,255,255,.04);
      padding:8px 10px;
      font-weight:900;
      font-size:13px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    .box .box-b{padding:10px}

    /* Ingresar panel (left) */
    .form-grid{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:6px 10px;
      align-items:center;
    }
    .lab{font-size:12px;color:var(--text)}
    .cell{
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      padding:6px 8px;
      border-radius:6px;
      color:var(--text);
      outline:none;
      height:28px;
      font-size:12px;
      width:100%;
    }
    .cell:focus{border-color:rgba(59,130,246,.55);box-shadow:0 0 0 2px rgba(59,130,246,.18)}
    select.cell{appearance:auto}

    /* Middle area */
    .ranges{padding:8px 10px 10px}
    .ranges-grid{display:grid;grid-template-columns:1fr 2fr;gap:8px 10px;align-items:center}
    .ranges-grid .hdr{font-weight:900;font-size:12px;text-align:center;opacity:.92}
    .ranges-grid .subhead{grid-column:1 / -1;font-weight:900;font-size:12px;text-align:center;opacity:.92;margin-top:6px}
    #boxRangos .cell{width:100%}

    /* Control box */
    .control-grid{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:6px 10px;
      align-items:center;
    }
    .val{
      text-align:right;
      font-variant-numeric:tabular-nums;
      padding:2px 0;
      font-size:12px;
    }
    .k{font-size:12px;color:var(--text)}
    .k b{font-weight:900}

    /* Right present box */
    .present-grid{
      display:grid;
      grid-template-columns: 70px 1fr;
      gap:8px 10px;
      align-items:center;
    }
    .pdf-btn{
      margin-top:10px;
      width:100%;
      height:34px;
      border-radius:4px;
      background:#e5e7eb;
      color:#111827;
      border:1px solid rgba(0,0,0,.25);
      font-weight:900;
      cursor:pointer;
    }

    /* Table */
    .table-wrap{
      margin-top:12px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:10px;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:50;
      background:linear-gradient(180deg, var(--hdr), var(--hdr2));
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:6px 8px 6px 8px;
      font-size:12px;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    tbody td{
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.10);
      padding:0;
    }
    tbody tr:nth-child(even) td{background:rgba(0,0,0,.14)}
    .cell-in{
      width:100%;
      height:26px;
      border:0;
      background:transparent;
      color:var(--text);
      padding:3px 6px;
      outline:none;
      font-size:12px;
      font-variant-numeric:tabular-nums;
    }
    .cell-in[disabled]{color:rgba(229,231,235,.88)}
    .cell-in:focus{outline:2px solid rgba(59,130,246,.25);background:rgba(59,130,246,.08)}

    /* ===== Intercalado azul / celeste (solo consola web) ===== */
    .table-wrap tbody tr:nth-child(odd) td{background:rgba(29,78,216,.18)}
    .table-wrap tbody tr:nth-child(even) td{background:rgba(125,211,252,.14)}

    /* ===== Resaltado por reglas de Liquidando / Peso Cola ===== */
    .table-wrap tbody tr.row-liq-1a3 td{
      background:#dff3ff !important;
      color:#0b2a6f !important;
    }
    .table-wrap tbody tr.row-liq-1a3 td .cell-in{ color:#0b2a6f !important; }
    .table-wrap tbody tr.row-liq-1a3 td .cell-in:focus{
      outline:2px solid rgba(11,42,111,.20) !important;
      background:rgba(255,255,255,.45) !important;
    }

    .table-wrap tbody tr.row-liq-gt3 td{
      background:#b7f7b7 !important;
      color:#0b4a1a !important;
    }
    .table-wrap tbody tr.row-liq-gt3 td .cell-in{ color:#0b4a1a !important; }
    .table-wrap tbody tr.row-liq-gt3 td .cell-in:focus{
      outline:2px solid rgba(11,74,26,.18) !important;
      background:rgba(255,255,255,.35) !important;
    }

    .table-wrap tbody tr.row-cola-sinliq td{
      background:#f6d7de !important;
      color:#7a0f1b !important;
    }
    .table-wrap tbody tr.row-cola-sinliq td .cell-in{ color:#7a0f1b !important; }
    .table-wrap tbody tr.row-cola-sinliq td .cell-in:focus{
      outline:2px solid rgba(122,15,27,.18) !important;
      background:rgba(255,255,255,.45) !important;
    }

    /* ===== AlineaciÃ³n numÃ©rica (consola web) ===== */
    .cell-in.num-right{text-align:right;padding-right:8px}
    th.num-right .filter-ui{justify-content:space-between}
    th.num-right .filter-ui > div:first-child{text-align:right}

    /* Header filter (Excel-like) */
    .filter-ui{ display:flex;align-items:center;gap:6px; }
    .filter-btn{
      width:16px;height:16px;flex:0 0 16px;
      border-radius:3px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      display:grid;place-items:center;
      cursor:pointer;
      opacity:.9;
    }
    .filter-btn svg{width:11px;height:11px;fill:rgba(255,255,255,.85)}
    .filter-pop{
      position:absolute;
      top:100%;
      left:0;
      z-index:20;
      width:220px;
      background:#0b1220;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 14px 30px rgba(0,0,0,.45);
      border-radius:10px;
      padding:10px;
      display:none;
    }
    .filter-pop input{
      width:100%;
      height:28px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:6px 8px;
      outline:none;
      font-size:12px;
    }
    .filter-pop .mini{
      margin-top:8px;
      display:flex;gap:8px;justify-content:flex-end
    }
    .mini button{
      height:28px;
      padding:0 10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      font-weight:800;
    }

    /* Column resizer */
    .resizer{
      position:absolute;top:0;right:0;height:100%;width:6px;
      cursor:col-resize;
      user-select:none;
    }

    /* Actions */
    .chk{display:grid;place-items:center}
    .del{
      color:#93c5fd;
      cursor:pointer;
      font-size:12px;
      text-decoration:underline;
      padding:3px 6px;
      display:inline-block;
    }

    /* Sheet tabs (bottom) */
    .tabs{
      display:flex;gap:6px;
      padding:10px 12px;
      align-items:center;
      border-top:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
      position:sticky;
      bottom:0;
    }
    .tab{
      padding:8px 14px;
      border-radius:10px 10px 0 0;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      opacity:.9;
    }
    .tab.active{
      background:rgba(255,255,255,.12);
      opacity:1;
      border-bottom-color:transparent;
    }

    /* Crear tab */
    .crear-grid{
      display:grid;
      grid-template-columns: 520px 1fr;
      gap:12px;
      align-items:start;
    }
    .simple-table th, .simple-table td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:0;
      background:rgba(0,0,0,.10);
    }
    .simple-table th{
      background:linear-gradient(180deg, var(--hdr), var(--hdr2));
      padding:6px 8px;
      font-size:12px;
      text-align:left;
    }

    @media (max-width: 1050px){
      .top-grid{grid-template-columns:1fr}
      .crear-grid{grid-template-columns:1fr}
    }

    .topbox{height:330px}
    .topbox .box-b{max-height: calc(330px - 34px); overflow:auto}
    .top-grid{align-items:stretch}
    .control-grid{grid-template-columns: 180px 1fr}

    /* ===== Row highlight when "Modificar" is enabled ===== */
    tr.row-editing td{
      background:#ffffff !important;
      color:#0b1b3a !important;
    }
    tr.row-editing td .cell-in{
      background:transparent !important;
      color:#0b1b3a !important;
      border-color:rgba(11,27,58,.35) !important;
    }
    tr.row-editing td .del{ color:#0b1b3a !important; }
  </style>

  <!-- PDF libs (global) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>
</head>

<body>

<!-- LOGIN -->
<section id="loginView" class="login-wrap">
  <div class="login-card">
    <p class="login-title">OCEANTREASURE | Login</p>
    <p class="login-sub">Acceso en la nube (Firebase). Ingrese correo y contraseÃ±a.</p>

    <div class="row">
      <label>Usuario</label>
      <input id="email" class="in" type="email" autocomplete="username" />
    </div>
    <div class="row">
      <label>Clave</label>
      <input id="pass" class="in" type="password" autocomplete="current-password" />
    </div>

    <button id="btnLogin" class="btn">INGRESAR</button>
    <div id="loginErr" class="err"></div>
  </div>
</section>

<!-- APP -->
<section id="appView" class="hidden">
  <header>
    <div class="h-left">
      <img class="h-logo" src="logo.png" alt="Oceantreasure" />
      <div>
        <p class="h-mini">Oceantreasure</p>
        <h1 class="h-title">SISTEMA DE PROGRAMACIÃ“N DIARIO DE PLANTA</h1>
      </div>
    </div>
    <div class="h-right">
      <span id="pillUser" class="pill">Usuario: <b id="h3_user">â€”</b></span>
      <span id="pillRole" class="pill">Rol: <b id="h3_role">â€”</b></span>
      <span id="pillNow" class="pill">Fecha: <b id="h4_now">â€”</b></span>
      <button id="btnLogout" class="linkbtn">Salir</button>
    </div>
  </header>

  <div class="sheet">
    <!-- TAB: ENERO -->
    <div id="viewEnero">
      <div class="top-grid">
        <!-- INGRESAR -->
        <div class="box topbox">
          <div class="box-h">INGRESAR</div>
          <div class="box-b">
            <div class="form-grid" id="formIngresar">
              <div class="lab">Hora:</div><input class="cell" id="c3_hora" type="time" />
              <div class="lab">Fecha:</div><input class="cell" id="c4_fecha" type="text" placeholder="dd-mmm" inputmode="latin" />
              <div class="lab">Proveedor:</div><input class="cell" id="c5_proveedor" />
              <div class="lab">OCK:</div><input class="cell" id="c6_oc" inputmode="numeric" />
              <div class="lab">Piscina:</div><input class="cell" id="c7_pisc" type="text" inputmode="latin" autocomplete="off" />
              <div class="lab">GuÃ­as:</div><input class="cell" id="c8_guia" type="text" inputmode="latin" autocomplete="off" />
              <div class="lab">Bines:</div><input class="cell" id="c9_bines" inputmode="numeric" />
              <div class="lab">Sector:</div><input class="cell" id="c10_sector" />
              <div class="lab">Lote:</div>
              <select class="cell" id="c11_lote"></select>
              <div class="lab">Secuencial:</div><input class="cell" id="c12_secuencial" type="text" inputmode="numeric" autocomplete="off" />
              <div class="lab">Libras:</div><input class="cell" id="c13_libras" inputmode="decimal" />
            </div>
          </div>
        </div>

        <!-- RANGOS / IMPORTADORES -->
        <div class="topbox" id="boxRangos">
          <div class="box-h">RANGOS / IMPORTADORES</div>
          <div class="ranges">
            <div class="ranges-grid">
              <div class="hdr">Rango</div>
              <div class="hdr">Importadores Clase "A"</div>

              <input class="cell" id="e7_rango" />
              <input class="cell" id="h7_impA1" />

              <input class="cell" id="e8_rango" />
              <input class="cell" id="h8_impA2" />

              <div class="subhead">Importador Clase "B"</div>

              <input class="cell" id="e12_todas" />
              <input class="cell" id="h12_impB" />
            </div>
          </div>
        </div>

        <!-- CONTROL -->
        <div class="box topbox">
          <div class="box-h">CONTROL</div>
          <div class="box-b">
            <div class="control-grid">
              <div class="k"><b>LIBRAS REMITIDAS:</b></div><div class="val" id="m3_librasRem">0,00</div>
              <div class="k"><b>COLA APROXIMADA:</b></div><div class="val" id="m4_colaAprox">0,00</div>
              <div style="height:4px"></div><div></div>
              <div class="k"><b>PESO PLANTA:</b></div><div class="val" id="m6_pesoPlanta">0,00</div>
              <div class="k"><b>PESO COLA:</b></div><div class="val" id="m7_pesoCola">0,00</div>
              <div style="height:4px"></div><div></div>
              <div class="k"><b>LIQUIDADO:</b></div><div class="val" id="m9_liquidado">0,00</div>
              <div class="k"><b>RENDIMIENTO:</b></div><div class="val" id="m10_rendTotal">0,00%</div>
            </div>
          </div>
        </div>

        <!-- PRESENTAR TABLA -->
        <div class="box topbox">
          <div class="box-h">PRESENTAR TABLA</div>
          <div class="box-b">
            <div class="present-grid">
              <div class="lab">Presentar tabla desde:</div><input class="cell" id="q3_desde" inputmode="numeric" />
              <div class="lab">Hasta:</div><input class="cell" id="q4_hasta" inputmode="numeric" />
            </div>
            <button id="btnPDF" class="pdf-btn">GENERAR PDF</button>
          </div>
        </div>
      </div>

      <!-- TABLE -->
      <div class="table-wrap">
        <div style="overflow:auto;max-height:58vh">
          <table id="tbl">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: CREAR -->
    <div id="viewCrear" class="hidden">
      <div class="crear-grid">
        <div class="box">
          <div class="box-h">CREAR | LOTES</div>
          <div class="box-b">
            <div style="font-size:12px;color:var(--muted);margin-bottom:8px">
              Agrega/edita lotes directamente como en Excel. Enter = guardar.
            </div>

            <div style="overflow:auto;max-height:70vh;border:1px solid rgba(255,255,255,.08);border-radius:10px">
              <table class="simple-table" style="width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed">
                <thead>
                  <tr>
                    <th style="width:70px">#</th>
                    <th>Lote</th>
                    <th style="width:90px">Quitar</th>
                  </tr>
                </thead>
                <tbody id="lotesBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="box-h">CREAR | NOTAS</div>
          <div class="box-b" style="font-size:12px;color:var(--muted);line-height:1.35">
            - El selector de <b>Lote</b> en ENERO toma los lotes de esta pestaÃ±a.<br/>
            - Todo se guarda en Firestore y se comparte entre dispositivos.<br/>
            - No se agregan botones extra (solo ediciÃ³n tipo Excel).
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bottom tabs -->
  <div class="tabs">
    <div class="tab active" id="tabEnero">ENERO</div>
    <div class="tab" id="tabCrear">CREAR</div>
  </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, query, orderBy, onSnapshot, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCMoLkSnnLowMagRNL7O6ttPo1FXd1URac",
    authDomain: "oceantreasure-app.firebaseapp.com",
    projectId: "oceantreasure-app",
    storageBucket: "oceantreasure-app.firebasestorage.app",
    messagingSenderId: "553014659258",
    appId: "1:553014659258:web:cfc30844a88433b7b79a83",
    measurementId: "G-HMMQKJY8NJ"
  };

  const ADMIN_EMAIL = "jeffersonfigueroa@oceantreasure.local";
  const EDITOR_LIMITED_EMAIL = "yanelavinueza@oceantreasure.local";
  const VIEWER_FULL_EMAIL = "gerenciageneral@oceantreasure.local";
  const VIEWER_ONLY_EMAILS = [
    "victoriacajias@oceantreasure.local",
    "lisbethmurillo@oceantreasure.local",
    "vanesasuarez@oceantreasure.local"
  ];

  const $ = (id)=>document.getElementById(id);
  const nf2 = new Intl.NumberFormat("es-EC", {minimumFractionDigits:2, maximumFractionDigits:2});
  const auth = getAuth(initializeApp(firebaseConfig));
  const db = getFirestore();

  function getRoleByEmail(email){
    const e = String(email || "").toLowerCase();

    if(e === ADMIN_EMAIL) return "admin";
    if(e === EDITOR_LIMITED_EMAIL) return "editor_limited";
    if(e === VIEWER_FULL_EMAIL) return "viewer_full";

    // ðŸ‘€ SOLO VISTA COMPLETA (NUEVOS USUARIOS)
    if(VIEWER_ONLY_EMAILS.includes(e)) return "viewer_full";

    return "viewer_limited";
  }

  function roleLabel(role){
    if(role === "admin") return "ADMIN (EDITA TODO)";
    if(role === "editor_limited") return "EDITOR (HASTA LIBRAS)";
    if(role === "viewer_full") return "SOLO VISTA (COMPLETO)";
    return "SOLO VISTA (HASTA LIBRAS)";
  }

  function nowText(){
    const d = new Date();
    return d.toLocaleString("es-EC", {year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});
  }
  function ymd(d){
    const z = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
  }
  function hm(d){
    const z = n => String(n).padStart(2,"0");
    return `${z(d.getHours())}:${z(d.getMinutes())}`;
  }
  function num(x){
    if(x===null||x===undefined) return null;
    const s0 = String(x).trim();
    if(!s0) return null;
    const s = s0.replace(/\s+/g, "");

    // Formato es-EC: coma decimal y punto de miles.
    // Si NO hay coma, aceptar 1 punto como decimal (1-2 decimales). Caso contrario, puntos como miles.
    if(s.includes(",")){
      const v = s.replace(/\./g, "").replace(",", ".");
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    const dots = (s.match(/\./g) || []).length;
    if(dots === 1 && /^\d+\.\d{1,2}$/.test(s)){
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    const v = s.replace(/\./g, "");
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function safeStr(x){ return (x===null||x===undefined) ? "" : String(x); }

  const MONTHS_ES = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
  function fmtFecha(x){
    const s = safeStr(x).trim();
    if(!s) return "";
    const m0 = /^\d{1,2}-[a-zA-ZÃ±Ã‘]{3}$/.exec(s);
    if(m0){
      const [dd,mmm] = s.split("-");
      return String(dd).padStart(2,"0")+"-"+mmm.toLowerCase();
    }
    const m1 = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
    if(m1){
      const dd = m1[3];
      const mm = Math.max(1, Math.min(12, Number(m1[2])));
      return dd+"-"+MONTHS_ES[mm-1];
    }
    const m2 = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(s);
    if(m2){
      const dd = String(m2[1]).padStart(2,"0");
      const mm = Math.max(1, Math.min(12, Number(m2[2])));
      return dd+"-"+MONTHS_ES[mm-1];
    }
    return s;
  }

  const loginView = $("loginView");
  const appView = $("appView");
  const loginErr = $("loginErr");
  const btnLogin = $("btnLogin");
  const btnLogout = $("btnLogout");

  const tabEnero = $("tabEnero");
  const tabCrear = $("tabCrear");
  const viewEnero = $("viewEnero");
  const viewCrear = $("viewCrear");

  const inputs = {
    hora: $("c3_hora"),
    fecha: $("c4_fecha"),
    proveedor: $("c5_proveedor"),
    oc: $("c6_oc"),
    pisc: $("c7_pisc"),
    guia: $("c8_guia"),
    bines: $("c9_bines"),
    sector: $("c10_sector"),
    lote: $("c11_lote"),
    secuencial: $("c12_secuencial"),
    libras: $("c13_libras"),
  };

  const rangeInputs = {
    e7: $("e7_rango"),
    h7: $("h7_impA1"),
    e8: $("e8_rango"),
    h8: $("h8_impA2"),
    e12: $("e12_todas"),
    h12: $("h12_impB"),
  };

  // ===== Persistencia (Firestore) de RANGOS / IMPORTADORES =====
  const RANGOS_DOC_ID = 'rangos_importadores';
  const RANGOS_COL = 'spc_config';
  const RANGOS_CACHE_KEY = 'spc_rangos_importadores_cache_v1';

  let _rangosApplyingRemote = false;
  let _rangosSaveTimer = null;

  function getRangosPayload(){
    return {
      e7: safeStr(rangeInputs.e7?.value).trim(),
      h7: safeStr(rangeInputs.h7?.value).trim(),
      e8: safeStr(rangeInputs.e8?.value).trim(),
      h8: safeStr(rangeInputs.h8?.value).trim(),
      e12: safeStr(rangeInputs.e12?.value).trim(),
      h12: safeStr(rangeInputs.h12?.value).trim(),
    };
  }

  function applyRangosPayload(p){
    if(!p) return;
    _rangosApplyingRemote = true;
    try{
      if(rangeInputs.e7) rangeInputs.e7.value = safeStr(p.e7);
      if(rangeInputs.h7) rangeInputs.h7.value = safeStr(p.h7);
      if(rangeInputs.e8) rangeInputs.e8.value = safeStr(p.e8);
      if(rangeInputs.h8) rangeInputs.h8.value = safeStr(p.h8);
      if(rangeInputs.e12) rangeInputs.e12.value = safeStr(p.e12);
      if(rangeInputs.h12) rangeInputs.h12.value = safeStr(p.h12);
    } finally {
      _rangosApplyingRemote = false;
    }
    try{ localStorage.setItem(RANGOS_CACHE_KEY, JSON.stringify(getRangosPayload())); }catch(_){}
  }

  let currentUser = null;
  let role = "viewer_limited";
  let canEdit = false;
  let canEditConfig = false;
  let canUseCrearTab = false;
  let allowDeleteRow = false;

  let rowsAll = [];
  let rowsVisible = [];
  const colFilters = {};
  let unsubProgram = null;
  let unsubLotes = null;
  let unsubRangos = null;

  function scheduleSaveRangos(){
    if(!canEditConfig) return;
    if(_rangosApplyingRemote) return;
    if(_rangosSaveTimer) clearTimeout(_rangosSaveTimer);
    _rangosSaveTimer = setTimeout(async ()=>{
      const payload = {
        ...getRangosPayload(),
        updatedAt: Date.now(),
        updatedBy: currentUser?.email || ''
      };
      try{ localStorage.setItem(RANGOS_CACHE_KEY, JSON.stringify(payload)); }catch(_){}
      try{
        await setDoc(doc(db, RANGOS_COL, RANGOS_DOC_ID), payload, {merge:true});
      }catch(e){
        console.warn('No se pudo guardar Rangos/Importadores en BD:', e?.message || e);
      }
    }, 250);
  }

  function initRangosPersist(){
    // Cache local (por si estÃ¡ sin red al inicio)
    try{
      const cache = JSON.parse(localStorage.getItem(RANGOS_CACHE_KEY) || 'null');
      if(cache) applyRangosPayload(cache);
    }catch(_){}

    // Quitar listener previo
    if(unsubRangos) { try{ unsubRangos(); }catch(_){}; unsubRangos = null; }

    // SincronizaciÃ³n en la nube (persistente entre PCs)
    try{
      unsubRangos = onSnapshot(doc(db, RANGOS_COL, RANGOS_DOC_ID), async (snap)=>{
        if(snap.exists()){
          const d = snap.data() || {};
          applyRangosPayload(d);
        }else if(canEditConfig){
          // Si no existe aÃºn, sembrar con lo que haya en pantalla
          const seed = {
            ...getRangosPayload(),
            createdAt: Date.now(),
            createdBy: currentUser?.email || ''
          };
          try{ await setDoc(doc(db, RANGOS_COL, RANGOS_DOC_ID), seed, {merge:true}); }catch(_){}
        }
      });
    }catch(e){
      console.warn('No se pudo suscribir a Rangos/Importadores:', e?.message || e);
    }

    // Guardar cuando el usuario edita (solo ADMIN)
    Object.values(rangeInputs).forEach(el=>{
      if(!el) return;
      el.removeEventListener('input', scheduleSaveRangos);
      el.addEventListener('input', scheduleSaveRangos);
    });
  }

  const filtros = { desde: $("q3_desde"), hasta: $("q4_hasta") };

  // ===== Persistencia (Firestore) de PRESENTAR TABLA (DESDE/HASTA) por usuario =====
  const PREFS_COL = "spc_user_prefs";
  const PREFS_CACHE_KEY = "spc_presentar_filtros_cache_v1";

  let _prefsApplyingRemote = false;
  let _prefsSaveTimer = null;
  let unsubPrefs = null;

  function prefsDocRef(){
    return doc(db, PREFS_COL, String(currentUser?.uid || ""));
  }

  function getPresentarPayload(){
    return {
      desde: safeStr(filtros.desde?.value).trim(),
      hasta: safeStr(filtros.hasta?.value).trim(),
    };
  }

  function applyPresentarPayload(p){
    if(!p) return;
    _prefsApplyingRemote = true;
    try{
      if(filtros.desde) filtros.desde.value = safeStr(p.desde);
      if(filtros.hasta) filtros.hasta.value = safeStr(p.hasta);
    } finally {
      _prefsApplyingRemote = false;
    }

    render();

    try{ localStorage.setItem(PREFS_CACHE_KEY, JSON.stringify(getPresentarPayload())); }catch(_){}
  }

  function scheduleSavePresentar(){
    if(_prefsApplyingRemote) return;
    if(!currentUser?.uid) return;

    if(_prefsSaveTimer) clearTimeout(_prefsSaveTimer);
    _prefsSaveTimer = setTimeout(async ()=>{
      const payload = {
        ...getPresentarPayload(),
        updatedAt: Date.now(),
        updatedBy: currentUser?.email || ""
      };

      try{ localStorage.setItem(PREFS_CACHE_KEY, JSON.stringify(payload)); }catch(_){}

      try{
        await setDoc(prefsDocRef(), payload, { merge:true });
      }catch(e){
        console.warn("No se pudo guardar filtros PRESENTAR TABLA:", e?.message || e);
      }
    }, 200);
  }

  function initPresentarPersist(){
    try{
      const cache = JSON.parse(localStorage.getItem(PREFS_CACHE_KEY) || "null");
      if(cache) applyPresentarPayload(cache);
    }catch(_){}

    if(unsubPrefs){ try{ unsubPrefs(); }catch(_){} unsubPrefs = null; }

    try{
      unsubPrefs = onSnapshot(prefsDocRef(), (snap)=>{
        if(snap.exists()){
          const d = snap.data() || {};
          applyPresentarPayload(d);
        }else{
          const seed = {
            ...getPresentarPayload(),
            createdAt: Date.now(),
            createdBy: currentUser?.email || ""
          };
          setDoc(prefsDocRef(), seed, { merge:true }).catch(()=>{});
        }
      });
    }catch(e){
      console.warn("No se pudo suscribir a filtros PRESENTAR TABLA:", e?.message || e);
    }

    if(filtros.desde){
      filtros.desde.removeEventListener("input", scheduleSavePresentar);
      filtros.desde.addEventListener("input", scheduleSavePresentar);
    }
    if(filtros.hasta){
      filtros.hasta.removeEventListener("input", scheduleSavePresentar);
      filtros.hasta.addEventListener("input", scheduleSavePresentar);
    }
  }

  const m3_librasRem = $("m3_librasRem");
  const m4_colaAprox = $("m4_colaAprox");
  const m6_pesoPlanta = $("m6_pesoPlanta");
  const m7_pesoCola = $("m7_pesoCola");
  const m9_liquidado = $("m9_liquidado");
  const m10_rendTotal = $("m10_rendTotal");

  const thead = $("thead");
  const tbody = $("tbody");
  const btnPDF = $("btnPDF");

  const h3_user = $("h3_user");
  const h3_role = $("h3_role");
  const h4_now = $("h4_now");

  const COLS_ALL = [
    {key:"hora", label:"Hora", w:72, editable:false},
    {key:"fecha", label:"Fecha", w:86, editable:false},
    {key:"proveedor", label:"Proveedor", w:150, editable:true},
    {key:"oc", label:"OC", w:72, editable:true},
    {key:"pisc", label:"Pisc", w:60, editable:true},
    {key:"guiaNum", label:"GuÃ­a", w:90, editable:true},
    {key:"bines", label:"Bines", w:60, editable:true},
    {key:"sector", label:"Sector", w:120, editable:true},
    {key:"lote", label:"Lote", w:150, editable:true},
    {key:"secuencial", label:"Secuencial", w:86, editable:false},
    {key:"gramo", label:"Gramo", w:70, editable:true},
    {key:"talla", label:"Talla", w:70, editable:false, computed:true},
    {key:"guiaLbs", label:"Libras", w:86, editable:true},
    {key:"promedio", label:"Promedio", w:86, editable:true},
    {key:"planta", label:"Planta", w:86, editable:false, computed:true},
    {key:"pesoCola", label:"Peso Cola", w:90, editable:true},
    {key:"basura", label:"Basura", w:70, editable:true},
    {key:"liquidando", label:"Liquidando", w:90, editable:true},
    {key:"rend", label:"Rend", w:78, editable:false, computed:true},
    {key:"modificar", label:"Modificar", w:74, editable:false, action:"edit"},
    {key:"quitar", label:"Quitar", w:72, editable:false, action:"delete"},
  ];

  function limitedColsUpToLibras(){
    const idx = COLS_ALL.findIndex(c => c.key === "guiaLbs");
    const cut = (idx >= 0) ? COLS_ALL.slice(0, idx+1) : COLS_ALL.slice();
    return cut.filter(c => !c.action);
  }

  function getActiveCols(){
    if(role === "admin") return COLS_ALL;
    if(role === "viewer_full"){
      return COLS_ALL.filter(c=>!c.action).map(c=> c.editable ? ({...c, editable:false}) : c);
    }
    const base = limitedColsUpToLibras();
    if(role === "editor_limited"){
      // âœ… Yanela: hasta LIBRAS + MODIFICAR + QUITAR
      const actions = COLS_ALL.filter(c=>c.action);
      return [...base, ...actions];
    }
    return base.map(c=> c.editable ? ({...c, editable:false}) : c);
  }

  function buildHeader(){
    const COLS = getActiveCols();
    const tr = document.createElement("tr");

    COLS.forEach((c)=>{
      const th = document.createElement("th");
      th.style.width = c.w+"px";
      th.dataset.key = c.key;

      if(["guiaLbs","promedio","planta","pesoCola","basura","liquidando","rend"].includes(c.key)){
        th.classList.add("num-right");
      }

      const wrap = document.createElement("div");
      wrap.className = "filter-ui";

      const title = document.createElement("div");
      title.style.flex = "1 1 auto";
      title.style.minWidth = "0";
      title.textContent = c.label;

      const fbtn = document.createElement("div");
      fbtn.className = "filter-btn";
      fbtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M3 5h18l-7 8v6l-4 2v-8L3 5z"/></svg>`;

      const pop = document.createElement("div");
      pop.className = "filter-pop";
      pop.innerHTML = `
        <input placeholder="Filtrar ${c.label}..." />
        <div class="mini">
          <button data-act="clear">Limpiar</button>
          <button data-act="ok">Aplicar</button>
        </div>
      `;

      const inp = pop.querySelector("input");
      inp.value = colFilters[c.key] || "";
      inp.addEventListener("input", ()=>{
        colFilters[c.key] = inp.value.trim();
        render();
      });
      fbtn.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        document.querySelectorAll(".filter-pop").forEach(p=>{ if(p!==pop) p.style.display="none"; });
        pop.style.display = (pop.style.display==="block") ? "none" : "block";
        inp.focus(); inp.select();
      });
      pop.addEventListener("click", (ev)=>ev.stopPropagation());
      pop.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.dataset.act;
          if(act==="clear"){ inp.value=""; colFilters[c.key]=""; }
          else colFilters[c.key]=inp.value.trim();
          pop.style.display="none";
          render();
        });
      });

      th.appendChild(pop);
      wrap.appendChild(fbtn);
      wrap.insertBefore(title, wrap.firstChild);
      th.appendChild(wrap);
      tr.appendChild(th);
    });

    thead.innerHTML = "";
    thead.appendChild(tr);

    document.addEventListener("click", ()=> {
      document.querySelectorAll(".filter-pop").forEach(p=>p.style.display="none");
    }, {once:true});
  }

  function computeRow(r){
    const g = num(r.gramo);
    const talla = (g==null) ? null : (454/(g*0.66));
    const pc = num(r.pesoCola);
    const ba = num(r.basura);
    const planta = (pc==null || ba==null) ? null : (pc/0.66);
    const liq = num(r.liquidando);
    const pro = num(r.promedio);
    const rend = (liq==null || pro==null || ba==null) ? null : (liq/(pro - ba));
    return {...r, talla, planta, rend};
  }

  function applyFilters(rows){
    let out = rows.slice();

    // ===== FILTRO POR SECUENCIAL (PRESENTAR TABLA) =====
    let d = num(filtros.desde.value);
    let h = num(filtros.hasta.value);
    if(d!=null && h!=null && d>h){
      const tmp = d; d = h; h = tmp;
    }
    if(d!=null) out = out.filter(r => (num(r.secuencial) ?? 0) >= d);
    if(h!=null) out = out.filter(r => (num(r.secuencial) ?? 0) <= h);

    // ===== FILTROS POR COLUMNA (Excel-like) =====
    out = out.filter(r=>{
      const COLS = getActiveCols();
      for(const c of COLS){
        const f = (colFilters[c.key]||"").trim().toLowerCase();
        if(!f) continue;
        const v = safeStr(r[c.key]).toLowerCase();
        if(!v.includes(f)) return false;
      }
      return true;
    });

    return out;
  }

  function updateSummary(visibleRows){
    const sum = (key)=> visibleRows.reduce((a,r)=> a + (num(r[key])||0), 0);

    const librasRem = sum("guiaLbs");
    const colaAprox = librasRem * 0.66;
    const pesoCola = sum("pesoCola");
    const pesoPlanta = (pesoCola ? (pesoCola/0.66) : 0);
    const liquidado = sum("liquidando");
    const rendTotal = (pesoPlanta>0) ? (liquidado/pesoPlanta) : 0;

    m3_librasRem.textContent = nf2.format(librasRem);
    m4_colaAprox.textContent = nf2.format(colaAprox);
    m7_pesoCola.textContent = nf2.format(pesoCola);
    m6_pesoPlanta.textContent = nf2.format(pesoPlanta);
    m9_liquidado.textContent = nf2.format(liquidado);
    m10_rendTotal.textContent = nf2.format(rendTotal*100) + "%";
  }

  const _saveTimers = new Map();
  function scheduleSaveFromInput(inp){
    if(!(role === "editor_limited" && canEdit)) return;
    const sec = inp?.dataset?.secuencial;
    if(!sec) return;
    const tr = inp.closest("tr");
    if(!tr) return;
    if(_saveTimers.has(sec)) clearTimeout(_saveTimers.get(sec));
    _saveTimers.set(sec, setTimeout(async ()=>{
      _saveTimers.delete(sec);
      try{ await saveRowFromDOM(tr, sec); }catch(e){}
    }, 600));
  }

  function render(){
    const COLS = getActiveCols();
    rowsVisible = applyFilters(rowsAll).map(computeRow);
    updateSummary(rowsVisible);

    tbody.innerHTML = "";
    rowsVisible.forEach((r, rowIndex)=>{
      const tr = document.createElement("tr");
      tr.classList.toggle("row-editing", !!r._editing);

      // ===== Reglas de color por fila =====
      const liqVal = num(r.liquidando);
      const colaVal = num(r.pesoCola);

      tr.classList.remove("row-liq-1a3","row-liq-gt3","row-cola-sinliq");

      if(liqVal != null){
        if(liqVal >= 1 && liqVal <= 3){
          tr.classList.add("row-liq-1a3");
        }else if(liqVal > 3){
          tr.classList.add("row-liq-gt3");
        }
      }else{
        if((colaVal || 0) > 0){
          tr.classList.add("row-cola-sinliq");
        }
      }

      COLS.forEach((c, colIndex)=>{
        const td = document.createElement("td");

        if(c.action==="edit"){
          const wrap = document.createElement("div");
          wrap.className = "chk";
          wrap.style.height="26px";
          const chk = document.createElement("input");
          chk.type="checkbox";
          chk.checked = !!r._editing;
          chk.addEventListener("change", async ()=>{
            if((role !== "admin" && role !== "editor_limited") || !canEdit){ chk.checked = false; return; }
            r._editing = chk.checked;
            tr.classList.toggle("row-editing", !!r._editing);
            tr.querySelectorAll("input[data-editable='1']").forEach(inp=> inp.disabled = !r._editing);
            if(!r._editing) await saveRowFromDOM(tr, r.secuencial);
          });
          wrap.appendChild(chk);
          td.appendChild(wrap);
        }
        else if(c.action==="delete"){
          const a = document.createElement("span");
          a.className="del";
          a.textContent="Eliminar";
          a.addEventListener("click", async ()=>{
            if(!((role === "admin" || role === "editor_limited") && allowDeleteRow)) return;
            if(!confirm("Â¿Eliminar esta fila?")) return;
            await deleteDoc(doc(db, "programacion", String(r.secuencial)));
          });
          td.appendChild(a);
        }
        else{
          const inp = document.createElement("input");
          inp.className="cell-in";
          inp.dataset.key = c.key;
          inp.dataset.secuencial = String(r.secuencial);
          inp.dataset.row = String(rowIndex);
          inp.dataset.col = String(colIndex);

          if(c.key==="pisc" || c.key==="guiaNum"){
            inp.type = "text";
            inp.inputMode = "latin";
            inp.autocapitalize = "characters";
            inp.autocomplete = "off";
            inp.addEventListener("input", ()=>{
              inp.value = inp.value.toUpperCase().replace(/[^0-9A-Z-]/g, "");
            });
          }

          if(c.key==="secuencial"){
            inp.type = "text";
            inp.inputMode = "numeric";
            inp.autocomplete = "off";
            inp.addEventListener("input", ()=>{ inp.value = inp.value.replace(/\D/g, ""); });
          }

          const _rightKeys = ["guiaLbs","promedio","planta","pesoCola","basura","liquidando","rend"];
          if(_rightKeys.includes(c.key)){
            inp.classList.add("num-right");
          }

          const _numKeys = ["gramo","guiaLbs","promedio","pesoCola","basura","liquidando"];
          if(_numKeys.includes(c.key)){
            inp.type = "text";
            inp.inputMode = "decimal";
            inp.autocomplete = "off";
            inp.addEventListener("input", ()=>{
              let s = inp.value;
              s = s.replace(/[^0-9.,]/g, "");
              const parts = s.split(",");
              if(parts.length > 2) s = parts[0] + "," + parts.slice(1).join("");
              inp.value = s;
            });
            inp.addEventListener("blur", ()=>{
              const s = inp.value.trim();
              if(s && !s.includes(",") && (s.match(/\./g)||[]).length===1 && /^\d+\.\d{1,2}$/.test(s)){
                inp.value = s.replace(".", ",");
              }
            });
          }

          let v = r[c.key];
          if(c.key==="rend" && r.rend!=null) v = nf2.format(r.rend*100) + "%";
          else if((c.key==="talla" || c.key==="planta") && v!=null) v = nf2.format(v);
          else if(c.key==="fecha") v = fmtFecha(v);
          else if(["gramo","guiaLbs","promedio","pesoCola","basura","liquidando"].includes(c.key) && v!=="" && v!=null){
            const n = num(v); v = (n==null) ? "" : nf2.format(n);
          } else v = safeStr(v);

          inp.value = v;

          if(c.editable){
            inp.dataset.editable="1";
            if(role === "admin") inp.disabled = !(canEdit && !!r._editing);
            else if(role === "editor_limited") inp.disabled = !(canEdit && !!r._editing);
            else inp.disabled = true;
            inp.addEventListener("blur", ()=> scheduleSaveFromInput(inp));
            inp.addEventListener("change", ()=> scheduleSaveFromInput(inp));
          } else {
            inp.disabled = true;
          }

          td.appendChild(inp);
        }
        tr.appendChild(td);
      });

      tbody.appendChild(tr);

      if(role === "admin"){
        tr.querySelectorAll("input[data-editable='1']").forEach(inp=> inp.disabled = true);
      }
    });
  }

  async function saveRowFromDOM(tr, secuencial){
    if(!canEdit) return;
    const docId = String(secuencial);

    const data = {};
    COLS_ALL.forEach(c=>{
      if(c.action) return;
      if(c.computed) return;
      const inp = tr.querySelector(`input.cell-in[data-key='${c.key}']`);
      if(!inp) return;
      data[c.key] = inp.value;
    });

    const toNumFields = ["oc","bines","gramo","guiaLbs","promedio","pesoCola","basura","liquidando"];
    toNumFields.forEach(k=>{
      if(data[k]===undefined) return;
      const n = num(data[k]);
      data[k] = (n==null) ? null : n;
    });

    try{ await updateDoc(doc(db, "programacion", docId), data); }
    catch(_){ await setDoc(doc(db, "programacion", docId), data, {merge:true}); }
  }

  async function addRowFromForm(){
    if(!canEdit) return;
    const sec = num(inputs.secuencial.value);
    if(sec==null) return;

    const d = new Date();
    const data = {
      hora: inputs.hora.value || hm(d),
      fecha: fmtFecha(inputs.fecha.value || ymd(d)),
      proveedor: inputs.proveedor.value.trim(),
      oc: num(inputs.oc.value),
      pisc: inputs.pisc.value.trim(),
      guiaNum: inputs.guia.value.trim(),
      bines: num(inputs.bines.value),
      sector: inputs.sector.value.trim(),
      lote: inputs.lote.value,
      secuencial: sec,
      gramo: null,
      guiaLbs: num(inputs.libras.value),
      promedio: null,
      pesoCola: null,
      basura: null,
      liquidando: null,
      createdAt: Date.now()
    };

    await setDoc(doc(db, "programacion", String(sec)), data, {merge:true});
  }

  function resetIngresarForNext(){
    const d = new Date();
    if(inputs.hora) inputs.hora.value = hm(d);
    if(inputs.fecha && !String(inputs.fecha.value||'').trim()) inputs.fecha.value = fmtFecha(ymd(d));

    if(inputs.proveedor) inputs.proveedor.value = '';
    if(inputs.oc) inputs.oc.value = '';
    if(inputs.pisc) inputs.pisc.value = '';
    if(inputs.guia) inputs.guia.value = '';
    if(inputs.bines) inputs.bines.value = '';
    if(inputs.sector) inputs.sector.value = '';
    if(inputs.secuencial) inputs.secuencial.value = '';
    if(inputs.libras) inputs.libras.value = '';

    inputs.hora?.focus();
    inputs.hora?.select?.();
  }

  function subscribeProgramacion(){
    if(unsubProgram) unsubProgram();
    unsubProgram = onSnapshot(query(collection(db,"programacion"), orderBy("secuencial","asc")), (snap)=>{
      const out = [];
      snap.forEach(d=>{
        if(d.id==="__config__") return;
        const v = d.data() || {};
        out.push({
          hora: v.hora ?? "",
          fecha: v.fecha ?? "",
          proveedor: v.proveedor ?? "",
          oc: v.oc ?? null,
          pisc: v.pisc ?? null,
          guiaNum: v.guiaNum ?? null,
          bines: v.bines ?? null,
          sector: v.sector ?? "",
          lote: v.lote ?? "",
          secuencial: (num(v.secuencial) ?? num(d.id) ?? null),
          gramo: v.gramo ?? null,
          guiaLbs: v.guiaLbs ?? null,
          promedio: v.promedio ?? null,
          pesoCola: v.pesoCola ?? null,
          basura: v.basura ?? null,
          liquidando: v.liquidando ?? null,
          _editing:false
        });
      });
      rowsAll = out.sort((a,b)=>(num(a.secuencial)||0)-(num(b.secuencial)||0));
      render();
    });
  }

  // ===== Lotes (CREAR tab) =====
  async function renderLotes(list){
    const body = $("lotesBody");
    if(!body) return;
    body.innerHTML = "";

    if(!(role === "admin" || role === "editor_limited" || role === "viewer_full")) return;

    if(role === "viewer_full"){
      list.forEach((x, idx)=>{
        const tr = document.createElement("tr");

        const td1 = document.createElement("td");
        td1.innerHTML = `<input class="cell-in" disabled value="${idx+1}" />`;
        tr.appendChild(td1);

        const td2 = document.createElement("td");
        td2.innerHTML = `<input class="cell-in" disabled value="${(x.lote||"").replace(/"/g,'&quot;')}" />`;
        tr.appendChild(td2);

        const td3 = document.createElement("td");
        td3.innerHTML = `<input class="cell-in" disabled value="-" />`;
        tr.appendChild(td3);

        body.appendChild(tr);
      });
      return;
    }

    const all = list.slice();
    all.push({id:"__new__", lote:""});

    all.forEach((x, idx)=>{
      const tr = document.createElement("tr");

      const td1 = document.createElement("td");
      td1.innerHTML = `<input class="cell-in" disabled value="${idx+1}" />`;
      tr.appendChild(td1);

      const td2 = document.createElement("td");
      const inp = document.createElement("input");
      inp.className="cell-in";
      inp.value = x.lote || "";
      inp.addEventListener("keydown", async (e)=>{
        if(e.key !== "Enter") return;
        e.preventDefault();
        const val = (inp.value || "").trim();
        if(!val) return;
        try{
          if(x.id === "__new__"){
            await addDoc(collection(db,"lotes"), {lote: val, createdAt: Date.now()});
            inp.value = "";
          }else{
            await updateDoc(doc(db,"lotes", x.id), {lote: val});
          }
          inp.blur();
        }catch(err){
          console.error(err);
          alert("No se pudo guardar el lote (permisos o conexiÃ³n).");
        }
      });
      td2.appendChild(inp);
      tr.appendChild(td2);

      const td3 = document.createElement("td");
      if(x.id !== "__new__"){
        const a = document.createElement("span");
        a.className="del";
        a.textContent="Eliminar";
        a.addEventListener("click", async ()=>{
          if(!confirm("Â¿Eliminar este lote?")) return;
          try{
            await deleteDoc(doc(db,"lotes", x.id));
          }catch(err){
            console.error(err);
            alert("No se pudo eliminar el lote (permisos o conexiÃ³n).");
          }
        });
        td3.appendChild(a);
      }else{
        td3.innerHTML = `<input class="cell-in" disabled value="" />`;
      }
      tr.appendChild(td3);

      body.appendChild(tr);
    });
  }

  function subscribeLotes(){
    if(unsubLotes) unsubLotes();
    unsubLotes = onSnapshot(query(collection(db,"lotes"), orderBy("createdAt","asc")), (snap)=>{
      const list = [];
      snap.forEach(d=>{
        const v = d.data() || {};
        list.push({id:d.id, lote: v.lote || ""});
      });
      if(inputs.lote){
        inputs.lote.innerHTML = "";
        list.forEach(x=>{
          const op = document.createElement("option");
          op.value = x.lote;
          op.textContent = x.lote;
          inputs.lote.appendChild(op);
        });
        // âœ… Pintar tabla de LOTES en pestaÃ±a CREAR
        renderLotes(list);
      }
    });
  }

  async function generatePDF(){
    const { jsPDF } = window.jspdf;

    const COLORS = {
      pageBg: [255,255,255],
      text: [17,24,39],
      muted: [55,65,81],
      head: [43,58,89],
      grid: [190,195,205],
      row: [255,255,255],
      section: [238,242,247],
    };

    const docPDF = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
    const W = docPDF.internal.pageSize.getWidth();
    const H = docPDF.internal.pageSize.getHeight();

    docPDF.setFillColor(...COLORS.pageBg);
    docPDF.rect(0, 0, W, H, "F");

    async function loadLogoDataURL(){
      try{
        const res = await fetch("logo.png", { cache: "no-store" });
        const blob = await res.blob();
        const data = await new Promise((resolve, reject)=>{
          const rd = new FileReader();
          rd.onload = ()=>resolve(rd.result);
          rd.onerror = reject;
          rd.readAsDataURL(blob);
        });
        const dim = await new Promise((resolve, reject)=>{
          const img = new Image();
          img.onload = ()=>resolve({w: img.naturalWidth || img.width, h: img.naturalHeight || img.height});
          img.onerror = reject;
          img.src = data;
        });
        return { data, ...dim };
      }catch(e){
        return null;
      }
    }

    const logo = await loadLogoDataURL();

    const headerY1 = 46;
    const headerY2 = 66;
    const headerY3 = 80;

    const drawHeader = (clearPage = false)=>{
      if(clearPage){
        docPDF.setFillColor(...COLORS.pageBg);
        docPDF.rect(0, 0, W, H, "F");
      }

      let xTitle = 40;

      if(logo?.data){
        const targetH = 38;
        const targetW = (logo.w && logo.h) ? (targetH * (logo.w / logo.h)) : 90;
        docPDF.addImage(logo.data, "PNG", 40, 18, targetW, targetH);
        xTitle = 40 + targetW + 10;
      }

      docPDF.setFont("helvetica","bold");
      docPDF.setFontSize(12);
      docPDF.setTextColor(...COLORS.text);
      docPDF.text("SISTEMA DE PROGRAMACIÃ“N DIARIO DE PLANTA", xTitle, headerY1);

      docPDF.setFont("helvetica","normal");
      docPDF.setFontSize(9);
      docPDF.setTextColor(...COLORS.muted);
      docPDF.text(`Usuario: ${currentUser?.email || ""} (${roleLabel(role)})`, 40, headerY2);
      docPDF.text(`Fecha/Hora: ${nowText()}`, 40, headerY3);

      docPDF.setTextColor(...COLORS.text);
    };

    drawHeader(true);

    const stripFormattedInt = (val)=>{
      if(val==null) return "";
      const s = String(val).trim();
      if(!s) return "";
      if(/[A-Za-z]/.test(s) || s.includes("-")) return s;

      if(s.includes(",") && s.includes(".")){
        if(s.lastIndexOf(",") > s.lastIndexOf(".")){
          return s.split(",")[0].replace(/\./g, "");
        }
        return s.split(".")[0].replace(/,/g, "");
      }
      if(s.includes(",")) return s.split(",")[0].replace(/\./g, "");
      if(s.includes(".")){
        const parts = s.split(".");
        if(parts.length > 2 || (parts.length === 2 && parts[1].length === 3)) return s.replace(/\./g, "");
        return parts[0];
      }
      return s;
    };

    const stripIntOnly = (val)=>{
      const t = stripFormattedInt(val);
      const m = t.match(/\d+/);
      return m ? m[0] : t;
    };

    const controlRows = [
      ["LIBRAS REMITIDAS", (document.getElementById("m3_librasRem")?.textContent || "0,00")],
      ["COLA APROXIMADA", (document.getElementById("m4_colaAprox")?.textContent || "0,00")],
      ["PESO PLANTA", (document.getElementById("m6_pesoPlanta")?.textContent || "0,00")],
      ["PESO COLA", (document.getElementById("m7_pesoCola")?.textContent || "0,00")],
      ["LIQUIDADO", (document.getElementById("m9_liquidado")?.textContent || "0,00")],
      ["RENDIMIENTO", (document.getElementById("m10_rendTotal")?.textContent || "0,00%")],
    ];

    const r1 = document.getElementById("e7_rango")?.value || "";
    const r2 = document.getElementById("e8_rango")?.value || "";
    const rB = document.getElementById("e12_todas")?.value || "";
    const a1 = document.getElementById("h7_impA1")?.value || "";
    const a2 = document.getElementById("h8_impA2")?.value || "";
    const b1 = document.getElementById("h12_impB")?.value || "";

    const startYBoxes = 102;
    const usableW = W - 80;
    const leftW = 300;
    const gap = 18;
    const rightW = usableW - leftW - gap;

    docPDF.autoTable({
      startY: startYBoxes,
      theme: "grid",
      margin: { left: 40, top: startYBoxes },
      tableWidth: leftW,
      head: [["CONTROL", "VALOR"]],
      body: controlRows,
      styles: { fontSize: 7, cellPadding: 2, textColor: COLORS.text, lineColor: COLORS.grid, lineWidth: 0.5 },
      headStyles: { fillColor: COLORS.head, textColor: [255,255,255], fontStyle: "bold", fontSize: 7, lineColor: COLORS.grid, lineWidth: 0.7 },
      bodyStyles: { fillColor: COLORS.row },
      columnStyles: { 1: { halign: "right" } },
      willDrawPage: (data)=>{
        if(data.pageNumber > 1) drawHeader(true);
        else drawHeader(false);
      },
    });
    const yAfterControl = docPDF.lastAutoTable.finalY;

    docPDF.autoTable({
      startY: startYBoxes,
      theme: "grid",
      margin: { left: 40 + leftW + gap, top: startYBoxes },
      tableWidth: rightW,
      head: [["RANGO", "IMPORTADOR"]],
      body: [
        [{ content: 'IMPORTADORES CLASE "A"', colSpan: 2, styles: { fillColor: COLORS.section, textColor: COLORS.text, fontStyle: 'bold', halign: 'center' } }],
        [r1, a1],
        [r2, a2],
        [{ content: 'IMPORTADOR CLASE "B"', colSpan: 2, styles: { fillColor: COLORS.section, textColor: COLORS.text, fontStyle: 'bold', halign: 'center' } }],
        [rB, b1],
      ],
      styles: { fontSize: 7, cellPadding: 2, textColor: COLORS.text, lineColor: COLORS.grid, lineWidth: 0.5 },
      headStyles: { fillColor: COLORS.head, textColor: [255,255,255], fontStyle: "bold", fontSize: 7, lineColor: COLORS.grid, lineWidth: 0.7 },
      bodyStyles: { fillColor: COLORS.row },
      willDrawPage: (data)=>{
        if(data.pageNumber > 1) drawHeader(true);
        else drawHeader(false);
      },
    });
    const yAfterRangos = docPDF.lastAutoTable.finalY;

    const startYTable = Math.max(yAfterControl, yAfterRangos) + 10;

    const dataCols = getActiveCols().filter(c=>!c.action);

    const rightKeys = new Set(["guiaLbs","promedio","planta","pesoCola","basura","liquidando","rend"]);
    const colStyles = {};
    dataCols.forEach((c,i)=>{
      if(rightKeys.has(c.key)) colStyles[i] = { halign: "right" };
    });

    const head = [dataCols.map(c=>c.label)];
    const body = rowsVisible.map(r=>{
      const rr = computeRow(r);
      return dataCols.map(c=>{
        const key = c.key;
        if(key === "rend") return (rr.rend==null) ? "" : (nf2.format(rr.rend*100) + "%");
        if(key === "talla") return (rr.talla==null) ? "" : nf2.format(rr.talla);
        if(key === "planta") return (rr.planta==null) ? "" : nf2.format(rr.planta);
        if(key === "fecha") return fmtFecha(rr[key]);

        const v = rr[key];
        if(v==null) return "";

        if(key === "oc" || key === "pisc" || key === "guiaNum" || key === "secuencial") return stripFormattedInt(v);
        if(key === "bines") return stripIntOnly(v);

        if(typeof v === "number") return nf2.format(v);
        return String(v);
      });
    });

    docPDF.autoTable({
      startY: startYTable,
      head,
      body,
      theme: "grid",
      margin: { left: 40, right: 40, top: startYBoxes },
      styles: {
        fontSize: 7,
        cellPadding: 2,
        textColor: COLORS.text,
        lineColor: COLORS.grid,
        lineWidth: 0.6,
        valign: "middle",
        overflow: "ellipsize",
      },
      headStyles: {
        fillColor: COLORS.head,
        textColor: [255,255,255],
        fontStyle: "bold",
        lineColor: COLORS.grid,
        lineWidth: 0.8,
      },
      bodyStyles: {
        fillColor: COLORS.row,
        textColor: COLORS.text,
      },
      alternateRowStyles: {
        fillColor: COLORS.row,
      },
      columnStyles: colStyles,
      willDrawPage: function(data){
        if(data.pageNumber > 1) drawHeader(true);
        else drawHeader(false);
      },
    });

    docPDF.save(`Programacion_Oceantreasure_${nowText().replace(/[\/:, ]/g,"-")}.pdf`);
  }

  function setTab(name){
    if(name==="ENERO"){
      tabEnero.classList.add("active");
      tabCrear.classList.remove("active");
      viewEnero.classList.remove("hidden");
      viewCrear.classList.add("hidden");
    }else{
      tabCrear.classList.add("active");
      tabEnero.classList.remove("active");
      viewCrear.classList.remove("hidden");
      viewEnero.classList.add("hidden");
    }
  }
  tabEnero.onclick = ()=>setTab("ENERO");
  tabCrear.onclick = ()=>setTab("CREAR");

  btnLogin.addEventListener("click", doLogin);
  $("pass").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  $("email").addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("pass").focus(); });
  btnLogout.addEventListener("click", async ()=>{ await signOut(auth); });
  btnPDF.addEventListener("click", generatePDF);

  // Mantener render inmediato
  filtros.desde.addEventListener("input", ()=>render());
  filtros.hasta.addEventListener("input", ()=>render());

  inputs.libras.addEventListener("keydown", async (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      if(!canEdit) return;
      await addRowFromForm();
      resetIngresarForNext();
    }
  });

  function keepAlnumDashUpper(el){
    if(!el) return;
    el.addEventListener("input", ()=>{ el.value = el.value.toUpperCase().replace(/[^0-9A-Z-]/g, ""); });
  }
  keepAlnumDashUpper(inputs.pisc);
  keepAlnumDashUpper(inputs.guia);

  if(inputs.secuencial){
    inputs.secuencial.addEventListener("input", ()=>{ inputs.secuencial.value = inputs.secuencial.value.replace(/\D/g, ""); });
  }

  if(filtros.desde) filtros.desde.addEventListener("input", ()=>{ filtros.desde.value = filtros.desde.value.replace(/\D/g, ""); });
  if(filtros.hasta) filtros.hasta.addEventListener("input", ()=>{ filtros.hasta.value = filtros.hasta.value.replace(/\D/g, ""); });

  async function doLogin(){
    loginErr.textContent = "";
    const email = $("email").value.trim();
    const pass = $("pass").value;
    try{ await signInWithEmailAndPassword(auth, email, pass); }
    catch(err){ loginErr.textContent = (err?.message || "Error de login").replace("Firebase: ",""); }
  }

  function hideControlMetric(valId, hide){
    const v = document.getElementById(valId);
    if(!v) return;
    const k = v.previousElementSibling;
    if(k) k.style.display = hide ? "none" : "";
    v.style.display = hide ? "none" : "";
  }

  onAuthStateChanged(auth, async (u)=>{
    currentUser = u;
    if(!u){
      appView.classList.add("hidden");
      loginView.classList.remove("hidden");
      return;
    }

    role = getRoleByEmail(u.email);
    canEdit = (role === "admin" || role === "editor_limited");
    canEditConfig = (role === "admin");
    canUseCrearTab = (role === "admin" || role === "editor_limited" || role === "viewer_full");
    allowDeleteRow = (role === "admin" || role === "editor_limited");

    loginView.classList.add("hidden");
    appView.classList.remove("hidden");

    h3_user.textContent = u.email;
    h3_role.textContent = roleLabel(role);

    const d = new Date();
    inputs.hora.value = hm(d);
    inputs.fecha.value = fmtFecha(ymd(d));

    if(window.__clock) clearInterval(window.__clock);
    const tick = ()=>{ h4_now.textContent = nowText(); };
    tick();
    window.__clock = setInterval(tick, 1000);

    Object.values(inputs).forEach(el=>{ if(el) el.disabled = !canEdit; });
    filtros.desde.disabled = false;
    filtros.hasta.disabled = false;
    Object.values(rangeInputs).forEach(el=>{ if(el) el.disabled = !canEditConfig; });

    if(!canUseCrearTab){
      tabCrear.classList.add("hidden");
      viewCrear.classList.add("hidden");
      setTab("ENERO");
    }else{
      tabCrear.classList.remove("hidden");
    }

    const limited = (role === "editor_limited" || role === "viewer_limited");
    hideControlMetric("m6_pesoPlanta", limited);
    hideControlMetric("m7_pesoCola", limited);
    hideControlMetric("m9_liquidado", limited);
    hideControlMetric("m10_rendTotal", limited);

    buildHeader();
    subscribeProgramacion();
    subscribeLotes();
    initRangosPersist();
    initPresentarPersist(); // âœ… Persistencia DESDE/HASTA por usuario
  });
</script>
</body>
</html>
