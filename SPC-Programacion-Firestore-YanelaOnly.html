<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SISTEMA DE PROGRAMACI√ìN DIARIO DE PLANTA</title>

  <!--
    ‚úÖ LISTO PARA GITHUB PAGES + FIREBASE

    1) Crea un proyecto en Firebase y habilita:
       - Authentication > Email/Password
       - Firestore Database (modo producci√≥n)
    2) Agrega tu dominio de GitHub Pages en:
       Authentication > Settings > Authorized domains
    3) Pega tu firebaseConfig abajo (busca: const firebaseConfig = {...})
    4) Reglas Firestore recomendadas (solo 1 usuario):
       rules_version = '2';
       service cloud.firestore {
         match /databases/{database}/documents {
           function isAllowed() { return request.auth != null && request.auth.token.email == "yanelavinueza@oceantreasure.local"; }
           match /programacion/{docId} { allow read, write: if isAllowed(); }
           match /lotes/{docId} { allow read, write: if isAllowed(); }
         }
       }

    üîí Importante: NUNCA pongas contrase√±as en el c√≥digo. El usuario ingresa en el login.
  -->

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel2:#0b1326;
      --grid:#1f2a44;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#1d4ed8;
      --hdr:#2b3a59;
      --hdr2:#1b2740;
      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;
      --cell:#0e1a33;
      --white:#fff;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    .hidden{display:none !important}

    /* Login */
    .login-wrap{min-height:100vh;display:grid;place-items:center;padding:24px}
    .login-card{
      width:min(560px, 92vw);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .login-title{font-size:16px;font-weight:800;margin:0 0 8px}
    .login-sub{font-size:12px;opacity:.8;margin:0 0 14px}
    .row{display:flex;gap:10px;align-items:center;margin:10px 0}
    .row label{width:90px;font-size:12px;color:var(--muted)}
    .in{
      flex:1;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 10px;
      border-radius:8px;
      outline:none;
    }
    .btn{
      width:100%;
      margin-top:10px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(29,78,216,.95), rgba(29,78,216,.70));
      color:white;
      font-weight:800;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .err{margin-top:10px;color:#fecaca;font-size:12px;min-height:16px}

    /* App */
    header{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.22);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .h-left{display:flex;align-items:flex-end;gap:12px}
    .h-title{margin:0;font-size:18px;font-weight:900;letter-spacing:.3px}
    .h-mini{font-size:12px;color:var(--muted);margin:0 0 1px}
    .h-right{display:flex;align-items:center;gap:10px}
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--text);
      white-space:nowrap;
    }
    .linkbtn{
      font-size:12px;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
    }

    /* Excel-like sheet area */
    .sheet{padding:12px 12px 0}
    .top-grid{
      display:grid;
      grid-template-columns: 320px 460px 360px 250px;
      gap:12px;
      align-items:start;
    }
    .box{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:10px;
      overflow:hidden;
    }
    .box .box-h{
      background:rgba(255,255,255,.04);
      padding:8px 10px;
      font-weight:900;
      font-size:13px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    .box .box-b{padding:10px}

    /* Ingresar panel (left) */
    .form-grid{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:6px 10px;
      align-items:center;
    }
    .lab{font-size:12px;color:var(--text)}
    .cell{
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      padding:6px 8px;
      border-radius:6px;
      color:var(--text);
      outline:none;
      height:28px;
      font-size:12px;
      width:100%;
    }
    .cell:focus{border-color:rgba(59,130,246,.55);box-shadow:0 0 0 2px rgba(59,130,246,.18)}
    select.cell{appearance:auto}

    /* Middle area */
    .mid-wrap{display:grid;gap:12px}
    .auth-row{
      display:flex;justify-content:center;gap:24px;flex-wrap:wrap;
      padding:8px 10px;border-radius:10px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
    }
    .auth-item{font-size:12px}
    .auth-item b{font-weight:900}
    .ranges{padding:8px 10px 10px}
.ranges-grid{display:grid;grid-template-columns:1fr 2fr;gap:8px 10px;align-items:center}
.ranges-grid .hdr{font-weight:900;font-size:12px;text-align:center;opacity:.92}
.ranges-grid .subhead{grid-column:1 / -1;font-weight:900;font-size:12px;text-align:center;opacity:.92;margin-top:6px}
#boxRangos .cell{width:100%}
    .ranges .title{
      grid-column:1/-1;
      font-weight:900;
      font-size:13px;
      text-align:center;
      padding:6px 0 8px;
    }
    .ranges .subhead{
      grid-column:1/-1;
      font-weight:900;
      font-size:12px;
      padding:6px 0;
      border-top:1px solid rgba(255,255,255,.06);
      margin-top:6px;
      text-align:center;
      opacity:.95;
    }

    /* Control box */
    .control-grid{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:6px 10px;
      align-items:center;
    }
    .val{
      text-align:right;
      font-variant-numeric:tabular-nums;
      padding:2px 0;
      font-size:12px;
    }
    .k{font-size:12px;color:var(--text)}
    .k b{font-weight:900}

    /* Right present box */
    .present-grid{
      display:grid;
      grid-template-columns: 70px 1fr;
      gap:8px 10px;
      align-items:center;
    }
    .pdf-btn{
      margin-top:10px;
      width:100%;
      height:34px;
      border-radius:4px;
      background:#e5e7eb;
      color:#111827;
      border:1px solid rgba(0,0,0,.25);
      font-weight:900;
      cursor:pointer;
    }

    /* Table */
    .table-wrap{
      margin-top:12px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:10px;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }
    thead th{
      position:relative;
      background:linear-gradient(180deg, var(--hdr), var(--hdr2));
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:6px 8px 6px 8px;
      font-size:12px;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    tbody td{
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.10);
      padding:0;
    }
    tbody tr:nth-child(even) td{background:rgba(0,0,0,.14)}
    .cell-in{
      width:100%;
      height:26px;
      border:0;
      background:transparent;
      color:var(--text);
      padding:3px 6px;
      outline:none;
      font-size:12px;
      font-variant-numeric:tabular-nums;
    }
    .cell-in[disabled]{color:rgba(229,231,235,.88)}
    .cell-in:focus{outline:2px solid rgba(59,130,246,.25);background:rgba(59,130,246,.08)}

    /* Header filter (Excel-like) */
    .filter-ui{
      display:flex;align-items:center;gap:6px;
    }
    .filter-btn{
      width:16px;height:16px;flex:0 0 16px;
      border-radius:3px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      display:grid;place-items:center;
      cursor:pointer;
      opacity:.9;
    }
    .filter-btn svg{width:11px;height:11px;fill:rgba(255,255,255,.85)}
    .filter-pop{
      position:absolute;
      top:100%;
      left:0;
      z-index:20;
      width:220px;
      background:#0b1220;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 14px 30px rgba(0,0,0,.45);
      border-radius:10px;
      padding:10px;
      display:none;
    }
    .filter-pop input{
      width:100%;
      height:28px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:6px 8px;
      outline:none;
      font-size:12px;
    }
    .filter-pop .mini{
      margin-top:8px;
      display:flex;gap:8px;justify-content:flex-end
    }
    .mini button{
      height:28px;
      padding:0 10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      font-weight:800;
    }

    /* Column resizer */
    .resizer{
      position:absolute;top:0;right:0;height:100%;width:6px;
      cursor:col-resize;
      user-select:none;
    }
    .resizer:after{
      content:"";
      position:absolute;top:0;right:2px;height:100%;width:1px;
      background:rgba(255,255,255,.14);
      opacity:.35;
    }

    /* Actions */
    .chk{display:grid;place-items:center}
    .del{
      color:#93c5fd;
      cursor:pointer;
      font-size:12px;
      text-decoration:underline;
      padding:3px 6px;
      display:inline-block;
    }
    .del:hover{color:#bfdbfe}

    /* Sheet tabs (bottom) */
    .tabs{
      display:flex;gap:6px;
      padding:10px 12px;
      align-items:center;
      border-top:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
      position:sticky;
      bottom:0;
    }
    .tab{
      padding:8px 14px;
      border-radius:10px 10px 0 0;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      opacity:.9;
    }
    .tab.active{
      background:rgba(255,255,255,.12);
      opacity:1;
      border-bottom-color:transparent;
    }

    /* Crear tab */
    .crear-grid{
      display:grid;
      grid-template-columns: 520px 1fr;
      gap:12px;
      align-items:start;
    }
    .simple-table th, .simple-table td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:0;
      background:rgba(0,0,0,.10);
    }
    .simple-table th{
      background:linear-gradient(180deg, var(--hdr), var(--hdr2));
      padding:6px 8px;
      font-size:12px;
      text-align:left;
    }

    @media (max-width: 1050px){
      .top-grid{grid-template-columns:1fr}
      .crear-grid{grid-template-columns:1fr}
    }
  

    .topbox{height:330px}
    .topbox .box-b{max-height: calc(330px - 34px); overflow:auto}
    /* angosto visual */
    .top-grid{align-items:stretch}
    

    .ranges{gap:8px}
    .ranges .lab{width:110px}
    .control-grid{grid-template-columns: 180px 1fr}
    </style>

  <!-- PDF libs (global) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>
</head>

<body>

<!-- LOGIN -->
<section id="loginView" class="login-wrap">
  <div class="login-card">
    <p class="login-title">OCEANTREASURE | Login</p>
    <p class="login-sub">Acceso en la nube (Firebase). Ingrese correo y contrase√±a.</p>

    <div class="row">
      <label>Usuario</label>
      <input id="email" class="in" type="email" autocomplete="username" />
    </div>
    <div class="row">
      <label>Clave</label>
      <input id="pass" class="in" type="password" autocomplete="current-password" />
    </div>

    <button id="btnLogin" class="btn">INGRESAR</button>
    <div id="loginErr" class="err"></div>
  </div>
</section>

<!-- APP -->
<section id="appView" class="hidden">
  <header>
    <div class="h-left">
      <div>
        <p class="h-mini">Oceantreasure</p>
        <h1 class="h-title">SISTEMA DE PROGRAMACI√ìN DIARIO DE PLANTA</h1>
      </div>
    </div>
    <div class="h-right">
      <span id="pillUser" class="pill">Usuario: <b id="h3_user">‚Äî</b></span>
      <span id="pillNow" class="pill">Fecha: <b id="h4_now">‚Äî</b></span>
      <button id="btnLogout" class="linkbtn">Salir</button>
    </div>
  </header>

  <div class="sheet">
    <!-- TAB: ENERO -->
    <div id="viewEnero">
      <div class="top-grid">
        <!-- INGRESAR -->
        <div class="box topbox">
          <div class="box-h">INGRESAR</div>
          <div class="box-b">
            <div class="form-grid" id="formIngresar">
              <div class="lab">Hora:</div><input class="cell" id="c3_hora" type="time" />
              <div class="lab">Fecha:</div><input class="cell" id="c4_fecha" type="text" placeholder="dd-mmm" inputmode="latin" />
              <div class="lab">Proveedor:</div><input class="cell" id="c5_proveedor" />
              <div class="lab">OCK:</div><input class="cell" id="c6_oc" inputmode="numeric" />
              <div class="lab">Piscina:</div><input class="cell" id="c7_pisc" inputmode="numeric" />
              <div class="lab">Gu√≠as:</div><input class="cell" id="c8_guia" inputmode="numeric" />
              <div class="lab">Bines:</div><input class="cell" id="c9_bines" inputmode="numeric" />
              <div class="lab">Sector:</div><input class="cell" id="c10_sector" />
              <div class="lab">Lote:</div>
              <select class="cell" id="c11_lote"></select>
              <div class="lab">Secuencial:</div><input class="cell" id="c12_secuencial" inputmode="numeric" />
              <div class="lab">Libras:</div><input class="cell" id="c13_libras" inputmode="decimal" />
            </div>
          </div>
        </div>

        <!-- MID (reubicado en columnas) -->
<!-- RANGOS / IMPORTADORES -->
        <div class="topbox" id="boxRangos">
          <div class="box-title">RANGOS / IMPORTADORES</div>
          <div class="ranges">
            <div class="ranges-grid">
              <div class="hdr">Rango</div>
              <div class="hdr">Importadores Clase "A"</div>

              <input class="cell" id="e7_rango" />
              <input class="cell" id="h7_impA1" />

              <input class="cell" id="e8_rango" />
              <input class="cell" id="h8_impA2" />

              <div class="subhead">Importador Clase "B"</div>

              <input class="cell" id="e12_todas" />
              <input class="cell" id="h12_impB" />
            </div>
          </div>
        </div>

        <!-- CONTROL -->
        <div class="box topbox">
            <div class="box-h">CONTROL</div>
            <div class="box-b">
              <div class="control-grid">
                <div class="k"><b>LIBRAS REMITIDAS:</b></div><div class="val" id="m3_librasRem">0,00</div>
                <div class="k"><b>COLA APROXIMADA:</b></div><div class="val" id="m4_colaAprox">0,00</div>
                <div style="height:4px"></div><div></div>
                <div class="k"><b>PESO PLANTA:</b></div><div class="val" id="m6_pesoPlanta">0,00</div>
                <div class="k"><b>PESO COLA:</b></div><div class="val" id="m7_pesoCola">0,00</div>
                <div style="height:4px"></div><div></div>
                <div class="k"><b>LIQUIDADO:</b></div><div class="val" id="m9_liquidado">0,00</div>
                <div class="k"><b>RENDIMIENTO:</b></div><div class="val" id="m10_rendTotal">0,00%</div>
              </div>
            </div>
          </div>

<!-- PRESENTAR TABLA -->
        <div class="box topbox">
          <div class="box-h">PRESENTAR TABLA</div>
          <div class="box-b">
            <div class="present-grid">
              <div class="lab">Desde:</div><input class="cell" id="q3_desde" inputmode="numeric" />
              <div class="lab">Hasta:</div><input class="cell" id="q4_hasta" inputmode="numeric" />
            </div>
            <button id="btnPDF" class="pdf-btn">GENERAR PDF</button>
          </div>
        </div>
      </div>

      <!-- TABLE -->
      <div class="table-wrap">
        <div style="overflow:auto;max-height:58vh">
          <table id="tbl">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: CREAR -->
    <div id="viewCrear" class="hidden">
      <div class="crear-grid">
        <div class="box">
          <div class="box-h">CREAR | LOTES</div>
          <div class="box-b">
            <div style="font-size:12px;color:var(--muted);margin-bottom:8px">
              Agrega/edita lotes directamente como en Excel. Enter = guardar.
            </div>

            <div style="overflow:auto;max-height:70vh;border:1px solid rgba(255,255,255,.08);border-radius:10px">
              <table class="simple-table" style="width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed">
                <thead>
                  <tr>
                    <th style="width:70px">#</th>
                    <th>Lote</th>
                    <th style="width:90px">Quitar</th>
                  </tr>
                </thead>
                <tbody id="lotesBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="box-h">CREAR | NOTAS</div>
          <div class="box-b" style="font-size:12px;color:var(--muted);line-height:1.35">
            - El selector de <b>Lote</b> en ENERO toma los lotes de esta pesta√±a.<br/>
            - Todo se guarda en Firestore y se comparte entre dispositivos.<br/>
            - No se agregan botones extra (solo edici√≥n tipo Excel).
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bottom tabs -->
  <div class="tabs">
    <div class="tab active" id="tabEnero">ENERO</div>
    <div class="tab" id="tabCrear">CREAR</div>
  </div>
</section>

<script type="module">
  // ===== Firebase SDK (modular) =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, updateDoc, deleteDoc,
    collection, query, orderBy, onSnapshot, getDocs, addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ===== 1) PEGA TU CONFIG AQU√ç =====
  const firebaseConfig = {
    apiKey: "PON_TU_API_KEY",
    authDomain: "PON_TU_AUTH_DOMAIN",
    projectId: "PON_TU_PROJECT_ID",
    storageBucket: "PON_TU_STORAGE_BUCKET",
    messagingSenderId: "PON_TU_SENDER_ID",
    appId: "PON_TU_APP_ID"
  };

  // Usuario permitido (login √∫nico)
  const ALLOWED_EMAIL = "yanelavinueza@oceantreasure.local";

  // ===== Helpers =====
  const $ = (id)=>document.getElementById(id);
  const nf2 = new Intl.NumberFormat("es-EC", {minimumFractionDigits:2, maximumFractionDigits:2});
  const nf0 = new Intl.NumberFormat("es-EC", {maximumFractionDigits:0});

  function nowText(){
    const d = new Date();
    return d.toLocaleString("es-EC", {year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});
  }
  function ymd(d){
    const z = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
  }
  function hm(d){
    const z = n => String(n).padStart(2,"0");
    return `${z(d.getHours())}:${z(d.getMinutes())}`;
  }
  function num(x){
    if(x===null||x===undefined||x==="") return null;
    const v = String(x).replace(/\./g,"").replace(",",".");
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function safeStr(x){ return (x===null||x===undefined) ? "" : String(x); }

  // Fecha: muestra como dd-mmm (ej: 04-ene)
  const MONTHS_ES = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
  function fmtFecha(x){
    const s = safeStr(x).trim();
    if(!s) return "";
    // ya viene como 04-ene
    const m0 = /^\d{1,2}-[a-zA-Z√±√ë]{3}$/.exec(s);
    if(m0){
      const [dd,mmm] = s.split("-");
      return String(dd).padStart(2,"0")+"-"+mmm.toLowerCase();
    }
    // ISO yyyy-mm-dd
    const m1 = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
    if(m1){
      const dd = m1[3];
      const mm = Math.max(1, Math.min(12, Number(m1[2])));
      return dd+"-"+MONTHS_ES[mm-1];
    }
    // dd/mm/yyyy
    const m2 = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(s);
    if(m2){
      const dd = String(m2[1]).padStart(2,"0");
      const mm = Math.max(1, Math.min(12, Number(m2[2])));
      return dd+"-"+MONTHS_ES[mm-1];
    }
    return s;
  }

  // ===== Init Firebase =====
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ===== UI refs =====
  const loginView = $("loginView");
  const appView = $("appView");
  const loginErr = $("loginErr");
  const btnLogin = $("btnLogin");
  const btnLogout = $("btnLogout");

  const tabEnero = $("tabEnero");
  const tabCrear = $("tabCrear");
  const viewEnero = $("viewEnero");
  const viewCrear = $("viewCrear");

  const inputs = {
    hora: $("c3_hora"),
    fecha: $("c4_fecha"),
    proveedor: $("c5_proveedor"),
    oc: $("c6_oc"),
    pisc: $("c7_pisc"),
    guia: $("c8_guia"),
    bines: $("c9_bines"),
    sector: $("c10_sector"),
    lote: $("c11_lote"),
    secuencial: $("c12_secuencial"),
    libras: $("c13_libras"),
  };

  // Enter = siguiente campo en INGRESAR (y en LIBRAS ejecuta CREAR)
  const ingresarOrder = [
    inputs.hora, inputs.fecha, inputs.proveedor, inputs.oc, inputs.pisc,
    inputs.guia, inputs.bines, inputs.sector, inputs.lote, inputs.secuencial, inputs.libras
  ].filter(Boolean);

  function focusNextIngresar(currentId){
  const order = [
    "c3_hora","c4_fecha","c5_proveedor","c6_oc","c7_pisc","c8_guia","c9_bines",
    "c10_sector","c11_lote","c12_secuencial","c13_libras"
  ];
  const idx = order.indexOf(currentId);
  const nextId = idx >= 0 ? order[idx + 1] : null;
  if(!nextId) return;
  const el = document.getElementById(nextId);
  if(el){
    el.focus();
    if(typeof el.select === "function") el.select();
  }
}

function clearIngresarForm(opts = {}){
  const keepHoraFecha = (opts.keepHoraFecha !== false); // default true
  const hora = document.getElementById("c3_hora");
  const fecha = document.getElementById("c4_fecha");

  // Limpia campos de ingreso (dejando Hora/Fecha por defecto para rapidez)
  const idsToClear = [
    "c5_proveedor","c6_oc","c7_pisc","c8_guia","c9_bines",
    "c10_sector","c12_secuencial","c13_libras"
  ];
  idsToClear.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.value = "";
  });

  // Mantener Lote seleccionado (c11_lote) para acelerar captura
  if(!keepHoraFecha){
    if(hora) hora.value = "";
    if(fecha) fecha.value = "";
  }

  // Volver cursor al inicio (Hora)
  if(hora){
    hora.focus();
    if(typeof hora.select === "function") hora.select();
  }
}

  inputs.fecha && inputs.fecha.addEventListener("blur", ()=>{ inputs.fecha.value = fmtFecha(inputs.fecha.value); });

  ingresarOrder.forEach((el)=>{
    if(el === inputs.libras) return; // libras ya tiene Enter=crear
    el.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        focusNextIngresar(el);
      }
    });
  });



  const rangeInputs = {
    e7: $("e7_rango"),
    h7: $("h7_impA1"),
    e8: $("e8_rango"),
    h8: $("h8_impA2"),
    e12: $("e12_todas"),
    h12: $("h12_impB"),
  };

  const filtros = {
    desde: $("q3_desde"),
    hasta: $("q4_hasta"),
  };

  const m3_librasRem = $("m3_librasRem");
  const m4_colaAprox = $("m4_colaAprox");
  const m6_pesoPlanta = $("m6_pesoPlanta");
  const m7_pesoCola = $("m7_pesoCola");
  const m9_liquidado = $("m9_liquidado");
  const m10_rendTotal = $("m10_rendTotal");

  const thead = $("thead");
  const tbody = $("tbody");
  const btnPDF = $("btnPDF");

  const h3_user = $("h3_user");
  const h4_now = $("h4_now");
  const pillUser = $("pillUser");
  const pillNow = $("pillNow");

  // ===== State =====
  let currentUser = null;
  let rowsAll = [];       // all firestore rows
  let rowsVisible = [];   // after filters
  const colFilters = {};  // {field: 'text'}
  let unsubProgram = null;
  let unsubLotes = null;
  let normalizedSecuencialOnce = false;

  // ===== Columns (Excel) =====
  const COLS = [
    {key:"hora", label:"Hora", w:72, editable:false},
    {key:"fecha", label:"Fecha", w:86, editable:false},
    {key:"proveedor", label:"Proveedor", w:150, editable:true},
    {key:"oc", label:"OC", w:72, editable:true},
    {key:"pisc", label:"Pisc", w:60, editable:true},
    {key:"guiaNum", label:"Gu√≠a", w:90, editable:true},
    {key:"bines", label:"Bines", w:60, editable:true},
    {key:"sector", label:"Sector", w:120, editable:true},
    {key:"lote", label:"Lote", w:150, editable:true},
    {key:"secuencial", label:"Secuencial", w:86, editable:false}, // doc id
    {key:"gramo", label:"Gramo", w:70, editable:true},
    {key:"talla", label:"Talla", w:70, editable:false, computed:true},
    {key:"guiaLbs", label:"Gu√≠a", w:86, editable:true},
    {key:"promedio", label:"Promedio", w:86, editable:true},
    {key:"planta", label:"Planta", w:86, editable:false, computed:true},
    {key:"pesoCola", label:"Peso Cola", w:90, editable:true},
    {key:"basura", label:"Basura", w:70, editable:true},
    {key:"liquidando", label:"Liquidando", w:90, editable:true},
    {key:"rend", label:"Rend", w:78, editable:false, computed:true},
    {key:"modificar", label:"Modificar", w:74, editable:false, action:"edit"},
    {key:"quitar", label:"Quitar", w:72, editable:false, action:"delete"},
  ];

  // ===== Build header with filter dropdown + resizers =====
  function buildHeader(){
    const tr = document.createElement("tr");
    COLS.forEach((c)=>{
      const th = document.createElement("th");
      th.style.width = c.w+"px";
      th.dataset.key = c.key;

      const wrap = document.createElement("div");
      wrap.className = "filter-ui";

      const title = document.createElement("div");
      title.style.flex = "1 1 auto";
      title.style.minWidth = "0";
      title.textContent = c.label;

      // Filter (no filter for action cols)
      if(!c.action){
        const fbtn = document.createElement("div");
        fbtn.className = "filter-btn";
        fbtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M3 5h18l-7 8v6l-4 2v-8L3 5z"/></svg>`;

        const pop = document.createElement("div");
        pop.className = "filter-pop";
        pop.innerHTML = `
          <input placeholder="Filtrar ${c.label}..." />
          <div class="mini">
            <button data-act="clear">Limpiar</button>
            <button data-act="ok">Aplicar</button>
          </div>
        `;

        const inp = pop.querySelector("input");
        inp.value = colFilters[c.key] || "";

        // Filtro en vivo (y con Enter) para que responda al escribir
        inp.addEventListener("input", ()=>{
          colFilters[c.key] = inp.value.trim();
          render();
        });
        inp.addEventListener("keydown", (e)=>{
          if(e.key==="Enter"){
            colFilters[c.key] = inp.value.trim();
            pop.style.display="none";
            render();
          }
        });

        fbtn.addEventListener("click", (ev)=>{
          ev.stopPropagation();
          // close others
          document.querySelectorAll(".filter-pop").forEach(p=>{ if(p!==pop) p.style.display="none"; });
          pop.style.display = (pop.style.display==="block") ? "none" : "block";
          inp.focus();
          inp.select();
        });

        pop.addEventListener("click", (ev)=>ev.stopPropagation());
        pop.querySelectorAll("button").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const act = btn.dataset.act;
            if(act==="clear"){
              inp.value = "";
              colFilters[c.key] = "";
              pop.style.display="none";
              render();
            }else{
              colFilters[c.key] = inp.value.trim();
              pop.style.display="none";
              render();
            }
          });
        });

        th.appendChild(pop);
        wrap.appendChild(fbtn);
      }

      wrap.insertBefore(title, wrap.firstChild);
      th.appendChild(wrap);

      const rz = document.createElement("div");
      rz.className = "resizer";
      th.appendChild(rz);

      tr.appendChild(th);
    });

    thead.innerHTML = "";
    thead.appendChild(tr);

    document.addEventListener("click", ()=> {
      document.querySelectorAll(".filter-pop").forEach(p=>p.style.display="none");
    });

    initColumnResizers();
  }

  // ===== Column resize (mouse) =====
  function initColumnResizers(){
    const ths = thead.querySelectorAll("th");
    ths.forEach((th, idx)=>{
      const rz = th.querySelector(".resizer");
      if(!rz) return;

      let startX=0, startW=0;

      const onMove = (e)=>{
        const dx = e.clientX - startX;
        const w = Math.max(42, startW + dx);
        th.style.width = w+"px";
        // also apply to all td in this column
        const rows = tbody.querySelectorAll("tr");
        rows.forEach(r=>{
          const td = r.children[idx];
          if(td) td.style.width = w+"px";
        });
      };

      const onUp = ()=>{
        document.removeEventListener("mousemove", onMove);
        document.removeEventListener("mouseup", onUp);
        document.body.style.cursor = "";
      };

      rz.onmousedown = (e)=>{
        e.preventDefault();
        startX = e.clientX;
        startW = th.getBoundingClientRect().width;
        document.body.style.cursor = "col-resize";
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      };
    });
  }

  // ===== Compute fields (Excel rules) =====
  function computeRow(r){
    // Talla = 454/(gramo*0.66) if gramo blank => blank
    const g = num(r.gramo);
    const talla = (g==null) ? null : (454/(g*0.66));

    // Planta = pesoCola/0.66 if pesoCola and basura not blank (igual Excel)
    const pc = num(r.pesoCola);
    const ba = num(r.basura);
    const planta = (pc==null || ba==null) ? null : (pc/0.66);

    // Rend = liquidando / (promedio - basura) if any blank => blank
    const liq = num(r.liquidando);
    const pro = num(r.promedio);
    const rend = (liq==null || pro==null || ba==null) ? null : (liq/(pro - ba));

    return {
      ...r,
      talla,
      planta,
      rend
    };
  }

  // ===== Apply filters (Desde/Hasta + header filters) =====
  function applyFilters(rows){
    const d = num(filtros.desde.value);
    const h = num(filtros.hasta.value);

    let out = rows.slice();

    // range filter by secuencial
    if(d!=null || h!=null){
      out = out.filter(r=>{
        const s = num(r.secuencial);
        if(s==null) return false;
        if(d!=null && s<d) return false;
        if(h!=null && s>h) return false;
        return true;
      });
    }

    // header filters (substring)
    out = out.filter(r=>{
      for(const c of COLS){
        if(c.action) continue;
        const f = (colFilters[c.key]||"").trim().toLowerCase();
        if(!f) continue;
        const v = safeStr(r[c.key]).toLowerCase();
        if(!v.includes(f)) return false;
      }
      return true;
    });

    return out;
  }

  // ===== Summary totals (AGGREGATE ignoring hidden rows -> visible rows) =====
  function updateSummary(visibleRows){
    const sum = (key)=> visibleRows.reduce((a,r)=> a + (num(r[key])||0), 0);

    const librasRem = sum("guiaLbs");       // M column
    const colaAprox = librasRem * 0.66;     // M4
    const pesoCola = sum("pesoCola");       // M7
    const pesoPlanta = (pesoCola ? (pesoCola/0.66) : 0); // M6
    const liquidado = sum("liquidando");    // M9
    const rendTotal = (pesoPlanta>0) ? (liquidado/pesoPlanta) : 0; // M10

    m3_librasRem.textContent = nf2.format(librasRem);
    m4_colaAprox.textContent = nf2.format(colaAprox);
    m7_pesoCola.textContent = nf2.format(pesoCola);
    m6_pesoPlanta.textContent = nf2.format(pesoPlanta);
    m9_liquidado.textContent = nf2.format(liquidado);
    m10_rendTotal.textContent = nf2.format(rendTotal*100) + "%";
  }

  // ===== Render table =====
  function render(){
    rowsVisible = applyFilters(rowsAll).map(computeRow);
    updateSummary(rowsVisible);

    tbody.innerHTML = "";
    rowsVisible.forEach((r, rowIndex)=>{
      const tr = document.createElement("tr");

      COLS.forEach((c, colIndex)=>{
        const td = document.createElement("td");
        td.style.width = (thead.querySelectorAll("th")[colIndex]?.style.width || c.w+"px");

        if(c.action==="edit"){
          const wrap = document.createElement("div");
          wrap.className = "chk";
          wrap.style.height="26px";
          const chk = document.createElement("input");
          chk.type="checkbox";
          chk.checked = !!r._editing;
          chk.addEventListener("change", async ()=>{
            r._editing = chk.checked;
            // enable/disable row inputs
            const rowEl = tr;
            rowEl.querySelectorAll("input[data-editable='1']").forEach(inp=>{
              inp.disabled = !r._editing;
            });
            if(!r._editing){
              await saveRowFromDOM(tr, r.secuencial);
            }
          });
          wrap.appendChild(chk);
          td.appendChild(wrap);
        }
        else if(c.action==="delete"){
          const a = document.createElement("span");
          a.className="del";
          a.textContent="Eliminar";
          a.addEventListener("click", async ()=>{
            if(!confirm("¬øEliminar esta fila?")) return;
            await deleteDoc(doc(db, "programacion", String(r.secuencial)));
          });
          td.appendChild(a);
        }
        else{
          const inp = document.createElement("input");
          inp.className="cell-in";
          inp.dataset.key = c.key;
          inp.dataset.secuencial = String(r.secuencial);
          inp.dataset.row = String(rowIndex);
          inp.dataset.col = String(colIndex);

          // value formatting
          let v = r[c.key];
          if(c.key==="rend" && r.rend!=null){
            v = nf2.format(r.rend*100) + "%";
          } else if((c.key==="talla" || c.key==="planta") && v!=null){
            v = nf2.format(v);
          } else if(c.key==="fecha"){ v = fmtFecha(v); }
          else if(["oc","pisc","guiaNum","bines","secuencial"].includes(c.key) && v!=="" && v!=null){
            v = safeStr(v);
          } else if(["gramo","guiaLbs","promedio","pesoCola","basura","liquidando"].includes(c.key) && v!=="" && v!=null){
            // show as number with possible decimals
            const n = num(v);
            v = (n==null) ? "" : nf2.format(n);
          } else {
            v = safeStr(v);
          }
          inp.value = v;

          // editable?
          if(c.editable){
            inp.dataset.editable="1";
            inp.disabled = !r._editing;
          }else{
            inp.disabled = true;
          }

          // Excel-like navigation (Enter/Arrows)
          inp.addEventListener("keydown", (e)=>handleGridNav(e, inp));

          // Recompute on input
          if(c.editable){
            inp.addEventListener("input", ()=>{
              // for numeric inputs, allow user typing; compute after short delay
              queueMicrotask(()=>{
                updateComputedCellsInRow(tr);
              });
            });
          }

          td.appendChild(inp);
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);

      // start with row disabled by default
      tr.querySelectorAll("input[data-editable='1']").forEach(inp=>inp.disabled=true);
    });
  }

  function getRowFromDOM(tr){
    const obj = {};
    tr.querySelectorAll("input.cell-in").forEach(inp=>{
      const key = inp.dataset.key;
      if(!key) return;
      obj[key] = inp.value;
    });
    return obj;
  }

  function updateComputedCellsInRow(tr){
    // read editable values and compute
    const r = {};
    tr.querySelectorAll("input.cell-in").forEach(inp=>{
      const key = inp.dataset.key;
      if(!key) return;
      r[key] = inp.value;
    });

    const computed = computeRow(r);

    // update computed cells
    const setCell = (key, val)=>{
      const inp = tr.querySelector(`input.cell-in[data-key='${key}']`);
      if(!inp) return;
      if(val==null || Number.isNaN(val)){
        inp.value = "";
      }else{
        if(key==="rend") inp.value = nf2.format(val*100) + "%";
        else inp.value = nf2.format(val);
      }
    };

    setCell("talla", computed.talla);
    setCell("planta", computed.planta);
    setCell("rend", computed.rend);

    // update summary too (because visible rows may have changed values while editing)
    // (solo visual; se recalcula al render final cuando se guarda)
  }

  async function saveRowFromDOM(tr, secuencial){
    const docId = String(secuencial);

    // build clean data
    const data = {};
    COLS.forEach(c=>{
      if(c.action) return;
      if(c.computed) return;
      const inp = tr.querySelector(`input.cell-in[data-key='${c.key}']`);
      if(!inp) return;
      data[c.key] = inp.value;
    });

    // normalize numeric fields to numbers (store as numbers)
    const toNumFields = ["oc","pisc","guiaNum","bines","gramo","guiaLbs","promedio","pesoCola","basura","liquidando"];
    toNumFields.forEach(k=>{
      if(data[k]===undefined) return;
      const n = num(data[k]);
      data[k] = (n==null) ? null : n;
    });

    // store
    await updateDoc(doc(db, "programacion", docId), data);
  }

  // ===== Grid keyboard navigation (Enter, Arrows) =====
  function focusCell(rowIdx, colIdx){
    const target = tbody.querySelector(`input.cell-in[data-row='${rowIdx}'][data-col='${colIdx}']`);
    if(target){ target.focus(); target.select?.(); }
  }

  function handleGridNav(e, inp){
    const row = Number(inp.dataset.row);
    const col = Number(inp.dataset.col);

    if(e.key==="Enter"){
      e.preventDefault();
      focusCell(Math.min(row+1, rowsVisible.length-1), col);
      return;
    }
    if(e.key==="ArrowDown"){
      e.preventDefault();
      focusCell(Math.min(row+1, rowsVisible.length-1), col);
      return;
    }
    if(e.key==="ArrowUp"){
      e.preventDefault();
      focusCell(Math.max(row-1, 0), col);
      return;
    }
    if(e.key==="ArrowRight"){
      // move only if caret at end
      const atEnd = inp.selectionStart === inp.value.length && inp.selectionEnd === inp.value.length;
      if(atEnd){
        e.preventDefault();
        focusCell(row, Math.min(col+1, COLS.length-1));
      }
      return;
    }
    if(e.key==="ArrowLeft"){
      const atStart = inp.selectionStart === 0 && inp.selectionEnd === 0;
      if(atStart){
        e.preventDefault();
        focusCell(row, Math.max(col-1, 0));
      }
      return;
    }
  }

  // ===== Add row from "INGRESAR" (Enter on Libras) =====
  async function addRowFromForm(){
    const sec = num(inputs.secuencial.value);
    if(sec==null){ return; }

    const d = new Date();
    const hora = inputs.hora.value || hm(d);
    const fecha = fmtFecha(inputs.fecha.value || ymd(d));

    const data = {
      hora,
      fecha,
      proveedor: inputs.proveedor.value.trim(),
      oc: num(inputs.oc.value),
      pisc: num(inputs.pisc.value),
      guiaNum: num(inputs.guia.value),
      bines: num(inputs.bines.value),
      sector: inputs.sector.value.trim(),
      lote: inputs.lote.value,
      secuencial: sec,
      gramo: null,
      guiaLbs: num(inputs.libras.value),
      promedio: null,
      pesoCola: null,
      basura: null,
      liquidando: null,
      createdAt: Date.now()
    };

    // doc id = secuencial
    await setDoc(doc(db, "programacion", String(sec)), data, {merge:true});

    // limpiar solo lo necesario (como Excel: el usuario sigue trabajando)
    inputs.c12_secuencial?.value; // (no existe, ignore)
  }

  // ===== Lotes (CREAR tab) =====
  async function renderLotes(list){
    const body = $("lotesBody");
    body.innerHTML = "";

    // show existing + one empty row at end
    const all = list.slice();
    all.push({id:"__new__", lote:""});

    all.forEach((x, idx)=>{
      const tr = document.createElement("tr");

      const td1 = document.createElement("td");
      td1.innerHTML = `<input class="cell-in" disabled value="${idx+1}" />`;
      tr.appendChild(td1);

      const td2 = document.createElement("td");
      const inp = document.createElement("input");
      inp.className="cell-in";
      inp.value = x.lote || "";
      inp.placeholder = "";
      inp.addEventListener("keydown", async (e)=>{
        if(e.key==="Enter"){
          e.preventDefault();
          const val = inp.value.trim();
          if(!val) return;
          if(x.id==="__new__"){
            await addDoc(collection(db,"lotes"), {lote: val, createdAt: Date.now()});
          }else{
            await updateDoc(doc(db,"lotes", x.id), {lote: val});
          }
          inp.blur();
        }
      });
      td2.appendChild(inp);
      tr.appendChild(td2);

      const td3 = document.createElement("td");
      if(x.id!=="__new__"){
        const a = document.createElement("span");
        a.className="del";
        a.textContent="Eliminar";
        a.addEventListener("click", async ()=>{
          if(!confirm("¬øEliminar este lote?")) return;
          await deleteDoc(doc(db,"lotes", x.id));
        });
        td3.appendChild(a);
      }
      tr.appendChild(td3);

      body.appendChild(tr);
    });
  }

  // ===== Load settings (rangos/importadores) =====
  async function loadConfigDoc(){
    const cfgRef = doc(db, "programacion", "__config__");
    // We'll keep in same collection to avoid extra collections (no botones extra, simple)
    // If doesn't exist, set defaults from your Excel.
    await setDoc(cfgRef, {
      e7: rangeInputs.e7.value || "U12 - 31/35",
      h7: rangeInputs.h7.value || "Nancy - Shezhen Yueshi",
      e8: rangeInputs.e8.value || "36/40 - 91/110",
      h8: rangeInputs.h8.value || "Criss - Guang Dong LvHuan",
      e12: rangeInputs.e12.value || "Todas",
      h12: rangeInputs.h12.value || "Criss - Guang Dong LvHuan",
      updatedAt: Date.now()
    }, {merge:true});
  }

  function bindConfigAutosave(){
    Object.values(rangeInputs).forEach(inp=>{
      inp.addEventListener("keydown", async (e)=>{
        if(e.key==="Enter"){
          e.preventDefault();
          await saveConfig();
          inp.blur();
        }
      });
    });
  }

  async function saveConfig(){
    const cfgRef = doc(db, "programacion", "__config__");
    await setDoc(cfgRef, {
      e7: rangeInputs.e7.value.trim(),
      h7: rangeInputs.h7.value.trim(),
      e8: rangeInputs.e8.value.trim(),
      h8: rangeInputs.h8.value.trim(),
      e12: rangeInputs.e12.value.trim(),
      h12: rangeInputs.h12.value.trim(),
      updatedAt: Date.now()
    }, {merge:true});
  }

  function subscribeConfig(){
    // listen config from same collection
    const qCfg = query(collection(db, "programacion"), orderBy("createdAt"));
    // Instead of scanning, we just fetch config once via setDoc/load - keep simple:
    // We'll read it from snapshot of doc directly using onSnapshot(docRef) but not imported.
  }

  // ===== Firestore subscriptions =====
  function subscribeProgramacion(){
    if(unsubProgram) unsubProgram();

    const q = query(collection(db,"programacion"), orderBy("secuencial","asc"));
    unsubProgram = onSnapshot(q, (snap)=>{
      const out = [];
      snap.forEach(d=>{
        if(d.id==="__config__") return;
        const v = d.data() || {};
        out.push({
          hora: v.hora ?? "",
          fecha: v.fecha ?? "",
          proveedor: v.proveedor ?? "",
          oc: v.oc ?? null,
          pisc: v.pisc ?? null,
          guiaNum: v.guiaNum ?? null,
          bines: v.bines ?? null,
          sector: v.sector ?? "",
          lote: v.lote ?? "",
          secuencial: (num(v.secuencial) ?? num(d.id) ?? null),
          gramo: v.gramo ?? null,
          guiaLbs: v.guiaLbs ?? null,
          promedio: v.promedio ?? null,
          pesoCola: v.pesoCola ?? null,
          basura: v.basura ?? null,
          liquidando: v.liquidando ?? null,
          _editing:false
        });
      });
      // Normalizar tipos (evita que Firestore ordene por tipo: number vs string)
      if(!normalizedSecuencialOnce){
        normalizedSecuencialOnce = true;
        snap.forEach(async d=>{
          if(d.id==="__config__") return;
          const v = d.data() || {};
          if(v.secuencial != null && typeof v.secuencial !== "number"){
            const s = num(v.secuencial);
            if(s != null){
              try{ await updateDoc(doc(db,"programacion", d.id), {secuencial: s}); }catch(e){}
            }
          }
        });
      }

      // Orden SIEMPRE num√©rico (menor -> mayor), incluso si hay registros viejos con tipos mixtos
      out.sort((a,b)=>{
        const aa = num(a.secuencial) ?? 0;
        const bb = num(b.secuencial) ?? 0;
        return aa - bb;
      });
      rowsAll = out;
      render();
    });
  }

  function subscribeLotes(){
    if(unsubLotes) unsubLotes();

    const q = query(collection(db,"lotes"), orderBy("createdAt","asc"));
    unsubLotes = onSnapshot(q, (snap)=>{
      const list = [];
      snap.forEach(d=>{
        const v = d.data() || {};
        list.push({id:d.id, lote: v.lote || ""});
      });

      // update select
      inputs.lote.innerHTML = "";
      list.forEach(x=>{
        const op = document.createElement("option");
        op.value = x.lote;
        op.textContent = x.lote;
        inputs.lote.appendChild(op);
      });

      // render crear tab
      renderLotes(list);
    });
  }

  // ===== PDF =====
  function generatePDF(){
    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});

    const title = "SISTEMA DE PROGRAMACI√ìN DIARIO DE PLANTA";
    const user = currentUser?.email || "";
    const stamp = nowText();

    docPDF.setFont("helvetica","bold");
    docPDF.setFontSize(12);
    docPDF.text(title, 40, 32);

    docPDF.setFont("helvetica","normal");
    docPDF.setFontSize(10);
    docPDF.text(`Usuario: ${user}`, 40, 50);
    docPDF.text(`Fecha/Hora: ${stamp}`, 40, 64);

    // Control resumen (visible rows)
    const sumLines = [
      ["LIBRAS REMITIDAS", m3_librasRem.textContent],
      ["COLA APROXIMADA", m4_colaAprox.textContent],
      ["PESO PLANTA", m6_pesoPlanta.textContent],
      ["PESO COLA", m7_pesoCola.textContent],
      ["LIQUIDADO", m9_liquidado.textContent],
      ["RENDIMIENTO", m10_rendTotal.textContent],
    ];

    docPDF.autoTable({
      startY: 80,
      head: [["CONTROL", "VALOR"]],
      body: sumLines,
      theme: "grid",
      styles: {fontSize:9, cellPadding:4},
      headStyles: {fillColor: [43,58,89]},
      columnStyles: {0:{cellWidth:150}, 1:{cellWidth:120, halign:"right"}}
    });

const controlFinalY = docPDF.lastAutoTable?.finalY || 80;

// RANGOS / IMPORTADORES (alineado a la misma altura del CONTROL)
const ra1 = (document.getElementById("e7_rango")?.value || "").trim();
const ia1 = (document.getElementById("h7_impA1")?.value || "").trim();
const ra2 = (document.getElementById("e8_rango")?.value || "").trim();
const ia2 = (document.getElementById("h8_impA2")?.value || "").trim();
const rb  = (document.getElementById("e12_todas")?.value || "").trim();
const ib  = (document.getElementById("h12_impB")?.value || "").trim();

docPDF.autoTable({
  startY: 80,
  margin: {left: 340},
  head: [["RANGO", "IMPORTADOR"]],
  body: [
    [{content:'IMPORTADORES CLASE "A"', colSpan:2, styles:{halign:"center", fontStyle:"bold", fillColor:[235,238,245]}}],
    [ra1, ia1],
    [ra2, ia2],
    [{content:'IMPORTADOR CLASE "B"', colSpan:2, styles:{halign:"center", fontStyle:"bold", fillColor:[235,238,245]}}],
    [rb, ib],
  ],
  columnStyles: {0:{cellWidth:110}, 1:{cellWidth:310}},
  styles: {fontSize:9, cellPadding:4},
  headStyles: {fillColor: [43,58,89], textColor: 255, fontStyle: "bold"},
  theme: "grid"
});

const rangesFinalY = docPDF.lastAutoTable?.finalY || 80;

const startY = Math.max(controlFinalY, rangesFinalY) + 10;


    // Table headers (exclude action columns)
    const dataCols = COLS.filter(c=>!c.action);
    const head = [dataCols.map(c=>c.label)];

    const body = rowsVisible.map(r=>{
      const rr = computeRow(r);
      return dataCols.map(c=>{
        const key = c.key;
        if(key==="rend") return (rr.rend==null) ? "" : (nf2.format(rr.rend*100)+"%");
        if(key==="talla") return (rr.talla==null) ? "" : nf2.format(rr.talla);
        if(key==="planta") return (rr.planta==null) ? "" : nf2.format(rr.planta);
        const v = rr[key];
        if(key==="fecha") return fmtFecha(v);
        if(key==="secuencial") return (v==null||v==="") ? "" : String(Math.trunc(num(v)));
        // En PDF: OC / Pisc / Gu√≠a / Bines sin separadores ni decimales (igual que Secuencial)
        if(["oc","pisc","guia","bines"].includes(key)){
          const n = num(v);
          return (n==null || isNaN(n)) ? "" : String(Math.trunc(n));
        }
        if(v==null) return "";
        if(typeof v==="number") return nf2.format(v);
        return String(v);
      });
    });

    docPDF.autoTable({
      startY,
      head,
      body,
      theme:"grid",
      styles:{fontSize:8, cellPadding:3, overflow:"linebreak"},
      headStyles:{fillColor:[43,58,89]},
      margin:{left:40,right:40}
    });

    const fname = `Programacion_Oceantreasure_${stamp.replace(/[\/,: ]/g,"-")}.pdf`;
    docPDF.save(fname);
  }

  // ===== Tabs =====
  function setTab(name){
    if(name==="ENERO"){
      tabEnero.classList.add("active");
      tabCrear.classList.remove("active");
      viewEnero.classList.remove("hidden");
      viewCrear.classList.add("hidden");
    }else{
      tabCrear.classList.add("active");
      tabEnero.classList.remove("active");
      viewCrear.classList.remove("hidden");
      viewEnero.classList.add("hidden");
    }
  }
  tabEnero.onclick = ()=>setTab("ENERO");
  tabCrear.onclick = ()=>setTab("CREAR");

  // ===== Events =====
  btnLogin.addEventListener("click", doLogin);
  $("pass").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  $("email").addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("pass").focus(); });

  btnLogout.addEventListener("click", async ()=>{
    await signOut(auth);
  });

  // Filters trigger rerender
  filtros.desde.addEventListener("input", ()=>render());
  filtros.hasta.addEventListener("input", ()=>render());

  // Add row: Enter on libras (C13)
  
inputs.libras.addEventListener("keydown", async (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      await addRowFromForm();

      // After inserting: clear INGRESAR and return cursor to Hora
      clearIngresarForm();
      inputs.hora.focus();
      inputs.hora.select?.();
    }
  });

// Save config: Enter on range inputs
  bindConfigAutosave();

  // PDF
  btnPDF.addEventListener("click", generatePDF);

  async function doLogin(){
    loginErr.textContent = "";
    const email = $("email").value.trim();
    const pass = $("pass").value;

    try{
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      // enforce allowed email
      if(cred.user?.email !== ALLOWED_EMAIL){
        await signOut(auth);
        loginErr.textContent = "Usuario no autorizado.";
        return;
      }
    }catch(err){
      loginErr.textContent = (err?.message || "Error de login").replace("Firebase: ","");
    }
  }

  // ===== Auth state =====
  onAuthStateChanged(auth, async (u)=>{
    currentUser = u;

    if(!u){
      // show login
      appView.classList.add("hidden");
      loginView.classList.remove("hidden");
      return;
    }

    // allowed email check
    if(u.email !== ALLOWED_EMAIL){
      await signOut(auth);
      loginErr.textContent = "Usuario no autorizado.";
      return;
    }

    // show app
    loginView.classList.add("hidden");
    appView.classList.remove("hidden");

    // top user/time
    const d = new Date();
    h3_user.textContent = u.email;
    $("h3_user").textContent = u.email;

    // initialize inputs for date/time like Excel
    inputs.hora.value = hm(d);
    inputs.fecha.value = fmtFecha(ymd(d));

    // live clock
    if(window.__clock) clearInterval(window.__clock);
    const tick = ()=>{
      const t = nowText();
      h4_now.textContent = t;
      $("h4_now").textContent = t;
    };
    tick();
    window.__clock = setInterval(tick, 1000);

    // header + subscriptions
    buildHeader();
    subscribeProgramacion();
    subscribeLotes();

    // ensure config doc exists (defaults)
    await loadConfigDoc();

    // load config values from Firestore if exists (simple read via getDocs)
    // we didn't import getDoc, so we use getDocs on programacion and pick __config__ quickly
    const snap = await getDocs(query(collection(db,"programacion")));
    snap.forEach(d=>{
      if(d.id==="__config__"){
        const v=d.data()||{};
        rangeInputs.e7.value = v.e7 || "";
        rangeInputs.h7.value = v.h7 || "";
        rangeInputs.e8.value = v.e8 || "";
        rangeInputs.h8.value = v.h8 || "";
        rangeInputs.e12.value = v.e12 || "";
        rangeInputs.h12.value = v.h12 || "";
      }
    });
  });

</script>
</body>
</html>
