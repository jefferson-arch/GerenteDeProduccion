<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Programación Diario de Planta | Oceantreasure</title>

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Excel-like theme */
    :root{
      --grid:#d9d9d9;
      --head:#1f4e79;          /* Excel table header blue */
      --headText:#fff;
      --yellow:#fff2cc;        /* Excel light yellow */
      --green:#c6efce;         /* Excel light green */
      --gray:#f2f2f2;
      --text:#111;
      --muted:#444;
      --danger:#c00000;
      --btn:#e7e6e6;
      --btnBorder:#7f7f7f;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:var(--text);font-family:Calibri,Arial,Helvetica,sans-serif;font-size:12px}
    .page{max-width:1600px;margin:0 auto;padding:10px 12px 62px}
    .title{text-align:center;font-family:"Times New Roman",Times,serif;font-size:22px;font-weight:700;margin:6px 0 10px}

    /* Login */
    .loginWrap{min-height:calc(100vh - 50px);display:grid;place-items:center;padding:18px;background:#f7f7f7}
    .loginCard{width:min(520px,94vw);background:#fff;border:1px solid var(--grid)}
    .loginHead{padding:12px 14px;background:var(--head);color:#fff;font-weight:700}
    .loginBody{padding:14px;display:grid;gap:10px}
    .loginRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .loginBody label{display:block;font-size:11px;color:var(--muted);margin-bottom:4px}
    .loginBody input{width:100%;padding:8px;border:1px solid var(--grid);border-radius:0}
    .loginBody button{width:100%;padding:9px;border:1px solid var(--btnBorder);background:var(--btn);border-radius:0;cursor:pointer;font-weight:700}
    .loginHint{font-size:11px;color:#555;line-height:1.35}

    /* Top “sheet” blocks */
    .topGrid{display:grid;grid-template-columns: 360px 1fr 360px 320px;gap:10px;align-items:start}
    .block{border:1px solid var(--grid);padding:6px}
    .block h3{margin:0 0 6px;text-align:center;font-family:"Times New Roman",Times,serif;font-size:15px}
    .miniTitle{text-align:center;font-family:"Times New Roman",Times,serif;font-weight:700;margin:0 0 6px}
    table.form{width:100%;border-collapse:collapse}
    table.form td{border:1px solid var(--grid);padding:4px 6px;vertical-align:middle}
    table.form td.lbl{width:42%;background:#fff;font-weight:700}
    .cellInput{width:100%;border:none;outline:none;background:transparent;font:inherit}
    .cell.yellow{background:var(--yellow)}
    .cell.green{background:var(--green)}
    .cell.gray{background:var(--gray)}
    .cell.right{text-align:right}
    .cell.center{text-align:center}
    .btnRow{display:flex;gap:8px;justify-content:center;margin-top:8px}
    .btn{padding:8px 12px;border:1px solid var(--btnBorder);background:var(--btn);cursor:pointer;border-radius:0;font-weight:700}
    .btn:active{transform:translateY(1px)}

    /* Auth block */
    .authRow{display:grid;grid-template-columns: 1fr 1fr;gap:8px;align-items:center;margin-bottom:6px}
    .authRow .label{text-align:right;font-family:"Times New Roman",Times,serif;font-weight:700}
    .authRow .value{font-family:"Times New Roman",Times,serif;font-weight:700}

    /* Control block */
    .controlGrid{display:grid;grid-template-columns: 1fr auto;gap:6px 10px}
    .controlGrid .k{font-family:"Times New Roman",Times,serif;font-weight:700}
    .controlGrid .v{min-width:140px;text-align:right;font-family:"Times New Roman",Times,serif;font-weight:700}

    /* Table */
    .tableWrap{margin-top:10px;border:1px solid var(--grid);overflow:auto;max-height:62vh}
    table.data{border-collapse:collapse;min-width:1500px;width:100%}
    table.data th, table.data td{border:1px solid var(--grid);padding:4px 6px;white-space:nowrap}
    table.data thead th{background:var(--head);color:var(--headText);font-family:"Times New Roman",Times,serif;font-weight:700}
    .fltRow th{background:#fff;color:#000;padding:2px}
    .fltRow input,.fltRow select{width:100%;padding:3px 4px;border:1px solid var(--grid);border-radius:0;font-size:11px}
    .delLink{color:var(--danger);text-decoration:underline;cursor:pointer;background:transparent;border:none;padding:0;font:inherit;font-weight:700}
    .chk{width:16px;height:16px;accent-color:#1f4e79}

    /* Bottom sheet tabs (Excel-like) */
    .sheetTabs{position:fixed;left:0;right:0;bottom:0;background:#f3f3f3;border-top:1px solid var(--grid);padding:6px 10px;display:flex;gap:6px;align-items:center}
    .tabBtn{padding:6px 12px;border:1px solid var(--grid);background:#fff;cursor:pointer;border-bottom:2px solid #fff;font-weight:700}
    .tabBtn.active{border-bottom:2px solid var(--head);}
    .statusRight{margin-left:auto;display:flex;gap:12px;align-items:center;font-size:11px;color:#333}
    .pill{border:1px solid var(--grid);background:#fff;padding:4px 8px}
    .hide{display:none !important}

    /* Toast */
    .toast{position:fixed;bottom:54px;left:50%;transform:translateX(-50%);
      background:#fff;border:1px solid var(--grid);padding:10px 12px;display:none;gap:10px;align-items:center;
      max-width:min(980px,92vw)
    }
    .toast.show{display:flex}
    .toast button{padding:6px 10px;border:1px solid var(--grid);background:var(--btn);cursor:pointer;border-radius:0}
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="loginView" class="loginWrap">
  <div class="loginCard">
    <div class="loginHead">Iniciar sesión</div>
    <div class="loginBody">
      <div class="loginHint">
        Inicia con tu correo y contraseña de <b>Firebase Authentication</b>. (No se guardan claves dentro del HTML.)
      </div>
      <div class="loginRow">
        <div>
          <label>Correo</label>
          <input id="email" type="email" autocomplete="username" />
        </div>
        <div>
          <label>Contraseña</label>
          <input id="pass" type="password" autocomplete="current-password" />
        </div>
      </div>
      <button id="btnLogin">Entrar</button>
      <div class="loginHint">
        Si aparece “unauthorized domain”, agrega tu dominio en Firebase → Authentication → Settings → Authorized domains.
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appView" class="hide">
  <div class="page">
    <div class="title">SISTEMA DE PROGRAMACIÓN DIARIO DE PLANTA</div>

    <!-- TOP GRID -->
    <div id="tab-programa">
      <div class="topGrid">

        <!-- INGRESAR -->
        <div class="block">
          <h3>INGRESAR</h3>
          <table class="form">
            <tr><td class="lbl">Hora:</td><td class="cell yellow"><input class="cellInput" id="fHora"></td></tr>
            <tr><td class="lbl">Fecha:</td><td class="cell yellow"><input class="cellInput" id="fFecha"></td></tr>
            <tr><td class="lbl">Proveedor:</td><td class="cell yellow"><input class="cellInput" id="fProveedor"></td></tr>
            <tr><td class="lbl">OCK:</td><td class="cell yellow"><input class="cellInput" id="fOC"></td></tr>
            <tr><td class="lbl">Piscina:</td><td class="cell yellow"><input class="cellInput" id="fPiscina"></td></tr>
            <tr><td class="lbl">Guías:</td><td class="cell yellow"><input class="cellInput" id="fGuias"></td></tr>
            <tr><td class="lbl">Bines:</td><td class="cell yellow"><input class="cellInput" id="fBines"></td></tr>
            <tr><td class="lbl">Sector:</td><td class="cell yellow"><input class="cellInput" id="fSector"></td></tr>
            <tr><td class="lbl">Lote:</td>
                <td class="cell yellow">
                  <select class="cellInput" id="fLote"><option value=""></option></select>
                </td>
            </tr>
            <tr><td class="lbl">Secuencial:</td><td class="cell yellow"><input class="cellInput" id="fSecuencial"></td></tr>
            <tr><td class="lbl">Libras:</td><td class="cell yellow cell.right"><input class="cellInput" id="fLibras" style="text-align:right"></td></tr>
          </table>
        </div>

        <!-- AUTENTICADO -->
        <div class="block">
          <h3>AUTENTICADO</h3>
          <div class="authRow">
            <div class="label">Usuario:</div>
            <div class="value" id="authUser">—</div>
          </div>
          <div class="authRow">
            <div class="label">Fecha actual:</div>
            <div class="value" id="authNow">—</div>
          </div>

          <div style="height:6px"></div>

          <table class="form">
            <tr>
              <td class="cell gray center" style="font-weight:700">Rango</td>
              <td class="cell gray center" style="font-weight:700">Importadores Clase "A"</td>
            </tr>
            <tr>
              <td class="cell green center"><input class="cellInput" id="hRango1"></td>
              <td class="cell green center"><input class="cellInput" id="hImpA1"></td>
            </tr>
            <tr>
              <td class="cell green center"><input class="cellInput" id="hRango2"></td>
              <td class="cell green center"><input class="cellInput" id="hImpA2"></td>
            </tr>
          </table>

          <div style="height:8px"></div>

          <div class="miniTitle" style="margin-top:6px">Importador Clase "B"</div>
          <table class="form">
            <tr>
              <td class="cell gray center" style="width:30%"><input class="cellInput" id="hImpBLabel" style="text-align:center"></td>
              <td class="cell gray center"><input class="cellInput" id="hImpB" style="text-align:center"></td>
            </tr>
          </table>

          
        </div>

        <!-- CONTROL -->
        <div class="block">
          <h3>CONTROL</h3>
          <div class="controlGrid">
            <div class="k">LIBRAS REMITIDAS:</div><div class="v" id="kLibras">0,00</div>
            <div class="k">COLA APROXIMADA:</div><div class="v" id="kCola">0,00</div>
            <div style="height:6px"></div><div></div>
            <div class="k">PESO PLANTA:</div><div class="v" id="kPlanta">0,00</div>
            <div class="k">PESO COLA:</div><div class="v" id="kPesoCola">0,00</div>
            <div style="height:10px"></div><div></div>
            <div class="k">LIQUIDADO:</div><div class="v" id="kLiquidado">0,00</div>
            <div class="k">RENDIMIENTO:</div><div class="v" id="kRend">0,00%</div>
          </div>
        </div>

        <!-- PRESENTAR TABLA -->
        <div class="block">
          <h3>PRESENTAR TABLA</h3>
          <table class="form">
            <tr><td class="lbl center" style="width:40%">Desde:</td><td class="cell yellow"><input class="cellInput" id="rDesde"></td></tr>
            <tr><td class="lbl center">Hasta:</td><td class="cell yellow"><input class="cellInput" id="rHasta"></td></tr>
          </table>
          <div class="btnRow" style="margin-top:10px">
            <button class="btn" id="btnPdf">GENERAR PDF</button>
          </div>
          <div class="btnRow" style="margin-top:6px">
            <button class="btn" id="btnClearFilters">LIMPIAR FILTROS</button>
          </div>
        </div>

      </div>

      <!-- DATA TABLE -->
      <div class="tableWrap">
        <table class="data" id="tbl"><colgroup id="colgroup"></colgroup>
          <thead>
            <tr id="headRow"></tr>
            <tr class="fltRow" id="filterRow"></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- TAB CREAR -->
    <div id="tab-crear" class="hide">
      <div class="topGrid" style="grid-template-columns: 1fr 1fr;">
        <div class="block">
          <h3>CREAR</h3>
          <table class="form">
            <tr>
              <td class="lbl">Nuevo Lote:</td>
              <td class="cell yellow"><input class="cellInput" id="newLote"></td>
            </tr>
          </table>
          <div class="btnRow">
            <button class="btn" id="btnAddLote">GUARDAR LOTE</button>
          </div>
          <div class="loginHint" style="margin-top:6px">
            Solo el administrador puede crear/eliminar lotes.
          </div>
        </div>

        <div class="block">
          <h3>LOTES</h3>
          <div class="tableWrap" style="max-height:55vh">
            <table class="data" style="min-width:720px;width:100%">
              <thead>
                <tr>
                  <th style="text-align:left">LOTE</th>
                  <th style="text-align:left">ADMINISTRADOR</th>
                  <th style="text-align:left">FECHA DE CREACIÓN</th>
                  <th style="text-align:left">ACCIONES</th>
                </tr>
              </thead>
              <tbody id="lotesBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Excel-like bottom tabs -->
  <div class="sheetTabs">
    <button class="tabBtn active" id="tabEnero">ENERO</button>
    <button class="tabBtn" id="tabCrearBtn" style="display:none">CREAR</button>

    <div class="statusRight">
      <span class="pill">Conectado: <span id="whoEmail">—</span></span>
      <button class="btn" id="btnLogout" style="padding:5px 10px">Salir</button>
      <span class="pill">Filas visibles: <span id="rowsCount">0</span></span>
      <span class="pill">Última actualización: <span id="lastSync">—</span></span>
    </div>
  </div>
</div>

<div id="toast" class="toast">
  <div id="toastMsg" style="font-weight:700"></div>
  <button id="toastX">OK</button>
</div>

<script type="module">
  /*******************************************************************
   * FIREBASE CONFIG (ya puesto con tus datos)
   *******************************************************************/
  const firebaseConfig = {
  apiKey: "AIzaSyCMoLkSnnLowMagRNL7O6ttPo1FXd1URac",
  authDomain: "oceantreasure-app.firebaseapp.com",
  projectId: "oceantreasure-app",
  storageBucket: "oceantreasure-app.firebasestorage.app",
  messagingSenderId: "553014659258",
  appId: "1:553014659258:web:cfc30844a88433b7b79a83",
  measurementId: "G-HMMQKJY8NJ"
};

  /*******************************************************************
   * REGLAS FRONT-END: solo correos permitidos
   *******************************************************************/
  const ALLOWED_EMAILS = [
    "yanelavinueza@oceantreasure.local",
    "jeffersonfigueroa@oceantreasure.local"
  ];
  const ADMIN_EMAIL = "jeffersonfigueroa@oceantreasure.local";

  /*******************************************************************
   * Firebase SDK (CDN modular)
   *******************************************************************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc,
    onSnapshot, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /*******************************************************************
   * Utils
   *******************************************************************/
  const nf2 = new Intl.NumberFormat("es-EC", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const nf0 = new Intl.NumberFormat("es-EC", { maximumFractionDigits: 0 });

  function showToast(msg){
    const t=document.getElementById("toast");
    document.getElementById("toastMsg").innerText=msg;
    t.classList.add("show");
  }
  document.getElementById("toastX").onclick=()=>document.getElementById("toast").classList.remove("show");

  function nowStr(){
    const d=new Date();
    const pad=n=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function parseNum(v){
    if(v===null||v===undefined) return null;
    if(typeof v==="number") return isFinite(v)?v:null;
    let s=String(v).trim();
    if(!s) return null;
    const hasComma=s.includes(",");
    const hasDot=s.includes(".");
    if(hasComma && hasDot) s=s.replace(/\./g,"").replace(",",".");
    else if(hasComma && !hasDot) s=s.replace(",",".");
    s=s.replace(/[^0-9.\-]/g,"");
    const n=Number(s);
    return isFinite(n)?n:null;
  }
  function fmt2(n){ return (n===null||n===undefined||!isFinite(n)) ? "" : nf2.format(n); }
  function fmtPct(n){
    return (n===null||n===undefined||!isFinite(n))
      ? ""
      : (new Intl.NumberFormat("es-EC",{style:"percent",minimumFractionDigits:2,maximumFractionDigits:2}).format(n));
  }

  function escapeHtml(s){
    return String(s??"").replace(/[&<>\"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  /*******************************************************************
   * Encabezado (E7:H8, E12:H12) → doc meta/encabezado
   *******************************************************************/
  const headerDocRef = doc(db, "meta", "encabezado");
  let currentUserEmail = null;

  async function loadHeader(){
    const snap = await getDoc(headerDocRef);
    if(!snap.exists()) return;
    const h = snap.data();
    document.getElementById("hRango1").value = h.rango1 ?? "";
    document.getElementById("hRango2").value = h.rango2 ?? "";
    document.getElementById("hImpA1").value  = h.impA1 ?? "";
    document.getElementById("hImpA2").value  = h.impA2 ?? "";
    document.getElementById("hImpB").value   = h.impB ?? "";
    document.getElementById("hImpBLabel").value = h.impBLabel ?? "";
  }

  let headerSaveTimer=null;
  function scheduleHeaderSave(){
    if(!currentUserEmail) return;
    clearTimeout(headerSaveTimer);
    headerSaveTimer=setTimeout(async ()=>{
      await setDoc(headerDocRef, {
        rango1: document.getElementById("hRango1").value.trim(),
        rango2: document.getElementById("hRango2").value.trim(),
        impA1: document.getElementById("hImpA1").value.trim(),
        impA2: document.getElementById("hImpA2").value.trim(),
        impB: document.getElementById("hImpB").value.trim(),
        impBLabel: document.getElementById("hImpBLabel").value.trim(),
        updatedAt: serverTimestamp(),
        updatedBy: currentUserEmail
      }, { merge:true });
    }, 650);
  }
  ["hRango1","hRango2","hImpA1","hImpA2","hImpB","hImpBLabel"].forEach(id=>{
    document.getElementById(id).addEventListener("input", scheduleHeaderSave);
  });

  /*******************************************************************
   * Lotes
   *******************************************************************/
  const lotesCol = collection(db, "lotes");
  let lotesUnsub=null;

  function subscribeLotes(isAdmin){
    if(lotesUnsub) lotesUnsub();
    const ql = query(lotesCol, orderBy("lote","asc"));
    lotesUnsub = onSnapshot(ql, (snap)=>{
      const lotes=[];
      snap.forEach(d=>lotes.push({id:d.id, ...d.data()}));

      // dropdown lote
      const sel=document.getElementById("fLote");
      const current=sel.value;
      sel.innerHTML = `<option value=""></option>` + lotes.map(x=>`<option value="${escapeHtml(x.lote)}">${escapeHtml(x.lote)}</option>`).join("");
      if(current && lotes.some(x=>x.lote===current)) sel.value=current;

      // table lotes
      const body=document.getElementById("lotesBody");
      body.innerHTML = lotes.map(x=>{
        const d = x.createdAt?.toDate ? x.createdAt.toDate() : null;
        const f = d ? d.toLocaleString("es-EC") : (x.createdAtText ?? "");
        return `<tr>
          <td>${escapeHtml(x.lote||"")}</td>
          <td>${escapeHtml(x.admin||"")}</td>
          <td>${escapeHtml(f||"")}</td>
          <td>${isAdmin ? `<button class="btn" data-del-lote="${x.id}" style="border-color:#c00000;color:#c00000">Eliminar</button>` : `<span>-</span>`}</td>
        </tr>`;
      }).join("");

      if(isAdmin){
        body.querySelectorAll("[data-del-lote]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id=btn.getAttribute("data-del-lote");
            if(!confirm("¿Eliminar este lote?")) return;
            await deleteDoc(doc(db,"lotes",id));
            showToast("Lote eliminado.");
          });
        });
      }
    });
  }

  document.getElementById("btnAddLote").addEventListener("click", async ()=>{
    if(currentUserEmail!==ADMIN_EMAIL) return showToast("Solo el administrador puede crear lotes.");
    const v=document.getElementById("newLote").value.trim();
    if(!v) return showToast("Escribe un lote.");
    await addDoc(lotesCol, {
      lote:v,
      admin: currentUserEmail,
      createdAt: serverTimestamp(),
      createdAtText: nowStr()
    });
    document.getElementById("newLote").value="";
    showToast("Lote guardado.");
  });

  /*******************************************************************
   * Tabla principal (programacion)
   *******************************************************************/
  const progCol = collection(db, "programacion");
  let progUnsub=null;
  let allRows=[];
  const filters={};
  let rangeDesde=null, rangeHasta=null;

  const COLS = [
    {key:"hora", label:"Hora"},
    {key:"fecha", label:"Fecha"},
    {key:"proveedor", label:"Proveedor"},
    {key:"oc", label:"OC"},
    {key:"piscina", label:"Pisc"},
    {key:"guias", label:"Guía"},
    {key:"bines", label:"Bines"},
    {key:"sector", label:"Sector"},
    {key:"lote", label:"Lote"},
    {key:"secuencial", label:"Secuencial"},
    {key:"gramo", label:"Gramo"},
    {key:"talla", label:"Talla"},
    {key:"libras", label:"Guía"},
    {key:"promedio", label:"Promedio"},
    {key:"planta", label:"Planta"},
    {key:"pesoCola", label:"Peso Cola"},
    {key:"basura", label:"Basura"},
    {key:"liquidando", label:"Liquidando"},
    {key:"rend", label:"Rend"},
    {key:"modificar", label:"Modificar"},
    {key:"quitar", label:"Quitar"}
  ];

  function calcRowDerived(r){
    const gr = parseNum(r.gramo);
    const talla = (gr && gr>0) ? 454/(gr*0.66) : null;

    const libras = parseNum(r.libras);
    let pesoCola = parseNum(r.pesoCola);
    if(pesoCola===null && libras!==null) pesoCola = libras*0.66;

    const basura = parseNum(r.basura);
    const planta = (pesoCola!==null && basura!==null) ? (pesoCola/0.66) : null;

    const promedio = planta;
    const liquidando = parseNum(r.liquidando);
    const denom = (promedio!==null && basura!==null) ? (promedio - basura) : null;
    const rend = (liquidando!==null && denom && denom>0) ? (liquidando/denom) : null;

    return {...r, talla, pesoCola, planta, promedio, rend};
  }

  function passesFilters(r){
    const sec = Number(r.secuencial);
    if(rangeDesde!==null && !Number.isNaN(sec) && sec < rangeDesde) return false;
    if(rangeHasta!==null && !Number.isNaN(sec) && sec > rangeHasta) return false;
    for(const [k,v] of Object.entries(filters)){
      if(!v) continue;
      const cell=(r[k]??"").toString().toLowerCase();
      if(!cell.includes(v.toLowerCase())) return false;
    }
    return true;
  }

  function visibleRows(){
    return allRows
      .map(calcRowDerived)
      .filter(passesFilters)
      .sort((a,b)=> (Number(a.secuencial)||0) - (Number(b.secuencial)||0));
  }

  function buildTableHeader(){
    const head=document.getElementById("headRow");
    const fr=document.getElementById("filterRow");
    const cg=document.getElementById("colgroup");

    // Build colgroup (one per column) for resizable widths
    cg.innerHTML = COLS.map(()=>`<col />`).join("");

    // Header with resize handles
    head.innerHTML = COLS.map((c,idx)=>`<th data-col="${idx}" style="position:relative">${escapeHtml(c.label)}<span class="rz" data-rz="${idx}" style="position:absolute;right:0;top:0;height:100%;width:6px;cursor:col-resize;"></span></th>`).join("");

    // Filter row (Excel like). IMPORTANT: Secuencial NO se filtra aquí (solo con "Presentar tabla")
    fr.innerHTML = COLS.map(c=>{
      if(c.key==="modificar" || c.key==="quitar") return `<th></th>`;
      if(c.key==="secuencial") return `<th></th>`;
      if(c.key==="lote") return `<th><select data-filter="lote"><option value=""></option></select></th>`;
      return `<th><input data-filter="${c.key}"></th>`;
    }).join("");

    // Lote filter options from dropdown
    const selLotes = fr.querySelector('[data-filter="lote"]');
    if(selLotes){
      const opts=[...document.querySelectorAll("#fLote option")].map(o=>o.value).filter(Boolean);
      selLotes.innerHTML = `<option value=""></option>` + opts.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      selLotes.addEventListener("change", ()=>{ filters["lote"]=selLotes.value; render(); });
    }

    fr.querySelectorAll("[data-filter]").forEach(el=>{
      const key=el.getAttribute("data-filter");
      if(key==="lote") return;
      el.addEventListener("input", ()=>{ filters[key]=el.value.trim(); render(); });
    });

    // Column resizing (manual with mouse)
    const cols=[...cg.querySelectorAll("col")];
    const ths=[...head.querySelectorAll("th")];

    // Set initial widths (close to Excel)
    const init = [70,70,120,60,50,80,60,110,170,80,70,70,80,85,70,85,70,90,70,70,60];
    ths.forEach((th,i)=>{
      const w = init[i] || 90;
      th.style.width = w+"px";
      cols[i].style.width = w+"px";
    });

    let rzIdx=null, startX=0, startW=0;
    head.querySelectorAll("[data-rz]").forEach(h=>{
      h.addEventListener("mousedown",(e)=>{
        rzIdx = Number(h.getAttribute("data-rz"));
        startX = e.clientX;
        startW = ths[rzIdx].getBoundingClientRect().width;
        document.body.style.userSelect="none";
      });
    });
    window.addEventListener("mousemove",(e)=>{
      if(rzIdx===null) return;
      const dx=e.clientX-startX;
      const w=Math.max(40, startW+dx);
      ths[rzIdx].style.width = w+"px";
      cols[rzIdx].style.width = w+"px";
    });
    window.addEventListener("mouseup",()=>{
      if(rzIdx===null) return;
      rzIdx=null;
      document.body.style.userSelect="";
    });
  }

  async function saveRowEdits(id){
    const row=allRows.find(x=>x.id===id);
    if(!row) return;
    const base={
      hora:(row.hora??"").toString().trim(),
      fecha:(row.fecha??"").toString().trim(),
      proveedor:(row.proveedor??"").toString().trim(),
      oc:(row.oc??"").toString().trim(),
      piscina:(row.piscina??"").toString().trim(),
      guias:(row.guias??"").toString().trim(),
      bines:(row.bines??"").toString().trim(),
      sector:(row.sector??"").toString().trim(),
      lote:(row.lote??"").toString().trim(),
      secuencial:(row.secuencial??"").toString().trim(),
      gramo:(row.gramo??"").toString().trim(),
      libras:(row.libras??"").toString().trim(),
      pesoCola:(row.pesoCola??"").toString().trim(),
      basura:(row.basura??"").toString().trim(),
      liquidando:(row.liquidando??"").toString().trim(),
      updatedAt:serverTimestamp(),
      updatedBy:currentUserEmail
    };
    await updateDoc(doc(db,"programacion",id), base);
    showToast("Cambios guardados.");
  }

  function render(){
    const rows=visibleRows();
    document.getElementById("rowsCount").innerText = String(rows.length);

    const sum=(key)=> rows.reduce((a,x)=>a+(parseNum(x[key])||0),0);
    const libras=sum("libras");
    const cola=libras*0.66;
    const pesoCola=sum("pesoCola");
    const planta = pesoCola ? (pesoCola/0.66) : 0;
    const liquidado=sum("liquidando");
    const rendimiento = planta>0 ? (liquidado/planta) : 0;

    document.getElementById("kLibras").innerText = nf2.format(libras);
    document.getElementById("kCola").innerText = nf2.format(cola);
    document.getElementById("kPesoCola").innerText = nf2.format(pesoCola);
    document.getElementById("kPlanta").innerText = nf2.format(planta);
    document.getElementById("kLiquidado").innerText = nf2.format(liquidado);
    document.getElementById("kRend").innerText = fmtPct(rendimiento);

    const tb=document.getElementById("tbody");
    tb.innerHTML = rows.map(r=>{
      const isEditing=!!r._editing;
      const cell = (key, val, editable=false, fmt="text")=>{
        if(editable && isEditing){
          const v=(val??"").toString();
          return `<td><input data-edit="${r.id}" data-key="${key}" value="${escapeHtml(v)}" style="width:100%;border:none;outline:none;font:inherit;padding:4px 6px"/></td>`;
        }
        let out="";
        if(fmt==="num2") out = fmt2(parseNum(val));
        else out = escapeHtml(val??"");
        return `<td>${out}</td>`;
      };

      return `<tr data-row="${r.id}">
        ${cell("hora", r.hora, true)}
        ${cell("fecha", r.fecha, true)}
        ${cell("proveedor", r.proveedor, true)}
        ${cell("oc", r.oc, true)}
        ${cell("piscina", r.piscina, true)}
        ${cell("guias", r.guias, true)}
        ${cell("bines", r.bines, true)}
        ${cell("sector", r.sector, true)}
        ${cell("lote", r.lote, true)}
        ${cell("secuencial", r.secuencial, true)}
        ${cell("gramo", r.gramo, true, "num2")}
        <td>${r.talla===null?"":nf2.format(r.talla)}</td>
        ${cell("libras", r.libras, true, "num2")}
        <td>${r.promedio===null?"":nf0.format(r.promedio)}</td>
        <td>${r.planta===null?"":nf0.format(r.planta)}</td>
        ${cell("pesoCola", r.pesoCola, true, "num2")}
        ${cell("basura", r.basura, true)}
        ${cell("liquidando", r.liquidando, true, "num2")}
        <td>${r.rend===null?"":fmtPct(r.rend)}</td>
        <td style="text-align:center"><input class="chk" type="checkbox" data-toggle-edit="${r.id}" ${isEditing?"checked":""}></td>
        <td style="text-align:center"><button class="delLink" data-del="${r.id}">Eliminar</button></td>
      </tr>`;
    }).join("");

    // toggle edit
    tb.querySelectorAll("[data-toggle-edit]").forEach(chk=>{
      chk.addEventListener("change", ()=>{
        const id=chk.getAttribute("data-toggle-edit");
        const row=allRows.find(x=>x.id===id);
        if(!row) return;
        row._editing = chk.checked;
        if(!chk.checked) saveRowEdits(id);
        render();
      });
    });

    // TAB = baja misma columna
    tb.querySelectorAll("[data-edit]").forEach(inp=>{
      inp.addEventListener("keydown",(e)=>{
        if(e.key==="Tab"){
          e.preventDefault();
          const id=inp.getAttribute("data-edit");
          const key=inp.getAttribute("data-key");
          const vis=visibleRows();
          const idx=vis.findIndex(x=>x.id===id);
          const next=vis[idx+1];
          if(!next) return;
          const nextRow=allRows.find(x=>x.id===next.id);
          if(nextRow && !nextRow._editing) nextRow._editing=true;
          render();
          setTimeout(()=>{
            const target=document.querySelector(`[data-edit="${next.id}"][data-key="${key}"]`);
            if(target) target.focus();
          }, 0);
        }
      });
      inp.addEventListener("input", ()=>{
        const id=inp.getAttribute("data-edit");
        const key=inp.getAttribute("data-key");
        const row=allRows.find(x=>x.id===id);
        if(!row) return;
        row[key]=inp.value;
        render();
      });
    });

    // delete
    tb.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id=btn.getAttribute("data-del");
        if(!confirm("¿Eliminar esta fila?")) return;
        await deleteDoc(doc(db,"programacion",id));
        showToast("Fila eliminada.");
      });
    });

    document.getElementById("lastSync").innerText = nowStr();
  }

  function subscribeProgramacion(){
    if(progUnsub) progUnsub();
    const qp=query(progCol, orderBy("secuencial","asc"));
    progUnsub=onSnapshot(qp,(snap)=>{
      const rows=[];
      snap.forEach(d=>rows.push({id:d.id,_editing:false,...d.data()}));
      allRows=rows;
      render();
    });
  }

  /*******************************************************************
   * Form add (secuencial ingresado por usuario)
   *******************************************************************/
  function getForm(){
    return {
      hora:document.getElementById("fHora").value.trim(),
      fecha:document.getElementById("fFecha").value.trim(),
      proveedor:document.getElementById("fProveedor").value.trim(),
      oc:document.getElementById("fOC").value.trim(),
      piscina:document.getElementById("fPiscina").value.trim(),
      guias:document.getElementById("fGuias").value.trim(),
      bines:document.getElementById("fBines").value.trim(),
      sector:document.getElementById("fSector").value.trim(),
      lote:document.getElementById("fLote").value.trim(),
      secuencial:document.getElementById("fSecuencial").value.trim(),
      libras:document.getElementById("fLibras").value.trim(),
      gramo:"",
      basura:"",
      liquidando:"",
      pesoCola:""
    };
  }
  function clearForm(){
    ["fHora","fFecha","fProveedor","fOC","fPiscina","fGuias","fBines","fSector","fSecuencial","fLibras"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("fLote").value="";
  }

  
  /*******************************************************************
   * Navegación tipo Excel en INGRESAR
   * - TAB: baja (wrap al inicio), SHIFT+TAB: sube (wrap al final)
   * - ENTER: baja (como Excel). Si estás en el último campo (Libras) => guarda/insertar fila.
   * - Flechas ↑↓: suben/bajan entre campos.
   *******************************************************************/
  function setupIngresarNav(){
    const order = ["fHora","fFecha","fProveedor","fOC","fPiscina","fGuias","fBines","fSector","fLote","fSecuencial","fLibras"]
      .map(id=>document.getElementById(id))
      .filter(Boolean);

    const focusAt = (idx)=>{
      const el = order[(idx+order.length)%order.length];
      if(el){ el.focus(); if(el.select) el.select(); }
    };

    order.forEach((el,idx)=>{
      el.addEventListener("keydown",(e)=>{
        if(e.key==="Tab"){
          e.preventDefault();
          focusAt(idx + (e.shiftKey?-1:1));
          return;
        }
        if(e.key==="Enter"){
          e.preventDefault();
          // Si está en el último campo => guardar fila
          if(el.id==="fLibras"){
            document.getElementById("btnAdd").click();
            // Mantener el foco en Hora para la siguiente fila como Excel
            setTimeout(()=>{ focusAt(0); }, 50);
          }else{
            focusAt(idx+1);
          }
          return;
        }
        if(e.key==="ArrowDown"){
          e.preventDefault();
          focusAt(idx+1);
          return;
        }
        if(e.key==="ArrowUp"){
          e.preventDefault();
          focusAt(idx-1);
          return;
        }
      });
    });
  }

document.getElementById("btnAdd").addEventListener("click", async ()=>{
    if(!currentUserEmail) return;
    const f=getForm();
    if(!f.secuencial) return showToast("Falta Secuencial.");
    if(!f.lote) return showToast("Selecciona un Lote.");
    await addDoc(progCol, {
      ...f,
      createdAt:serverTimestamp(),
      createdAtText:nowStr(),
      createdBy:currentUserEmail,
      updatedAt:serverTimestamp(),
      updatedBy:currentUserEmail
    });
    showToast("Fila guardada en la nube.");
  });

  document.getElementById("btnClearFilters").addEventListener("click", ()=>{
    Object.keys(filters).forEach(k=>filters[k]="");
    rangeDesde=null; rangeHasta=null;
    document.querySelectorAll("#filterRow [data-filter]").forEach(el=>el.value="");
    document.getElementById("rDesde").value="";
    document.getElementById("rHasta").value="";
    render();
  });

  document.getElementById("rDesde").addEventListener("input", ()=>{
    const v=parseNum(document.getElementById("rDesde").value);
    rangeDesde = (v===null)?null:Number(v);
    render();
  });
  document.getElementById("rHasta").addEventListener("input", ()=>{
    const v=parseNum(document.getElementById("rHasta").value);
    rangeHasta = (v===null)?null:Number(v);
    render();
  });

  document.getElementById("btnPdf").addEventListener("click", ()=>{
    const rows=visibleRows();
    if(rows.length===0) return showToast("No hay filas visibles para imprimir.");

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation:"landscape", unit:"pt", format:"a4" });

    pdf.setFont("times","bold");
    pdf.setFontSize(14);
    pdf.text("SISTEMA DE PROGRAMACIÓN DIARIO DE PLANTA", 40, 30);

    pdf.setFont("times","normal");
    pdf.setFontSize(10);
    pdf.text(`Usuario: ${currentUserEmail}`, 40, 46);
    pdf.text(`Fecha: ${nowStr()}`, 40, 60);

    const sum=(key)=> rows.reduce((a,x)=>a+(parseNum(x[key])||0),0);
    const libras=sum("libras");
    const cola=libras*0.66;
    const pesoCola=sum("pesoCola");
    const planta = pesoCola ? pesoCola/0.66 : 0;
    const liquidado=sum("liquidando");
    const rendimiento = planta>0 ? (liquidado/planta) : 0;

    pdf.text(`Libras: ${nf2.format(libras)} | Cola aprox: ${nf2.format(cola)} | Peso cola: ${nf2.format(pesoCola)} | Planta: ${nf2.format(planta)} | Liquidado: ${nf2.format(liquidado)} | Rend: ${fmtPct(rendimiento)}`, 40, 76);

    const head = COLS.filter(c=>!["modificar","quitar"].includes(c.key)).map(c=>c.label);
    const body = rows.map(r=>{
      const d=calcRowDerived(r);
      return [
        d.hora??"", d.fecha??"", d.proveedor??"", d.oc??"", d.piscina??"",
        d.guias??"", d.bines??"", d.sector??"", d.lote??"", d.secuencial??"",
        fmt2(parseNum(d.gramo)), d.talla===null?"":nf2.format(d.talla),
        fmt2(parseNum(d.libras)), d.promedio===null?"":nf0.format(d.promedio),
        d.planta===null?"":nf0.format(d.planta),
        fmt2(parseNum(d.pesoCola)), d.basura??"", fmt2(parseNum(d.liquidando)),
        d.rend===null?"":fmtPct(d.rend)
      ];
    });

    pdf.autoTable({
      startY: 90,
      head: [head],
      body,
      theme: "grid",
      styles: { font:"times", fontSize:8, cellPadding:3 },
      headStyles: { fillColor:[31,78,121], textColor:[255,255,255] },
      margin: { left:40, right:40 }
    });

    const d=new Date();
    const pad=n=>String(n).padStart(2,"0");
    const fname = `Programacion_Oceantreasure_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}.pdf`;
    pdf.save(fname);
  });

  /*******************************************************************
   * Tabs (bottom)
   *******************************************************************/
  function showTab(which){
    document.getElementById("tab-programa").classList.toggle("hide", which!=="enero");
    document.getElementById("tab-crear").classList.toggle("hide", which!=="crear");
    document.getElementById("tabEnero").classList.toggle("active", which==="enero");
    document.getElementById("tabCrearBtn").classList.toggle("active", which==="crear");
  }
  document.getElementById("tabEnero").addEventListener("click", ()=>showTab("enero"));
  document.getElementById("tabCrearBtn").addEventListener("click", ()=>showTab("crear"));

  /*******************************************************************
   * Auth
   *******************************************************************/
  document.getElementById("btnLogin").addEventListener("click", async ()=>{
    const email=document.getElementById("email").value.trim();
    const pass=document.getElementById("pass").value;
    if(!email || !pass) return showToast("Ingresa correo y contraseña.");
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(err){
      console.error(err);
      showToast("No se pudo iniciar sesión. Revisa usuario/clave o dominios autorizados.");
    }
  });

  document.getElementById("btnLogout").addEventListener("click", async ()=>{
    await signOut(auth);
  });

  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      currentUserEmail=null;
      document.getElementById("loginView").classList.remove("hide");
      document.getElementById("appView").classList.add("hide");
      return;
    }

    const email = user.email || "";
    if(!ALLOWED_EMAILS.includes(email)){
      showToast("Este usuario no está autorizado para usar el sistema.");
      await signOut(auth);
      return;
    }

    currentUserEmail=email;

    document.getElementById("loginView").classList.add("hide");
    document.getElementById("appView").classList.remove("hide");

    document.getElementById("authUser").innerText=email;
    document.getElementById("whoEmail").innerText=email;

    document.getElementById("authNow").innerText=nowStr();
    setInterval(()=>{ document.getElementById("authNow").innerText=nowStr(); }, 1000);

    const isAdmin = (email===ADMIN_EMAIL);
    document.getElementById("tabCrearBtn").style.display = isAdmin ? "inline-block" : "none";
    showTab("enero");

    buildTableHeader();
    setupIngresarNav();
    await loadHeader();
    subscribeLotes(isAdmin);
    subscribeProgramacion();

    // refrescar opciones de filtro lote tras cargar lotes
    setTimeout(buildTableHeader, 600);
  });
</script>
</body>
</html>
