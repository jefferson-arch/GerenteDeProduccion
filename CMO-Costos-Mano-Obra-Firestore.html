<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CMO | Costos Mano de Obra</title>
  <style>
    :root{
      --blue:#1e88e5;
      --blue2:#0b5fb6;
      --cyan:#2bb7e3;
      --bg:#0b1220;
      --card:#0f1b33;
      --line:rgba(255,255,255,.12);
      --text:#e8eef9;
      --muted:rgba(232,238,249,.72);
      --good:#2e7d32;
      --warn:#ffb300;
      --bad:#d32f2f;
      --white:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0a1020;color:var(--text)}
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 14px;border-bottom:1px solid var(--line);background:linear-gradient(90deg, rgba(30,136,229,.22), rgba(43,183,227,.10));}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,.10);display:grid;place-items:center;overflow:hidden;border:1px solid rgba(255,255,255,.18)}
    .titlewrap{min-width:0}
    h1{margin:0;font-size:15px;letter-spacing:.3px}
    .sub{margin:2px 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .topbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pill{padding:7px 10px;border:1px solid var(--line);background:rgba(255,255,255,.06);border-radius:10px;font-size:12px;color:var(--text)}
    .btn{border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);padding:8px 10px;border-radius:10px;font-weight:700;font-size:12px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg, rgba(30,136,229,.95), rgba(11,95,182,.95));border-color:rgba(255,255,255,.20)}
    .btn.danger{background:rgba(211,47,47,.18);border-color:rgba(211,47,47,.35)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    main{max-width:1280px;margin:0 auto;padding:12px}
    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:12px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(15,27,51,.92);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .cardhd{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);background:rgba(255,255,255,.04)}
    .cardhd b{font-size:12px;letter-spacing:.3px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    label{font-size:12px;color:var(--muted)}
    input[type="number"], input[type="time"], input[type="date"]{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:5px 6px;
      border-radius:10px;
      font-size:12px;
      outline:none;
    }
    input[type="number"]{width:110px}
    input[type="time"]{width:106px}
    input[type="date"]{width:150px}
    .tablewrap{overflow:auto}
    table{border-collapse:collapse;width:100%;min-width:920px}
    th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:4px 6px;font-size:12px;white-space:nowrap}
    th{position:sticky;top:0;background:rgba(10,16,32,.85);backdrop-filter: blur(6px);z-index:2;text-align:left;color:#d8e6ff;font-size:11px;letter-spacing:.35px}
    td.num, th.num{text-align:right}
    td.small{font-size:11px;color:var(--muted)}
    tr.total td{font-weight:800;background:rgba(255,255,255,.03)}
    .muted{color:var(--muted)}
    .rightTop{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);background:linear-gradient(90deg, rgba(30,136,229,.18), rgba(43,183,227,.06));}
    .metric{display:flex;flex-direction:column;gap:3px;padding:10px;border:1px solid rgba(255,255,255,.14);border-radius:14px;background:rgba(255,255,255,.04)}
    .metric span{font-size:11px;color:rgba(232,238,249,.75);letter-spacing:.4px}
    .metric b{font-size:24px;letter-spacing:.4px}
    .metric b.green{color:#7CFC7C}
    .metric b.blue{color:#8cc7ff}
    .metric b.white{color:#ffffff}
    .metric b.small{font-size:20px}
    .art{padding:10px 12px}
    .artbox{border:1px solid rgba(255,255,255,.14);border-radius:14px;background:rgba(255,255,255,.03);overflow:hidden}
    .footerbox{padding:10px 12px;border-top:1px solid var(--line);display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .status{font-size:12px;color:var(--muted)}
    .warn{color:#ffd27d}
    .ok{color:#86ffb4}
    .err{color:#ff8a80}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px;padding:2px 6px;border:1px solid rgba(255,255,255,.18);border-radius:8px;background:rgba(255,255,255,.05);color:rgba(232,238,249,.9)}
    /* login modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:5000}
    .modal.show{display:flex}
    .login{width:100%;max-width:420px;background:rgba(15,27,51,.96);border:1px solid rgba(255,255,255,.18);border-radius:16px;overflow:hidden}
    .login .hd{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)}
    .login .bd{padding:14px;display:grid;gap:10px}
    .login input{width:100%}
    .login .row{display:flex;gap:8px}
    .login .row .btn{flex:1}
  
    .seg{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .segBtn{border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);padding:6px 10px;border-radius:12px;font-weight:700;font-size:12px;cursor:pointer}
    .segBtn.active{background:linear-gradient(180deg, rgba(43,183,227,.95), rgba(30,136,229,.85));border-color:rgba(255,255,255,.20)}
    .chartBox{border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;background:rgba(255,255,255,.02);height:260px}
    .chartBox canvas{width:100% !important;height:100% !important}

  </style>
</head>
<body class="safe">
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true">
      <!-- simple wave logo -->
      <svg width="42" height="42" viewBox="0 0 64 64" fill="none">
        <path d="M10 26c8-10 18-14 30-12 6 1 10 4 14 8" stroke="rgba(140,199,255,.95)" stroke-width="4" stroke-linecap="round"/>
        <path d="M10 38c9-8 18-11 30-9 6 1 10 3 14 6" stroke="rgba(43,183,227,.95)" stroke-width="4" stroke-linecap="round"/>
        <path d="M10 50c10-6 20-8 30-6 6 1 10 2 14 4" stroke="rgba(255,255,255,.85)" stroke-width="4" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="titlewrap">
      <h1>COSTOS POR MANO DE OBRA — OCEAN TREASURE</h1>
      <div class="sub" id="subline">Firebase + GitHub • Vista para todos los logueados • Edición solo para editores</div>
    </div>
  </div>
  <div class="topbar">
    <span class="pill" id="userPill">No logueado</span>
    <button class="btn" id="btnLogin">Login</button>
    <button class="btn danger" id="btnLogout" style="display:none">Salir</button>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="cardhd">
        <b>Tabla de costos por área</b>
        <div class="controls">
          <label>Fecha</label>
          <input type="date" id="fecha" />
          <label>Incentivo ($/h)</label>
          <input type="number" id="incentivo" step="0.01" />
          <label>Libras procesadas</label>
          <input type="number" id="libras" step="1" />
          <button class="btn" id="btnNuevo">NUEVO</button>
          <button class="btn primary" id="btnGuardar">GUARDAR</button>
        </div>
      </div>

      <div class="tablewrap">
        <table id="tabla">
          <thead>
            <tr>
              <th>ÁREA</th>
              <th class="num">CUPO</th>
              <th class="num">BASE $/H</th>
              <th class="num">VALOR $/H</th>
              <th class="num">HI</th>
              <th class="num">HF</th>
              <th class="num">AL</th>
              <th class="num">HT</th>
              <th class="num">COSTO ÁREA</th>
              <th class="num">COSTO TOTAL ÁREA/JORNADA</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr class="total">
              <td>Total</td>
              <td class="num" id="tCupo">0</td>
              <td></td>
              <td></td>
              <td colspan="3"></td>
              <td class="num muted" id="tHt">—</td>
              <td class="num" id="tCostoArea">0</td>
              <td class="num" id="tCostoJornada">0</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="footerbox">
        <div class="status" id="status">Estado: <span class="warn">sin cargar</span></div>
        <div class="status">
          Tips: <span class="kbd">Tab</span> avanza • <span class="kbd">Enter</span> recalcula • si no eres editor, verás todo pero no podrás guardar.
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <div class="rightTop">
        <div class="metric">
          <span>LIBRAS PROCESADAS</span>
          <b class="green" id="mLibras">0</b>
        </div>
        <div class="metric">
          <span>VALOR NOMINAL JORNADA</span>
          <b class="white small" id="mNominal">$ 0,00</b>
        </div>
        <div class="metric">
          <span>MANO DE OBRA (CUPO TOTAL)</span>
          <b class="blue" id="mMano">0</b>
        </div>
        <div class="metric">
          <span>COSTO DE PRODUCCIÓN ($/lb)</span>
          <b class="blue" id="mCostoProd">$ 0,0000</b>
        </div>
      </div>

      </div>

    </aside>
  </div>
</main>

<!-- LOGIN MODAL -->
<div class="modal" id="modal">
  <div class="login">
    <div class="hd"><b>Login</b> <div class="muted" style="font-size:12px;margin-top:4px">Usa tu correo y contraseña de Firebase Auth</div></div>
    <div class="bd">
      <div>
        <label>Correo</label>
        <input id="email" value="jeffersonfigueroa@oceantreasure.local" type="email" placeholder="usuario@oceantreasure.local" autocomplete="username"/>
      </div>
      <div>
        <label>Contraseña</label>
        <input id="pass" type="password" placeholder="••••••••" autocomplete="current-password"/>
      </div>
      <div class="row">
        <button class="btn" id="btnCancelar">Cancelar</button>
        <button class="btn primary" id="btnEntrar">Entrar</button>
      </div>
      <div class="status" id="loginMsg"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
  // ====== Firebase (v9 modular) ======
  // ✅ Tu config
  const firebaseConfig = {"apiKey": "AIzaSyCMoLkSnnLowMagRNL7O6ttPo1FXd1URac", "authDomain": "oceantreasure-app.firebaseapp.com", "projectId": "oceantreasure-app", "storageBucket": "oceantreasure-app.firebasestorage.app", "messagingSenderId": "553014659258", "appId": "1:553014659258:web:cfc30844a88433b7b79a83", "measurementId": "G-HMMQKJY8NJ"};

  const EDITORS = new Set([
    "yanelavinueza@oceantreasure.local",
    "jeffersonfigueroa@oceantreasure.local",
    "milenalmeida@oceantreasure.local",
    "aracellytomala@oceantreasure.local",
    "keniacruz@oceantreasure.local",
    "rrhh@oceantreasure.local",
    "soporte@oceantreasure.local",
    "liquidacionesdepago@oceantreasure.local",
    "ordenesdeproduccion@oceantreasure.local"
  ]);

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
const COL = "cmo_costos_mo"; // colección principal

  // ====== Defaults (desde tu Excel) ======
  const DEFAULTS = {"incentivo": 0.2, "librasProcesadas": 30000, "rows": [{"area": "RECEPCION", "cupo": 4.0, "baseRate": 1.7, "hi": 7.583333333333333, "hf": 12.0, "al": 1.0, "htFixed": null}, {"area": "DESCABEZADO C1", "cupo": 7.0, "baseRate": 2.0, "hi": 7.5, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "DESCABEZADO C2", "cupo": 4.0, "baseRate": 2.0, "hi": 7.683333333333334, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "PESADOR - SELLADOR MQ", "cupo": 6.0, "baseRate": 2.0, "hi": 8.5, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "TOLVERO - OPERADOR", "cupo": 3.0, "baseRate": 2.0, "hi": 8.5, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "CAJERO - AUXILIAR MQ", "cupo": 10.0, "baseRate": 1.9, "hi": 8.5, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "VARIOS MQ1", "cupo": 6.0, "baseRate": 1.7, "hi": 8.5, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "VARIOS MQ2", "cupo": 7.0, "baseRate": 1.7, "hi": 8.5, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "PRECAJAS", "cupo": 6.0, "baseRate": 1.7, "hi": 8.266666666666667, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "BODEGA", "cupo": 1.0, "baseRate": 1.7, "hi": 7.833333333333333, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "CONGELACION", "cupo": 3.0, "baseRate": 2.0, "hi": 8.45, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "PRODUCCION", "cupo": 12.0, "baseRate": 2.0, "hi": 8.0, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "CALIDAD", "cupo": 0, "baseRate": 1.8, "hi": null, "hf": 12.0, "al": 0, "htFixed": null}, {"area": "MASTERIZADO", "cupo": 5.0, "baseRate": 2.0, "hi": 8.466666666666667, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "CAMARA", "cupo": 5.0, "baseRate": 2.0, "hi": 8.466666666666667, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "EMBARQUE", "cupo": 4.0, "baseRate": 2.0, "hi": 8.466666666666667, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "CASILLEROS", "cupo": 1.0, "baseRate": 1.7, "hi": 7.216666666666667, "hf": 12.0, "al": 1.5, "htFixed": null}, {"area": "LAVADO MATERIAL", "cupo": 1.0, "baseRate": 1.7, "hi": 8.0, "hf": 12.0, "al": 1.0, "htFixed": null}, {"area": "BAÑOS", "cupo": 1.0, "baseRate": 2.0, "hi": 7.833333333333333, "hf": 12.0, "al": 1.0, "htFixed": null}, {"area": "Limpieza Turno noche", "cupo": 9.0, "baseRate": 1.7, "hi": 19.0, "hf": 6.0, "al": 1.0, "htFixed": 10.0}]};

  // ====== Helpers ======
  const $ = (id)=>document.getElementById(id);
  const esEC = new Intl.NumberFormat("es-EC");
  const esEC2 = new Intl.NumberFormat("es-EC", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const esEC4 = new Intl.NumberFormat("es-EC", { minimumFractionDigits: 4, maximumFractionDigits: 4 });

  function fmtInt(n){ return esEC.format(Math.round(Number(n||0))); }
  function fmt2(n){ return esEC2.format(Number(n||0)); }
  function fmt4(n){ return esEC4.format(Number(n||0)); }

  function timeToNum(tStr){
    if(!tStr) return null;
    const [h,m] = tStr.split(":").map(Number);
    if(Number.isNaN(h)||Number.isNaN(m)) return null;
    return h + (m/60);
  }
  function numToTime(n){
    if(n===null || n===undefined) return "";
    n = Number(n);
    if(!Number.isFinite(n)) return "";
    let h = Math.floor(n);
    let m = Math.round((n - h) * 60);
    if(m===60){ m=0; h=(h+1)%24; }
    return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
  }

  function calcHT(hi, hf, al, htFixed){
    // si hay HT fijo en excel, úsalo (ej: turno noche)
    if(Number.isFinite(htFixed)) return Math.max(0, Number(htFixed));
    if(hi===null || hf===null) return 0;
    let dur = hf - hi;
    if(dur < 0) dur += 24; // cruza medianoche
    let ht = dur - (Number(al||0));
    if(!Number.isFinite(ht)) return 0;
    return Math.max(0, ht);
  }

  function round2(n){ return Math.round((Number(n||0) + Number.EPSILON)*100)/100; }

  
  // ====== Dashboard charts (Chart.js) ======
  let areaBar = null;
  let areaDonut = null;
  let htScatter = null;
  let prodChart = null;

  let areaMetric = "costoJornada";
  let tarifaSeg = "all";
  let groupSeg = "day";
  let prodBarsMetric = "libras";

  function computeRowMetrics(r){
    const valorHora = Number(r.baseRate||0) + Number(model.incentivo||0);
    const hi = (r.hi===null || r.hi===undefined) ? null : Number(r.hi);
    const hf = (r.hf===null || r.hf===undefined) ? null : Number(r.hf);
    const al = Number(r.al||0);
    const ht = calcHT(hi, hf, al, r.htFixed);
    const costoArea = valorHora * ht;
    const costoJornada = costoArea * Number(r.cupo||0);
    return { valorHora, ht, costoArea, costoJornada };
  }

  function tarifaBucket(valorHora){
    if(valorHora <= 1.90) return "low";
    if(valorHora <= 2.10) return "mid";
    return "high";
  }

  function getFilteredRows(){
    const sel = $("areaFilter")?.value || "__all__";
    return model.rows.filter(r=>{
      const m = computeRowMetrics(r);
      if(tarifaSeg !== "all" && tarifaBucket(m.valorHora) !== tarifaSeg) return false;
      if(sel !== "__all__" && r.area !== sel) return false;
      return true;
    });
  }

  function buildAreaDatasets(){
    const rows = getFilteredRows();
    const labels = [];
    const values = [];
    const donutValues = [];
    const donutLabels = [];
    const scatter = []; // {x: cupo, y: ht}

    rows.forEach(r=>{
      const m = computeRowMetrics(r);
      labels.push(r.area);

      let v = 0;
      if(areaMetric==="cupo") v = Number(r.cupo||0);
      else if(areaMetric==="ht") v = Number(m.ht||0);
      else if(areaMetric==="costoArea") v = Number(m.costoArea||0);
      else v = Number(m.costoJornada||0);
      values.push(v);

      // donut en base a costo/jornada
      donutLabels.push(r.area);
      donutValues.push(Number(m.costoJornada||0));

      scatter.push({ x: Number(r.cupo||0), y: Number(m.ht||0), area: r.area });
    });

    return { labels, values, donutLabels, donutValues, scatter };
  }

  function ensureChartColors(){
    // dejamos default, pero afinamos grid/ticks con blanco/celeste/azul/negro (sin cambiar colores de dataset)
    return {
      tick: "rgba(232,238,249,.82)",
      grid: "rgba(255,255,255,.06)"
    };
  }

  function updateAreaCharts(){
    if(!window.Chart) return;
    const {labels, values, donutLabels, donutValues, scatter} = buildAreaDatasets();
    const c = ensureChartColors();

    const labelMap = {
      cupo: "Cupo",
      ht: "HT (horas)",
      costoArea: "Costo área ($)",
      costoJornada: "Costo total/jornada ($)"
    };

    // BAR
    const ctxBar = $("areaChart")?.getContext("2d");
    if(ctxBar){
      if(!areaBar){
        areaBar = new Chart(ctxBar, {
          type: "bar",
          data: { labels, datasets: [{ label: labelMap[areaMetric], data: values, borderWidth: 1 }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true } },
            scales: {
              x: { ticks: { color: c.tick }, grid: { color: c.grid } },
              y: { ticks: { color: c.tick }, grid: { color: c.grid } }
            }
          }
        });
      }else{
        areaBar.data.labels = labels;
        areaBar.data.datasets[0].data = values;
        areaBar.data.datasets[0].label = labelMap[areaMetric];
        areaBar.update();
      }
    }

    // DONUT
    const ctxDonut = $("areaDonut")?.getContext("2d");
    if(ctxDonut){
      if(!areaDonut){
        areaDonut = new Chart(ctxDonut, {
          type: "doughnut",
          data: { labels: donutLabels, datasets: [{ data: donutValues, borderWidth: 1 }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });
      }else{
        areaDonut.data.labels = donutLabels;
        areaDonut.data.datasets[0].data = donutValues;
        areaDonut.update();
      }
    }

    // SCATTER (puntos/círculos)
    const ctxSc = $("htScatter")?.getContext("2d");
    if(ctxSc){
      const pts = scatter.map(p=>({ x:p.x, y:p.y }));
      if(!htScatter){
        htScatter = new Chart(ctxSc, {
          type: "scatter",
          data: { datasets: [{ label: "HT vs Cupo", data: pts, pointRadius: 5, pointHoverRadius: 7 }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true } },
            scales: {
              x: { title:{display:true, text:"Cupo"}, ticks:{color:c.tick}, grid:{color:c.grid} },
              y: { title:{display:true, text:"HT (horas)"}, ticks:{color:c.tick}, grid:{color:c.grid} }
            }
          }
        });
      }else{
        htScatter.data.datasets[0].data = pts;
        htScatter.update();
      }
    }
  }

  // ====== Productividad (acumulado diario) ======
  let dailyCache = []; // [{fecha, dia, N, cupo, nominal, libras, costoProd}]
  let prodSeriesCache = []; // [{key,label,libras,nominal,cupo,costoProd}]

  function isoWeekKey(d){
    // ISO week key "YYYY-Www"
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = (date.getUTCDay() + 6) % 7;
    date.setUTCDate(date.getUTCDate() - dayNum + 3);
    const firstThursday = new Date(Date.UTC(date.getUTCFullYear(),0,4));
    const week = 1 + Math.round(((date - firstThursday) / 86400000 - 3 + ((firstThursday.getUTCDay()+6)%7)) / 7);
    const year = date.getUTCFullYear();
    return `${year}-W${String(week).padStart(2,"0")}`;
  }

  function buildProdSeries(){
    const by = new Map();

    for(const r of dailyCache){
      const d = new Date((r.fecha||"")+"T00:00:00");
      let key = r.fecha;
      let label = r.fecha;
      if(groupSeg==="week"){
        key = isoWeekKey(d);
        label = key;
      }else if(groupSeg==="month"){
        key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
        label = key;
      }

      const cur = by.get(key) || { key, label, libras:0, nominal:0, cupo:0, _count:0 };
      cur.libras += Number(r.libras||0);
      cur.nominal += Number(r.nominal||0);
      cur.cupo += Number(r.cupo||0);
      cur._count += 1;
      by.set(key, cur);
    }

    // costoProd promedio ponderado por libras (más real)
    const arr = Array.from(by.values()).sort((a,b)=>a.key.localeCompare(b.key)).map(x=>{
      const costoProd = x.libras>0 ? (x.nominal/x.libras) : 0;
      return { key:x.key, label:x.label, libras:x.libras, nominal:x.nominal, cupo:x.cupo, costoProd };
    });

    prodSeriesCache = arr;
  }

  function updateProdChart(){
    if(!window.Chart) return;
    buildProdSeries();
    const c = ensureChartColors();

    const labels = prodSeriesCache.map(x=>x.label);
    const bars = prodSeriesCache.map(x=>{
      if(prodBarsMetric==="nominal") return x.nominal;
      if(prodBarsMetric==="cupo") return x.cupo;
      return x.libras;
    });
    const line = prodSeriesCache.map(x=>x.costoProd);

    const barLabel = prodBarsMetric==="nominal" ? "Valor nominal ($)" : (prodBarsMetric==="cupo" ? "Cupo" : "Libras procesadas");
    const ctx = $("prodChart")?.getContext("2d");
    if(!ctx) return;

    if(!prodChart){
      prodChart = new Chart(ctx, {
        data: {
          labels,
          datasets: [
            { type:"bar", label: barLabel, data: bars, borderWidth: 1, yAxisID:"y" },
            { type:"line", label:"Costo producción ($/lb)", data: line, yAxisID:"y1", tension:0.25, pointRadius:5, pointHoverRadius:7 }
          ]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{display:true} },
          scales:{
            x:{ ticks:{color:c.tick}, grid:{color:c.grid} },
            y:{ position:"left", ticks:{color:c.tick}, grid:{color:c.grid} },
            y1:{ position:"right", ticks:{color:c.tick}, grid:{drawOnChartArea:false}, suggestedMin:0 }
          }
        }
      });
    }else{
      prodChart.data.labels = labels;
      prodChart.data.datasets[0].data = bars;
      prodChart.data.datasets[0].label = barLabel;
      prodChart.data.datasets[1].data = line;
      prodChart.update();
    }
  }

  // ====== Export Excel ======
  function exportExcel(){
    if(!window.XLSX){
      alert("No se pudo cargar XLSX (SheetJS). Revisa tu conexión o CDN.");
      return;
    }
    const wb = XLSX.utils.book_new();

    // Hoja 1: Resumen diario (tabla)
    const sheet1 = [["DIA","N","CUPO","VALOR_NOMINAL","LIBRAS_PROCESADAS","COSTO_PRODUCCION"]];
    dailyCache.forEach(r=>{
      sheet1.push([r.dia, r.N, r.cupo, r.nominal, r.libras, r.costoProd]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet1), "RESUMEN_DIARIO");

    // Hoja 2: Productividad agrupada
    buildProdSeries();
    const sheet2 = [["GRUPO", "LIBRAS", "VALOR_NOMINAL", "CUPO", "COSTO_PRODUCCION"]];
    prodSeriesCache.forEach(x=>{
      sheet2.push([x.label, x.libras, x.nominal, x.cupo, x.costoProd]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet2), "PRODUCTIVIDAD");

    // Hoja 3: Por área (día actual en pantalla)
    const sheet3 = [["AREA","CUPO","BASE_RATE","INCENTIVO","VALOR_HORA","HI","HF","AL","HT","COSTO_AREA","COSTO_JORNADA"]];
    model.rows.forEach(r=>{
      const m = computeRowMetrics(r);
      sheet3.push([
        r.area, Number(r.cupo||0), Number(r.baseRate||0), Number(model.incentivo||0),
        m.valorHora, r.hi, r.hf, Number(r.al||0), m.ht, m.costoArea, m.costoJornada
      ]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet3), "POR_AREA");

    const fecha = $("fecha")?.value || "export";
    XLSX.writeFile(wb, `CMO_${fecha}.xlsx`);
  }


  async function loadDailySummary(){
    try{
      const snap = await db.collection(COL).orderBy("fecha","desc").limit(30).get();
      const tb = $("dailyTbody");
      if(!tb) return;
      tb.innerHTML = "";

      let sumCupo=0, sumNominal=0, sumLibras=0, sumCostoProd=0;
      let nCount = 0;

      dailyCache = [];
      let N = snap.size;

      for(const docu of snap.docs){
        const d = docu.data() || {};
        const fecha = d.fecha || docu.id;
        const incent = Number(d.incentivo||0);
        const libras = Number(d.librasProcesadas||0);
        const rows = Array.isArray(d.rows) ? d.rows : [];

        let cupoTotal = 0;
        let nominal = 0;

        for(const r0 of rows){
          const baseRate = Number(r0.baseRate||0);
          const valorHora = baseRate + incent;
          const hi = (r0.hi===null || r0.hi===undefined) ? null : Number(r0.hi);
          const hf = (r0.hf===null || r0.hf===undefined) ? null : Number(r0.hf);
          const al = Number(r0.al||0);
          const ht = calcHT(hi, hf, al, r0.htFixed);
          const costoArea = valorHora * ht;
          const costoJornada = costoArea * Number(r0.cupo||0);
          cupoTotal += Number(r0.cupo||0);
          nominal += costoJornada;
        }

        const costoProd = libras>0 ? (nominal / libras) : 0;

        const dt = new Date(fecha+"T00:00:00");
        const dia = dt.toLocaleDateString("es-EC", { weekday:"long" }).toUpperCase();

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${dia}</td>
          <td class="num">${N}</td>
          <td class="num">${fmtInt(cupoTotal)}</td>
          <td class="num">$ ${fmt2(nominal)}</td>
          <td class="num">${fmtInt(libras)}</td>
          <td class="num">${fmt4(costoProd)}</td>
        `;
        tb.appendChild(tr);

        dailyCache.push({ fecha, dia, N, cupo: cupoTotal, nominal, libras, costoProd });

        sumCupo += cupoTotal;
        sumNominal += nominal;
        sumLibras += libras;
        sumCostoProd += costoProd;
        nCount += 1;
        N -= 1;
      }

      updateProdChart();

      if(nCount>0){
        $("avgCupo").textContent = fmtInt(sumCupo/nCount);
        $("avgNominal").textContent = "$ "+fmt2(sumNominal/nCount);
        $("avgLibras").textContent = fmtInt(sumLibras/nCount);
        $("avgCostoProd").textContent = fmt4(sumCostoProd/nCount);
      }else{
        $("avgCupo").textContent = "0";
        $("avgNominal").textContent = "$ 0,00";
        $("avgLibras").textContent = "0";
        $("avgCostoProd").textContent = "0,0000";
      }
    }catch(err){
      console.error(err);
    }
  }

  // ====== State ======
  let currentUser = null;
  let canEdit = false;
  let currentDocId = null; // doc activo (fecha)
  let model = structuredClone(DEFAULTS);

  // ====== UI render ======
  function render(){
    // header inputs
    $("incentivo").value = model.incentivo ?? 0;
    $("libras").value = model.librasProcesadas ?? 0;

    // metrics
    $("mLibras").textContent = fmtInt(model.librasProcesadas||0);

    const tb = $("tbody");
    tb.innerHTML = "";

    // llena dropdown de área (una vez)
    const af = $("areaFilter");
    if(af && af.options.length <= 1){
      af.innerHTML = "";
      const o0 = document.createElement("option");
      o0.value="__all__";
      o0.textContent="Área: Todas";
      af.appendChild(o0);
      model.rows.forEach(r=>{
        const o = document.createElement("option");
        o.value = r.area;
        o.textContent = r.area;
        af.appendChild(o);
      });
    }

    let totalCupo = 0;
    let totalCostoArea = 0;   // suma de costo área unitario (no es súper útil, pero lo dejamos como excel)
    let totalCostoJornada = 0;

    model.rows.forEach((r, idx)=>{
      const valorHora = Number(r.baseRate||0) + Number(model.incentivo||0);
      const hi = (r.hi===null || r.hi===undefined) ? null : Number(r.hi);
      const hf = (r.hf===null || r.hf===undefined) ? null : Number(r.hf);
      const al = Number(r.al||0);
      const ht = calcHT(hi, hf, al, r.htFixed);
      const costoArea = valorHora * ht;
      const costoJornada = costoArea * Number(r.cupo||0);

      totalCupo += Number(r.cupo||0);
      totalCostoArea += costoArea;
      totalCostoJornada += costoJornada;

      const tr = document.createElement("tr");

      function td(text, cls){
        const e=document.createElement("td");
        if(cls) e.className=cls;
        e.textContent=text;
        return e;
      }

      tr.appendChild(td(r.area||"", ""));
      // cupo
      {
        const tdEl=document.createElement("td"); tdEl.className="num";
        const inp=document.createElement("input");
        inp.type="number"; inp.step="1"; inp.value = r.cupo ?? 0;
        inp.disabled = !canEdit;
        inp.addEventListener("input", ()=>{ r.cupo = Number(inp.value||0); recalc(); });
        tdEl.appendChild(inp); tr.appendChild(tdEl);
      }
      // base rate
      {
        const tdEl=document.createElement("td"); tdEl.className="num";
        const inp=document.createElement("input");
        inp.type="number"; inp.step="0.01"; inp.value = r.baseRate ?? 0;
        inp.disabled = !canEdit;
        inp.addEventListener("input", ()=>{ r.baseRate = Number(inp.value||0); recalc(); });
        tdEl.appendChild(inp); tr.appendChild(tdEl);
      }
      tr.appendChild(td("$ "+fmt2(valorHora), "num"));
      // HI
      {
        const tdEl=document.createElement("td"); tdEl.className="num";
        const inp=document.createElement("input");
        inp.type="time"; inp.value = numToTime(r.hi);
        inp.disabled = !canEdit;
        inp.addEventListener("input", ()=>{ r.hi = timeToNum(inp.value); recalc(); });
        tdEl.appendChild(inp); tr.appendChild(tdEl);
      }
      // HF
      {
        const tdEl=document.createElement("td"); tdEl.className="num";
        const inp=document.createElement("input");
        inp.type="time"; inp.value = numToTime(r.hf);
        inp.disabled = !canEdit;
        inp.addEventListener("input", ()=>{ r.hf = timeToNum(inp.value); recalc(); });
        tdEl.appendChild(inp); tr.appendChild(tdEl);
      }
      // AL
      {
        const tdEl=document.createElement("td"); tdEl.className="num";
        const inp=document.createElement("input");
        inp.type="number"; inp.step="0.5"; inp.value = r.al ?? 0;
        inp.disabled = !canEdit;
        inp.addEventListener("input", ()=>{ r.al = Number(inp.value||0); recalc(); });
        tdEl.appendChild(inp); tr.appendChild(tdEl);
      }
      tr.appendChild(td(fmt2(ht), "num"));
      tr.appendChild(td("$ "+fmt2(costoArea), "num"));
      tr.appendChild(td("$ "+fmt2(costoJornada), "num"));

      tb.appendChild(tr);
    });

    // totals
    $("tCupo").textContent = fmtInt(totalCupo);
    $("tCostoArea").textContent = "$ "+fmt2(totalCostoArea);
    $("tCostoJornada").textContent = "$ "+fmt2(totalCostoJornada);

    // right metrics
    $("mNominal").textContent = "$ "+fmt2(totalCostoJornada);
    $("mMano").textContent = fmtInt(totalCupo);

    const libras = Number(model.librasProcesadas||0);
    const costoProd = libras>0 ? (totalCostoJornada / libras) : 0;
    $("mCostoProd").textContent = "$ "+fmt4(costoProd);

    // status
    $("status").innerHTML = 'Estado: <span class="'+(canEdit?'ok':'warn')+'">'+(canEdit?'Editor (puedes guardar)':'Solo vista')+'</span>';

    // dashboard chart
    updateAreaCharts();
  }

  let raf = null;
  function recalc(){
    if(raf) cancelAnimationFrame(raf);
    raf = requestAnimationFrame(()=>render());
  }

  function setInputsEnabled(){
    $("btnGuardar").disabled = !canEdit;
    $("incentivo").disabled = !canEdit;
    $("libras").disabled = !canEdit;
  }

  // ====== Data IO ======
  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,10);
  }

  function docIdFromDate(dateISO){
    // un documento por fecha (YYYY-MM-DD)
    return dateISO;
  }

  async function loadLatest(){
    try{
      const snap = await db.collection(COL).orderBy("fecha","desc").limit(1).get();
      if(snap.empty) return;
      const d = snap.docs[0].data();
      if(d){
        applyDataToModel(d);
        $("lastLoad").textContent = new Date().toLocaleString("es-EC");
      }
    }catch(err){
      console.error(err);
    }
  }
      const d = snap.docs[0];
      const data = d.data();
      currentDocId = d.id;
      applyDataToModel(data);
      $("fecha").value = data.fecha || currentDocId;
      $("lastLoad").textContent = new Date().toLocaleString("es-EC");
      // refresca resumen
      loadDailySummary();
      recalc();
    }catch(err){
      console.error(err);
      $("status").innerHTML = 'Estado: <span class="err">Error cargando: '+(err?.message||err)+'</span>';
    }
  }

  async function loadByDate(dateISO){
    const id = docIdFromDate(dateISO);
    try{
      const ref = db.collection(COL).doc(id);
      const snap = await ref.get();
      if(!snap.exists){
        currentDocId = id;
        model = structuredClone(DEFAULTS);
        model.librasProcesadas = Number($("libras").value||DEFAULTS.librasProcesadas);
        model.incentivo = Number($("incentivo").value||DEFAULTS.incentivo);
        recalc();
        $("lastLoad").textContent = "sin registro (defaults)";
        return;
      }
      currentDocId = id;
      applyDataToModel(snap.data());
      $("lastLoad").textContent = new Date().toLocaleString("es-EC");
      recalc();
    }catch(err){
      console.error(err);
      $("status").innerHTML = 'Estado: <span class="err">Error cargando fecha: '+(err?.message||err)+'</span>';
    }
  }

  function applyDataToModel(data){
    // Normaliza para no romper si falta algo
    model = structuredClone(DEFAULTS);
    if(data && typeof data === "object"){
      if("incentivo" in data) model.incentivo = Number(data.incentivo||0);
      if("librasProcesadas" in data) model.librasProcesadas = Number(data.librasProcesadas||0);
      if(Array.isArray(data.rows)){
        // match por area, para no perder orden
        const map = new Map(data.rows.map(x=>[x.area, x]));
        model.rows = model.rows.map(r=> {
          const saved = map.get(r.area);
          if(!saved) return r;
          return {
            ...r,
            cupo: Number(saved.cupo ?? r.cupo ?? 0),
            baseRate: Number(saved.baseRate ?? r.baseRate ?? 0),
            hi: saved.hi===null || saved.hi===undefined ? r.hi : Number(saved.hi),
            hf: saved.hf===null || saved.hf===undefined ? r.hf : Number(saved.hf),
            al: Number(saved.al ?? r.al ?? 0),
            htFixed: Number.isFinite(saved.htFixed) ? Number(saved.htFixed) : r.htFixed
          };
        });
      }
    }
    $("incentivo").value = model.incentivo;
    $("libras").value = model.librasProcesadas;
  }

  async function save(){
    if(!canEdit) return;
    const fecha = $("fecha").value || todayISO();
    const id = docIdFromDate(fecha);
    const payload = {
      fecha,
      incentivo: Number(model.incentivo||0),
      librasProcesadas: Number(model.librasProcesadas||0),
      rows: model.rows.map(r=>({
        area: r.area,
        cupo: Number(r.cupo||0),
        baseRate: Number(r.baseRate||0),
        hi: (r.hi===null||r.hi===undefined) ? null : Number(r.hi),
        hf: (r.hf===null||r.hf===undefined) ? null : Number(r.hf),
        al: Number(r.al||0),
        htFixed: Number.isFinite(r.htFixed) ? Number(r.htFixed) : null
      })),
      updatedBy: currentUser?.email || null,
      updatedAt: serverTimestamp()
    };
    try{
      await db.collection(COL).doc(id).set(payload, { merge: true });
      currentDocId = id;
      $("status").innerHTML = 'Estado: <span class="ok">Guardado ✅</span>';
      $("lastLoad").textContent = new Date().toLocaleString("es-EC");
    }catch(err){
      console.error(err);
      $("status").innerHTML = 'Estado: <span class="err">No se pudo guardar: '+(err?.message||err)+'</span>';
    }
  }

  // ====== Events ======
  $("fecha").value = todayISO();

  // Tabs
  function setTab(which){
    $("panelArea").style.display = which==="area" ? "" : "none";
    $("panelProd").style.display = which==="prod" ? "" : "none";
    $("tabArea").classList.toggle("primary", which==="area");
    $("tabProd").classList.toggle("primary", which==="prod");
    if(which==="area") updateAreaCharts();
    else updateProdChart();
  }
  $("tabArea").addEventListener("click", ()=>setTab("area"));
  $("tabProd").addEventListener("click", ()=>setTab("prod"));

  // Segmentación métricas (área)
  $("segMetric").addEventListener("click", (e)=>{
    const b = e.target.closest(".segBtn"); if(!b) return;
    areaMetric = b.dataset.m;
    for(const x of $("segMetric").querySelectorAll(".segBtn")) x.classList.toggle("active", x===b);
    updateAreaCharts();
  });

  // Segmentación tarifas
  $("segTarifa").addEventListener("click", (e)=>{
    const b = e.target.closest(".segBtn"); if(!b) return;
    tarifaSeg = b.dataset.t;
    for(const x of $("segTarifa").querySelectorAll(".segBtn")) x.classList.toggle("active", x===b);
    updateAreaCharts();
  });

  // Filtro por área
  $("areaFilter").addEventListener("change", ()=>updateAreaCharts());

  // Segmentación productividad (día/semana/mes)
  $("segGroup").addEventListener("click", (e)=>{
    const b = e.target.closest(".segBtn"); if(!b) return;
    groupSeg = b.dataset.g;
    for(const x of $("segGroup").querySelectorAll(".segBtn")) x.classList.toggle("active", x===b);
    updateProdChart();
  });

  $("prodMetric").addEventListener("change", ()=>{
    prodBarsMetric = $("prodMetric").value;
    updateProdChart();
  });

  // Export
  $("btnExport").addEventListener("click", exportExcel);



  

  $("incentivo").addEventListener("input", ()=>{
    model.incentivo = Number($("incentivo").value||0);
    recalc();
  });
  $("libras").addEventListener("input", ()=>{
    model.librasProcesadas = Number($("libras").value||0);
    recalc();
  });

  $("btnNuevo").addEventListener("click", ()=>{
    model = structuredClone(DEFAULTS);
    model.incentivo = Number($("incentivo").value||DEFAULTS.incentivo);
    model.librasProcesadas = Number($("libras").value||DEFAULTS.librasProcesadas);
    recalc();
    $("status").innerHTML = 'Estado: <span class="warn">nuevo (no guardado)</span>';
  });

  $("btnGuardar").addEventListener("click", save);

  $("fecha").addEventListener("change", ()=>{
    const f = $("fecha").value;
    if(!f) return;
    loadByDate(f);
  });

  // ====== Auth modal ======
  const modal = $("modal");
  $("btnLogin").addEventListener("click", ()=>{ modal.classList.add("show"); $("loginMsg").textContent=""; });
  $("btnCancelar").addEventListener("click", ()=>{ modal.classList.remove("show"); });
  modal.addEventListener("click", (e)=>{ if(e.target===modal) modal.classList.remove("show"); });

  $("btnEntrar").addEventListener("click", async ()=>{
    $("loginMsg").textContent = "Ingresando...";
    try{
      await auth.signInWithEmailAndPassword($("email").value.trim(), $("pass").value);
      $("loginMsg").textContent = "";
      modal.classList.remove("show");
    }catch(err){
      $("loginMsg").textContent = "Error: " + (err?.message||err);
    }
  });

  $("btnLogout").addEventListener("click", ()=>signOut(auth));

  auth.onAuthStateChanged(async (user)=>{
    const pill = $("userPill");
    if(!user){
      if(pill){ pill.textContent="No logueado"; pill.classList.remove("ok"); pill.classList.add("warn"); }
      setInputsEnabled(false);
      $("status").textContent = "sin cargar";
      return;
    }
    const email = (user.email||"").toLowerCase();
    const isEd = EDITORS.has(email);
    if(pill){ pill.textContent = (isEd? "Editor: ":"Vista: ")+email; pill.classList.add("ok"); pill.classList.remove("warn"); }
    setInputsEnabled(isEd);
    try{ await loadLatest(); }catch(e){ console.error(e); }
    try{ await loadDailySummary(); }catch(e){ console.error(e); }
    render();
    recalc();
    return;

    currentUser = user;
    if(!user){
      canEdit = false;
      $("userPill").textContent = "No logueado";
      $("btnLogin").style.display = "";
      $("btnLogout").style.display = "none";
      setInputsEnabled();
      // sin login no se carga nada
      model = structuredClone(DEFAULTS);
      recalc();
      $("status").innerHTML = 'Estado: <span class="warn">Inicia sesión para ver datos</span>';
      return;
    }
    const email = (user.email||"").toLowerCase();
    canEdit = EDITORS.has(email);
    $("userPill").textContent = (canEdit ? "Editor: " : "Vista: ") + email;
    $("btnLogin").style.display = "none";
    $("btnLogout").style.display = "";
    setInputsEnabled();

    // carga el último registro
    await loadLatest();
    await loadDailySummary();
    setTab('area');
    recalc();
  });

  // primer render
  model.incentivo = DEFAULTS.incentivo;
  model.librasProcesadas = DEFAULTS.librasProcesadas;
  $("incentivo").value = model.incentivo;
  $("libras").value = model.librasProcesadas;
  recalc();
</script>
</body>
</html>
