<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CMO | Costos Mano de Obra</title>

  <link rel="icon" href="favicon.ico?v=1">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png?v=1">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png?v=1">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=1">

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --card2:#f7fbff;
      --line:#d9e3f2;
      --text:#0b1220;
      --muted:#4b5563;
      --blue:#1e88e5;
      --blue2:#0b4f8a;
      --sky:#e6f4ff;
      --gray:#f2f4f7;
      --btn:#1e88e5;
      --btn2:#136fbf;
      --danger:#e53935;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1500px;margin:0 auto;padding:14px 14px 22px}

    /* Header tipo Excel (celeste/azul) */
    header{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:12px 14px;border:1px solid var(--line);
      background:linear-gradient(180deg, var(--sky), #ffffff);
      border-radius:10px;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:260px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#6ec6ff,#1e88e5);
      color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;letter-spacing:.4px}
    .brand h1{margin:0;font-size:16px}
    .brand small{display:block;margin-top:3px;color:var(--muted);font-size:12px}

    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px}
    .chip b{color:#0b1220}
    .btn{cursor:pointer;border:1px solid var(--line);background:#fff;color:var(--text);
      padding:9px 12px;border-radius:8px;font-weight:800;font-size:12px}
    .btn.primary{background:var(--btn);border-color:var(--btn);color:#fff}
    .btn.primary:hover{background:var(--btn2);border-color:var(--btn2)}
    .btn.danger{background:#fff;border-color:#f3b6b5;color:var(--danger)}
    .btn.danger:hover{background:#fff5f5}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin-top:12px}
    @media (max-width: 1100px){.grid{grid-template-columns:1fr}}

    .panel{border:1px solid var(--line);background:var(--card);border-radius:10px;overflow:hidden}
    .panelHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, #dff2ff, #ffffff);
    }
    .panelHead h2{margin:0;font-size:13px;letter-spacing:.2px}
    .panelBody{padding:10px 12px}

    /* Inputs */
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{display:block;font-size:11px;color:var(--muted);margin:0 0 5px}
    input, select{width:100%;padding:8px 9px;border-radius:8px;border:1px solid var(--line);
      background:#fff;color:var(--text);outline:none}
    input:focus, select:focus{border-color:rgba(30,136,229,.65)}
    .field{min-width:150px;max-width:230px}
    .field.sm{min-width:120px;max-width:170px}
    .field.lg{min-width:220px;max-width:340px}

    /* Tables */
    table{width:100%;border-collapse:collapse;font-size:12px}
    th, td{border:1px solid var(--line);padding:6px 7px;vertical-align:middle}
    thead th{background:#1e88e5;color:#fff;text-align:center}
    tbody td{background:#fff}
    tbody tr:nth-child(even) td{background:var(--card2)}
    td.num{text-align:right;font-variant-numeric:tabular-nums}
    td.center{text-align:center}
    tr.total td{background:#eef6ff;font-weight:900}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    /* KPIs */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px}
    @media (max-width: 700px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px}
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{margin-top:6px;font-size:22px;font-weight:900;letter-spacing:.2px;color:#0b1220}
    .kpi .v small{font-size:12px;font-weight:800;color:var(--muted)}

    /* Chart */
    .chartWrap{border:1px solid var(--line);border-radius:10px;background:#fff;padding:10px}
    canvas{width:100%;height:430px}

    /* Login */
    .loginWrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .loginCard{width:100%;max-width:560px;border:1px solid var(--line);background:var(--card);
      border-radius:12px;padding:16px}
    .loginCard h2{margin:0 0 8px;font-size:16px}
    .loginCard p{margin:0 0 14px;color:var(--muted);font-size:12px;line-height:1.35}
    .err{color:var(--danger);font-size:12px;margin-top:10px;white-space:pre-wrap}

    /* Toast */
    .toast{position:fixed;left:12px;right:12px;bottom:12px;display:flex;justify-content:center;pointer-events:none}
    .toast > div{pointer-events:auto;max-width:920px;width:100%;border:1px solid var(--line);background:#fff;
      border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .toast b{font-size:12px}
    .toast .msg{font-size:12px;color:var(--muted)}
    .hidden{display:none !important}
  </style>
</head>
<body>

  <!-- LOGIN -->
  <section id="login" class="loginWrap">
    <div class="loginCard">
      <div class="brand" style="margin-bottom:8px">
        <div class="logo">OT</div>
        <div>
          <h1 style="margin:0">CMO — Costos por Mano de Obra</h1>
          <small>Firebase Auth + Firestore (GitHub Pages)</small>
        </div>
      </div>

      <p>
        Editor (puede guardar): <b>milenalmeida@oceantreasure.local</b><br>
        Otros usuarios logueados: <b>solo vista</b>.
      </p>

      <div class="row">
        <div class="field lg" style="flex:1">
          <label>Correo</label>
          <input id="email" type="email" placeholder="usuario@oceantreasure.local" autocomplete="username" />
        </div>
        <div class="field lg" style="flex:1">
          <label>Contraseña</label>
          <input id="pass" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px;align-items:center;justify-content:flex-end">
        <button class="btn primary" id="btnLogin">Ingresar</button>
      </div>
      <div class="err" id="loginErr"></div>
    </div>
  </section>

  <!-- APP -->
  <section id="app" class="wrap hidden">
    <header>
      <div class="brand">
        <div class="logo">OT</div>
        <div>
          <h1>CMO — Costos por Mano de Obra (OCEANTREASURE)</h1>
          <small>Interfaz en colores celestes/blancos • datos en la nube</small>
        </div>
      </div>

      <div class="right">
        <div class="chip" id="roleChip">Rol: <b>—</b></div>
        <div class="chip" id="userChip">Usuario: <b>—</b></div>
        <button class="btn" id="btnSeed" disabled>Inicializar plantilla</button>
        <button class="btn danger" id="btnLogout">Salir</button>
      </div>
    </header>

    <div class="grid">

      <!-- IZQUIERDA -->
      <div class="panel">
        <div class="panelHead">
          <div>
            <h2>Costos por Área</h2>
          </div>
          <div class="actions">
            <button class="btn" id="btnAddArea" disabled>+ Área</button>
            <button class="btn primary" id="btnSaveAreas" disabled>Guardar áreas</button>
          </div>
        </div>

        <div class="panelBody">
          <div class="kpis">
            <div class="kpi">
              <div class="t">LIBRAS PROCESADAS (Jornada)</div>
              <div class="v" id="kpiLbs">—</div>
            </div>
            <div class="kpi">
              <div class="t">VALOR NOMINAL JORNADA</div>
              <div class="v" id="kpiNominal">—</div>
            </div>
            <div class="kpi">
              <div class="t">MANO DE OBRA (CUPO)</div>
              <div class="v" id="kpiCupo">—</div>
            </div>
            <div class="kpi">
              <div class="t">COSTO DE PRODUCCIÓN</div>
              <div class="v" id="kpiCosto">—</div>
            </div>
          </div>

          <div class="row" style="margin-bottom:10px">
            <div class="field sm">
              <label>Incentivo (suma a valor/hora)</label>
              <input id="incentiveAdd" type="number" step="0.01" />
            </div>
            <div class="field sm">
              <label>Libras jornada</label>
              <input id="jornadaLbs" type="number" step="1" />
            </div>
            <div class="field sm">
              <label>&nbsp;</label>
              <button class="btn primary" id="btnSaveSettings" disabled>Guardar arriba</button>
            </div>
          </div>

          <div style="overflow:auto;border-radius:10px">
            <table id="tblAreas">
              <thead>
                <tr>
                  <th style="min-width:220px">ÁREA</th>
                  <th style="min-width:60px">CUPO</th>
                  <th style="min-width:90px">BASE $/H</th>
                  <th style="min-width:80px">+ INC</th>
                  <th style="min-width:70px">HI</th>
                  <th style="min-width:70px">HF</th>
                  <th style="min-width:70px">AL</th>
                  <th style="min-width:70px">HT</th>
                  <th style="min-width:110px">COSTO ÁREA</th>
                  <th style="min-width:130px">TOTAL ÁREA</th>
                  <th style="min-width:90px">ACCIONES</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr class="total">
                  <td class="center">TOTAL</td>
                  <td class="num" id="totCupo">—</td>
                  <td colspan="6"></td>
                  <td class="num" id="totCostoArea">—</td>
                  <td class="num" id="totNominal">—</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

        </div>
      </div>

      <!-- DERECHA -->
      <div class="panel">
        <div class="panelHead">
          <div>
            <h2 id="monthTitle">Mes</h2>
          </div>
          <div class="actions">
            <button class="btn" id="btnAddDay" disabled>+ Día</button>
            <button class="btn primary" id="btnSaveDays" disabled>Guardar mes</button>
          </div>
        </div>

        <div class="panelBody">
          <div class="row" style="margin-bottom:10px">
            <div class="field sm">
              <label>Año</label>
              <input id="year" type="number" step="1" min="2020" />
            </div>
            <div class="field sm">
              <label>Mes</label>
              <select id="month">
                <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
                <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
                <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
                <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
              </select>
            </div>
            <div class="field sm">
              <label>&nbsp;</label>
              <button class="btn" id="btnReload">Cargar</button>
            </div>
          </div>

          <div style="overflow:auto;border-radius:10px;margin-bottom:10px">
            <table id="tblDays">
              <thead>
                <tr>
                  <th style="min-width:140px">DÍA</th>
                  <th style="min-width:50px">N</th>
                  <th style="min-width:70px">CUPO</th>
                  <th style="min-width:110px">VALOR NOMINAL</th>
                  <th style="min-width:130px">LIBRAS PROCESADAS</th>
                  <th style="min-width:120px">COSTO</th>
                  <th style="min-width:90px">ACCIONES</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr class="total">
                  <td class="center">TOTAL</td>
                  <td></td>
                  <td class="num" id="mTotCupo">—</td>
                  <td class="num" id="mTotValor">—</td>
                  <td class="num" id="mTotLbs">—</td>
                  <td class="num" id="mPromCosto">—</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="row" style="margin:-4px 0 10px">
            <div class="chip">EMPAC ($): <b id="empacUsd">—</b></div>
            <div class="chip">COLA EMPACADA (lbs): <b id="colaEmpacada">—</b></div>
            <div class="chip">EQUIV. CONTENEDORES: <b id="equivCont">—</b></div>
            <div class="chip">ENTERO DESCABEZADO (lbs): <b id="enteroDesc">—</b></div>
            <div class="chip">PROMEDIO: <b id="promedioChip">—</b></div>
          </div>

          <div class="chartWrap">
            <canvas id="chart"></canvas>
          </div>

        </div>
      </div>

    </div>
  </section>

  <div class="toast hidden" id="toast"><div>
    <div>
      <b id="toastTitle">Listo</b>
      <div class="msg" id="toastMsg"></div>
    </div>
    <button class="btn" id="toastClose">OK</button>
  </div></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCMoLkSnnLowMagRNL7O6ttPo1FXd1URac",
      authDomain: "oceantreasure-app.firebaseapp.com",
      projectId: "oceantreasure-app",
      storageBucket: "oceantreasure-app.firebasestorage.app",
      messagingSenderId: "553014659258",
      appId: "1:553014659258:web:cfc30844a88433b7b79a83",
      measurementId: "G-HMMQKJY8NJ"
    };

    const DEFAULT_DATA = {"settings": {"company": "OCEANTREASURE", "module": "CMO — Costos Mano de Obra", "year": 2026, "month": 1, "incentiveAdd": 0.0, "jornadaLibras": 30000, "contenedorColaLbs": 52272, "colaFactor": 0.66}, "areas": [{"name": "RECEPCION", "cupo": 4, "baseRate": 1.9, "usesIncentive": true, "hi": "07:35", "hf": "12:00", "al": 1.0, "order": 0}, {"name": "DESCABEZADO C1", "cupo": 7, "baseRate": 2.2, "usesIncentive": true, "hi": "07:30", "hf": "12:00", "al": 1.5, "order": 1}, {"name": "DESCABEZADO C2", "cupo": 4, "baseRate": 2.2, "usesIncentive": true, "hi": "07:41", "hf": "12:00", "al": 1.5, "order": 2}, {"name": "PESADOR - SELLADOR MQ", "cupo": 6, "baseRate": 2.2, "usesIncentive": true, "hi": "08:30", "hf": "12:00", "al": 1.5, "order": 3}, {"name": "TOLVERO - OPERADOR", "cupo": 3, "baseRate": 2.2, "usesIncentive": true, "hi": "08:30", "hf": "12:00", "al": 1.5, "order": 4}, {"name": "CAJERO - AUXILIAR MQ", "cupo": 10, "baseRate": 2.1, "usesIncentive": true, "hi": "08:30", "hf": "12:00", "al": 1.5, "order": 5}, {"name": "VARIOS MQ1", "cupo": 6, "baseRate": 1.9, "usesIncentive": true, "hi": "08:30", "hf": "12:00", "al": 1.5, "order": 6}, {"name": "VARIOS MQ2", "cupo": 7, "baseRate": 1.9, "usesIncentive": true, "hi": "08:30", "hf": "12:00", "al": 1.5, "order": 7}, {"name": "PRECAJAS", "cupo": 6, "baseRate": 1.9, "usesIncentive": true, "hi": "08:16", "hf": "12:00", "al": 1.5, "order": 8}, {"name": "BODEGA", "cupo": 1, "baseRate": 1.9, "usesIncentive": true, "hi": "07:50", "hf": "12:00", "al": 1.5, "order": 9}, {"name": "CONGELACION", "cupo": 3, "baseRate": 2.2, "usesIncentive": true, "hi": "08:27", "hf": "12:00", "al": 1.5, "order": 10}, {"name": "PRODUCCION", "cupo": 12, "baseRate": 2.2, "usesIncentive": true, "hi": "08:00", "hf": "12:00", "al": 1.5, "order": 11}, {"name": "CALIDAD", "cupo": 0, "baseRate": 2.0, "usesIncentive": true, "hi": "", "hf": "12:00", "al": 0.0, "order": 12}, {"name": "MASTERIZADO", "cupo": 5, "baseRate": 2.2, "usesIncentive": true, "hi": "08:28", "hf": "12:00", "al": 1.5, "order": 13}, {"name": "CAMARA", "cupo": 5, "baseRate": 2.2, "usesIncentive": true, "hi": "08:28", "hf": "12:00", "al": 1.5, "order": 14}, {"name": "EMBARQUE", "cupo": 4, "baseRate": 2.2, "usesIncentive": true, "hi": "08:28", "hf": "12:00", "al": 1.5, "order": 15}, {"name": "CASILLEROS", "cupo": 1, "baseRate": 1.9, "usesIncentive": true, "hi": "07:13", "hf": "12:00", "al": 1.5, "order": 16}, {"name": "LAVADO MATERIAL", "cupo": 1, "baseRate": 1.9, "usesIncentive": true, "hi": "08:00", "hf": "12:00", "al": 1.0, "order": 17}, {"name": "BAÑOS", "cupo": 1, "baseRate": 2.2, "usesIncentive": true, "hi": "07:50", "hf": "12:00", "al": 1.0, "order": 18}, {"name": "Limpieza Turno noche", "cupo": 9, "baseRate": 1.7, "usesIncentive": false, "hi": "19:00", "hf": "06:00", "al": 1.0, "order": 19}], "days": [{"dia": "VIERNES", "n": 2, "cupo": 50, "valorNominal": 1091.0, "librasProcesadas": 8052.0}, {"dia": "SABADO", "n": 3, "cupo": 73, "valorNominal": 1340.0, "librasProcesadas": 19965.0}, {"dia": "LUNES", "n": 5, "cupo": 109, "valorNominal": 1844.0, "librasProcesadas": 90000.0}, {"dia": "MARTES", "n": 6, "cupo": 117, "valorNominal": 2282.0, "librasProcesadas": 52227.0}, {"dia": "MIERCOLES", "n": 7, "cupo": 112, "valorNominal": 2265.0, "librasProcesadas": 63000.0}, {"dia": "JUEVES", "n": 8, "cupo": 104, "valorNominal": 2075.0, "librasProcesadas": 82600.0}, {"dia": "VIERNES", "n": 9, "cupo": 110, "valorNominal": 2047.0, "librasProcesadas": 59714.0}, {"dia": "SABADO", "n": 10, "cupo": 104, "valorNominal": 1931.0, "librasProcesadas": 101183.0}]};
    const UI_EDITOR_EMAIL = "milenalmeida@oceantreasure.local";

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(() => {});
    db.enablePersistence({synchronizeTabs:true}).catch(()=>{});

    const $ = (id) => document.getElementById(id);
    const nf0 = new Intl.NumberFormat("es-EC", {maximumFractionDigits:0});
    const nf2 = new Intl.NumberFormat("es-EC", {minimumFractionDigits:2, maximumFractionDigits:2});
    const nf4 = new Intl.NumberFormat("es-EC", {minimumFractionDigits:4, maximumFractionDigits:6});

    function toNum(v){ const n = Number(String(v).replace(",", ".")); return Number.isFinite(n) ? n : 0; }
    function fmtMoney2(v){ return "$ " + nf2.format(toNum(v)); }
    function fmtNum0(v){ return nf0.format(toNum(v)); }
    function fmtCost(v){ return nf4.format(toNum(v)); }

    function timeToMinutes(hhmm){
      if(!hhmm) return null;
      const m = String(hhmm).trim().match(/^(\d{1,2}):(\d{2})$/);
      if(!m) return null;
      const h = Math.max(0, Math.min(23, parseInt(m[1],10)));
      const mm = Math.max(0, Math.min(59, parseInt(m[2],10)));
      return h*60 + mm;
    }
    function calcHT(hi, hf, al){
      const s = timeToMinutes(hi);
      const e0 = timeToMinutes(hf);
      if(s==null || e0==null) return 0;
      let e = e0;
      if(e < s) e += 24*60;
      const hours = (e - s) / 60;
      return Math.max(0, hours - toNum(al));
    }

    function nowToast(title,msg){
      $("toastTitle").textContent = title || "Listo";
      $("toastMsg").textContent = msg || "";
      $("toast").classList.remove("hidden");
      clearTimeout(window.__tTO);
      window.__tTO = setTimeout(()=>$("toast").classList.add("hidden"), 2200);
    }
    $("toastClose").onclick = () => $("toast").classList.add("hidden");

    let currentUser=null, canEditUI=false;
    let settings=null, areas=[], days=[];
    let chart=null;

    const settingsRef = db.collection("cmo_settings").doc("global");
    const areasCol = db.collection("cmo_areas");
    const daysCol = db.collection("cmo_days");

    $("btnLogin").addEventListener("click", doLogin);
    $("pass").addEventListener("keydown", (e) => { if(e.key==="Enter") doLogin(); });

    async function doLogin(){
      $("loginErr").textContent = "";
      const email = $("email").value.trim();
      const pass  = $("pass").value;
      if(!email || !pass) {
        $("loginErr").textContent = "Ingresa correo y contraseña.";
        return;
      }
      try {
        await auth.signInWithEmailAndPassword(email, pass);
      } catch(err) {
        $("loginErr").textContent = (err && err.message) ? err.message : String(err);
      }
    }

    $("btnLogout").addEventListener("click", async () => { try { await auth.signOut(); } catch(e) {} });

    auth.onAuthStateChanged(async (user) => {
      currentUser = user || null;
      if(!currentUser) {
        $("app").classList.add("hidden");
        $("login").classList.remove("hidden");
        return;
      }
      $("login").classList.add("hidden");
      $("app").classList.remove("hidden");

      const email = (currentUser.email || "").toLowerCase();
      canEditUI = (email === UI_EDITOR_EMAIL);

      $("userChip").innerHTML = "Usuario: <b>"+ escapeHtml(email || "—") +"</b>";
      $("roleChip").innerHTML = "Rol: <b>"+ (canEditUI ? "EDITOR" : "SOLO VISTA") +"</b>";

      for(const id of ["btnAddArea","btnSaveAreas","btnSaveSettings","btnAddDay","btnSaveDays","btnSeed"]) {
        $(id).disabled = !canEditUI;
      }

      await loadAll();
    });

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[c])); }

    $("btnReload").addEventListener("click", async () => {
      await loadDaysByMonth();
      renderDays();
      renderChart();
    });

    async function loadAll(){
      await loadSettings();
      await loadAreas();
      await loadDaysByMonth();
      renderSettings();
      renderAreas();
      renderDays();
      renderChart();
      maybeEnableSeed();
    }

    async function loadSettings(){
      const snap = await settingsRef.get();
      settings = snap.exists ? snap.data() : null;
    }
    async function loadAreas(){
      const q = await areasCol.orderBy("order","asc").get();
      areas = q.docs.map(d => ({id:d.id, ...d.data()}));
    }
    async function loadDaysByMonth(){
      const y = toNum($("year").value) || (settings?.year || DEFAULT_DATA.settings.year);
      const m = toNum($("month").value) || (settings?.month || DEFAULT_DATA.settings.month);
      $("monthTitle").textContent = monthName(m).toUpperCase() + " DEL " + y;

      const q = await daysCol.where("year","==",y).where("month","==",m).orderBy("n","asc").get();
      days = q.docs.map(d => ({id:d.id, ...d.data()}));
    }
    function monthName(m){ return ["","Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][m] || "Mes"; }

    function maybeEnableSeed(){
      const needs = (!settings) || (areas.length===0);
      $("btnSeed").disabled = !(canEditUI && needs);
    }

    function renderSettings(){
      const s = settings || DEFAULT_DATA.settings;
      $("incentiveAdd").value = s.incentiveAdd ?? 0;
      $("jornadaLbs").value = s.jornadaLibras ?? 0;
      $("year").value = s.year ?? DEFAULT_DATA.settings.year;
      $("month").value = String(s.month ?? DEFAULT_DATA.settings.month);
      updateKpis();
    }

    function getSettingsFromUI(){
      const base = settings || DEFAULT_DATA.settings;
      return {
        ...base,
        incentiveAdd: toNum($("incentiveAdd").value),
        jornadaLibras: toNum($("jornadaLbs").value),
        year: toNum($("year").value) || base.year,
        month: toNum($("month").value) || base.month,
      };
    }

    $("btnSaveSettings").addEventListener("click", async () => {
      if(!canEditUI) return;
      const s = getSettingsFromUI();
      try {
        await settingsRef.set(s, {merge:true});
        settings = s;
        nowToast("Guardado", "Ajustes guardados.");
        renderAreas();
        renderDays();
        renderChart();
      } catch(e) {
        nowToast("Error", (e && e.message) ? e.message : String(e));
      }
    });

    for(const id of ["incentiveAdd","jornadaLbs"]) {
      $(id).addEventListener("input", () => {
        renderAreas();
        updateKpis();
      });
    }

    function calcAreasTotals(areaList, s){
      let totalCupo=0, totalCostoArea=0, totalNominal=0;
      for(const a of areaList){
        totalCupo += toNum(a.cupo);
        const rate = toNum(a.overrideRate ?? (toNum(a.baseRate) + (a.usesIncentive ? toNum(s.incentiveAdd) : 0)));
        const ht = calcHT(a.hi, a.hf, a.al);
        const costoArea = rate * ht;
        const totalArea = costoArea * toNum(a.cupo);
        totalCostoArea += costoArea;
        totalNominal += totalArea;
      }
      return {totalCupo, totalCostoArea, totalNominal};
    }

    function updateKpis(){
      const s = getSettingsFromUI();
      const list = (areas.length ? areas : DEFAULT_DATA.areas.map(x=>({...x})));
      const totals = calcAreasTotals(list, s);

      $("kpiLbs").textContent = fmtNum0(s.jornadaLibras || 0);
      $("kpiNominal").textContent = fmtMoney2(totals.totalNominal);
      $("kpiCupo").textContent = fmtNum0(totals.totalCupo);
      $("kpiCosto").textContent = fmtCost( (toNum(s.jornadaLibras)>0) ? (totals.totalNominal / toNum(s.jornadaLibras)) : 0 );

      $("totCupo").textContent = fmtNum0(totals.totalCupo);
      $("totCostoArea").textContent = fmtMoney2(totals.totalCostoArea);
      $("totNominal").textContent = fmtMoney2(totals.totalNominal);
    }

    function renderAreas(){
      const s = getSettingsFromUI();
      const tbody = $("tblAreas").querySelector("tbody");
      tbody.innerHTML = "";

      const list = (areas.length ? areas : DEFAULT_DATA.areas.map(x=>({...x})));

      list.forEach((a, idx) => {
        const rate = toNum(a.overrideRate ?? (toNum(a.baseRate) + (a.usesIncentive ? toNum(s.incentiveAdd) : 0)));
        const ht = calcHT(a.hi, a.hf, a.al);
        const costoArea = rate * ht;
        const totalArea = costoArea * toNum(a.cupo);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input data-k="name" data-i="${idx}" value="${escapeHtml(a.name||"")}" ${canEditUI?'':'disabled'}></td>
          <td class="num"><input data-k="cupo" data-i="${idx}" type="number" step="1" value="${toNum(a.cupo)}" ${canEditUI?'':'disabled'}></td>
          <td class="num"><input data-k="baseRate" data-i="${idx}" type="number" step="0.01" value="${toNum(a.baseRate)}" ${canEditUI?'':'disabled'}></td>
          <td class="center">
            <select data-k="usesIncentive" data-i="${idx}" ${canEditUI?'':'disabled'}>
              <option value="1" ${a.usesIncentive?'selected':''}>SI</option>
              <option value="0" ${!a.usesIncentive?'selected':''}>NO</option>
            </select>
          </td>
          <td class="center"><input data-k="hi" data-i="${idx}" value="${escapeHtml(a.hi||"")}" placeholder="HH:MM" ${canEditUI?'':'disabled'}></td>
          <td class="center"><input data-k="hf" data-i="${idx}" value="${escapeHtml(a.hf||"")}" placeholder="HH:MM" ${canEditUI?'':'disabled'}></td>
          <td class="num"><input data-k="al" data-i="${idx}" type="number" step="0.25" value="${toNum(a.al)}" ${canEditUI?'':'disabled'}></td>
          <td class="num">${nf2.format(ht)}</td>
          <td class="num">${fmtMoney2(costoArea)}</td>
          <td class="num">${fmtMoney2(totalArea)}</td>
          <td class="center">
            <button class="btn danger" data-del-area="${idx}" ${canEditUI?'':'disabled'}>Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // handlers
      if(canEditUI){
        tbody.querySelectorAll("input,select").forEach(el => {
          el.addEventListener("input", onAreaEdit);
          el.addEventListener("change", onAreaEdit);
        });
        tbody.querySelectorAll("[data-del-area]").forEach(btn => {
          btn.addEventListener("click", () => {
            const i = parseInt(btn.getAttribute("data-del-area"),10);
            areas.splice(i,1);
            areas.forEach((x,k)=>x.order=k);
            renderAreas();
            updateKpis();
          });
        });
      }

      updateKpis();
    }

    function onAreaEdit(e){
      const el = e.target;
      const i = parseInt(el.getAttribute("data-i"),10);
      const k = el.getAttribute("data-k");
      if(!areas[i]) {
        areas = DEFAULT_DATA.areas.map(x=>({...x}));
      }
      let v = el.value;
      if(k==="cupo") v = Math.max(0, Math.round(toNum(v)));
      if(k==="baseRate"||k==="al") v = toNum(v);
      if(k==="usesIncentive") v = (String(v)==="1");
      if(k==="name") v = String(v||"");
      if(k==="hi"||k==="hf") v = String(v||"").trim();

      areas[i][k] = v;
      renderAreas();
    }

    $("btnAddArea").addEventListener("click", () => {
      if(!canEditUI) return;
      areas.push({
        name:"NUEVA AREA",
        cupo:0,
        baseRate:0,
        usesIncentive:true,
        hi:"08:00",
        hf:"12:00",
        al:1.5,
        order: areas.length
      });
      renderAreas();
    });

    $("btnSaveAreas").addEventListener("click", async () => {
      if(!canEditUI) return;
      try {
        const batch = db.batch();
        const old = await areasCol.get();
        old.forEach(doc => batch.delete(doc.ref));
        areas.forEach((a, idx) => {
          batch.set(areasCol.doc(), {
            name: String(a.name||"").trim(),
            cupo: Math.max(0, Math.round(toNum(a.cupo))),
            baseRate: toNum(a.baseRate),
            usesIncentive: !!a.usesIncentive,
            hi: String(a.hi||"").trim(),
            hf: String(a.hf||"").trim(),
            al: toNum(a.al),
            order: idx
          });
        });
        await batch.commit();
        nowToast("Guardado", "Áreas guardadas.");
        await loadAreas();
        renderAreas();
        maybeEnableSeed();
      } catch(e) {
        nowToast("Error", (e && e.message) ? e.message : String(e));
      }
    });

    function renderDays(){
      const tbody = $("tblDays").querySelector("tbody");
      tbody.innerHTML = "";

      const y = toNum($("year").value) || DEFAULT_DATA.settings.year;
      const m = toNum($("month").value) || DEFAULT_DATA.settings.month;
      let list = days.length ? days : DEFAULT_DATA.days.map(x=>({...x, year:y, month:m}));
      list = list.slice().sort((a,b)=>toNum(a.n)-toNum(b.n));

      let tCupo=0, tValor=0, tLbs=0;
      list.forEach((d, idx) => {
        const costo = (toNum(d.librasProcesadas)>0) ? (toNum(d.valorNominal)/toNum(d.librasProcesadas)) : 0;
        tCupo += toNum(d.cupo);
        tValor += toNum(d.valorNominal);
        tLbs  += toNum(d.librasProcesadas);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input data-k="dia" data-i="${idx}" value="${escapeHtml(d.dia||"")}" ${canEditUI?'':'disabled'}></td>
          <td class="num"><input data-k="n" data-i="${idx}" type="number" step="1" value="${toNum(d.n)}" ${canEditUI?'':'disabled'}></td>
          <td class="num"><input data-k="cupo" data-i="${idx}" type="number" step="1" value="${toNum(d.cupo)}" ${canEditUI?'':'disabled'}></td>
          <td class="num"><input data-k="valorNominal" data-i="${idx}" type="number" step="0.01" value="${toNum(d.valorNominal)}" ${canEditUI?'':'disabled'}></td>
          <td class="num"><input data-k="librasProcesadas" data-i="${idx}" type="number" step="1" value="${toNum(d.librasProcesadas)}" ${canEditUI?'':'disabled'}></td>
          <td class="num">${fmtCost(costo)}</td>
          <td class="center"><button class="btn danger" data-del-day="${idx}" ${canEditUI?'':'disabled'}>Eliminar</button></td>
        `;
        tbody.appendChild(tr);
      });

      $("mTotCupo").textContent = fmtNum0(tCupo);
      $("mTotValor").textContent = fmtMoney2(tValor);
      $("mTotLbs").textContent  = fmtNum0(tLbs);
      const prom = (tLbs>0) ? (tValor/tLbs) : 0;
      $("mPromCosto").textContent = fmtCost(prom);

      // resumen tipo captura
      const s = getSettingsFromUI();
      const cont = toNum(s.contenedorColaLbs ?? 52272);
      const colaFactor = toNum(s.colaFactor ?? 0.66);

      $("empacUsd").textContent = fmtMoney2(tValor);
      $("colaEmpacada").textContent = fmtNum0(tLbs);
      $("equivCont").textContent = nf2.format( (cont>0) ? (tLbs/cont) : 0 );
      $("enteroDesc").textContent = fmtNum0( (colaFactor>0) ? (tLbs/colaFactor) : 0 );
      $("promedioChip").textContent = fmtCost(prom);

      if(canEditUI){
        tbody.querySelectorAll("input").forEach(el => {
          el.addEventListener("input", onDayEdit);
        });
        tbody.querySelectorAll("[data-del-day]").forEach(btn => {
          btn.addEventListener("click", () => {
            const i = parseInt(btn.getAttribute("data-del-day"),10);
            days.splice(i,1);
            renderDays();
            renderChart();
          });
        });
      }
    }

    function onDayEdit(e){
      const el = e.target;
      const i = parseInt(el.getAttribute("data-i"),10);
      const k = el.getAttribute("data-k");
      if(!days[i]) {
        days = DEFAULT_DATA.days.map(x => ({...x, year:toNum($("year").value), month:toNum($("month").value)}));
      }
      let v = el.value;
      if(k==="n"||k==="cupo") v = Math.max(0, Math.round(toNum(v)));
      if(k==="valorNominal") v = toNum(v);
      if(k==="librasProcesadas") v = Math.max(0, toNum(v));
      if(k==="dia") v = String(v||"").toUpperCase();

      days[i][k] = v;
      days[i].year = toNum($("year").value);
      days[i].month = toNum($("month").value);

      renderDays();
      renderChart();
    }

    $("btnAddDay").addEventListener("click", () => {
      if(!canEditUI) return;
      const y = toNum($("year").value);
      const m = toNum($("month").value);
      days.push({
        year:y, month:m,
        dia:"",
        n: (days.length? (Math.max(...days.map(d=>toNum(d.n)))+1) : 1),
        cupo:0,
        valorNominal:0,
        librasProcesadas:0
      });
      renderDays();
      renderChart();
    });

    $("btnSaveDays").addEventListener("click", async () => {
      if(!canEditUI) return;
      try {
        const y = toNum($("year").value);
        const m = toNum($("month").value);

        const existing = await daysCol.where("year","==",y).where("month","==",m).get();
        const batch = db.batch();
        existing.forEach(doc => batch.delete(doc.ref));

        const list = days.slice().sort((a,b)=>toNum(a.n)-toNum(b.n));
        list.forEach((d, idx) => {
          batch.set(daysCol.doc(), {
            year:y, month:m,
            dia: String(d.dia||"").trim().toUpperCase(),
            n: Math.max(0, Math.round(toNum(d.n))),
            cupo: Math.max(0, Math.round(toNum(d.cupo))),
            valorNominal: toNum(d.valorNominal),
            librasProcesadas: Math.max(0, toNum(d.librasProcesadas)),
            order: idx
          });
        });
        await batch.commit();
        nowToast("Guardado", "Mes guardado.");
        await loadDaysByMonth();
        renderDays();
        renderChart();
      } catch(e) {
        nowToast("Error", (e && e.message) ? e.message : String(e));
      }
    });

    function renderChart(){
      const ctx = $("chart");
      const list = (days.length ? days : DEFAULT_DATA.days).slice().sort((a,b)=>toNum(a.n)-toNum(b.n));

      const labels = list.map(d => String(d.n||""));
      const lbs = list.map(d => toNum(d.librasProcesadas));
      const cost = list.map(d => (toNum(d.librasProcesadas)>0) ? (toNum(d.valorNominal)/toNum(d.librasProcesadas)) : 0);

      const data = {
        labels,
        datasets: [
          {
            type:"bar",
            label:"LIBRAS PROCESADAS",
            data: lbs,
            yAxisID:"y",
            borderWidth:0
          },
          {
            type:"line",
            label:"COSTO DE PRODUCCIÓN",
            data: cost,
            yAxisID:"y1",
            tension:.25,
            pointRadius:3
          }
        ]
      };

      const options = {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{labels:{color:"#0b1220"}},
          tooltip:{
            callbacks:{
              label:(c)=>{
                const label = c.dataset.label || "";
                const v = c.raw;
                if(label.includes("LIBRAS")) return label + ": " + nf0.format(v);
                return label + ": " + nf4.format(v);
              }
            }
          }
        },
        scales:{
          x:{ticks:{color:"#0b1220"}, grid:{color:"rgba(11,18,32,.10)"}},
          y:{position:"left", ticks:{color:"#0b1220"}, grid:{color:"rgba(11,18,32,.10)"}},
          y1:{position:"right", ticks:{color:"#0b1220"}, grid:{drawOnChartArea:false}}
        }
      };

      if(chart) {
        chart.data = data;
        chart.options = options;
        chart.update();
      } else {
        chart = new Chart(ctx, {data, options});
      }
    }

    $("btnSeed").addEventListener("click", async () => {
      if(!canEditUI) return;
      try {
        const ok = confirm("Cargar plantilla inicial a Firestore. ¿Continuar?");
        if(!ok) return;

        const batch = db.batch();
        batch.set(settingsRef, DEFAULT_DATA.settings, {merge:true});

        const oldA = await areasCol.get();
        oldA.forEach(doc => batch.delete(doc.ref));
        DEFAULT_DATA.areas.forEach((a, idx) => batch.set(areasCol.doc(), {...a, order: idx}));

        const y = DEFAULT_DATA.settings.year;
        const m = DEFAULT_DATA.settings.month;
        const oldD = await daysCol.where("year","==",y).where("month","==",m).get();
        oldD.forEach(doc => batch.delete(doc.ref));
        DEFAULT_DATA.days.forEach((d, idx) => batch.set(daysCol.doc(), {...d, year:y, month:m, order: idx}));

        await batch.commit();
        nowToast("Listo", "Plantilla cargada.");
        await loadAll();
      } catch(e) {
        nowToast("Error", (e && e.message) ? e.message : String(e));
      }
    });
  </script>
</body>
</html>
