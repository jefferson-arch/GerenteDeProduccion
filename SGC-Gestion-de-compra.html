<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión de Compra - Oceantreasure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f2f2f5;
      color: #222;
    }

    /* ------------ LOGIN ------------ */
    .login-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #3f4c6b 0, #1f1f2b 40%, #000 100%);
      z-index: 999;
      color: #fff;
    }
    .login-card {
      background: #ffffff;
      color: #222;
      border-radius: 16px;
      padding: 24px 22px 20px;
      width: 100%;
      max-width: 360px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.35);
    }
    .login-card h1 {
      margin: 0 0 4px;
      font-size: 1.05rem;
      font-weight: 700;
      text-align: center;
    }
    .login-card p {
      margin: 0 0 16px;
      font-size: 0.8rem;
      text-align: center;
      color: #555;
    }
    .login-card label {
      display: block;
      font-size: 0.78rem;
      font-weight: 600;
      margin-bottom: 3px;
    }
    .login-card input {
      width: 100%;
      padding: 6px 8px;
      font-size: 0.85rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }
    .login-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }
    .login-btn {
      background: #2d6cdf;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 16px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .login-btn:hover { background: #2455aa; }
    .login-error {
      display: none;
      margin-top: 4px;
      font-size: 0.78rem;
      color: #b00020;
      text-align: center;
    }

    /* ------------ APP PRINCIPAL ------------ */
    .app {
      max-width: 1200px;
      margin: 16px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,.08);
      overflow: hidden;
    }
    header {
      background: #555c6d;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }
    header .title {
      font-weight: 600;
      font-size: 0.9rem;
    }
    header .user-info {
      font-size: 0.85rem;
      text-align: center;
      flex: 1;
    }
    header .meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .logout-btn {
      background: transparent;
      color: #fff;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.8);
      padding: 4px 12px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .logout-btn:hover {
      background: rgba(0,0,0,.2);
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      background: #f8f8fb;
    }
    .tabs button {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      border-bottom: 3px solid transparent;
      transition: background 0.15s, border-color 0.15s;
    }
    .tabs button.active {
      background: #fff;
      border-bottom-color: #2d6cdf;
      color: #2d6cdf;
    }
    .tab {
      display: none;
      padding: 16px 20px 20px 20px;
    }
    .tab.active { display: block; }

    .form-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }
    .form-row label {
      font-size: 0.8rem;
      font-weight: 600;
      display: block;
    }
    .form-row input,
    .form-row select {
      width: 100%;
      padding: 4px 6px;
      font-size: 0.85rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* NUEVA FILA DE BOTONES (EXPORTAR/IMPORTAR) */
    .actions-backup {
      margin-top: 4px;
      margin-bottom: 4px;
      justify-content: flex-start;
    }

    button.primary {
      background: #2d6cdf;
      color: #fff;
      border-radius: 6px;
      border: none;
      padding: 6px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    button.secondary {
      background: #e0e0e5;
      color: #333;
      border-radius: 6px;
      border: none;
      padding: 6px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn-export {
      background: #0c9f6a;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-export:hover { background: #0a7c52; }

    .btn-import {
      background: #f4a000;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-import:hover { background: #c88200; }

    button.primary:hover { background: #2455aa; }
    button.secondary:hover { background: #d0d0d6; }

    /* BARRA DE BÚSQUEDA */
    .search-container {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .search-container input {
      padding: 6px 10px;
      font-size: 0.85rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 250px;
    }

    .table-wrapper {
      margin-top: 12px;
      max-height: 420px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      background: #fff;
      table-layout: fixed;
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }
    thead tr { background: #ececf4; }
    th, td {
      padding: 2px 4px;
      border-bottom: 1px solid #eee;
      text-align: left;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
    }
    th.numeric, td.numeric { text-align: right; }
    tr:nth-child(even) td { background: #fafafa; }
    tr.group-header td {
      background: #dde3f5;
      font-weight: 600;
    }
    tr.subtotal-row td {
      background: #f4f4f9;
      font-weight: 700;
      border-top: 1px solid #ccc;
    }
    td.actions-cell { text-align: center; }
    td.actions-cell button {
      font-size: 0.75rem;
      padding: 2px 6px;
    }
    .totals-footer {
      margin-top: 10px;
      font-size: 0.8rem;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      color: #444;
    }
    .actions-report {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 8px;
      gap: 8px;
    }
    .pdf-header-info {
      font-size: 0.75rem;
      margin-bottom: 4px;
    }

    .catalog-section {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 12px;
      background: #fafafa;
    }
    .catalog-section h3 {
      margin: 0 0 6px 0;
      font-size: 0.9rem;
    }
    .catalog-section .catalog-form {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
    }
    .catalog-section .catalog-form input {
      flex: 1;
    }
    .catalog-section .catalog-form select {
      width: 130px;
      font-size: 0.8rem;
      padding: 4px 6px;
    }
    .catalog-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      max-height: 140px;
      overflow-y: auto;
      font-size: 0.8rem;
    }
    .catalog-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
      border-bottom: 1px dashed #e0e0e0;
    }
    .catalog-list li button {
      font-size: 0.7rem;
      padding: 1px 6px;
    }

    /* ---- Anchos tabla INGRESO ---- */
    #tab-entrada table th:nth-child(1), #tab-entrada table td:nth-child(1) { width: 22%; } 
    #tab-entrada table th:nth-child(2), #tab-entrada table td:nth-child(2) { width: 12%; }
    #tab-entrada table th:nth-child(3), #tab-entrada table td:nth-child(3) { width: 18%; }
    #tab-entrada table th:nth-child(4), #tab-entrada table td:nth-child(4) { width: 10%; }
    #tab-entrada table th:nth-child(5), #tab-entrada table td:nth-child(5) { width: 8%; }
    #tab-entrada table th:nth-child(6), #tab-entrada table td:nth-child(6) { width: 8%; }
    #tab-entrada table th:nth-child(7), #tab-entrada table td:nth-child(7) { width: 10%; }
    #tab-entrada table th:nth-child(8), #tab-entrada table td:nth-child(8) { width: 10%; }
    #tab-entrada table th:nth-child(9), #tab-entrada table td:nth-child(9) { width: 7%; }

    @media (max-width: 900px) {
      .form-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      header { flex-direction: column; align-items: flex-start; }
      header .user-info { text-align: left; }
    }
  </style>
</head>
<body>

<div id="login-screen" class="login-screen">
  <div class="login-card">
    <h1>Sistema de Gestión de Compra</h1>
    <p>Inicia sesión para continuar</p>
    <form id="login-form">
      <label for="login-username">Usuario</label>
      <input type="text" id="login-username" autocomplete="username" />

      <label for="login-password">Contraseña</label>
      <input type="password" id="login-password" autocomplete="current-password" />

      <div class="login-actions">
        <button type="submit" class="login-btn">Ingresar</button>
      </div>
      <div id="login-error" class="login-error">
        Usuario o contraseña incorrectos.
      </div>
    </form>
  </div>
</div>

<div class="app" id="main-app" style="display:none;">
  <header>
    <div class="title">Fecha: <span id="header-date-text"></span></div>
    <div class="user-info">
      Usuario: <span id="header-user">-</span>
      <span id="header-role" style="font-size:0.75rem;opacity:.85;"></span>
    </div>
    <div class="meta">
      <span>SISTEMA DE GESTIÓN DE COMPRA OCEANTREASURE</span>
      <button type="button" id="btn-logout" class="logout-btn">Cerrar sesión</button>
    </div>
  </header>

  <nav class="tabs">
    <button class="active" data-tab="entrada">1. Ingreso de datos</button>
    <button data-tab="reporte">2. Reporte agrupado</button>
    <button data-tab="creacion">3. Creación</button>
  </nav>

  <section id="tab-entrada" class="tab active">
    <form id="entrada-form">
      <div class="form-row">
        <div>
          <label for="fecha">Fecha</label>
          <input type="date" id="fecha" required />
        </div>
        <div>
          <label for="comprador">Comprador</label>
          <input type="text" id="comprador" list="datalist-compradores" placeholder="KEVIN, PATRICIO..." required />
          <datalist id="datalist-compradores"></datalist>
        </div>
        <div>
          <label for="proveedor">Proveedor / Cliente</label>
          <input type="text" id="proveedor" list="datalist-proveedores" placeholder="HENGXING 6C, GOLD CAMARON..." required />
          <datalist id="datalist-proveedores"></datalist>
        </div>
        <div>
          <label for="sector">Sector</label>
          <input type="text" id="sector" list="datalist-sectores" placeholder="ISLA PUNA, TENGUEL..." required />
          <datalist id="datalist-sectores"></datalist>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="kilos">Libras</label>
          <input type="number" step="0.01" id="kilos" required />
        </div>
        <div>
          <label for="lotes">Gramaje</label>
          <input type="number" step="0.01" id="lotes" required />
        </div>
        <div>
          <label for="monto">Cola aproximada</label>
          <input type="number" step="0.01" id="monto" readonly />
        </div>
      </div>

      <div class="actions actions-backup">
        <button type="button" class="btn-export" onclick="exportarJSON()">Exportar datos</button>
        <button type="button" class="btn-import" onclick="document.getElementById('file-import-json').click()">Importar datos</button>
        <input type="file" id="file-import-json" accept="application/json" style="display:none" />
      </div>

      <div class="actions">
        <button type="button" class="secondary" id="btn-limpiar">Limpiar todo</button>
        <button type="submit" class="primary">Agregar fila</button>
      </div>
    </form>

    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
    
    <div class="search-container">
      <label style="font-size: 0.85rem; font-weight: 600;">Filtrar tabla:</label>
      <input type="text" id="search-input" placeholder="Buscar por Comprador o Proveedor..." oninput="renderEntrada()" />
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>Fecha</th>
          <th>Comprador</th>
          <th>Proveedor</th>
          <th>Sector</th>
          <th class="numeric">Libras</th>
          <th class="numeric">Gramaje</th>
          <th class="numeric">Cola aprox</th>
          <th>Usuario</th>
          <th>Acciones</th>
        </tr>
        </thead>
        <tbody id="entrada-tbody"></tbody>
      </table>
    </div>
  </section>

  <section id="tab-reporte" class="tab">
    <div class="actions-report">
      <button type="button" class="primary" onclick="exportarPDF()">Exportar PDF</button>
    </div>
    <div id="reporte-contenedor">
      <div id="pdf-header-info" class="pdf-header-info"></div>
      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>Fecha</th>
            <th>Comprador</th>
            <th>Proveedor</th>
            <th>Sector</th>
            <th class="numeric">Libras</th>
            <th class="numeric">Gramaje</th>
            <th class="numeric">Cola aprox</th>
          </tr>
          </thead>
          <tbody id="reporte-tbody"></tbody>
        </table>
      </div>
      <div class="totals-footer">
        <span><strong>Volumen de compra con cabeza:</strong> <span id="footer-total-kilos">0,00</span></span>
        <span><strong>Gramaje promedio:</strong> <span id="footer-gramaje-promedio">0,00</span></span>
        <span><strong>Total Cola aprox:</strong> <span id="footer-total-monto">0,00</span></span>
      </div>
    </div>
  </section>

  <section id="tab-creacion" class="tab">
    <div class="catalog-section">
      <h3>Catálogo de Compradores</h3>
      <div class="catalog-form">
        <input type="text" id="nuevo-comprador" placeholder="Nombre de comprador" />
        <button type="button" class="primary" onclick="agregarCatalogo('comprador')">Agregar</button>
      </div>
      <ul id="lista-compradores-admin" class="catalog-list"></ul>
    </div>
    <div class="catalog-section">
      <h3>Catálogo de Proveedores / Clientes</h3>
      <div class="catalog-form">
        <input type="text" id="nuevo-proveedor" placeholder="Nombre de proveedor / cliente" />
        <button type="button" class="primary" onclick="agregarCatalogo('proveedor')">Agregar</button>
      </div>
      <ul id="lista-proveedores-admin" class="catalog-list"></ul>
    </div>
    <div class="catalog-section">
      <h3>Catálogo de Sectores</h3>
      <div class="catalog-form">
        <input type="text" id="nuevo-sector" placeholder="Nombre de sector" />
        <button type="button" class="primary" onclick="agregarCatalogo('sector')">Agregar</button>
      </div>
      <ul id="lista-sectores-admin" class="catalog-list"></ul>
    </div>
    <div class="catalog-section">
      <h3>Usuarios del sistema</h3>
      <div class="catalog-form">
        <input type="text" id="nuevo-usuario" placeholder="Usuario" />
        <input type="password" id="nuevo-password" placeholder="Contraseña" />
        <select id="nuevo-rol">
          <option value="ADMINISTRADOR">ADMINISTRADOR</option>
          <option value="ESTANDAR">ESTANDAR</option>
        </select>
        <button type="button" class="primary" onclick="agregarUsuario()">Agregar</button>
      </div>
      <table style="width:100%; border-collapse:collapse; font-size:0.78rem;">
        <thead>
        <tr style="background:#ececf4;">
          <th style="text-align:left; padding:2px 4px;">Usuario</th>
          <th style="text-align:left; padding:2px 4px;">Rol</th>
          <th style="text-align:center; padding:2px 4px;">Acciones</th>
        </tr>
        </thead>
        <tbody id="usuarios-tbody"></tbody>
      </table>
    </div>
  </section>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  let loggedInUser = null;
  let loggedInRole = null;
  let registros = [];
  let compradores = [];
  let proveedores = [];
  let sectores = [];
  let usuarios = [];

  const formatoFechaLargo = (iso) => {
    if (!iso) return "";
    const date = new Date(iso + "T00:00:00");
    return date.toLocaleDateString("es-EC", { weekday: "long", year: "numeric", month: "long", day: "numeric" });
  };

  const formatoFechaCorta = (iso) => {
    if (!iso) return "";
    const date = new Date(iso + "T00:00:00");
    return date.toLocaleDateString("es-EC", { day: "2-digit", month: "2-digit", year: "numeric" });
  };

  const formatNumber = (value, decimals) => {
    const num = Number(value) || 0;
    return num.toLocaleString("es-EC", { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
  };

  const guardarEnLocalStorage = () => localStorage.setItem("registrosCompra", JSON.stringify(registros));
  const guardarCatalogos = () => {
    localStorage.setItem("catalogoCompradores", JSON.stringify(compradores));
    localStorage.setItem("catalogoProveedores", JSON.stringify(proveedores));
    localStorage.setItem("catalogoSectores", JSON.stringify(sectores));
  };
  const guardarUsuarios = () => localStorage.setItem("usuariosSistema", JSON.stringify(usuarios));

  const cargarDesdeLocalStorage = () => {
    const r = localStorage.getItem("registrosCompra");
    if (r) try { registros = JSON.parse(r); } catch { registros = []; }
    const c1 = localStorage.getItem("catalogoCompradores");
    const c2 = localStorage.getItem("catalogoProveedores");
    const c3 = localStorage.getItem("catalogoSectores");
    try { compradores = c1 ? JSON.parse(c1) : []; } catch { compradores = []; }
    try { proveedores = c2 ? JSON.parse(c2) : []; } catch { proveedores = []; }
    try { sectores   = c3 ? JSON.parse(c3)   : []; } catch { sectores = []; }
  };

  const cargarUsuarios = () => {
    const udata = localStorage.getItem("usuariosSistema");
    if (udata) try { usuarios = JSON.parse(udata) || []; } catch { usuarios = []; }
    if (!usuarios.some(u => u.rol === "ADMINISTRADOR")) {
      usuarios.push({ usuario: "JeffersonFigueroaING87", password: "Divergente1987", rol: "ADMINISTRADOR" });
      guardarUsuarios();
    }
  };

  /* --------- RENDER TAB 1 (CON ORDENAMIENTO Y FILTRO) --------- */
  const renderEntrada = () => {
    const tbody = document.getElementById("entrada-tbody");
    const searchTerm = document.getElementById("search-input").value.toLowerCase();
    tbody.innerHTML = "";

    // 1. Ordenamos de la fecha más antigua a la más reciente
    const registrosProcesados = [...registros].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

    registrosProcesados.forEach((reg) => {
      // 2. Filtro de búsqueda
      if (searchTerm && !reg.comprador.toLowerCase().includes(searchTerm) && !reg.proveedor.toLowerCase().includes(searchTerm)) {
        return;
      }

      const originalIdx = registros.indexOf(reg);
      const tr = document.createElement("tr");
      const celdas = [formatoFechaLargo(reg.fecha), reg.comprador, reg.proveedor, reg.sector || "", formatNumber(reg.kilos, 2), formatNumber(reg.gramaje, 2), formatNumber(reg.monto, 2), reg.usuario || ""];

      celdas.forEach((valor, i) => {
        const td = document.createElement("td");
        if (i >= 4 && i <= 6) td.classList.add("numeric");
        td.textContent = valor;
        tr.appendChild(td);
      });

      const tdAcc = document.createElement("td");
      tdAcc.className = "actions-cell";
      const btnDel = document.createElement("button");
      btnDel.textContent = "Borrar";
      btnDel.className = "secondary";
      btnDel.onclick = () => {
        registros.splice(originalIdx, 1);
        guardarEnLocalStorage();
        actualizarTodo();
      };
      tdAcc.appendChild(btnDel);
      tr.appendChild(tdAcc);
      tbody.appendChild(tr);
    });
  };

  /* --------- RENDER TAB 2 --------- */
  const renderReporte = () => {
    const tbody = document.getElementById("reporte-tbody");
    tbody.innerHTML = "";
    const ordenados = [...registros].sort((a, b) => a.fecha.localeCompare(b.fecha));
    let fAct = null, sLib = 0, sGrS = 0, sGrC = 0, sCol = 0, tLib = 0, tGrS = 0, tGrC = 0, tCol = 0;

    const insSub = () => {
      if (fAct === null || sGrC === 0) return;
      const tr = document.createElement("tr"); tr.className = "subtotal-row";
      const td1 = document.createElement("td"); td1.colSpan = 4; td1.textContent = "Subtotal:"; tr.appendChild(td1);
      const td2 = document.createElement("td"); td2.className = "numeric"; td2.textContent = formatNumber(sLib, 2); tr.appendChild(td2);
      const td3 = document.createElement("td"); td3.className = "numeric"; td3.textContent = formatNumber(sGrS/sGrC, 2); tr.appendChild(td3);
      const td4 = document.createElement("td"); td4.className = "numeric"; td4.textContent = formatNumber(sCol, 2); tr.appendChild(td4);
      tbody.appendChild(tr);
    };

    ordenados.forEach(reg => {
      if (fAct !== reg.fecha) {
        insSub();
        fAct = reg.fecha; sLib = 0; sGrS = 0; sGrC = 0; sCol = 0;
        const trG = document.createElement("tr"); trG.className = "group-header";
        const tdG = document.createElement("td"); tdG.colSpan = 7; tdG.textContent = formatoFechaLargo(reg.fecha);
        trG.appendChild(tdG); tbody.appendChild(trG);
      }
      sLib += reg.kilos; sGrS += reg.gramaje; sGrC++; sCol += reg.monto;
      tLib += reg.kilos; tGrS += reg.gramaje; tGrC++; tCol += reg.monto;
      const tr = document.createElement("tr");
      [formatoFechaCorta(reg.fecha), reg.comprador, reg.proveedor, reg.sector || "", formatNumber(reg.kilos, 2), formatNumber(reg.gramaje, 2), formatNumber(reg.monto, 2)].forEach((v,i)=>{
        const td = document.createElement("td"); if(i>=4) td.className="numeric"; td.textContent=v; tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    insSub();
    document.getElementById("footer-total-kilos").textContent = formatNumber(tLib, 2);
    document.getElementById("footer-gramaje-promedio").textContent = formatNumber(tGrC > 0 ? tGrS/tGrC : 0, 2);
    document.getElementById("footer-total-monto").textContent = formatNumber(tCol, 2);
  };

  const renderCatalogos = () => {
    ["compradores", "proveedores", "sectores"].forEach(tipo => {
      const dl = document.getElementById("datalist-" + tipo); dl.innerHTML = "";
      const admin = document.getElementById("lista-" + tipo + "-admin"); admin.innerHTML = "";
      const lista = tipo === "compradores" ? compradores : tipo === "proveedores" ? proveedores : sectores;
      lista.forEach((n, idx) => {
        const opt = document.createElement("option"); opt.value = n; dl.appendChild(opt);
        const li = document.createElement("li"); li.textContent = n;
        const btn = document.createElement("button"); btn.textContent="X"; btn.className="secondary";
        btn.onclick = () => { lista.splice(idx, 1); guardarCatalogos(); renderCatalogos(); };
        li.appendChild(btn); admin.appendChild(li);
      });
    });
  };

  const renderUsuarios = () => {
    const tbody = document.getElementById("usuarios-tbody"); tbody.innerHTML = "";
    usuarios.forEach((u, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:2px 4px">${u.usuario}</td><td style="padding:2px 4px">${u.rol}</td><td style="text-align:center"><button class="secondary" style="font-size:0.7rem" onclick="eliminarUsuario(${idx})">Eliminar</button></td>`;
      tbody.appendChild(tr);
    });
  };

  function agregarCatalogo(tipo) {
    const input = document.getElementById("nuevo-" + tipo);
    const lista = tipo === "comprador" ? compradores : tipo === "proveedor" ? proveedores : sectores;
    if (input.value.trim() && !lista.includes(input.value.trim())) {
      lista.push(input.value.trim()); guardarCatalogos(); renderCatalogos();
    }
    input.value = "";
  }

  function agregarUsuario() {
    const u = document.getElementById("nuevo-usuario").value.trim();
    const p = document.getElementById("nuevo-password").value;
    const r = document.getElementById("nuevo-rol").value;
    if (u && p) { usuarios.push({ usuario: u, password: p, rol: r }); guardarUsuarios(); renderUsuarios(); }
  }

  function eliminarUsuario(idx) {
    if (usuarios[idx].rol === "ADMINISTRADOR" && usuarios.filter(u=>u.rol==="ADMINISTRADOR").length <= 1) return alert("Debe haber un administrador.");
    usuarios.splice(idx, 1); guardarUsuarios(); renderUsuarios();
  }

  const actualizarTodo = () => { renderEntrada(); renderReporte(); renderCatalogos(); renderUsuarios(); };

  document.getElementById("kilos").addEventListener("input", e => {
    document.getElementById("monto").value = (Number(e.target.value) * 0.66).toFixed(2);
  });

  document.getElementById("entrada-form").addEventListener("submit", e => {
    e.preventDefault();
    registros.push({
      fecha: document.getElementById("fecha").value,
      comprador: document.getElementById("comprador").value,
      proveedor: document.getElementById("proveedor").value,
      sector: document.getElementById("sector").value,
      kilos: Number(document.getElementById("kilos").value),
      gramaje: Number(document.getElementById("lotes").value),
      monto: Number(document.getElementById("kilos").value) * 0.66,
      usuario: loggedInUser
    });
    guardarEnLocalStorage(); actualizarTodo();
    e.target.reset(); document.getElementById("fecha").value = new Date().toISOString().slice(0,10);
  });

  document.getElementById("btn-limpiar").onclick = () => { if(confirm("¿Borrar todo?")) { registros=[]; guardarEnLocalStorage(); actualizarTodo(); } };

  document.querySelectorAll(".tabs button").forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll(".tabs button, .tab").forEach(el => el.classList.remove("active"));
      btn.classList.add("active"); document.getElementById("tab-" + btn.dataset.tab).classList.add("active");
    };
  });

  const loginForm = document.getElementById("login-form");
  loginForm.onsubmit = e => {
    e.preventDefault();
    const u = document.getElementById("login-username").value, p = document.getElementById("login-password").value;
    const user = usuarios.find(usr => usr.usuario === u && usr.password === p);
    if (user) {
      loggedInUser = user.usuario; loggedInRole = user.rol;
      sessionStorage.setItem("authOk", "1"); sessionStorage.setItem("authRole", user.rol); sessionStorage.setItem("authUser", user.usuario);
      document.getElementById("login-screen").style.display = "none"; document.getElementById("main-app").style.display = "block";
      document.getElementById("header-user").textContent = user.usuario; document.getElementById("header-role").textContent = `(${user.rol})`;
      document.getElementById("header-date-text").textContent = formatoFechaLargo(new Date().toISOString().slice(0,10));
      document.querySelector('[data-tab="creacion"]').style.display = user.rol === "ADMINISTRADOR" ? "" : "none";
      actualizarTodo();
    } else document.getElementById("login-error").style.display = "block";
  };

  document.getElementById("btn-logout").onclick = () => { sessionStorage.clear(); location.reload(); };

  function exportarJSON() {
    const blob = new Blob([JSON.stringify({registros, compradores, proveedores, sectores, usuarios}, null, 2)], {type: "application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
  }

  document.getElementById("file-import-json").onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => {
      const d = JSON.parse(ev.target.result);
      registros = d.registros; compradores = d.compradores; proveedores = d.proveedores; sectores = d.sectores; usuarios = d.usuarios;
      guardarEnLocalStorage(); guardarCatalogos(); guardarUsuarios(); actualizarTodo(); alert("Importado.");
    };
    reader.readAsText(e.target.files[0]);
  };

  async function exportarPDF() {
    // 1) Encabezado del reporte (queda dentro del PDF)
    const info = document.getElementById("pdf-header-info");
    const now = new Date();
    info.textContent = `Fecha: ${now.toLocaleString("es-EC")} | Usuario: ${loggedInUser || "-"}`;

    // 2) Clonamos el contenedor para capturar TODO (incluyendo lo que está "scrolleable")
    const original = document.getElementById("reporte-contenedor");
    const clone = original.cloneNode(true);

    // Colocamos el clon fuera de pantalla, pero renderizable
    clone.style.position = "fixed";
    clone.style.left = "-10000px";
    clone.style.top = "0";
    clone.style.width = original.offsetWidth + "px";
    clone.style.maxHeight = "none";
    clone.style.overflow = "visible";
    document.body.appendChild(clone);

    // Expandimos la tabla para que no corte por altura (max-height / overflow)
    const wrappers = clone.querySelectorAll(".table-wrapper");
    wrappers.forEach(w => {
      w.style.maxHeight = "none";
      w.style.overflow = "visible";
      w.style.borderRadius = "0";
    });

    // 3) Captura en canvas (a mayor scale, mejor nitidez)
    const canvas = await html2canvas(clone, {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true,
      width: clone.scrollWidth,
      height: clone.scrollHeight,
      windowWidth: clone.scrollWidth,
      windowHeight: clone.scrollHeight
    });

    // Quitamos el clon
    document.body.removeChild(clone);

    // 4) Generación del PDF en múltiples páginas si es necesario
    const pdf = new jspdf.jsPDF("l", "mm", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const margin = 10;
    const imgWidth = pageWidth - margin * 2;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    const imgData = canvas.toDataURL("image/png");

    const usableHeight = pageHeight - margin * 2;
    let heightLeft = imgHeight;
    let position = margin;

    // Primera página
    pdf.addImage(imgData, "PNG", margin, position, imgWidth, imgHeight);
    heightLeft -= usableHeight;

    // Páginas siguientes (recorte por desplazamiento vertical)
    while (heightLeft > 0) {
      pdf.addPage();
      position = margin - (imgHeight - heightLeft);
      pdf.addImage(imgData, "PNG", margin, position, imgWidth, imgHeight);
      heightLeft -= usableHeight;
    }

    // 5) Nombre del archivo: SGC Gestion de compra + fecha + hora
    const pad = (n) => String(n).padStart(2, "0");
    const stamp = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;
    pdf.save(`SGC Gestion de compra_${stamp}.pdf`);
  }

  cargarDesdeLocalStorage(); cargarUsuarios();
  if(sessionStorage.getItem("authOk") === "1") {
    loggedInUser = sessionStorage.getItem("authUser"); loggedInRole = sessionStorage.getItem("authRole");
    document.getElementById("login-screen").style.display = "none"; document.getElementById("main-app").style.display = "block";
    document.getElementById("header-user").textContent = loggedInUser; document.getElementById("header-role").textContent = `(${loggedInRole})`;
    document.getElementById("header-date-text").textContent = formatoFechaLargo(new Date().toISOString().slice(0,10));
    document.querySelector('[data-tab="creacion"]').style.display = loggedInRole === "ADMINISTRADOR" ? "" : "none";
    actualizarTodo();
  }
  document.getElementById("fecha").value = new Date().toISOString().slice(0,10);
</script>
</body>
</html>