<!doctype html>
<!-- BUILD_HISTORIAL_ACTIVO v20 2026-01-30 03:15 UTC -->
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SDA | Avance Descabezado</title>

  <!-- FAVICON -->
  <link rel="icon" href="favicon.ico?v=1">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png?v=1">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png?v=1">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=1">

  <style>
    :root{
      --blue:#1e88e5;
      --navy:#0d2f4f;
      --green:#2e7d32;
      --graybtn:#d9d9d9;
      --lightblue:#cfefff;
      --border:#dcdcdc;
      --softgreen:#dff1d8;
      --warnbg:#fff4d6;
      --warnbd:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#000}
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .wrap{max-width:980px;margin:0 auto;padding:10px 12px 24px}
    .topline{text-align:left;font-size:14px;padding:6px 0 8px;border-bottom:1px solid #ddd}
    .topline .email{color:var(--blue);text-decoration:underline}
    .navrow{display:flex;justify-content:space-between;align-items:flex-start;font-size:14px;padding:10px 0;min-height:26px}
    .navrow .left a{display:block;color:var(--green);text-decoration:none;margin:0 0 4px;cursor:pointer}
    .navrow .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .navrow .right .miniBtn{
      border:1px dotted #666;background:#fff;padding:4px 8px;font-weight:700;cursor:pointer
    }
    .navrow .right .miniBtn.danger{
      border-color:#b00020;
      color:#b00020;
    }
    .center{text-align:center}
    .title{margin:14px 0 10px;font-size:18px;color:var(--blue);letter-spacing:.5px}
    .logo{width:86px;height:86px;margin:8px auto 6px;display:block;object-fit:contain}
    .brand{font-weight:700;letter-spacing:.5px;margin:0;font-size:14px}
    .tagline{margin:0 0 8px;font-size:10px;letter-spacing:1px}
    .form{margin:14px auto 0;width:100%;max-width:430px}
    .row{display:grid;grid-template-columns:130px 1fr;gap:10px;align-items:center;margin:10px 0}
    .row label{font-size:16px}
    input[type="text"],input[type="password"],select{
      width:100%;padding:8px 10px;border:1px solid #ccc;background:#eee;outline:none;font-size:15px;min-height:38px
    }
    select{background:#fff}
    .btn{
      display:block;width:240px;margin:10px auto;padding:8px 10px;border:1px solid #555;background:var(--graybtn);
      color:#000;font-weight:700;text-align:center;cursor:pointer;user-select:none
    }
    .btn.blue{background:var(--lightblue);border-color:#2a2a2a;color:#0b5aa5}
    .btn.green{background:var(--softgreen);border-color:#2a2a2a;color:#1a5e1a}
    .btn.black{background:#000;color:#fff;border-color:#000}
    .btn:active{transform:scale(.99)}
    .linkCenter{text-align:center;margin-top:16px;color:var(--blue);text-decoration:underline;cursor:pointer;font-size:14px}

    .view{display:none}
    .view.active{display:block}

    /* Tabla */
    .tableWrap{width:100%;overflow:auto;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;font-size:13px;min-width:820px}
    thead th{background:var(--navy);color:#fff;padding:6px 8px;text-align:left;white-space:nowrap;vertical-align:bottom}
    tbody td{border-bottom:1px solid #eee;padding:6px 8px;vertical-align:middle;white-space:nowrap}
    tbody tr:hover{background:#fafafa}
    .cellEdit{
      border:1px dotted #666; padding:2px 6px; min-width:90px; display:inline-block; text-align:right;
      background:#fff; cursor:pointer;
    }
    .cellEdit.locked{background:#f4f4f4}

    /* ✅ Resaltar personas sin libras / 0 */
    .cellEdit.zero{
      background:var(--warnbg);
      border-color:var(--warnbd);
      font-weight:800;
    }
    .cellEdit.pulse{
      outline:2px solid var(--warnbd);
      outline-offset:2px;
      animation:pulseOne .85s ease-in-out 1;
    }
    @keyframes pulseOne{
      0%{transform:scale(1)}
      50%{transform:scale(1.02)}
      100%{transform:scale(1)}
    }

    .totalBox{
      font-weight:700; font-size:16px; padding:4px 8px; border:1px dotted #666; background:#fff;
      min-width:90px; text-align:right;
    }
    .thBtn{
      display:inline-block;
      margin-top:4px;
      font-size:11px;
      padding:3px 6px;
      border:1px dotted rgba(255,255,255,.9);
      background:rgba(255,255,255,.08);
      color:#fff;
      cursor:pointer;
      font-weight:700;
    }

    /* ✅ Tabla Libras: más compacta (solo APELLIDOS | NOMBRES | LIBRAS) */
    #tblLibras{min-width:420px}
    @media (max-width:520px){
      #tblLibras{min-width:360px}
    }

    /* ✅ Filtro registro (DÍA / MES / AÑO / HISTÓRICO) */
    .filterBar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start;
      margin:8px 0 12px;
    }
    .filterBar label{font-size:13px}
    .filterBar select,.filterBar input[type="date"]{
      padding:6px 8px; border:1px solid #ccc; background:#fff; font-size:13px; min-height:32px;
    }
    .filterBar .miniBtn{padding:6px 10px}

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:14px;z-index:999}
    .modal{width:min(420px,100%);background:#fff;border:1px solid #999;padding:14px}
    .modal h3{margin:0 0 6px;font-size:16px;text-align:center}
    .modal .buildTag{
      text-align:center;
      font-size:11px;
      color:#666;
      margin:-2px 0 8px;
      letter-spacing:.3px;
    }
    .modal .meta{font-size:13px;margin:0 0 10px}
    .modal .meta b{font-weight:700}

    /* ✅ Solo el input de libras (ya no afecta radios) */
    .modal #modalInput{
      width:100%;
      padding:10px;
      border:1px solid #ccc;
      font-size:16px;
    }

    /* ✅ Input + botón (+) en la misma línea */
    .modal .inputRow{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .modal .inputRow #modalInput{
      flex:1;
      min-width:0;
    }

    /* ✅ Botón + */
    .modal .plusBtn{
      width:44px;
      min-width:44px;
      height:42px;
      border:1px solid #2a2a2a;
      background:var(--lightblue);
      color:#0b5aa5;
      font-weight:900;
      font-size:22px;
      line-height:1;
      cursor:pointer;
      user-select:none;
    }
    .modal .plusBtn:active{transform:scale(.99)}

    .modal .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px}
    .modal .actions .btn{margin:0;width:160px}

    /* Gavetas + Libras finales (Modal) */
    .modal .modalName{display:block;font-size:20px;font-weight:800;margin:0 0 4px;}
    .modal .modalSub{font-size:13px;margin:0 0 10px;}
    .modal .optRow{display:flex;gap:14px;align-items:center;justify-content:center;margin:10px 0 6px;}
    .modal .optRow label{display:flex;gap:6px;align-items:center;font-size:14px;cursor:pointer;user-select:none;}
    .modal .optRow input[type="radio"]{transform:scale(1.15)}
    .modal .netBox{margin:8px 0 0;border:1px solid #ddd;background:#fff;padding:10px;text-align:center;}
    .modal .netBox .netLabel{font-size:12px;color:#333;margin-bottom:4px;}
    .modal .netBox .netValue{font-size:26px;font-weight:900;color:#0a8f2a;line-height:1;}
    /* ✅ Historial de acumulación (Modal) */
    .modal .histBox{
      margin:8px 0 0;
      border:2px solid #9bbbd6;
      background:#fafafa;
      padding:8px 10px;
      font-size:12px;
      color:#111;
    }
    .modal .histBox .histLabel{
      font-weight:800;
      margin-bottom:4px;
      color:#333;
    }
    .modal .histBox .histLine{
      font-family:"Courier New",Courier,monospace;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ✅ Modal "sin libras" */
    .listBox{
      border:1px solid #ddd;
      background:#fafafa;
      padding:8px 10px;
      max-height:220px;
      overflow:auto;
      font-size:13px;
    }
    .listItem{
      padding:6px 0;
      border-bottom:1px dashed #ddd;
    }
    .listItem:last-child{border-bottom:none}
    .listItem b{font-weight:800}
    .hint{
      font-size:12px;
      color:#333;
      background:var(--warnbg);
      border:1px solid rgba(245,158,11,.45);
      padding:8px 10px;
      margin-top:10px;
    }

    /* Mobile tweaks */
    @media (max-width:520px){
      .row{grid-template-columns:110px 1fr}
      .btn{width:100%}
      .wrap{padding:10px 10px 20px}
      .navrow{padding:8px 0}
      .navrow .right{gap:6px}
      table{min-width:740px}
    }
  </style>
</head>

<body class="safe">
  <div class="wrap">

    <!-- LOGIN -->
    <section id="vLogin" class="view active">
      <div class="center">
        <div class="title">INICIAR SESIÓN</div>
        <img class="logo" src="logo.png" alt="Oceantreasure Logo" onerror="this.style.display='none'">
        <p class="brand">OCEANTREASURE S.A.</p>
        <p class="tagline">100% ECUADORIAN QUALITY</p>
      </div>

      <div class="form">
        <div class="row">
          <label>Usuario:</label>
          <input id="loginEmail" type="text" autocomplete="username" />
        </div>
        <div class="row">
          <label>Contraseña:</label>
          <input id="loginPass" type="password" autocomplete="current-password" />
        </div>

        <div class="btn" id="btnLogin">ACCEDER</div>
        <div class="center" id="loginMsg" style="color:#b00020;font-size:13px;min-height:18px;"></div>
        <div class="center" id="bootMsg" style="color:#555;font-size:12px;min-height:18px;"></div>
      </div>
    </section>

    <!-- HEADER (solo logeado) -->
    <div id="authHeader" style="display:none;">
      <div class="topline">Usuario: <span class="email" id="userEmail"></span></div>
    </div>

    <!-- ASISTENCIA AVANCE -->
    <section id="vAsistencia" class="view">
      <div class="navrow">
        <div class="left"></div>
        <div class="right">
          <div class="miniBtn" id="btnRegistroA">REGISTRO DE PESADAS</div>
        </div>
      </div>

      <div class="center">
        <img class="logo" src="logo.png" alt="Oceantreasure Logo" onerror="this.style.display='none'">
        <p class="brand">OCEANTREASURE S.A.</p>
        <p class="tagline">100% ECUADORIAN QUALITY</p>
      </div>

      <div class="form">
        <div class="row" style="grid-template-columns:90px 1fr;">
          <label>Cuadrilla</label>
          <select id="selCuadrilla">
            <option value=""></option>
            <option>OCEANTREASURE</option>
            <option>MAREPREX</option>
            <option>FELESMAR</option>
          </select>
        </div>

        <div class="btn blue" id="btnTomarAsistencia">TOMAR ASISTENCIA</div>
        <div class="linkCenter" id="linkLogoutA">Cerrar sesión</div>
      </div>
    </section>

    <!-- NOMINA PRESENTE -->
    <section id="vNomina" class="view">
      <div class="navrow">
        <div class="left">
          <a id="lnkBackAsistencia">Volver</a>
          <a id="lnkLogoutN">Cerrar sesión</a>
        </div>
        <div class="right">
          <div class="miniBtn" id="btnRegistroN">REGISTRO DE PESADAS</div>
          <div class="miniBtn" id="btnPesar">PESAR CABEZAS</div>
        </div>
      </div>

      <div class="center">
        <img class="logo" src="logo.png" alt="Oceantreasure Logo" onerror="this.style.display='none'">
        <p class="brand">OCEANTREASURE S.A.</p>
        <p class="tagline">100% ECUADORIAN QUALITY</p>
      </div>

      <div class="center" style="font-size:13px;margin:6px 0 4px;">
        Cuadrilla seleccionada: <b id="nominaCuadrilla"></b>
      </div>
      <div class="center" style="font-size:13px;margin:0 0 10px;">
        Pesada actual: <b id="nominaPesadaLabel">—</b>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:140px;">ID</th>
              <th>APELLIDOS</th>
              <th>NOMBRES</th>
              <th style="width:135px;">PRESENTE<br><span class="thBtn" id="btnSelectAll">SELECCIONAR TODOS</span></th>
            </tr>
          </thead>
          <tbody id="nominaBody"></tbody>
        </table>
      </div>
    </section>

    <!-- LIBRAS CABEZAS PERSONAL -->
    <section id="vLibras" class="view">
      <div class="navrow">
        <div class="left">
          <a id="lnkBackNomina">Volver</a>
          <a id="lnkLogoutL">Cerrar sesión</a>
        </div>
        <div class="right">
          <div class="miniBtn" id="btnRegistro">REGISTRO DE PESADAS</div>
          <div class="miniBtn" id="btnNuevaPesada">GUARDAR</div>
          <div class="miniBtn" id="btnPdf">GENERAR PDF</div>
        </div>
      </div>

      <div class="center">
        <img class="logo" src="logo.png" alt="Oceantreasure Logo" onerror="this.style.display='none'">
        <p class="brand">OCEANTREASURE S.A.</p>
        <p class="tagline">100% ECUADORIAN QUALITY</p>
      </div>

      <div style="font-size:13px;margin:6px 0 2px;line-height:1.45;">
        Pesada: <b id="pesadaNum">—</b><br>
        Supervisor: <b id="pesadaSupervisor">—</b><br>
        Fecha: <b id="pesadaFecha">—</b><br>
        Hora: <b id="pesadaHora">—</b>
        <span id="pesadaLabel" style="display:none;">—</span>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0 10px;">
        <div style="font-size:13px;">
          Cuadrilla: <b id="librasCuadrilla"></b>
        </div>
        <div class="totalBox" id="totalLibras">0,00</div>
      </div>

      <div class="tableWrap">
        <table id="tblLibras">
          <thead>
            <tr>
              <th>APELLIDOS</th>
              <th>NOMBRES</th>
              <th style="width:110px;">LIBRAS</th>
            </tr>
          </thead>
          <tbody id="librasBody"></tbody>
        </table>
      </div>
    </section>

    <!-- REGISTRO DE PESADAS -->
    <section id="vRegistro" class="view">
      <div class="navrow">
        <div class="left">
          <a id="lnkBackRegistro">Volver</a>
          <a id="lnkLogoutR">Cerrar sesión</a>
        </div>
        <div class="right">
          <div class="miniBtn" id="btnExcelR">DESCARGAR EXCEL</div>
          <div class="miniBtn" id="btnPdfR">GENERAR PDF</div>
          <div class="miniBtn danger" id="btnClearR" title="Borra el historial de ESTA CUADRILLA (solo Jefferson)">LIMPIAR HISTÓRICO</div>
        </div>
      </div>

      <div class="center">
        <img class="logo" src="logo.png" alt="Oceantreasure Logo" onerror="this.style.display='none'">
        <p class="brand">OCEANTREASURE S.A.</p>
        <p class="tagline">100% ECUADORIAN QUALITY</p>
      </div>

      <div style="font-size:13px;margin:6px 0 10px;">
        Cuadrilla: <b id="regCuadrilla">—</b> &nbsp; | &nbsp; Rango: <b id="regFecha">HISTÓRICO</b>
      </div>

      <!-- ✅ FILTRO (por defecto hoy) -->
      <div class="filterBar">
        <label>Filtrar por:</label>
        <select id="regFilterMode" aria-label="Modo de filtro">
          <option value="DIA" selected>DÍA</option>
          <option value="MES">MES</option>
          <option value="ANIO">AÑO</option>
          <option value="HISTORICO">HISTÓRICO</option>
        </select>
        <input id="regFilterDate" type="date" />
        <div class="miniBtn" id="btnAplicarFiltro">APLICAR</div>
        <div class="miniBtn" id="btnVerHistorico">VER HISTÓRICO</div>
      </div>

      <div class="tableWrap">
        <table id="tblRegistro">
          <thead>
            <tr>
              <th>PESADA</th>
              <th style="width:120px;">FECHA</th>
              <th style="width:85px;">HORA</th>
              <th>SUPERVISOR</th>
              <th>APELLIDOS</th>
              <th>NOMBRES</th>
              <th>CUADRILLA</th>
              <th style="width:110px;">LIBRAS</th>
            </tr>
          </thead>
          <tbody id="regBody"></tbody>
        </table>
      </div>
    </section>

  </div>

  <!-- MODAL LIBRAS -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h3>CARGAR LIBRAS</h3>
      <div class="buildTag">HISTORIAL ACTIVO · v20 · 2026-01-30</div>
      <p class="meta" id="modalMeta"></p>

      <!-- ✅ Input más pequeño + botón + -->
      <div class="inputRow">
        <input id="modalInput" type="text" inputmode="decimal" placeholder="0,00" />
        <button id="modalAdd" class="plusBtn" type="button" title="Acumular (+)">+</button>
      </div>

      <div class="optRow" aria-label="Gavetas">
        <label><input type="radio" name="gavetas" id="gav1" value="1"> 1 gaveta</label>
        <label><input type="radio" name="gavetas" id="gav2" value="2" checked> 2 gavetas</label>
      </div>
      <div class="netBox">
        <div class="netLabel">LIBRAS FINALES (descontando gavetas)</div>
        <div class="netValue" id="modalNet">0,00</div>
      </div>

      <!-- ✅ Historial (solo visual) -->
      <div class="histBox" id="histBox">
        <div class="histLabel">DETALLE</div>
        <div class="histLine" id="modalHistory">—</div>
      </div>

      <div class="actions">
        <div class="btn blue" id="modalOk">ACEPTAR</div>
        <div class="btn" id="modalCancel">CANCELAR</div>
      </div>
    </div>
  </div>

  <!-- ✅ MODAL: Personas sin libras / 0 -->
  <div class="modalBack" id="zeroBack">
    <div class="modal">
      <h3>PERSONAL SIN LIBRAS</h3>
      <div class="buildTag">VALIDACIÓN GUARDAR · v20 · 2026-01-30</div>
      <p class="meta" id="zeroMeta"></p>
      <div class="listBox" id="zeroList"></div>

      <div class="hint">
        Si presionas <b>ACEPTAR</b>, se guardarán únicamente los registros con <b>LIBRAS &gt; 0</b>.
        Los que estén en <b>0</b> o vacíos <b>no se guardan</b> y no aparecerán en el histórico.
      </div>

      <div class="actions">
        <div class="btn green" id="zeroAccept">ACEPTAR</div>
        <div class="btn" id="zeroReview">REVISAR</div>
      </div>
    </div>
  </div>

  <!-- Captura errores JS -->
  <script>
    (function(){
      const show = (msg)=>{
        const el = document.getElementById("bootMsg");
        if(el) el.textContent = msg;
      };
      window.addEventListener("error", (e)=>{
        try{ show("Error JS: " + (e?.message || "ver consola")); }catch(_){}
      });
      window.addEventListener("unhandledrejection", (e)=>{
        try{ show("Error (promise): " + (e?.reason?.message || e?.reason || "ver consola")); }catch(_){}
      });
    })();
  </script>

  <!-- libs PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <!-- libs Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, EmailAuthProvider, reauthenticateWithCredential }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, getDoc, doc, setDoc, writeBatch, runTransaction }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ Mismo Firebase Project (Oceantreasure)
    const firebaseConfig = {
      apiKey: "AIzaSyCMoLkSnnLowMagRNL7O6ttPo1FXd1URac",
      authDomain: "oceantreasure-app.firebaseapp.com",
      projectId: "oceantreasure-app",
      storageBucket: "oceantreasure-app.firebasestorage.app",
      messagingSenderId: "553014659258",
      appId: "1:553014659258:web:cfc30844a88433b7b79a83",
      measurementId: "G-HMMQKJY8NJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // SRH colección (Talento Humano)
    const COL_SRH = "rrhh_talento";
    // SDA colección (registros de pesadas)
    const COL_SDA = "sda_avance_cabezas";
    // Contadores globales por día (y cuadrilla)
    const COL_COUNTERS = "sda_pesada_counters";

    const ALLOWED = new Set([
      "aracellytomala@oceantreasure.local",
      "keniacruz@oceantreasure.local",
      "gingervaldiviezo@oceantreasure.local",
      "pesadoradesalojo@oceantreasure.local",
      "vanesapacheco@oceantreasure.local",
      "jeffersonfigueroa@oceantreasure.local",
      // ✅ nuevos (solo registro HOY)
      "solangefelesmar@oceantreasure.local",
      "angiemareprex@oceantreasure.local"
    ]);

    // Usuarios que pueden ver el histórico de TODOS los supervisores (sin elegir cuadrilla)
    const ADMIN_VIEW_ALL = new Set([
      "jeffersonfigueroa@oceantreasure.local",
      "vanesapacheco@oceantreasure.local"
    ]);

    // =======================
    // ✅ PERMISOS ESPECIALES (REGISTRO SOLO HOY)
    // =======================
    const REGISTRO_ONLY_TODAY = new Map([
      ["solangefelesmar@oceantreasure.local", { cuadrilla: "FELESMAR" }],
      ["angiemareprex@oceantreasure.local",  { cuadrilla: "MAREPREX"  }],
    ]);

    let currentPolicy = {
      mode: "NORMAL",          // NORMAL | REGISTRO_ONLY_TODAY
      fixedCuadrilla: "",      // si aplica
    };

    function computePolicy(email){
      const e = (email || "").toLowerCase();
      if(REGISTRO_ONLY_TODAY.has(e)){
        return { mode: "REGISTRO_ONLY_TODAY", fixedCuadrilla: REGISTRO_ONLY_TODAY.get(e).cuadrilla };
      }
      return { mode: "NORMAL", fixedCuadrilla: "" };
    }

    // Supervisores operativos (se muestran en el histórico completo)
    const SUPERVISORS = [
      "gingervaldiviezo@oceantreasure.local",
      "aracellytomala@oceantreasure.local",
      "pesadoradesalojo@oceantreasure.local"
    ];

    const $ = (id) => document.getElementById(id);

    const views = {
      login: $("vLogin"),
      asistencia: $("vAsistencia"),
      nomina: $("vNomina"),
      libras: $("vLibras"),
      registro: $("vRegistro")
    };

    // ✅ Opciones originales para restaurar si cambia usuario
    const ORIGINAL_CUADRILLA_OPTIONS = `
      <option value=""></option>
      <option>OCEANTREASURE</option>
      <option>MAREPREX</option>
      <option>FELESMAR</option>
    `;

    let currentViewName = "login";

    function showView(name){
      // ✅ Si es REGISTRO_ONLY_TODAY, solo permitimos: login / asistencia / registro
      if(currentPolicy?.mode === "REGISTRO_ONLY_TODAY"){
        const allowedViews = new Set(["login","asistencia","registro"]);
        if(!allowedViews.has(name)) name = "asistencia";
      }

      Object.values(views).forEach(v => v.classList.remove("active"));
      views[name].classList.add("active");
      currentViewName = name;
    }
    function setHeaderVisible(v){ $("authHeader").style.display = v ? "block" : "none"; }
    function setUserEmail(email){ $("userEmail").textContent = email || ""; }
    async function doLogout(){ await signOut(auth); }

    // --- Estado ---
    let currentUserEmail = "";
    let currentCuadrilla = "";
    let registroReturnView = "libras";
    let nomina = [];           // [{id, apellidos, nombres, areaTrabajo, cuadrilla}]
    let presentes = new Set(); // ids presentes
    let sessionId = "";        // id de sesión para SDA (solo UI)
    let librasMap = new Map(); // id -> number

    // pesada
    let pesadaN = 0;
    let pesadaLabel = "—";     // texto visible
    let pesadaKey = "";        // clave safe

    // registro cache
    let registroRows = [];
    let registroAllRows = [];
    let registroFilterMode = "DIA";
    let registroFilterDate = ""; // yyyy-mm-dd

    function todayKey(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function todayHuman(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    }
    function timeHM(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${hh}:${mi}`;
    }
    function timeHMS(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${hh}:${mi}:${ss}`;
    }
    function nowLocalString(){
      // ✅ fecha/hora del dispositivo (local)
      try{ return new Date().toLocaleString("es-EC"); }
      catch(_){ return `${todayHuman()} ${timeHMS()}`; }
    }

    function playSuccessBeep(){
      try{
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if(!AudioCtx) return;

        const ctx = new AudioCtx();
        if(ctx.state === "suspended"){
          ctx.resume().catch(()=>{});
        }

        const o = ctx.createOscillator();
        const g = ctx.createGain();

        o.type = "sine";
        o.frequency.setValueAtTime(880, ctx.currentTime);
        g.gain.setValueAtTime(0.001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.18);

        o.connect(g);
        g.connect(ctx.destination);

        o.start();
        o.stop(ctx.currentTime + 0.20);

        setTimeout(()=>{ try{ ctx.close(); }catch(_){ } }, 300);
      }catch(_){}
    }

    function hapticOk(){
      try{
        if(navigator.vibrate) navigator.vibrate([50, 30, 70]);
      }catch(_){}
    }

    function feedbackOk(){
  hapticOk();
  playSuccessBeep();
}

// ✅ Guardado pendiente (reintento seguro)
function pendingSaveKey(){
  return `SDA_PENDING_SAVE_${todayKey()}_${currentCuadrilla}_${currentUserEmail}`;
}
function loadPendingSave(){
  try{
    const raw = localStorage.getItem(pendingSaveKey());
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.cuadrilla || !Array.isArray(obj.entries)) return null;
    return obj;
  }catch(_){ return null; }
}
function setPendingSave(obj){
  try{ localStorage.setItem(pendingSaveKey(), JSON.stringify(obj)); }catch(_){}
}
function clearPendingSave(){
  try{ localStorage.removeItem(pendingSaveKey()); }catch(_){}
}

// ✅ Internet real (bloquea guardado si no hay)
async function ensureInternetOrWarn(){
  const msg = `❌ Sin acceso a internet.
Conéctese a una red para poder GUARDAR la pesada.`;

  try{
    if(typeof navigator !== "undefined" && navigator.onLine === false){
      alert(msg);
      return false;
    }
  }catch(_){}

  const timeout = (ms)=> new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")), ms));

  try{
    await Promise.race([
      fetch("https://www.gstatic.com/generate_204", { mode:"no-cors", cache:"no-store" }),
      timeout(5000)
    ]);
    return true;
  }catch(_){
    alert(msg);
    return false;
  }
}

async function sleepMs(ms){ return new Promise(res=>setTimeout(res, ms)); }

function buildEntriesFromValidIds(validIds){
  const entries = [];
  for(const id of validIds){
    const p = nomina.find(x=>x.id===id);
    if(!p) continue;
    const lbs = librasMap.has(id) ? Number(librasMap.get(id)) : 0;
    if(!Number.isFinite(lbs) || lbs <= 0) continue;
    entries.push({
      personId: String(id),
      apellidos: p.apellidos || "",
      nombres: p.nombres || "",
      area: p.areaTrabajo || "",
      libras: lbs
    });
  }
  return entries;
}

async function getLastSavedPesadaNumber(){
  // Fuente de verdad: counter (última pesada guardada). Si no existe, bootstrap con max en SDA.
  const counterId = `${todayKey()}_${currentCuadrilla}`.replaceAll(" ","_");
  const ref = doc(db, COL_COUNTERS, counterId);

  let last = 0;
  try{
    const snap = await getDoc(ref);
    if(snap.exists()){
      const v = Number((snap.data()||{}).last || 0);
      last = (Number.isFinite(v) && v >= 0) ? v : 0;
    }
  }catch(err){
    console.error("getLastSavedPesadaNumber getDoc error:", err);
  }

  // Bootstrap / auto-repair si SDA tiene un max mayor
  try{
    let maxN = 0;
    const q = query(
      collection(db, COL_SDA),
      where("cuadrilla","==", currentCuadrilla),
      where("fecha","==", todayKey())
    );
    const snap2 = await getDocs(q);
    snap2.forEach(d=>{
      const x = d.data() || {};
      const n = Number(x.pesadaNumero || 0);
      if(Number.isFinite(n) && n > maxN) maxN = n;
    });
    if(maxN > last){
      last = maxN;
      await setDoc(ref, { last, fecha: todayKey(), cuadrilla: currentCuadrilla, updatedAt: new Date().toISOString() }, { merge:true });
    }else if(!Number.isFinite(last)){
      last = 0;
    }else{
      // asegurar doc
      await setDoc(ref, { last, fecha: todayKey(), cuadrilla: currentCuadrilla, updatedAt: new Date().toISOString() }, { merge:true });
    }
  }catch(err){
    console.error("bootstrap counter error:", err);
  }
  return last;
}

function makePesadaLabel(n){
  return `Pesada${n}_${userShort()}_${todayHuman()}_${timeHM()}`;
}
function makePesadaKeyFromLabel(label){
  return String(label||"").replaceAll(":","-").replaceAll("/","-");
}
function setPesadaDraftNumber(n){
  const nn = Number(n||0);
  const label = makePesadaLabel(nn);
  const key = makePesadaKeyFromLabel(label);
  pesadaN = nn;
  pesadaLabel = label;
  pesadaKey = key;
  try{ localStorage.setItem(pesadaCurrentKey(), JSON.stringify({ pesadaN: nn, label, key, createdAt: new Date().toISOString(), draft:true })); }catch(_){}
  updatePesadaUI();
  return { assigned: nn, label, key };
}

async function ensurePesadaDraft(){
  // Muestra próxima pesada basada en lo último GUARDADO.
  if(!currentCuadrilla) return;

  const pend = loadPendingSave();
  if(pend && pend.draft && pend.draft.pesadaN){
    setPesadaDraftNumber(Number(pend.draft.pesadaN||0));
    return;
  }

  const last = await getLastSavedPesadaNumber();
  const expected = last + 1;

  const raw = localStorage.getItem(pesadaCurrentKey());
  if(raw){
    try{
      const obj = JSON.parse(raw);
      const nLocal = Number(obj?.pesadaN || 0);
      if(obj && obj.label && obj.key && nLocal === expected){
        pesadaN = nLocal;
        pesadaLabel = obj.label;
        pesadaKey = obj.key;
        updatePesadaUI();
        return;
      }
    }catch(_){}
  }

  setPesadaDraftNumber(expected);
}

async function savePesadaTransaction(entries){
  // ✅ Atómico: asigna número + escribe counter + docs en una transacción
  if(!Array.isArray(entries) || entries.length === 0) throw new Error("No hay registros para guardar.");
  if(entries.length > 450) throw new Error("Demasiados registros para una transacción. Divida la pesada.");

  const counterId = `${todayKey()}_${currentCuadrilla}`.replaceAll(" ","_");
  const counterRef = doc(db, COL_COUNTERS, counterId);

  const res = await runTransaction(db, async (tx)=>{
    const snap = await tx.get(counterRef);
    let last = 0;
    if(snap.exists()){
      const v = Number((snap.data()||{}).last || 0);
      last = (Number.isFinite(v) && v >= 0) ? v : 0;
    }

    const assigned = last + 1;
    const label = makePesadaLabel(assigned);
    const key = makePesadaKeyFromLabel(label);

    const fecha = todayKey();
    const hora  = timeHMS();
    const nowIso = new Date().toISOString();
    const fechaHoraLocal = nowLocalString();

    tx.set(counterRef, { last: assigned, fecha, cuadrilla: currentCuadrilla, updatedAt: nowIso }, { merge:true });

    for(const e of entries){
      const payload = {
        pesadaNumero: assigned,
        numeroPesada: label,
        pesadaKey: key,
        fecha,
        hora,
        fechaHoraLocal,
        cuadrilla: currentCuadrilla,
        usuario: currentUserEmail,

        personId: e.personId,
        apellidos: e.apellidos,
        nombres: e.nombres,
        area: e.area,
        libras: e.libras,

        updatedAt: nowIso
      };
      const docId = `${key}_${e.personId}`;
      tx.set(doc(db, COL_SDA, docId), payload, { merge:true });
    }

    return { assigned, label, key };
  });

  // reflejar resultado real
  pesadaN = Number(res.assigned||0);
  pesadaLabel = res.label;
  pesadaKey = res.key;
  try{ localStorage.setItem(pesadaCurrentKey(), JSON.stringify({ pesadaN, label: pesadaLabel, key: pesadaKey, createdAt: new Date().toISOString(), draft:false })); }catch(_){}
  updatePesadaUI();
  return res;
}

async function commitSaveWithRetry(entries, maxAttempts = 3){
  let lastErr = null;
  for(let attempt=1; attempt<=maxAttempts; attempt++){
    if(!(await ensureInternetOrWarn())){
      lastErr = new Error("offline");
      break;
    }
    try{
      return await savePesadaTransaction(entries);
    }catch(err){
      lastErr = err;
      console.error(`TXN SAVE ATTEMPT ${attempt} ERROR`, err);
      await sleepMs(Math.min(2500 * attempt, 7000));
    }
  }
  throw (lastErr || new Error("No se pudo guardar."));
}

function hookOnlineRetry(){
  window.addEventListener("online", async ()=>{
    try{
      if(!currentUserEmail || !currentCuadrilla) return;
      const pend = loadPendingSave();
      if(!pend) return;

      const ok = confirm(`✅ Conexión restablecida.\n¿Desea REINTENTAR guardar la pesada pendiente?`);
      if(!ok) return;

      const entries = Array.isArray(pend.entries) ? pend.entries : [];
      if(entries.length === 0){
        alert("No hay registros pendientes para reintentar.");
        clearPendingSave();
        return;
      }

      const displayed = Number(pend?.draft?.pesadaN || 0);

      let res;
      try{
        res = await commitSaveWithRetry(entries, 3);
      }catch(err){
        console.error("ONLINE RETRY ERROR", err);
        alert("No se pudo completar el reintento. Verifique su internet e intente nuevamente.");
        return;
      }

      clearPendingSave();

      if(Number.isFinite(res.assigned) && displayed && res.assigned !== displayed){
        alert(`ℹ️ El número de pesada fue cambiado a Pesada${res.assigned} (otro dispositivo guardó primero Pesada${displayed}).`);
      }

      feedbackOk();
      alert(`✅ Pesada guardada:
${res.label}
(Reintento exitoso)`);

      // Preparar siguiente draft
      presentes = new Set();
      librasMap = new Map();
      sessionId = "";
      clearSession();

      await ensurePesadaDraft();
      loadNomina().then(()=>showView("nomina"));
    }catch(_){}
  });
}
hookOnlineRetry();

    function makeSessionId(){
      const d = new Date();
      const stamp = d.toISOString().replaceAll(":","").replaceAll(".","").replaceAll("-","").replace("T","_").slice(0,15);
      return `SDA_${todayKey()}_${currentCuadrilla}_${stamp}`;
    }

    function sessionStorageKey(){
      return `SDA_SESSION_${todayKey()}_${currentCuadrilla}_${currentUserEmail}`;
    }
    function pesadaCurrentKey(){
      return `SDA_PESADA_CURRENT_${todayKey()}_${currentCuadrilla}_${currentUserEmail}`;
    }

    function userShort(){
      const u = (currentUserEmail || "").split("@")[0] || "";
      return u.replaceAll(".","").replaceAll(" ","");
    }

    async function allocateNextPesadaNumber(){
      const counterId = `${todayKey()}_${currentCuadrilla}`.replaceAll(" ","_");
      const ref = doc(db, COL_COUNTERS, counterId);
      const next = await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        let last = 0;
        if(snap.exists()){
          const v = Number((snap.data()||{}).last || 0);
          last = (Number.isFinite(v) && v >= 0) ? v : 0;
        }
        const n = last + 1;
        tx.set(ref, { last: n, fecha: todayKey(), cuadrilla: currentCuadrilla, updatedAt: new Date().toISOString() }, { merge:true });
        return n;
      });
      return next;
    }

    async function nextPesada(){
      const n = await allocateNextPesadaNumber();
      const label = `Pesada${n}_${userShort()}_${todayHuman()}_${timeHM()}`;
      const key = label.replaceAll(":","-").replaceAll("/","-");
      localStorage.setItem(pesadaCurrentKey(), JSON.stringify({ pesadaN: n, label, key, createdAt: new Date().toISOString() }));
      return { n, label, key };
    }

    async function ensurePesada(){
      // ✅ Objetivo: evitar repetir número de pesada por usuario.
      // Regla: el número debe ser ÚNICO por (fecha + cuadrilla) sin importar usuario.
      // Estrategia:
      // 1) Leemos el contador (COL_COUNTERS) para hoy+cuadrilla.
      // 2) Si existe pesada guardada en localStorage y ES la última asignada => la mantenemos (permite refrescar sin perder).
      // 3) Si la pesada local está "atrasada" (menor a last del contador) => se descarta y se asigna una nueva.
      // 4) Si no existe contador, lo inicializamos consultando SDA (hoy+cuadrilla) y guardando el max en el contador.
      const raw = localStorage.getItem(pesadaCurrentKey());

      // ✅ obtener last del contador (con fallback)
      const counterId = `${todayKey()}_${currentCuadrilla}`.replaceAll(" ","_");
      const counterRef = doc(db, COL_COUNTERS, counterId);

      async function computeMaxPesadaFromSDA(){
        // Fallback por si no existe counter (o se borró).
        // Consulta registros HOY de la cuadrilla y obtiene el máxima pesadaNumero.
        let maxN = 0;
        try{
          const q = query(
            collection(db, COL_SDA),
            where("cuadrilla","==", currentCuadrilla),
            where("fecha","==", todayKey())
          );
          const snap = await getDocs(q);
          snap.forEach(d=>{
            const x = d.data() || {};
            const n = Number(x.pesadaNumero || 0);
            if(Number.isFinite(n) && n > maxN) maxN = n;
          });
        }catch(err){
          console.error("Fallback max pesada error:", err);
        }
        return maxN;
      }

      async function getCounterLastSafe(){
        try{
          const snap = await getDoc(counterRef);
          if(snap.exists()){
            const v = Number((snap.data()||{}).last || 0);
            return (Number.isFinite(v) && v >= 0) ? v : 0;
          }
        }catch(err){
          console.error("getCounterLastSafe error:", err);
        }
        // Si no existe counter, lo inicializamos con max de SDA
        const maxN = await computeMaxPesadaFromSDA();
        try{
          await setDoc(counterRef, { last: maxN, fecha: todayKey(), cuadrilla: currentCuadrilla, updatedAt: new Date().toISOString() }, { merge:true });
        }catch(err){
          console.error("init counter error:", err);
        }
        return maxN;
      }

      const last = await getCounterLastSafe();

      if(raw){
        try{
          const obj = JSON.parse(raw);
          const nLocal = Number(obj?.pesadaN || 0);
          const hasAll = !!(obj && obj.label && obj.key && nLocal);

          if(hasAll){
            // ✅ Si la pesada local es la última asignada del contador, permitimos continuar (refresh-safe).
            // ✅ Si está atrasada (nLocal < last), NO la usamos para evitar duplicar números.
            if(nLocal === last && last > 0){
              pesadaN = nLocal;
              pesadaLabel = obj.label;
              pesadaKey = obj.key;
              updatePesadaUI();
              return;
            }
            // Si el contador está en 0 (no hay nada) y local es 1, permitimos (primer caso)
            if(last === 0 && nLocal === 1){
              pesadaN = nLocal;
              pesadaLabel = obj.label;
              pesadaKey = obj.key;
              updatePesadaUI();
              return;
            }
            // Caso típico de duplicación: local viejo, contador ya avanzó
            // => descartamos y generamos nueva
          }
        }catch(_){}
      }

      // ✅ Si llegamos aquí: asignar una nueva pesada (nunca repetida por cuadrilla+día)
      const p = await nextPesada();
      pesadaN = p.n; pesadaLabel = p.label; pesadaKey = p.key;
      updatePesadaUI();
    }

    function updatePesadaUI(){
      if($("pesadaLabel")) $("pesadaLabel").textContent = pesadaLabel || "—";
      if($("nominaPesadaLabel")) $("nominaPesadaLabel").textContent = pesadaLabel || "—";

      const label = String(pesadaLabel || "").trim();
      let p = "—", sup = "—", fecha = "—", hora = "—";
      if(label && label !== "—"){
        const parts = label.split("_");
        p = parts[0] || "—";
        sup = parts[1] || "—";
        fecha = parts[2] || "—";
        hora = parts[3] || "—";
      }

      if($("pesadaNum")) $("pesadaNum").textContent = p;
      if($("pesadaSupervisor")) $("pesadaSupervisor").textContent = sup;
      if($("pesadaFecha")) $("pesadaFecha").textContent = fecha;
      if($("pesadaHora")) $("pesadaHora").textContent = hora;
    }

    // =======================
    // ✅ UI policy helpers
    // =======================
    function applyAsistenciaPolicy(){
      const sel = $("selCuadrilla");
      const btnTomar = $("btnTomarAsistencia");
      const btnRegistroA = $("btnRegistroA");

      if(!sel) return;

      // Restaurar por si cambia usuario
      sel.innerHTML = ORIGINAL_CUADRILLA_OPTIONS;
      sel.disabled = false;

      // Mostrar por defecto
      if(btnTomar) btnTomar.style.display = "";
      if(btnRegistroA) btnRegistroA.style.display = "";

      if(currentPolicy.mode === "REGISTRO_ONLY_TODAY"){
        // ✅ Solo 1 opción, fija
        sel.innerHTML = `<option>${currentPolicy.fixedCuadrilla}</option>`;
        sel.value = currentPolicy.fixedCuadrilla;
        sel.disabled = true;

        // ✅ No pueden tomar asistencia
        if(btnTomar) btnTomar.style.display = "none";

        // ✅ Fijar cuadrilla en estado
        currentCuadrilla = currentPolicy.fixedCuadrilla;
      }
    }

    function applyRegistroPolicyUI(){
      const bar = document.querySelector(".filterBar");
      const btnClear = $("btnClearR");

      // ✅ Nunca mostrar limpiar histórico en modo restringido
      if(btnClear) btnClear.style.display = (currentPolicy.mode === "REGISTRO_ONLY_TODAY") ? "none" : "";

      // ✅ Ocultar totalmente el filtro (día/mes/año/histórico + date + botones)
      if(bar) bar.style.display = (currentPolicy.mode === "REGISTRO_ONLY_TODAY") ? "none" : "";
    }

    // --- Login ---
    $("btnLogin").onclick = async () => {
      $("loginMsg").textContent = "";
      const email = $("loginEmail").value.trim();
      const pass  = $("loginPass").value;
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(e){
        $("loginMsg").textContent = "Error: usuario o contraseña incorrectos.";
        console.error("LOGIN ERROR", e);
      }
    };
    ["loginEmail","loginPass"].forEach(id=>{
      $(id).addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnLogin").click(); });
    });

    // Logout links
    $("linkLogoutA").onclick = doLogout;
    $("lnkLogoutN").onclick = doLogout;
    $("lnkLogoutL").onclick = doLogout;
    $("lnkLogoutR").onclick = doLogout;

    // Back links
    $("lnkBackAsistencia").onclick = () => showView("asistencia");
    $("lnkBackNomina").onclick = () => showView("nomina");
    $("lnkBackRegistro").onclick = () => showView(registroReturnView || "libras");

    // Auth state
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUserEmail = user.email || "";
        setHeaderVisible(true);
        setUserEmail(currentUserEmail);

        currentPolicy = computePolicy(currentUserEmail);

        if(!ALLOWED.has((currentUserEmail || "").toLowerCase())){
          alert("Acceso no autorizado.");
          await doLogout();
          return;
        }

        resetAll();
        applyAsistenciaPolicy();
        showView("asistencia");

        // ✅ EXTRA PRO: auto-abrir Registro para usuarios restringidos
        if(currentPolicy.mode === "REGISTRO_ONLY_TODAY"){
          await openRegistro(true);
        }

      } else {
        currentUserEmail = "";
        setHeaderVisible(false);
        setUserEmail("");
        currentPolicy = { mode:"NORMAL", fixedCuadrilla:"" };
        resetAll();
        showView("login");
      }
    });

    function resetAll(){
      currentCuadrilla = "";
      nomina = [];
      presentes = new Set();
      sessionId = "";
      librasMap = new Map();
      pesadaN = 0;
      pesadaLabel = "—";
      pesadaKey = "";
      registroRows = [];
      registroAllRows = [];
      registroFilterMode = "DIA";
      registroFilterDate = "";

      $("selCuadrilla").value = "";
      $("nominaBody").innerHTML = "";
      $("librasBody").innerHTML = "";
      $("regBody").innerHTML = "";
      $("nominaCuadrilla").textContent = "";
      $("librasCuadrilla").textContent = "";
      $("regCuadrilla").textContent = "—";
      $("regFecha").textContent = "—";
      $("totalLibras").textContent = "0,00";
      updatePesadaUI();
      updateSelectAllBtn();

      applyAsistenciaPolicy();
      applyRegistroPolicyUI();
    }

    // --- Tomar Asistencia ---
    $("btnTomarAsistencia").onclick = async () => {
      if(currentPolicy.mode === "REGISTRO_ONLY_TODAY"){
        alert("Acceso restringido: solo REGISTRO DE PESADAS.");
        return;
      }

      const c = $("selCuadrilla").value || "";
      if(!c){ alert("Seleccione la CUADRILLA."); return; }
      currentCuadrilla = c;
      $("nominaCuadrilla").textContent = c;
      $("librasCuadrilla").textContent = c;

      const saved = localStorage.getItem(sessionStorageKey());
      if(saved){
        try{
          const obj = JSON.parse(saved);
          sessionId = obj.sessionId || "";
          presentes = new Set(obj.presentes || []);
          librasMap = new Map(Object.entries(obj.libras || {}).map(([k,v])=>[k, Number(v)]));
        }catch(_){}
      }

      await ensurePesadaDraft();
      await loadNomina();
      showView("nomina");
    };

    // --- Seleccionar todos ---
    function updateSelectAllBtn(){
      const btn = $("btnSelectAll");
      if(!btn) return;
      if(nomina.length > 0 && presentes.size === nomina.length){
        btn.textContent = "QUITAR TODOS";
      }else{
        btn.textContent = "SELECCIONAR TODOS";
      }
    }

    $("btnSelectAll").onclick = ()=>{
      if(nomina.length === 0) return;
      const selectAll = !(presentes.size === nomina.length);
      presentes = new Set(selectAll ? nomina.map(p=>p.id) : []);
      $("nominaBody").querySelectorAll('input[type="checkbox"][data-id]').forEach(chk=>{
        chk.checked = selectAll;
      });
      persistSession();
      updateSelectAllBtn();
    };

    async function loadNomina(){
      $("nominaBody").innerHTML = "";

      const q = query(
        collection(db, COL_SRH),
        where("areaTrabajo","==","AVANCE DESCABEZADO"),
        where("cuadrilla","==", currentCuadrilla),
        orderBy("apellidos","asc"),
        orderBy("nombres","asc")
      );

      let snap;
      try{
        snap = await getDocs(q);
      }catch(err){
        alert("Firestore pidió crear un ÍNDICE para esta consulta. En consola Firebase te saldrá un link 'Create index' y lo creas en 1 clic.");
        throw err;
      }

      nomina = [];
      snap.forEach(d=>{
        const x = d.data() || {};
        nomina.push({
          id: x.id || d.id,
          apellidos: x.apellidos || "",
          nombres: x.nombres || "",
          areaTrabajo: x.areaTrabajo || "",
          cuadrilla: x.cuadrilla || ""
        });
      });

      if(nomina.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4">No hay personal registrado para esta cuadrilla.</td>`;
        $("nominaBody").appendChild(tr);
        updateSelectAllBtn();
        return;
      }

      for(const p of nomina){
        const tr = document.createElement("tr");
        const checked = presentes.has(p.id) ? "checked" : "";
        tr.innerHTML = `
          <td>${esc(p.id)}</td>
          <td>${esc(p.apellidos)}</td>
          <td>${esc(p.nombres)}</td>
          <td style="text-align:center;">
            <input type="checkbox" data-id="${esc(p.id)}" ${checked} />
          </td>
        `;
        $("nominaBody").appendChild(tr);
      }

      $("nominaBody").querySelectorAll('input[type="checkbox"][data-id]').forEach(chk=>{
        chk.addEventListener("change", ()=>{
          const id = chk.getAttribute("data-id");
          if(chk.checked) presentes.add(id);
          else presentes.delete(id);
          persistSession();
          updateSelectAllBtn();
        });
      });

      updateSelectAllBtn();
      persistSession();
    }

    // --- Pasar a Libras ---
    $("btnPesar").onclick = async () => {
      if(!currentCuadrilla){ alert("Seleccione la cuadrilla primero."); return; }
      if(presentes.size === 0){
        alert("Seleccione al menos 1 persona como PRESENTE.");
        return;
      }

      if(!sessionId) sessionId = makeSessionId();
      await ensurePesadaDraft();

      renderLibras();
      showView("libras");
    };

    function isValidPositive(n){
      return (typeof n === "number" && Number.isFinite(n) && n > 0);
    }

    function renderLibras(){
      $("librasCuadrilla").textContent = currentCuadrilla;
      $("librasBody").innerHTML = "";

      const presentesArr = [...presentes]
        .map(id => nomina.find(x=>x.id===id))
        .filter(Boolean)
        .sort((a,b)=> (a.apellidos||"").localeCompare(b.apellidos||"","es") || (a.nombres||"").localeCompare(b.nombres||"","es"));

      for(const p of presentesArr){
        const val = librasMap.has(p.id) ? librasMap.get(p.id) : null;
        const showVal = (typeof val === "number" && !isNaN(val) && val !== null) ? fmt(val) : "";
        const locked = showVal ? "locked" : "";
        const isZeroOrEmpty = (!isValidPositive(Number(val))) ? "zero" : ""; // ✅ resalta 0 / vacío
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(p.apellidos)}</td>
          <td>${esc(p.nombres)}</td>
          <td style="text-align:right;">
            <span class="cellEdit ${locked} ${isZeroOrEmpty}" data-id="${esc(p.id)}" title="Click para ingresar. Doble click para corregir.">${esc(showVal)}</span>
          </td>
        `;
        $("librasBody").appendChild(tr);
      }

      $("librasBody").querySelectorAll(".cellEdit[data-id]").forEach(cell=>{
        const id = cell.getAttribute("data-id");
        cell.addEventListener("click", ()=> openLibrasModal(id));
        cell.addEventListener("dblclick", (e)=>{ e.preventDefault(); openLibrasModal(id); });
      });

      updateTotal();
      persistSession();
      updatePesadaUI();
    }

    // --- Modal de Libras ---
    let modalPersonId = "";
    let modalAccumNet = 0;
    let modalTouched = false;
    let modalExistingNet = null;
    let modalParts = [];

    function openModal(open){ $("modalBack").style.display = open ? "flex" : "none"; }
    $("modalCancel").onclick = () => openModal(false);

    function openLibrasModal(personId){
      modalPersonId = personId;

      const p = nomina.find(x=>x.id===personId);
      const current = librasMap.has(personId) ? librasMap.get(personId) : null;

      modalExistingNet = (typeof current === "number" && !isNaN(current)) ? current : null;
      modalAccumNet = 0;
      modalTouched = false;

      $("modalMeta").innerHTML = `
        <b>${esc(p?.apellidos || "")} ${esc(p?.nombres || "")}</b><br>
        ID: <b>${esc(personId)}</b>
        ${modalExistingNet !== null ? `<br>Actual en tabla: <b>${esc(fmt(modalExistingNet))}</b>` : ``}
      `;

      $("modalInput").value = "";

      if($("gav2")) $("gav2").checked = true;
      if($("gav1")) $("gav1").checked = false;

      if($("modalHistory")) $("modalHistory").textContent = "—";
      updateModalNet();
      openModal(true);
      setTimeout(()=>{ $("modalInput").focus(); }, 30);
    }

    function parseNumberEs(s){
      const raw = String(s||"").trim();
      if(!raw) return NaN;
      const norm = raw.replaceAll(".","").replaceAll(","," .").replace(" .",".").replaceAll(" ","");
      return Number(norm);
    }
    function fmt(n){
      try{
        return n.toLocaleString("es-EC", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }catch(_){
        return (Math.round(n*100)/100).toFixed(2).replace(".",",");
      }
    }

    function getSelectedGavetas(){
      const r1 = $("gav1");
      const r2 = $("gav2");
      if(r1 && r1.checked) return 1;
      if(r2 && r2.checked) return 2;
      return 2;
    }
    const GAVETA_PESO = 5;

    function computeNetLbs(gross){
      const g = getSelectedGavetas();
      return gross - (g * GAVETA_PESO);
    }

    function getCurrentSegmentNet(){
      const gross = parseNumberEs($("modalInput")?.value);
      if(isNaN(gross)) return null;
      return computeNetLbs(gross);
    }

    function renderModalHistory(segNet){
      const line = $("modalHistory");
      if(!line) return;

      const raw = String($("modalInput")?.value || "").trim();
      const hasTyped = raw.length > 0;

      const parts = modalParts.slice();
      if(hasTyped && typeof segNet === "number" && !isNaN(segNet)){
        parts.push(segNet);
      }

      if(parts.length === 0){
        line.textContent = "—";
        return;
      }

      const total = parts.reduce((a,b)=> a + (Number(b)||0), 0);
      const left = parts.map(x => fmt(Math.max(0, Number(x)||0))).join(" + ");
      line.textContent = `${left} = ${fmt(Math.max(0, total))}`;
    }

    function updateModalNet(){
      const netEl = $("modalNet");
      if(!netEl) return;

      const segNet = getCurrentSegmentNet();
      let total = modalAccumNet + (typeof segNet === "number" ? segNet : 0);

      if(total < 0) total = 0;
      netEl.textContent = fmt(total);

      renderModalHistory(segNet);
    }

    $("modalAdd").onclick = () => {
      const gross = parseNumberEs($("modalInput").value);

      if(isNaN(gross) || gross < 0){
        alert("Ingrese un valor válido de libras.");
        return;
      }

      const net = computeNetLbs(gross);

      if(net < 0){
        alert("El descuento por gavetas supera a las libras ingresadas.");
        return;
      }

      modalParts.push(net);
      modalAccumNet += net;
      modalTouched = true;

      $("modalInput").value = "";
      updateModalNet();
      $("modalInput").focus();
    };

    $("modalOk").onclick = async () => {
      if(!modalTouched){
        openModal(false);
        return;
      }

      const raw = String($("modalInput").value || "").trim();
      let addNet = 0;

      if(raw){
        const gross = parseNumberEs(raw);
        if(isNaN(gross) || gross < 0){
          alert("Ingrese un valor válido de libras.");
          return;
        }
        const net = computeNetLbs(gross);
        if(net < 0){
          alert("El descuento por gavetas supera a las libras ingresadas.");
          return;
        }
        addNet = net;
      }

      if(addNet > 0) modalParts.push(addNet);
      const totalFinal = modalAccumNet + addNet;
      librasMap.set(modalPersonId, totalFinal);

      modalParts = [];
      modalAccumNet = 0;
      modalTouched = false;
      $("modalInput").value = "";
      if($("modalHistory")) $("modalHistory").textContent = "—";

      openModal(false);
      renderLibras();
    };

    $("modalInput").addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        $("modalAdd").click();
      }
      if(e.key === "Escape") $("modalCancel").click();
    });

    $("modalInput").addEventListener("input", ()=>{
      modalTouched = true;
      updateModalNet();
    });
    if($("gav1")) $("gav1").addEventListener("change", ()=>{ modalTouched = true; updateModalNet(); });
    if($("gav2")) $("gav2").addEventListener("change", ()=>{ modalTouched = true; updateModalNet(); });

    function updateTotal(){
      let total = 0;
      for(const v of librasMap.values()){
        if(typeof v === "number" && !isNaN(v) && v > 0) total += v; // ✅ total solo >0
      }
      $("totalLibras").textContent = fmt(total);
    }

    function persistSession(){
      if(!currentUserEmail || !currentCuadrilla) return;
      const obj = {
        sessionId: sessionId || "",
        presentes: [...presentes],
        libras: Object.fromEntries([...librasMap.entries()].map(([k,v])=>[k, v])),
        updatedAt: new Date().toISOString()
      };
      try{ localStorage.setItem(sessionStorageKey(), JSON.stringify(obj)); }catch(_){}
    }

    function clearSession(){
      try{ localStorage.removeItem(sessionStorageKey()); }catch(_){}
    }

    // ==========================
    // ✅ Validación GUARDAR: zeros
    // ==========================
    function getZeroOrEmptyList(){
      const zeros = [];
      const valids = [];
      for(const id of presentes){
        const p = nomina.find(x=>x.id===id);
        if(!p) continue;
        const lbs = librasMap.has(id) ? Number(librasMap.get(id)) : NaN;
        if(!Number.isFinite(lbs) || lbs <= 0){
          zeros.push({ id, apellidos: p.apellidos||"", nombres: p.nombres||"", lbs });
        }else{
          valids.push(id);
        }
      }
      zeros.sort((a,b)=>
        (a.apellidos||"").localeCompare(b.apellidos||"","es") ||
        (a.nombres||"").localeCompare(b.nombres||"","es")
      );
      return { zeros, valids };
    }

    function openZeroModal(list){
      return new Promise((resolve)=>{
        const meta = $("zeroMeta");
        const box  = $("zeroList");
        const back = $("zeroBack");
        const bOk  = $("zeroAccept");
        const bRv  = $("zeroReview");

        const count = list.length;
        meta.innerHTML = `Se detectó <b>${count}</b> persona(s) con <b>LIBRAS vacías o en 0</b>.<br>¿Desea guardar la pesada omitiéndolas?`;

        box.innerHTML = list.map((x,i)=>`
          <div class="listItem">
            ${i+1}. <b>${esc(x.apellidos)}</b> ${esc(x.nombres)} &nbsp; <span style="color:#666">[ID: ${esc(x.id)}]</span>
          </div>
        `).join("");

        back.style.display = "flex";

        const cleanup = ()=>{
          back.style.display = "none";
          bOk.onclick = null;
          bRv.onclick = null;
        };
        bOk.onclick = ()=>{ cleanup(); resolve(true); };
        bRv.onclick = ()=>{ cleanup(); resolve(false); };
      });
    }

    function markZerosOnTable(zeroList){
      const ids = new Set(zeroList.map(z=>String(z.id)));
      const cells = $("librasBody")?.querySelectorAll?.(".cellEdit[data-id]") || [];
      cells.forEach(c=>{
        const id = String(c.getAttribute("data-id")||"");
        c.classList.toggle("zero", ids.has(id));
      });

      if(zeroList.length){
        const firstId = String(zeroList[0].id);
        const first = Array.from(cells).find(c=>String(c.getAttribute("data-id")||"")===firstId);
        if(first){
          first.scrollIntoView({behavior:"smooth", block:"center"});
          first.classList.add("pulse");
          setTimeout(()=>first.classList.remove("pulse"), 900);
        }
      }
    }

    // --- NUEVA PESADA ---

    async function resetForNextPesada(){
      presentes = new Set();
      librasMap = new Map();
      sessionId = "";
      clearSession();
      clearPendingSave();

      await ensurePesadaDraft();
      loadNomina().then(()=>showView("nomina"));
    }

    // GUARDAR
    $("btnNuevaPesada").onclick = async () => {
      if(!currentCuadrilla){
        alert("Seleccione la cuadrilla.");
        return;
      }

      // ✅ No guardar sin internet
      if(!(await ensureInternetOrWarn())) return;

      // ✅ mostrar próxima pesada según BD (o pendiente)
      await ensurePesadaDraft();

      try{
        if(presentes.size > 0){

          const { zeros, valids } = getZeroOrEmptyList();

          if(zeros.length > 0){
            const accept = await openZeroModal(zeros);
            if(!accept){
              markZerosOnTable(zeros);
              return;
            }
          }

          const entries = buildEntriesFromValidIds(valids);
          if(entries.length === 0){
            alert("No se guardó nada porque no hay registros con LIBRAS > 0.");
            return;
          }

          const displayed = Number(pesadaN||0);
          const draft = { pesadaN: displayed, label: pesadaLabel, key: pesadaKey };

          // ✅ guardar pendiente (por si cae internet durante transacción)
          setPendingSave({
            user: currentUserEmail,
            cuadrilla: currentCuadrilla,
            draft,
            entries,
            createdAt: new Date().toISOString(),
            status: "PENDING"
          });

          let res;
          try{
            res = await commitSaveWithRetry(entries, 3);
          }catch(err){
            console.error("TXN SAVE ERROR", err);
            alert(`❌ No se pudo completar el guardado.\nLa pesada queda PENDIENTE para reintentar cuando vuelva el internet.`);
            return;
          }

          clearPendingSave();

          if(Number.isFinite(res.assigned) && displayed && res.assigned !== displayed){
            alert(`ℹ️ El número de pesada fue cambiado a Pesada${res.assigned} (otro dispositivo guardó primero Pesada${displayed}).`);
          }

          feedbackOk();
          alert(`Pesada guardada: ${res.label}
(Se guardaron ${entries.length} registro(s) con libras > 0)`);

        } else {
          alert("No hay personal marcado como PRESENTE. Se iniciará una nueva pesada en blanco.");
        }
      }catch(err){
        alert("Error guardando la pesada. Revisa conexión/reglas de Firestore.");
        console.error("SAVE ERROR", err);
        return;
      }

      // ✅ reset para siguiente pesada (sin reservar número)
      presentes = new Set();
      librasMap = new Map();
      sessionId = "";
      clearSession();
      clearPendingSave();

      await ensurePesadaDraft();
      loadNomina().then(()=>showView("nomina"));
    };

    // =======================
    // ✅ REGISTRO + FILTRO
    // =======================
    function toggleClearBtnForAllMode(){
      const b = $("btnClearR");
      if(!b) return;
      b.style.display = currentCuadrilla ? "" : "none";
    }

    function initRegistroFilterUI(){
      if(!$("regFilterDate") || !$("regFilterMode")) return;
      const today = todayKey();
      $("regFilterDate").value = today;
      $("regFilterMode").value = "DIA";
      registroFilterMode = "DIA";
      registroFilterDate = today;
      updateRegFechaLabel();
    }
    function updateRegFechaLabel(){
      const rf = $("regFecha");
      if(!rf) return;
      if(registroFilterMode === "HISTORICO"){ rf.textContent = "HISTÓRICO"; return; }
      if(registroFilterMode === "ANIO"){ rf.textContent = (registroFilterDate||"").slice(0,4) || "—"; return; }
      if(registroFilterMode === "MES"){ rf.textContent = (registroFilterDate||"").slice(0,7) || "—"; return; }
      rf.textContent = registroFilterDate || "—";
    }
    function renderRegistroTable(){
      $("regBody").innerHTML = "";
      if(!registroRows || registroRows.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="8">No hay registros guardados.</td>`;
        $("regBody").appendChild(tr);
        return;
      }
      for(const r of registroRows){
        const tr = document.createElement("tr");
        const pesadaTxt = r.pesadaNumero ? `PESADA ${r.pesadaNumero}` : "";
        tr.innerHTML = `
          <td>${esc(pesadaTxt)}</td>
          <td>${esc(r.fecha || "")}</td>
          <td>${esc(r.hora || "")}</td>
          <td>${esc(r.usuario || "")}</td>
          <td>${esc(r.apellidos || "")}</td>
          <td>${esc(r.nombres || "")}</td>
          <td>${esc(r.cuadrilla || "")}</td>
          <td style="text-align:right;">${esc(fmt(r.libras || 0))}</td>
        `;
        $("regBody").appendChild(tr);
      }
    }
    function applyRegistroFilter(){
      // ✅ Bloqueo absoluto para usuarios "solo HOY"
      if(currentPolicy.mode === "REGISTRO_ONLY_TODAY"){
        registroFilterMode = "DIA";
        registroFilterDate = todayKey();
      }else{
        const modeEl = $("regFilterMode");
        const dateEl = $("regFilterDate");
        registroFilterMode = (modeEl && modeEl.value) ? modeEl.value : (registroFilterMode || "DIA");
        registroFilterDate = (dateEl && dateEl.value) ? dateEl.value : (registroFilterDate || todayKey());
      }

      let filtered = (registroAllRows || []).slice();
      if(registroFilterMode === "DIA"){
        filtered = filtered.filter(r => (r.fecha || "") === registroFilterDate);
      }else if(registroFilterMode === "MES"){
        const ym = (registroFilterDate || "").slice(0,7);
        filtered = filtered.filter(r => (r.fecha || "").startsWith(ym));
      }else if(registroFilterMode === "ANIO"){
        const y = (registroFilterDate || "").slice(0,4);
        filtered = filtered.filter(r => (r.fecha || "").startsWith(y));
      }else{
        // HISTORICO => sin filtrar
      }
      registroRows = filtered;
      updateRegFechaLabel();
      renderRegistroTable();
    }

    if($("btnAplicarFiltro")) $("btnAplicarFiltro").onclick = ()=> applyRegistroFilter();
    if($("btnVerHistorico")) $("btnVerHistorico").onclick = ()=>{
      if($("regFilterMode")) $("regFilterMode").value = "HISTORICO";
      registroFilterMode = "HISTORICO";
      applyRegistroFilter();
    };
    if($("regFilterMode")) $("regFilterMode").addEventListener("change", ()=> applyRegistroFilter());
    if($("regFilterDate")) $("regFilterDate").addEventListener("change", ()=> applyRegistroFilter());

    async function openRegistro(fromAsistencia = false){
      // ✅ Modo restringido: abre directo, sin filtros ni histórico
      if(currentPolicy.mode === "REGISTRO_ONLY_TODAY"){
        currentCuadrilla = currentPolicy.fixedCuadrilla;
        registroReturnView = "asistencia";
        toggleClearBtnForAllMode();
        applyRegistroPolicyUI();
        await loadRegistro();
        showView("registro");
        return;
      }

      const isAdmin = ADMIN_VIEW_ALL.has((currentUserEmail || "").toLowerCase());
      const selected = ($("selCuadrilla") ? ($("selCuadrilla").value || "") : "");

      if(!currentCuadrilla && selected) currentCuadrilla = selected;

      if(!currentCuadrilla){
        if(!(isAdmin && fromAsistencia)){
          alert("Seleccione la CUADRILLA.");
          return;
        }
        currentCuadrilla = ""; // TODAS
      }

      registroReturnView = currentViewName || "libras";

      toggleClearBtnForAllMode();
      initRegistroFilterUI();
      await loadRegistro();
      showView("registro");
    }

    if($("btnRegistro")) $("btnRegistro").onclick = (e)=>{ e?.preventDefault?.(); e?.stopPropagation?.(); openRegistro(false); };
    if($("btnRegistroA")) $("btnRegistroA").onclick = (e)=>{ e?.preventDefault?.(); e?.stopPropagation?.(); openRegistro(true); };
    if($("btnRegistroN")) $("btnRegistroN").onclick = (e)=>{ e?.preventDefault?.(); e?.stopPropagation?.(); openRegistro(false); };

    async function loadRegistro(){
      $("regBody").innerHTML = "";
      registroRows = [];
      registroAllRows = [];

      const isRestricted = (currentPolicy.mode === "REGISTRO_ONLY_TODAY");
      const today = todayKey();

      const isAdmin = ADMIN_VIEW_ALL.has((currentUserEmail || "").toLowerCase());

      let q;

      if(isRestricted){
        // ✅ SOLO HOY + SOLO SU CUADRILLA
        currentCuadrilla = currentPolicy.fixedCuadrilla;

        $("regCuadrilla").textContent = currentCuadrilla;
        $("regFecha").textContent = today;

        q = query(
          collection(db, COL_SDA),
          where("cuadrilla","==", currentCuadrilla),
          where("fecha","==", today)
        );
      }else{
        if(!currentCuadrilla && !isAdmin){
          alert("Seleccione la CUADRILLA.");
          return;
        }

        $("regCuadrilla").textContent = currentCuadrilla || "TODAS";
        $("regFecha").textContent = "HISTÓRICO";

        q = isAdmin
          ? (currentCuadrilla
              ? query(
                  collection(db, COL_SDA),
                  where("cuadrilla","==", currentCuadrilla),
                  where("usuario","in", SUPERVISORS)
                )
              : query(
                  collection(db, COL_SDA),
                  where("usuario","in", SUPERVISORS)
                ))
          : query(
              collection(db, COL_SDA),
              where("cuadrilla","==", currentCuadrilla),
              where("usuario","==", currentUserEmail)
            );
      }

      let snap;
      try{
        snap = await getDocs(q);
      }catch(err){
        alert("No se pudo consultar el REGISTRO. Revisa conexión, permisos o índices.");
        throw err;
      }

      snap.forEach(d=>{
        const x = d.data() || {};
        if(!x.numeroPesada) return;

        // ✅ Ocultar históricos con 0 o vacío (por si existían datos viejos)
        const lbs = (typeof x.libras === "number") ? x.libras : 0;
        if(!(Number.isFinite(lbs) && lbs > 0)) return;

        registroRows.push({
          pesadaNumero: typeof x.pesadaNumero === "number" ? x.pesadaNumero : 0,
          fecha: x.fecha || "",
          hora: x.hora || "",
          usuario: x.usuario || "",
          apellidos: x.apellidos || "",
          nombres: x.nombres || "",
          cuadrilla: x.cuadrilla || "",
          libras: lbs
        });
      });

      registroRows.sort((a,b)=>
        (a.pesadaNumero - b.pesadaNumero) ||
        (a.apellidos||"").localeCompare(b.apellidos||"","es") ||
        (a.nombres||"").localeCompare(b.nombres||"","es")
      );

      registroAllRows = registroRows.slice();

      if(isRestricted){
        registroFilterMode = "DIA";
        registroFilterDate = todayKey();
      }

      applyRegistroFilter();
      applyRegistroPolicyUI();
    }

    // Export Excel (registro)
    $("btnExcelR").onclick = () => {
      if(!registroRows || registroRows.length === 0){
        alert("No hay datos para exportar.");
        return;
      }
      if(!window.XLSX){
        alert("No se pudo cargar la librería de Excel (XLSX). Verifica conexión a internet.");
        return;
      }

      const headers = ["PESADA","FECHA","HORA","SUPERVISOR","APELLIDOS","NOMBRES","CUADRILLA","LIBRAS"];
      const data = [headers];
      for(const r of registroRows){
        data.push([`PESADA ${r.pesadaNumero || ''}`.trim(), r.fecha || "", r.hora || "", r.usuario || "", r.apellidos, r.nombres, r.cuadrilla, r.libras]);
      }

      const ws = XLSX.utils.aoa_to_sheet(data);
      ws["!cols"] = [{wch:12},{wch:12},{wch:8},{wch:22},{wch:28},{wch:22},{wch:16},{wch:10}];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Registro");

      const now = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      const stamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
      const fname = `SDA_RegistroPesadas_${currentCuadrilla}_${stamp}.xlsx`.replaceAll(" ","_");
      XLSX.writeFile(wb, fname);
    };

    // PDF (registro)
    $("btnPdfR").onclick = () => {
      const { jsPDF } = window.jspdf || {};
      if(!jsPDF){
        alert("No se pudo cargar la librería PDF.");
        return;
      }
      if(!registroRows || registroRows.length === 0){
        alert("No hay datos para generar PDF.");
        return;
      }

      const body = registroRows.map(r=>[
        (`PESADA ${r.pesadaNumero || ""}`).trim(),
        r.fecha || "",
        r.hora || "",
        (r.usuario || ""),
        r.apellidos,
        r.nombres,
        r.cuadrilla,
        fmt(r.libras)
      ]);

      const now = new Date();
      const dtLocal = nowLocalString();
      const fileStamp = now.toISOString().slice(0,19).replaceAll(":","-").replace("T","_");

      const titleLine = `SDA - Registro de Pesadas | ${currentUserEmail} | ${dtLocal}`;

      const docp = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
      docp.setFont("Times","Normal");
      docp.setFontSize(12);
      docp.text(titleLine, 40, 40);
      docp.setFontSize(11);
      docp.text(`Cuadrilla: ${currentCuadrilla}    Filtro: ${$("regFecha")?$("regFecha").textContent:"HISTÓRICO"}    Generado: ${dtLocal}`, 40, 60);

      docp.autoTable({
        startY: 80,
        head: [["PESADA","FECHA","HORA","SUPERVISOR","APELLIDOS","NOMBRES","CUADRILLA","LIBRAS"]],
        body,
        styles: { font: "Times", fontSize: 9 },
        headStyles: { fillColor: [13,47,79] },
        margin: { left: 40, right: 40 }
      });

      const fname = `SDA_RegistroPesadas_${currentCuadrilla}_${fileStamp}.pdf`.replaceAll(" ","_");
      docp.save(fname);
    };

    // ✅ LIMPIAR HISTÓRICO (registro)
    const CLEAR_ADMIN = "jeffersonfigueroa@oceantreasure.local";

    async function reauthForSensitiveAction(){
      const user = auth.currentUser;
      if(!user || !user.email) throw new Error("No hay sesión activa.");
      const pass = prompt("Para confirmar, ingrese su contraseña de Firebase:");
      if(!pass) throw new Error("Acción cancelada.");
      const cred = EmailAuthProvider.credential(user.email, pass);
      await reauthenticateWithCredential(user, cred);
      return true;
    }

    if($("btnClearR")){
      $("btnClearR").onclick = async () => {
        if(!currentCuadrilla){
          alert("Seleccione la CUADRILLA.");
          return;
        }

        if((currentUserEmail || "").toLowerCase() !== CLEAR_ADMIN){
          alert("Acceso denegado. Solo Jefferson puede LIMPIAR HISTÓRICO.");
          return;
        }

        const ok = confirm("⚠️ Esta acción borrará TODO el registro histórico de ESTA CUADRILLA (todos los usuarios). ¿Desea continuar?");
        if(!ok) return;

        try{
          await reauthForSensitiveAction();
        }catch(err){
          alert("No se pudo validar la contraseña. No se realizó la acción.");
          console.error("REAUTH ERROR:", err);
          return;
        }

        const q = query(
          collection(db, COL_SDA),
          where("cuadrilla","==", currentCuadrilla)
        );

        let snap;
        try{
          snap = await getDocs(q);
        }catch(err){
          alert("No se pudo consultar el REGISTRO para borrar. Revisa conexión o permisos.");
          return;
        }

        if(!snap || snap.empty){
          alert("No hay registros para borrar.");
          return;
        }

        let deleted = 0;
        try{
          let batch = writeBatch(db);
          let ops = 0;

          for(const d of snap.docs){
            batch.delete(doc(db, COL_SDA, d.id));
            deleted++;
            ops++;

            if(ops >= 450){
              await batch.commit();
              batch = writeBatch(db);
              ops = 0;
            }
          }
          if(ops > 0) await batch.commit();
        }catch(err){
          alert("No se pudo borrar el historial. Revisa reglas/permisos de Firestore.");
          console.error("DELETE ERROR:", err);
          return;
        }

        alert(`Histórico eliminado: ${deleted} registro(s).`);
        await loadRegistro();
      };
    }

    // --- PDF (pantalla libras) ---
    $("btnPdf").onclick = () => {
      const { jsPDF } = window.jspdf || {};
      if(!jsPDF){
        alert("No se pudo cargar la librería PDF.");
        return;
      }

      const rows = [];
      const presentesArr = [...presentes]
        .map(id => nomina.find(x=>x.id===id))
        .filter(Boolean)
        .sort((a,b)=> (a.apellidos||"").localeCompare(b.apellidos||"","es") || (a.nombres||"").localeCompare(b.nombres||"","es"));

      for(const p of presentesArr){
        const n = librasMap.has(p.id) ? librasMap.get(p.id) : null;
        rows.push([
          p.apellidos || "",
          p.nombres || "",
          (typeof n === "number" && !isNaN(n)) ? fmt(n) : ""
        ]);
      }

      let total = 0;
      for(const v of librasMap.values()){
        if(typeof v === "number" && !isNaN(v) && v > 0) total += v;
      }

      const now = new Date();
      const dtLocal = nowLocalString();
      const fileStamp = now.toISOString().slice(0,19).replaceAll(":","-").replace("T","_");

      const titleLine = `SDA - Avance Descabezado | ${currentUserEmail} | ${dtLocal}`;

      const docp = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
      docp.setFont("Times","Normal");
      docp.setFontSize(12);
      docp.text(titleLine, 40, 40);
      docp.setFontSize(11);
      docp.text(`Pesada: ${pesadaLabel}    Cuadrilla: ${currentCuadrilla}    Total Libras: ${fmt(total)}`, 40, 60);

      docp.autoTable({
        startY: 80,
        head: [["APELLIDOS","NOMBRES","LIBRAS"]],
        body: rows,
        styles: { font: "Times", fontSize: 9 },
        headStyles: { fillColor: [13,47,79] },
        margin: { left: 40, right: 40 }
      });

      const fname = `SDA_${pesadaKey}_${currentCuadrilla}_${userShort()}_${fileStamp}.pdf`.replaceAll(" ","_");
      docp.save(fname);
    };

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  </script>
</body>
</html>
