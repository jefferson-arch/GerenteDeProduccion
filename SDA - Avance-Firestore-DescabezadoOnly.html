<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SDA | Avance Descabezado</title>

  <style>
    :root{
      --blue:#1e88e5;
      --navy:#0d2f4f;
      --green:#2e7d32;
      --graybtn:#d9d9d9;
      --lightblue:#cfefff;
      --border:#dcdcdc;
      --softgreen:#dff1d8;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#000}
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .wrap{max-width:980px;margin:0 auto;padding:10px 12px 24px}
    .topline{text-align:left;font-size:14px;padding:6px 0 8px;border-bottom:1px solid #ddd}
    .topline .email{color:var(--blue);text-decoration:underline}
    .navrow{display:flex;justify-content:space-between;align-items:flex-start;font-size:14px;padding:10px 0;min-height:26px}
    .navrow .left a{display:block;color:var(--green);text-decoration:none;margin:0 0 4px;cursor:pointer}
    .navrow .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .navrow .right .miniBtn{
      border:1px dotted #666;background:#fff;padding:4px 8px;font-weight:700;cursor:pointer
    }
    .center{text-align:center}
    .title{margin:14px 0 10px;font-size:18px;color:var(--blue);letter-spacing:.5px}
    .logo{width:86px;height:86px;margin:8px auto 6px;display:block;object-fit:contain}
    .brand{font-weight:700;letter-spacing:.5px;margin:0;font-size:14px}
    .tagline{margin:0 0 8px;font-size:10px;letter-spacing:1px}
    .form{margin:14px auto 0;width:100%;max-width:430px}
    .row{display:grid;grid-template-columns:130px 1fr;gap:10px;align-items:center;margin:10px 0}
    .row label{font-size:16px}
    input[type="text"],input[type="password"],select{
      width:100%;padding:8px 10px;border:1px solid #ccc;background:#eee;outline:none;font-size:15px;min-height:38px
    }
    select{background:#fff}
    .btn{
      display:block;width:240px;margin:10px auto;padding:8px 10px;border:1px solid #555;background:var(--graybtn);
      color:#000;font-weight:700;text-align:center;cursor:pointer;user-select:none
    }
    .btn.blue{background:var(--lightblue);border-color:#2a2a2a;color:#0b5aa5}
    .btn.green{background:var(--softgreen);border-color:#2a2a2a;color:#1a5e1a}
    .btn.black{background:#000;color:#fff;border-color:#000}
    .btn:active{transform:scale(.99)}
    .linkCenter{text-align:center;margin-top:16px;color:var(--blue);text-decoration:underline;cursor:pointer;font-size:14px}

    .view{display:none}
    .view.active{display:block}

    /* Tabla */
    .tableWrap{width:100%;overflow:auto;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;font-size:13px;min-width:820px}
    thead th{background:var(--navy);color:#fff;padding:6px 8px;text-align:left;white-space:nowrap;vertical-align:bottom}
    tbody td{border-bottom:1px solid #eee;padding:6px 8px;vertical-align:middle;white-space:nowrap}
    tbody tr:hover{background:#fafafa}
    .cellEdit{
      border:1px dotted #666; padding:2px 6px; min-width:90px; display:inline-block; text-align:right;
      background:#fff; cursor:pointer;
    }
    .cellEdit.locked{background:#f4f4f4}
    .totalBox{
      font-weight:700; font-size:16px; padding:4px 8px; border:1px dotted #666; background:#fff;
      min-width:90px; text-align:right;
    }
    .thBtn{
      display:inline-block;
      margin-top:4px;
      font-size:11px;
      padding:3px 6px;
      border:1px dotted rgba(255,255,255,.9);
      background:rgba(255,255,255,.08);
      color:#fff;
      cursor:pointer;
      font-weight:700;
    }

        .cellLink{color:var(--blue);text-decoration:underline;cursor:pointer}
/* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:14px;z-index:999}
    .modal{width:min(420px,100%);background:#fff;border:1px solid #999;padding:14px}
    .modal h3{margin:0 0 6px;font-size:16px;text-align:center}
    .modal .meta{font-size:13px;margin:0 0 10px}
    .modal .meta b{font-weight:700}
    .modal input{
      width:100%;padding:10px;border:1px solid #ccc;font-size:16px
    }
    .modal .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px}
    .modal .actions .btn{margin:0;width:160px}

    /* Mobile tweaks */
    @media (max-width:520px){
      .row{grid-template-columns:110px 1fr}
      .btn{width:100%}
      .wrap{padding:10px 10px 20px}
      .navrow{padding:8px 0}
      .navrow .right{gap:6px}
      table{min-width:740px}
    }
  </style>
</head>

<body class="safe">
  <div class="wrap">

    <!-- LOGIN -->
    <section id="vLogin" class="view active">
      <div class="center">
        <div class="title">INICIAR SESIÓN</div>
        <img class="logo" src="logo.png" alt="Oceantreasure Logo" onerror="this.style.display='none'">
        <p class="brand">OCEANTREASURE S.A.</p>
        <p class="tagline">100% ECUADORIAN QUALITY</p>
      </div>

      <div class="form">
        <div class="row">
          <label>Usuario:</label>
          <input id="loginEmail" type="text" autocomplete="username" />
        </div>
        <div class="row">
          <label>Contraseña:</label>
          <input id="loginPass" type="password" autocomplete="current-password" />
        </div>

        <div class="btn" id="btnLogin">ACCEDER</div>
        <div class="center" id="loginMsg" style="color:#b00020;font-size:13px;min-height:18px;"></div>
      </div>
    </section>

    <!-- HEADER (solo logeado) -->
    <div id="authHeader" style="display:none;">
      <div class="topline">Usuario: <span class="email" id="userEmail"></span></div>
    </div>

    <!-- ASISTENCIA AVANCE -->
    <section id="vAsistencia" class="view">
      <div class="navrow">
        <div class="left"></div>
        <div class="right">
          <div class="miniBtn" id="btnRegistroA">REGISTRO DE PESADAS</div>
        </div>
      </div>

      <div class="center">
        <img class="logo" src="logo.png" alt="Oceantreasure Logo" onerror="this.style.display='none'">
        <p class="brand">OCEANTREASURE S.A.</p>
        <p class="tagline">100% ECUADORIAN QUALITY</p>
      </div>

      <div class="form">
        <div class="row" style="grid-template-columns:90px 1fr;">
          <label>Cuadrilla</label>
          <select id="selCuadrilla">
            <option value=""></option>
            <option>OCEANTREASURE</option>
            <option>MAREPREX</option>
            <option>FELESMAR</option>
          </select>
        </div>

        <div class="btn blue" id="btnTomarAsistencia">TOMAR ASISTENCIA</div>
        <div class="linkCenter" id="linkLogoutA">Cerrar sesión</div>
      </div>
    </section>

    <!-- NOMINA PRESENTE -->
    <section id="vNomina" class="view">
      <div class="navrow">
        <div class="left">
          <a id="lnkBackAsistencia">Volver</a>
          <a id="lnkLogoutN">Cerrar sesión</a>
        </div>
        <div class="right">
          <div class="miniBtn" id="btnRegistroN">REGISTRO DE PESADAS</div>
          <div class="miniBtn" id="btnPesar">PESAR CABEZAS</div>
        </div>
      </div>

      <div class="center">
        <img class="logo" src="logo.png" alt="Oceantreasure Logo" onerror="this.style.display='none'">
        <p class="brand">OCEANTREASURE S.A.</p>
        <p class="tagline">100% ECUADORIAN QUALITY</p>
      </div>

      <div class="center" style="font-size:13px;margin:6px 0 4px;">
        Cuadrilla seleccionada: <b id="nominaCuadrilla"></b>
      </div>
      <div class="center" style="font-size:13px;margin:0 0 10px;">
        Pesada actual: <b id="nominaPesadaLabel">—</b>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:140px;">ID</th>
              <th>APELLIDOS</th>
              <th>NOMBRES</th>
              <th>AREA</th>
              <th>CUADRILLA</th>
              <th style="width:135px;">PRESENTE<br><span class="thBtn" id="btnSelectAll">SELECCIONAR TODOS</span></th>
            </tr>
          </thead>
          <tbody id="nominaBody"></tbody>
        </table>
      </div>
    </section>

    <!-- LIBRAS CABEZAS PERSONAL -->
    <section id="vLibras" class="view">
      <div class="navrow">
        <div class="left">
          <a id="lnkBackNomina">Volver</a>
          <a id="lnkLogoutL">Cerrar sesión</a>
        </div>
        <div class="right">
          <div class="miniBtn" id="btnRegistro">REGISTRO DE PESADAS</div>
          <div class="miniBtn" id="btnNuevaPesada">GUARDAR</div>
          <div class="miniBtn" id="btnPdf">GENERAR PDF</div>
        </div>
      </div>

      <div class="center">
        <img class="logo" src="logo.png" alt="Oceantreasure Logo" onerror="this.style.display='none'">
        <p class="brand">OCEANTREASURE S.A.</p>
        <p class="tagline">100% ECUADORIAN QUALITY</p>
      </div>

      <div style="font-size:13px;margin:6px 0 2px;">
        Pesada: <b id="pesadaLabel">—</b>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0 10px;">
        <div style="font-size:13px;">
          Cuadrilla: <b id="librasCuadrilla"></b>
        </div>
        <div class="totalBox" id="totalLibras">0,00</div>
      </div>

      <div class="tableWrap">
        <table id="tblLibras">
          <thead>
            <tr>
              <th style="width:140px;">ID</th>
              <th>APELLIDOS</th>
              <th>NOMBRES</th>
              <th>AREA</th>
              <th>CUADRILLA</th>
              <th style="width:110px;">LIBRAS</th>
            </tr>
          </thead>
          <tbody id="librasBody"></tbody>
        </table>
      </div>
    </section>

    <!-- REGISTRO DE PESADAS -->
        <!-- REGISTRO DE PESADAS -->
    <section id="vRegistro" class="view">
      <div class="navrow">
        <div class="left">
          <a id="lnkBackRegistro">Volver</a>
          <a id="lnkLogoutR">Cerrar sesión</a>
        </div>
        <div class="right">
          <div class="miniBtn" id="btnExcelR">DESCARGAR EXCEL</div>
          <div class="miniBtn" id="btnPdfR">GENERAR PDF</div>
          <div class="miniBtn" id="btnPesarR">PESAR CABEZAS</div>
        </div>
      </div>

      <div class="center">
        <img class="logo" src="logo.png" alt="Oceantreasure Logo" onerror="this.style.display='none'">
        <p class="brand">OCEANTREASURE S.A.</p>
        <p class="tagline">100% ECUADORIAN QUALITY</p>
      </div>

      <div class="center" style="font-size:13px;margin:6px 0 6px;">
        <span id="regContext"></span>
      </div>
      <div class="center" style="font-size:12px;margin:0 0 10px;opacity:.85;">
        <span id="regHint"></span>
      </div>

      <div class="tableWrap">
        <table id="tblRegistro">
          <thead id="regHead"></thead>
          <tbody id="regBody"></tbody>
        </table>
      </div>
    </section>

  </div>

  <!-- MODAL LIBRAS -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h3>CARGAR LIBRAS</h3>
      <p class="meta" id="modalMeta"></p>
      <input id="modalInput" type="text" inputmode="decimal" placeholder="0,00" />
      <div class="actions">
        <div class="btn blue" id="modalOk">ACEPTAR</div>
        <div class="btn" id="modalCancel">CANCELAR</div>
      </div>
    </div>
  </div>

  <!-- libs PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <!-- libs Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, doc, setDoc }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ Mismo Firebase Project (Oceantreasure)
    const firebaseConfig = {
      apiKey: "AIzaSyCMoLkSnnLowMagRNL7O6ttPo1FXd1URac",
      authDomain: "oceantreasure-app.firebaseapp.com",
      projectId: "oceantreasure-app",
      storageBucket: "oceantreasure-app.firebasestorage.app",
      messagingSenderId: "553014659258",
      appId: "1:553014659258:web:cfc30844a88433b7b79a83",
      measurementId: "G-HMMQKJY8NJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // SRH colección (Talento Humano)
    const COL_SRH = "rrhh_talento";
    // SDA colección (registros de pesadas)
    const COL_SDA = "sda_avance_cabezas";

    const ALLOWED = new Set([
      "aracellytomala@oceantreasure.local",
      "keniacruz@oceantreasure.local"
    ]);

    const $ = (id) => document.getElementById(id);

    const views = {
      login: $("vLogin"),
      asistencia: $("vAsistencia"),
      nomina: $("vNomina"),
      libras: $("vLibras"),
      registro: $("vRegistro")
    };

    let currentViewName = "login";

    function showView(name){
      Object.values(views).forEach(v => v.classList.remove("active"));
      views[name].classList.add("active");
      currentViewName = name;
    }
    function setHeaderVisible(v){ $("authHeader").style.display = v ? "block" : "none"; }
    function setUserEmail(email){ $("userEmail").textContent = email || ""; }
    async function doLogout(){ await signOut(auth); }

    // --- Estado ---
    let currentUserEmail = "";
    let currentCuadrilla = "";
    let registroReturnView = "libras";
    let nomina = [];           // [{id, apellidos, nombres, areaTrabajo, cuadrilla}]
    let presentes = new Set(); // ids presentes
    let sessionId = "";        // id de sesión para SDA (solo UI)
    let librasMap = new Map(); // id -> number

    // pesada
    let pesadaN = 0;
    let pesadaLabel = "—";     // texto visible
    let pesadaKey = "";        // clave safe

    // registro cache
    let registroRows = [];

    function todayKey(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function todayHuman(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    }
    function timeHM(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${hh}:${mi}`;
    }
    function timeHMS(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${hh}:${mi}:${ss}`;
    }

    function makeSessionId(){
      const d = new Date();
      const stamp = d.toISOString().replaceAll(":","").replaceAll(".","").replaceAll("-","").replace("T","_").slice(0,15);
      return `SDA_${todayKey()}_${currentCuadrilla}_${stamp}`;
    }

    function sessionStorageKey(){
      return `SDA_SESSION_${todayKey()}_${currentCuadrilla}_${currentUserEmail}`;
    }
    function pesadaCounterKey(){
      return `SDA_PESADA_COUNTER_${todayKey()}_${currentCuadrilla}_${currentUserEmail}`;
    }
    function pesadaCurrentKey(){
      return `SDA_PESADA_CURRENT_${todayKey()}_${currentCuadrilla}_${currentUserEmail}`;
    }

    function userShort(){
      const u = (currentUserEmail || "").split("@")[0] || "";
      return u.replaceAll(".","").replaceAll(" ","");
    }

    function nextPesada(){
  const keyCount = pesadaCounterKey();
  let n = 0;
  try{
    const obj = JSON.parse(localStorage.getItem(keyCount) || "{}");
    n = Number(obj.pesadaN || 0);
  }catch(_){}
  if(isNaN(n) || n < 0) n = 0;
  n = n + 1;

  // ✅ NUMERO DE PESADA: solo (Numero)+(Usuario)
  const label = `Pesada${n}_${userShort()}`;

  // ✅ Key interno único (no se muestra en tabla)
  const key = `K_${todayKey()}_${(currentCuadrilla||"TODAS")}_${userShort()}_${Date.now()}`;

  const rec = { pesadaN: n, label, key, createdAt: new Date().toISOString() };

  try{ localStorage.setItem(keyCount, JSON.stringify({ pesadaN: n, updatedAt: rec.createdAt })); }catch(_){}
  try{ localStorage.setItem(pesadaCurrentKey(), JSON.stringify(rec)); }catch(_){}

  return rec;
}

    function ensurePesada(){
      const raw = localStorage.getItem(pesadaCurrentKey());
      if(raw){
        try{
          const obj = JSON.parse(raw);
          if(obj && obj.label && obj.key && obj.pesadaN){
            pesadaN = Number(obj.pesadaN);
            pesadaLabel = obj.label;
            pesadaKey = obj.key;
            updatePesadaUI();
            return;
          }
        }catch(_){}
      }
      const p = nextPesada();
      pesadaN = p.n; pesadaLabel = p.label; pesadaKey = p.key;
      updatePesadaUI();
    }

    function updatePesadaUI(){
      $("pesadaLabel").textContent = pesadaLabel || "—";
      $("nominaPesadaLabel").textContent = pesadaLabel || "—";
    }

    // --- Login ---
    $("btnLogin").onclick = async () => {
      $("loginMsg").textContent = "";
      const email = $("loginEmail").value.trim();
      const pass  = $("loginPass").value;
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(e){
        $("loginMsg").textContent = "Error: usuario o contraseña incorrectos.";
      }
    };
    ["loginEmail","loginPass"].forEach(id=>{
      $(id).addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnLogin").click(); });
    });

    // Logout links
    $("linkLogoutA").onclick = doLogout;
    $("lnkLogoutN").onclick = doLogout;
    $("lnkLogoutL").onclick = doLogout;
    $("lnkLogoutR").onclick = doLogout;

    // Back links
    $("lnkBackAsistencia").onclick = () => showView("asistencia");
    $("lnkBackNomina").onclick = () => showView("nomina");
    $("lnkBackRegistro").onclick = () => showView(registroReturnView || "libras");

    // Auth state
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUserEmail = user.email || "";
        setHeaderVisible(true);
        setUserEmail(currentUserEmail);

        if(!ALLOWED.has(currentUserEmail)){
          alert("Acceso no autorizado.");
          await doLogout();
          return;
        }

        resetAll();
        showView("asistencia");
      } else {
        currentUserEmail = "";
        setHeaderVisible(false);
        setUserEmail("");
        resetAll();
        showView("login");
      }
    });

    function resetAll(){
      currentCuadrilla = "";
      nomina = [];
      presentes = new Set();
      sessionId = "";
      librasMap = new Map();
      pesadaN = 0;
      pesadaLabel = "—";
      pesadaKey = "";
      registroRows = [];

      $("selCuadrilla").value = "";
      $("nominaBody").innerHTML = "";
      $("librasBody").innerHTML = "";
      $("regBody").innerHTML = "";
      $("nominaCuadrilla").textContent = "";
      $("librasCuadrilla").textContent = "";
      $("regCuadrilla").textContent = "—";
      $("regFecha").textContent = "—";
      $("totalLibras").textContent = "0,00";
      updatePesadaUI();
      updateSelectAllBtn();
    }

    // --- Tomar Asistencia ---
    $("btnTomarAsistencia").onclick = async () => {
      const c = $("selCuadrilla").value || "";
      if(!c){ alert("Seleccione la CUADRILLA."); return; }
      currentCuadrilla = c;
      $("nominaCuadrilla").textContent = c;
      $("librasCuadrilla").textContent = c;

      // Recuperar sesión guardada (por refresco)
      const saved = localStorage.getItem(sessionStorageKey());
      if(saved){
        try{
          const obj = JSON.parse(saved);
          sessionId = obj.sessionId || "";
          presentes = new Set(obj.presentes || []);
          librasMap = new Map(Object.entries(obj.libras || {}).map(([k,v])=>[k, Number(v)]));
        }catch(_){}
      }

      ensurePesada();
      await loadNomina();
      showView("nomina");
    };

    // --- Seleccionar todos ---
    function updateSelectAllBtn(){
      const btn = $("btnSelectAll");
      if(!btn) return;
      if(nomina.length > 0 && presentes.size === nomina.length){
        btn.textContent = "QUITAR TODOS";
      }else{
        btn.textContent = "SELECCIONAR TODOS";
      }
    }

    $("btnSelectAll").onclick = ()=>{
      if(nomina.length === 0) return;
      const selectAll = !(presentes.size === nomina.length);
      presentes = new Set(selectAll ? nomina.map(p=>p.id) : []);
      $("nominaBody").querySelectorAll('input[type="checkbox"][data-id]').forEach(chk=>{
        chk.checked = selectAll;
      });
      persistSession();
      updateSelectAllBtn();
    };

    async function loadNomina(){
      $("nominaBody").innerHTML = "";

      // Consulta SRH: areaTrabajo = AVANCE DESCABEZADO y cuadrilla
      const q = query(
        collection(db, COL_SRH),
        where("areaTrabajo","==","AVANCE DESCABEZADO"),
        where("cuadrilla","==", currentCuadrilla),
        orderBy("apellidos","asc"),
        orderBy("nombres","asc")
      );

      let snap;
      try{
        snap = await getDocs(q);
      }catch(err){
        alert("Firestore pidió crear un ÍNDICE para esta consulta. En consola Firebase te saldrá un link 'Create index' y lo creas en 1 clic.");
        throw err;
      }

      nomina = [];
      snap.forEach(d=>{
        const x = d.data() || {};
        nomina.push({
          id: x.id || d.id,
          apellidos: x.apellidos || "",
          nombres: x.nombres || "",
          areaTrabajo: x.areaTrabajo || "",
          cuadrilla: x.cuadrilla || ""
        });
      });

      if(nomina.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6">No hay personal registrado para esta cuadrilla.</td>`;
        $("nominaBody").appendChild(tr);
        updateSelectAllBtn();
        return;
      }

      for(const p of nomina){
        const tr = document.createElement("tr");
        const checked = presentes.has(p.id) ? "checked" : "";
        tr.innerHTML = `
          <td>${esc(p.id)}</td>
          <td>${esc(p.apellidos)}</td>
          <td>${esc(p.nombres)}</td>
          <td>${esc(p.areaTrabajo)}</td>
          <td>${esc(p.cuadrilla)}</td>
          <td style="text-align:center;">
            <input type="checkbox" data-id="${esc(p.id)}" ${checked} />
          </td>
        `;
        $("nominaBody").appendChild(tr);
      }

      // handlers
      $("nominaBody").querySelectorAll('input[type="checkbox"][data-id]').forEach(chk=>{
        chk.addEventListener("change", ()=>{
          const id = chk.getAttribute("data-id");
          if(chk.checked) presentes.add(id);
          else presentes.delete(id);
          persistSession();
          updateSelectAllBtn();
        });
      });

      updateSelectAllBtn();
      persistSession();
    }

    // --- Pasar a Libras ---
    $("btnPesar").onclick = async () => {
      if(!currentCuadrilla){ alert("Seleccione la cuadrilla primero."); return; }
      if(presentes.size === 0){
        alert("Seleccione al menos 1 persona como PRESENTE.");
        return;
      }

      if(!sessionId) sessionId = makeSessionId();
      ensurePesada();

      renderLibras();
      showView("libras");
    };

    function renderLibras(){
      $("librasCuadrilla").textContent = currentCuadrilla;
      $("librasBody").innerHTML = "";

      const presentesArr = [...presentes]
        .map(id => nomina.find(x=>x.id===id))
        .filter(Boolean)
        .sort((a,b)=> (a.apellidos||"").localeCompare(b.apellidos||"","es") || (a.nombres||"").localeCompare(b.nombres||"","es"));

      for(const p of presentesArr){
        const val = librasMap.has(p.id) ? librasMap.get(p.id) : null;
        const showVal = (typeof val === "number" && !isNaN(val)) ? fmt(val) : "";
        const locked = showVal ? "locked" : "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(p.id)}</td>
          <td>${esc(p.apellidos)}</td>
          <td>${esc(p.nombres)}</td>
          <td>${esc(p.areaTrabajo)}</td>
          <td>${esc(p.cuadrilla)}</td>
          <td style="text-align:right;">
            <span class="cellEdit ${locked}" data-id="${esc(p.id)}" title="Click para ingresar. Doble click para corregir.">${esc(showVal)}</span>
          </td>
        `;
        $("librasBody").appendChild(tr);
      }

      $("librasBody").querySelectorAll(".cellEdit[data-id]").forEach(cell=>{
        const id = cell.getAttribute("data-id");
        cell.addEventListener("click", ()=> openLibrasModal(id));
        cell.addEventListener("dblclick", (e)=>{ e.preventDefault(); openLibrasModal(id); });
      });

      updateTotal();
      persistSession();
      updatePesadaUI();
    }

    // --- Modal de Libras ---
    let modalPersonId = "";
    function openModal(open){ $("modalBack").style.display = open ? "flex" : "none"; }
    $("modalCancel").onclick = () => openModal(false);

    function openLibrasModal(personId){
      modalPersonId = personId;
      const p = nomina.find(x=>x.id===personId);
      const current = librasMap.has(personId) ? librasMap.get(personId) : null;

      $("modalMeta").innerHTML = `
        <b>${esc(p?.apellidos || "")} ${esc(p?.nombres || "")}</b><br>
        ID: <b>${esc(personId)}</b>
      `;

      $("modalInput").value = (typeof current === "number" && !isNaN(current)) ? fmt(current) : "";
      openModal(true);
      setTimeout(()=>{ $("modalInput").focus(); }, 30);
    }

    function parseNumberEs(s){
      const raw = String(s||"").trim();
      if(!raw) return NaN;
      const norm = raw.replaceAll(".","").replaceAll(",",".");
      return Number(norm);
    }
    function fmt(n){
      try{
        return n.toLocaleString("es-EC", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }catch(_){
        return (Math.round(n*100)/100).toFixed(2).replace(".",",");
      }
    }

    $("modalOk").onclick = async () => {
      const n = parseNumberEs($("modalInput").value);
      if(isNaN(n) || n < 0){
        alert("Ingrese un valor válido de libras.");
        return;
      }
      librasMap.set(modalPersonId, n);
      openModal(false);
      renderLibras();
    };

    $("modalInput").addEventListener("keydown", (e)=>{
      if(e.key === "Enter") $("modalOk").click();
      if(e.key === "Escape") $("modalCancel").click();
    });

    function updateTotal(){
      let total = 0;
      for(const v of librasMap.values()){
        if(typeof v === "number" && !isNaN(v)) total += v;
      }
      $("totalLibras").textContent = fmt(total);
    }

    function persistSession(){
      if(!currentUserEmail || !currentCuadrilla) return;
      const obj = {
        sessionId: sessionId || "",
        presentes: [...presentes],
        libras: Object.fromEntries([...librasMap.entries()].map(([k,v])=>[k, v])),
        updatedAt: new Date().toISOString()
      };
      try{ localStorage.setItem(sessionStorageKey(), JSON.stringify(obj)); }catch(_){}
    }

    function clearSession(){
      try{ localStorage.removeItem(sessionStorageKey()); }catch(_){}
    }
    // --- NUEVA PESADA ---
    async function savePesadaToFirestore(){
      const fecha = todayKey();
      const hora = timeHMS();
      const nowIso = new Date().toISOString();

      for(const id of presentes){
        const p = nomina.find(x=>x.id===id);
        if(!p) continue;

        const lbs = librasMap.has(id) ? librasMap.get(id) : 0;
        const payload = {
          pesadaNumero: pesadaN,
          numeroPesada: pesadaLabel,      // lo que se muestra
          pesadaKey: pesadaKey,           // safe
          fecha,
          hora,
          cuadrilla: currentCuadrilla,
          usuario: currentUserEmail,

          personId: id,
          apellidos: p.apellidos || "",
          nombres: p.nombres || "",
          area: p.areaTrabajo || "",
          libras: (typeof lbs === "number" && !isNaN(lbs)) ? lbs : 0,

          updatedAt: nowIso
        };

        const docId = `${pesadaKey}_${id}`;
        await setDoc(doc(db, COL_SDA, docId), payload, { merge:true });
      }
    }

    function resetForNextPesada(){
      // limpiar TODOS: marcados y libras
      presentes = new Set();
      librasMap = new Map();
      sessionId = "";
      clearSession();

      // nueva pesada
      const p = nextPesada();
      pesadaN = p.n;
      pesadaLabel = p.label;
      pesadaKey = p.key;
      updatePesadaUI();

      // volver a nómina para marcar de nuevo
      loadNomina().then(()=>showView("nomina"));
    }

    // Reemplazar handler NUEVA PESADA con el correcto (evita errores)
    $("btnNuevaPesada").onclick = async () => {
      if(!currentCuadrilla){
        alert("Seleccione la cuadrilla.");
        return;
      }
      ensurePesada();

      // guarda valores actuales (si hay presentes)
      try{
        if(presentes.size > 0){
          await savePesadaToFirestore();
          alert(`Pesada guardada: ${pesadaLabel}`);
        } else {
          alert("No hay personal marcado como PRESENTE. Se iniciará una nueva pesada en blanco.");
        }
      }catch(err){
        alert("Error guardando la pesada. Revisa conexión/reglas de Firestore.");
        return;
      }

      // limpiar y crear nueva pesada
      resetForNextPesada();
    };

    // --- REGISTRO DE PESADAS ---
let registroMode = "summary";     // summary | date | pesada
let registroFecha = "";
let registroPesada = "";
registroReturnView = "asistencia";
let registroRaw = [];             // docs mapeados
let registroHeaders = [];

function dmyFromKey(yyyy_mm_dd){
  const s = String(yyyy_mm_dd||"").trim();
  if(!s) return "";
  const parts = s.split("-");
  if(parts.length !== 3) return s;
  return `${parts[2]}-${parts[1]}-${parts[0]}`;
}

function parsePesadaNumber(label){
  const m = String(label||"").match(/Pesada\s*(\d+)/i);
  return m ? Number(m[1]) : 0;
}


function normalizeNumeroPesada(v){
  const s = String(v||"").trim();
  if(!s) return "";
  // Si viene con fecha/hora al final: PesadaN_user_dd-mm-yyyy_hh:mm -> PesadaN_user
  const m = s.match(/^(Pesada\s*\d+_[^_]+)(?:_\d{2}-\d{2}-\d{4}.*)?$/i);
  if(m) return m[1].replace(/\s+/g,"");
  return s.replace(/\s+/g,"");
}

function setRegistroContext(){
  const c = currentCuadrilla ? currentCuadrilla : "TODAS";
  if(registroMode === "summary"){
    $("regContext").textContent = `Cuadrilla: ${c}   |   Rango: HISTÓRICO`;
    $("regHint").textContent = "Click en la FECHA para ver todas las pesadas de ese día. Click en el NÚMERO DE PESADA para ver solo esa pesada.";
  } else if(registroMode === "date"){
    $("regContext").textContent = `Cuadrilla: ${c}   |   Fecha: ${dmyFromKey(registroFecha)}`;
    $("regHint").textContent = "Mostrando todas las pesadas de ese día. (Volver regresa al histórico.)";
  } else {
    $("regContext").textContent = `Cuadrilla: ${c}   |   Fecha: ${dmyFromKey(registroFecha)}   |   Pesada: ${registroPesada}`;
    $("regHint").textContent = "Mostrando solo esa pesada. (Volver regresa al histórico.)";
  }
}

function renderRegistroTable(){
  // head
  const head = $("regHead");
  head.innerHTML = "";
  const trh = document.createElement("tr");
  for(const h of registroHeaders){
    const th = document.createElement("th");
    th.textContent = h;
    trh.appendChild(th);
  }
  head.appendChild(trh);

  // body
  const body = $("regBody");
  body.innerHTML = "";

  if(registroRows.length === 0){
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = registroHeaders.length || 1;
    td.textContent = "No hay registros para mostrar.";
    tr.appendChild(td);
    body.appendChild(tr);
    return;
  }

  if(registroMode === "summary"){
    // rows = [[fechaKey, fechaDMY, numeroPesada]]
    for(const r of registroRows){
      const tr = document.createElement("tr");

      const tdF = document.createElement("td");
      tdF.innerHTML = `<span class="cellLink" data-fecha="${esc(r[0])}">${esc(r[1])}</span>`;
      tr.appendChild(tdF);

      const tdP = document.createElement("td");
      tdP.innerHTML = `<span class="cellLink" data-fecha="${esc(r[0])}" data-pesada="${esc(r[2])}">${esc(r[2])}</span>`;
      tr.appendChild(tdP);

      body.appendChild(tr);
    }
  } else {
    // detail rows are plain strings already
    for(const r of registroRows){
      const tr = document.createElement("tr");
      for(const cell of r){
        const td = document.createElement("td");
        td.textContent = cell;
        tr.appendChild(td);
      }
      body.appendChild(tr);
    }
  }
}

async function loadRegistroRaw(){
  registroRaw = [];

  // Permitir abrir registro desde "Tomar asistencia" (sin cuadrilla seleccionada)
  const c = currentCuadrilla || ($("selCuadrilla")?.value || "");
  const hasCuadrilla = !!String(c).trim();

  // Query por usuario (y por cuadrilla si existe)
  let q;
  if(hasCuadrilla){
    currentCuadrilla = c;
    q = query(
      collection(db, COL_SDA),
      where("usuario","==", currentUserEmail),
      where("cuadrilla","==", currentCuadrilla)
    );
  } else {
    q = query(
      collection(db, COL_SDA),
      where("usuario","==", currentUserEmail)
    );
  }

  let snap;
  try{
    snap = await getDocs(q);
  }catch(err){
    alert("Firestore pidió crear un ÍNDICE para esta consulta. En consola Firebase te saldrá un link 'Create index' y lo creas en 1 clic.");
    throw err;
  }

  snap.forEach(d=>{
    const x = d.data() || {};
    const fecha = x.fecha || "";
    const numeroPesada = normalizeNumeroPesada((x.numeroPesada || "").trim() || (x.pesadaNumero ? `Pesada${x.pesadaNumero}_${userShort(x.usuario||currentUserEmail)}` : "") || (x.sessionId || ""));
    const libras = (typeof x.libras === "number" && !isNaN(x.libras)) ? x.libras : null;

    registroRaw.push({
      id: x.personId || x.id || d.id,
      numeroPesada,
      fecha,
      apellidos: x.apellidos || "",
      nombres: x.nombres || "",
      area: x.area || x.areaTrabajo || "",
      cuadrilla: x.cuadrilla || "",
      libras,
      updatedAt: x.updatedAt || ""
    });
  });

  // Orden: fecha desc, pesadaNo desc, apellidos asc
  registroRaw.sort((a,b)=>{
    const fa = String(a.fecha||"");
    const fb = String(b.fecha||"");
    if(fa !== fb) return fb.localeCompare(fa);
    const na = parsePesadaNumber(a.numeroPesada);
    const nb = parsePesadaNumber(b.numeroPesada);
    if(na !== nb) return nb - na;
    const aa = (a.apellidos||"").localeCompare(b.apellidos||"","es");
    if(aa) return aa;
    return (a.nombres||"").localeCompare(b.nombres||"","es");
  });
}

function buildSummary(){
  const map = new Map(); // key: fecha||numero
  for(const r of registroRaw){
    if(!r.fecha || !r.numeroPesada) continue;
    const k = `${r.fecha}||${r.numeroPesada}`;
    if(!map.has(k)){
      map.set(k, { fecha: r.fecha, numeroPesada: r.numeroPesada });
    }
  }
  const arr = [...map.values()];
  arr.sort((a,b)=>{
    if(a.fecha !== b.fecha) return String(b.fecha).localeCompare(String(a.fecha));
    return parsePesadaNumber(b.numeroPesada) - parsePesadaNumber(a.numeroPesada);
  });

  // registroRows: [fechaKey, fechaDMY, numeroPesada]
  registroHeaders = ["FECHA", "NUMERO DE PESADA"];
  registroRows = arr.map(x => [x.fecha, dmyFromKey(x.fecha), x.numeroPesada]);
}

function buildDetailByDate(){
  const rows = registroRaw.filter(r => r.fecha === registroFecha);
  registroHeaders = ["ID","NUMERO DE PESADA","FECHA","APELLIDOS","NOMBRES","AREA","CUADRILLA","LIBRAS"];
  registroRows = rows.map(r => [
    String(r.id||""),
    String(r.numeroPesada||""),
    dmyFromKey(r.fecha),
    String(r.apellidos||""),
    String(r.nombres||""),
    String(r.area||""),
    String(r.cuadrilla||""),
    (typeof r.libras === "number" && !isNaN(r.libras)) ? fmt(r.libras) : ""
  ]);
}

function buildDetailByPesada(){
  const rows = registroRaw.filter(r => r.fecha === registroFecha && r.numeroPesada === registroPesada);
  registroHeaders = ["ID","NUMERO DE PESADA","FECHA","APELLIDOS","NOMBRES","AREA","CUADRILLA","LIBRAS"];
  registroRows = rows.map(r => [
    String(r.id||""),
    String(r.numeroPesada||""),
    dmyFromKey(r.fecha),
    String(r.apellidos||""),
    String(r.nombres||""),
    String(r.area||""),
    String(r.cuadrilla||""),
    (typeof r.libras === "number" && !isNaN(r.libras)) ? fmt(r.libras) : ""
  ]);
}

async function openRegistro(fromView){
  registroReturnView = fromView || currentViewName || "asistencia";
  registroMode = "summary";
  registroFecha = "";
  registroPesada = "";
  await loadRegistroRaw();
  buildSummary();
  setRegistroContext();
  renderRegistroTable();
  showView("registro");
}

// Botones REGISTRO en pantallas
$("btnRegistroA").onclick = () => openRegistro("asistencia");
$("btnRegistroN").onclick = () => openRegistro("nomina");
$("btnRegistroL").onclick = () => openRegistro("libras");

// Clicks en tabla (modo summary)
$("regBody").addEventListener("click", (e)=>{
  const t = e.target.closest(".cellLink");
  if(!t) return;
  const fecha = t.getAttribute("data-fecha") || "";
  const pesada = t.getAttribute("data-pesada") || "";

  if(!fecha) return;

  if(pesada){
    registroMode = "pesada";
    registroFecha = fecha;
    registroPesada = pesada;
    buildDetailByPesada();
  }else{
    registroMode = "date";
    registroFecha = fecha;
    registroPesada = "";
    buildDetailByDate();
  }
  setRegistroContext();
  renderRegistroTable();
});

// Volver: si estamos en detalle -> regresa al histórico; si estamos en histórico -> vuelve a pantalla anterior
$("lnkBackRegistro").onclick = ()=>{
  if(registroMode !== "summary"){
    registroMode = "summary";
    registroFecha = "";
    registroPesada = "";
    buildSummary();
    setRegistroContext();
    renderRegistroTable();
  }else{
    showView(registroReturnView);
  }
};

$("lnkLogoutR").onclick = doLogout;

// Ir a "Pesar cabezas": si hay cuadrilla seleccionada -> nómina; si no -> asistencia
$("btnPesarR").onclick = ()=>{
  if(currentCuadrilla) showView("nomina");
  else showView("asistencia");
};

function makeFileStamp(){
  const d = new Date();
  const pad = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}`;
}

function exportCurrentToXlsx(){
  if(!window.XLSX){
    alert("No se pudo cargar la librería XLSX.");
    return;
  }
  const aoa = [registroHeaders, ...registroRows.map(r => {
    // summary: [fechaKey, fechaDMY, numero] -> export 2 cols
    if(registroMode === "summary") return [r[1], r[2]];
    return r;
  })];

  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Registro");

  const user = userShort();
  const base = (registroMode === "summary") ? "HISTORICO" : (registroMode === "date" ? dmyFromKey(registroFecha) : registroPesada);
  const fname = `SDA_RegistroPesadas_${user}_${base}_${makeFileStamp()}.xlsx`.replaceAll(" ","_");
  XLSX.writeFile(wb, fname);
}

function exportCurrentToPdf(){
  const { jsPDF } = window.jspdf || {};
  if(!jsPDF){
    alert("No se pudo cargar la librería PDF.");
    return;
  }

  const rows = registroRows.map(r => {
    if(registroMode === "summary") return [r[1], r[2]];
    return r;
  });

  const head = (registroMode === "summary")
    ? [["FECHA","NUMERO DE PESADA"]]
    : [registroHeaders];

  const user = currentUserEmail || "";
  const title = `SDA - Registro de Pesadas | ${user}`;

  const docp = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
  docp.setFont("Times","Normal");
  docp.setFontSize(12);
  docp.text(title, 40, 40);
  docp.setFontSize(11);
  docp.text($("regContext").textContent || "", 40, 60);

  docp.autoTable({
    startY: 80,
    head,
    body: rows,
    styles: { font: "Times", fontSize: 9 },
    headStyles: { fillColor: [13,47,79] },
    margin: { left: 40, right: 40 }
  });

  const u = userShort();
  const base = (registroMode === "summary") ? "HISTORICO" : (registroMode === "date" ? dmyFromKey(registroFecha) : registroPesada);
  const fname = `SDA_RegistroPesadas_${u}_${base}_${makeFileStamp()}.pdf`.replaceAll(" ","_");
  docp.save(fname);
}

$("btnExcelR").onclick = exportCurrentToXlsx;
$("btnPdfR").onclick = exportCurrentToPdf;

// --- PDF (pantalla libras) ---
    $("btnPdf").onclick = () => {
      const { jsPDF } = window.jspdf || {};
      if(!jsPDF){
        alert("No se pudo cargar la librería PDF.");
        return;
      }

      const rows = [];
      const presentesArr = [...presentes]
        .map(id => nomina.find(x=>x.id===id))
        .filter(Boolean)
        .sort((a,b)=> (a.apellidos||"").localeCompare(b.apellidos||"","es") || (a.nombres||"").localeCompare(b.nombres||"","es"));

      for(const p of presentesArr){
        const n = librasMap.has(p.id) ? librasMap.get(p.id) : null;
        rows.push([
          p.id,
          p.apellidos || "",
          p.nombres || "",
          p.areaTrabajo || "",
          p.cuadrilla || "",
          (typeof n === "number" && !isNaN(n)) ? fmt(n) : ""
        ]);
      }

      let total = 0;
      for(const v of librasMap.values()){
        if(typeof v === "number" && !isNaN(v)) total += v;
      }

      const now = new Date();
      const dt = now.toISOString().slice(0,19).replace("T"," ");
      const fileStamp = now.toISOString().slice(0,19).replaceAll(":","-").replace("T","_");

      const titleLine = `SDA - Avance Descabezado | ${currentUserEmail} | ${dt}`;

      const docp = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
      docp.setFont("Times","Normal");
      docp.setFontSize(12);
      docp.text(titleLine, 40, 40);
      docp.setFontSize(11);
      docp.text(`Pesada: ${pesadaLabel}    Cuadrilla: ${currentCuadrilla}    Total Libras: ${fmt(total)}`, 40, 60);

      docp.autoTable({
        startY: 80,
        head: [["ID","APELLIDOS","NOMBRES","AREA","CUADRILLA","LIBRAS"]],
        body: rows,
        styles: { font: "Times", fontSize: 9 },
        headStyles: { fillColor: [13,47,79] },
        margin: { left: 40, right: 40 }
      });

      const fname = `SDA_${pesadaKey}_${currentCuadrilla}_${userShort()}_${fileStamp}.pdf`.replaceAll(" ","_");
      docp.save(fname);
    };

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  </script>
</body>
</html>
