<!doctype html>
<!-- DX - Etiquetas Importadores Zebra ZT411 (10x15cm) -->
<!-- BUILD_DX_LABELS_ZT411 v1.0.0 2026-02-08 -->
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DX | Etiquetas Importadores (ZT411)</title>

  <!-- FAVICON (opcional) -->
  <link rel="icon" href="favicon.ico?v=1">

  <style>
    :root{
      --navy:#0d2f4f;
      --blue:#1e88e5;
      --green:#2e7d32;
      --red:#c62828;
      --gray:#6b7280;
      --bg:#f6f7fb;
      --card:#ffffff;
      --border:#e5e7eb;
      --shadow: 0 8px 20px rgba(0,0,0,.08);

      /* Label controls */
      --labelScale: 1;
      --textScale: 1;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg); color:#111827;
    }

    .topbar{
      position: sticky; top:0; z-index: 20;
      background: linear-gradient(90deg, var(--navy), #163e67);
      color:#fff; padding: 12px 16px;
      display:flex; align-items:center; justify-content:space-between;
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
    }
    .topbar .title{
      font-weight: 800; letter-spacing:.2px;
    }
    .topbar .meta{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      font-size: 12.5px;
    }
    .pill{
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
      padding: 5px 10px; border-radius: 999px;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding: 8px 12px;
      border-radius: 10px;
      cursor:pointer;
      font-weight: 700;
      transition: transform .04s ease, box-shadow .14s ease;
    }
    .btn:hover{ box-shadow: 0 10px 20px rgba(0,0,0,.08); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: var(--blue);
      border-color: #1976d2;
      color:#fff;
    }
    .btn.danger{
      background: var(--red);
      border-color: #b71c1c;
      color:#fff;
    }
    .btn.green{
      background: var(--green);
      border-color: #1b5e20;
      color:#fff;
    }
    .btn.ghost{
      background: transparent;
      color:#fff;
      border-color: rgba(255,255,255,.28);
    }
    .btn:disabled{
      opacity:.55; cursor:not-allowed; box-shadow:none;
    }

    .wrap{
      max-width: 1320px;
      margin: 14px auto;
      padding: 0 12px 24px;
    }

    .grid{
      display:grid;
      grid-template-columns: 430px 1fr;
      gap: 14px;
      align-items:start;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h3{
      margin:0;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      letter-spacing: .2px;
      color:#0f172a;
      background: linear-gradient(180deg, #ffffff, #fbfcff);
    }
    .card .content{
      padding: 12px 14px;
    }

    .tabs{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      padding: 12px 14px;
      border-bottom:1px solid var(--border);
      background: #ffffff;
    }
    .tab{
      border: 1px solid var(--border);
      background:#fff;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      cursor:pointer;
      font-weight: 800;
      user-select:none;
    }
    .tab.active{
      background: #eaf2ff;
      border-color: #bcd7ff;
      color:#0b3a7a;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      margin: 10px 0;
      flex-wrap:wrap;
    }
    label{
      font-size: 12px;
      color: var(--gray);
      font-weight: 800;
      display:block;
      margin-bottom: 5px;
    }
    input[type="text"], input[type="date"], input[type="number"], select{
      width: 100%;
      padding: 9px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      outline:none;
      background:#fff;
    }
    input[type="range"]{ width: 100%; }
    .col{
      flex: 1 1 160px;
      min-width: 160px;
    }

    .hint{
      font-size: 12px;
      color:#4b5563;
      line-height: 1.25rem;
    }
    .small{
      font-size: 11.5px;
      color:#6b7280;
    }
    .hr{
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    /* Label preview area */
    .previewWrap{
      padding: 12px 14px;
    }
    .previewHeader{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .labelOuter{
      width: 100%;
      min-height: 520px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        linear-gradient(0deg, rgba(0,0,0,.04), rgba(0,0,0,.04)),
        repeating-linear-gradient(90deg, rgba(0,0,0,.07) 0, rgba(0,0,0,.07) 1px, transparent 1px, transparent 10px),
        repeating-linear-gradient(0deg, rgba(0,0,0,.07) 0, rgba(0,0,0,.07) 1px, transparent 1px, transparent 10px);
      border: 1px dashed #cbd5e1;
      border-radius: 14px;
      padding: 16px;
      overflow:auto;
    }

    /* Exact physical size: 10cm x 15cm (100mm x 150mm) */
    .labelStage{
      width: 100mm;
      height: 150mm;
      background:#fff;
      border: 1px solid #111827;
      box-shadow: 0 18px 40px rgba(0,0,0,.15);
      transform-origin: top left;
      transform: scale(var(--labelScale));
    }

    /* Keep SVG crisp */
    #labelSVG{
      width: 100%;
      height: 100%;
      display:block;
    }
    .svgText{
      font-family: Arial, Helvetica, sans-serif;
      font-weight: 700;
      fill: #000;
      /* Scale ALL text via transform origin 0 0 (applied in render) */
    }

    /* History table */
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12.5px;
    }
    th, td{
      border-bottom: 1px solid var(--border);
      padding: 8px 8px;
      text-align:left;
      vertical-align:middle;
    }
    th{
      background:#fbfcff;
      color:#334155;
      font-size: 12px;
      letter-spacing:.2px;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .tableWrap{
      max-height: 330px;
      overflow:auto;
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      background: #111827;
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0,0,0,.25);
      max-width: 360px;
      font-size: 13px;
      display:none;
      z-index: 999;
    }

    /* Login modal */
    .modalBack{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 1000;
    }
    .modal{
      width: min(520px, 100%);
      background:#fff;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modal h2{
      margin:0;
      padding: 14px 16px;
      background: linear-gradient(90deg, var(--navy), #163e67);
      color:#fff;
      font-size: 15px;
      letter-spacing:.2px;
    }
    .modal .body{ padding: 14px 16px; }
    .modal .footer{
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      background:#fff;
    }

    /* Print: force exact label size, no margins */
    @media print{
      body{ background:#fff !important; }
      .topbar, .wrap, .toast, .modalBack{ display:none !important; }
      /* Print-only container */
      #printRoot{
        display:block !important;
      }
      @page{
        size: 100mm 150mm;
        margin: 0;
      }
    }
    #printRoot{
      display:none;
    }

    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
      .labelOuter{ min-height: 420px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="title">DX | Etiquetas Importadores (ZT411 · 10×15 cm)</div>
    <div class="meta">
      <span class="pill" id="pillUser">Sin sesión</span>
      <span class="pill" id="pillRole">Rol: —</span>
      <button class="btn ghost" id="btnLogout" style="display:none;">Cerrar sesión</button>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modalBack" id="loginBack">
    <div class="modal">
      <h2>Iniciar sesión</h2>
      <div class="body">
        <div class="hint">
          Acceso permitido solo para:
          <b>davidballas@oceantreasure.local</b> (Digitador) y
          <b>jeffersonfigueroa@oceantreasure.local</b> (Administrador).
        </div>
        <div class="hr"></div>
        <div class="row">
          <div class="col">
            <label>Email</label>
            <input id="loginEmail" type="text" placeholder="usuario@oceantreasure.local" autocomplete="username" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Contraseña</label>
            <input id="loginPass" type="text" placeholder="••••••••" autocomplete="current-password" />
            <div class="small">Tip: si deseas ocultar la contraseña, cambia type="text" por type="password".</div>
          </div>
        </div>
        <div class="small" style="margin-top:10px;">
          Si el usuario no está autorizado, el sistema cerrará sesión automáticamente.
        </div>
      </div>
      <div class="footer">
        <button class="btn primary" id="btnLogin">Entrar</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="tabs" id="tabs"></div>
    </div>

    <div class="grid" style="margin-top:14px;">
      <!-- Left: Controls + History -->
      <div class="card">
        <h3>Controles de etiqueta</h3>
        <div class="content">

          <div class="row">
            <div class="col">
              <label>Escala del diseño (estirar / encoger)</label>
              <input id="scaleRange" type="range" min="0.4" max="1.8" step="0.02" value="1" />
              <div class="row" style="margin-top:8px;">
                <button class="btn" id="btnScaleDown">−</button>
                <button class="btn" id="btnScaleUp">+</button>
                <button class="btn" id="btnScaleFit">Ajustar</button>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Tamaño de texto (global)</label>
              <input id="textRange" type="range" min="0.7" max="1.6" step="0.02" value="1" />
              <div class="small">Escala todos los textos sin perder nitidez (SVG).</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="col">
              <label>Secuencial</label>
              <input id="inSec" type="text" placeholder="00001234" />
            </div>
            <div class="col" style="flex:0 0 170px; min-width:170px;">
              <label>&nbsp;</label>
              <button class="btn primary" id="btnApplySec">Ingresar secuencial</button>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Lote</label>
              <input id="inLote" type="text" placeholder="0222" />
            </div>
            <div class="col">
              <label>Fecha</label>
              <input id="inFecha" type="date" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Talla</label>
              <input id="inTalla" type="text" placeholder="21/25" />
            </div>
            <div class="col">
              <label>Nota (opcional)</label>
              <input id="inNota" type="text" placeholder="Opcional" />
            </div>
          </div>

          <div class="row">
            <button class="btn green" id="btnSave">Guardar en Firestore</button>
            <button class="btn" id="btnPDF">PDF (10×15 alta definición)</button>
            <button class="btn" id="btnPrint">Imprimir (ZT411)</button>
          </div>

          <div class="small">
            <b>Calidad:</b> la etiqueta se genera como <b>SVG</b> (vectores) para mantener líneas y letras nítidas.
            El PDF se crea a tamaño real <b>100×150 mm</b>.
          </div>

          <div class="hr"></div>

          <div class="row" id="templateAdminRow" style="display:none;">
            <div class="col" style="min-width:240px;">
              <label>Plantilla (admin)</label>
              <input id="inTplName" type="text" placeholder="Nombre plantilla (opcional)" />
            </div>
            <div class="col" style="min-width:240px;">
              <label>Subir fondo (PNG/JPG/SVG → se guarda como DataURL)</label>
              <input id="inBgFile" type="file" accept=".png,.jpg,.jpeg,.svg" />
              <div class="small">Usa imágenes grandes (ej. 1000×1500 px) para máxima definición.</div>
            </div>
            <div class="col" style="flex:0 0 210px; min-width:210px;">
              <label>&nbsp;</label>
              <button class="btn primary" id="btnSaveTemplate">Guardar plantilla actual</button>
            </div>
          </div>

          <div class="row" id="nuevoAdminRow" style="display:none;">
            <div class="col">
              <label>Crear nuevo importador (tab "Nuevo")</label>
              <input id="inNuevoNombre" type="text" placeholder="Ej: NUEVO - Importador X" />
            </div>
            <div class="col" style="flex:0 0 210px; min-width:210px;">
              <label>&nbsp;</label>
              <button class="btn" id="btnCrearNuevo">Crear pestaña</button>
            </div>
          </div>

        </div>
      </div>

      <!-- Right: Preview + History -->
      <div class="card">
        <h3>Vista previa (tamaño real 10×15 cm)</h3>
        <div class="previewWrap">
          <div class="previewHeader">
            <div class="hint">
              Importador actual: <b id="lblImporter">—</b><br>
              <span class="small">Si al imprimir se ve pequeño, pon escala = 1 y usa "Imprimir".</span>
            </div>
            <div class="row" style="margin:0;">
              <span class="pill" style="background:#eef2ff;border-color:#c7d2fe;color:#1f2937;" id="pillStatus">Listo</span>
            </div>
          </div>

          <div class="labelOuter">
            <div class="labelStage" id="labelStage">
              <!-- SVG render -->
              <svg id="labelSVG" viewBox="0 0 1000 1500" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <clipPath id="clipAll"><rect x="0" y="0" width="1000" height="1500"/></clipPath>
                </defs>

                <!-- Background image (optional) -->
                <image id="bgImage" x="0" y="0" width="1000" height="1500" preserveAspectRatio="none" href="" style="display:none;" />

                <!-- Border (for reference) -->
                <rect x="0" y="0" width="1000" height="1500" fill="none" stroke="#000" stroke-width="8" />

                <!-- Static header placeholder -->
                <text id="tImporter" x="40" y="90" class="svgText" font-size="54">IMPORTADOR</text>
                <line x1="40" y1="115" x2="960" y2="115" stroke="#000" stroke-width="6" />

                <!-- Dynamic fields -->
                <text id="tSec" x="960" y="70" class="svgText" font-size="46" text-anchor="end">SEC 00000000</text>

                <text id="tLote" x="40" y="200" class="svgText" font-size="52">LOTE: —</text>
                <text id="tFecha" x="40" y="270" class="svgText" font-size="46">FECHA: —</text>
                <text id="tTalla" x="40" y="340" class="svgText" font-size="56">TALLA: —</text>
                <text id="tNota" x="40" y="410" class="svgText" font-size="40" opacity="0.9">—</text>

                <!-- Example barcode area (placeholder) -->
                <rect x="80" y="520" width="840" height="280" fill="none" stroke="#000" stroke-width="6" />
                <text x="500" y="670" class="svgText" font-size="46" text-anchor="middle">ÁREA CÓDIGO / QR</text>

                <!-- Footer -->
                <line x1="40" y1="1400" x2="960" y2="1400" stroke="#000" stroke-width="6" />
                <text id="tUser" x="40" y="1460" class="svgText" font-size="34">Guardado por: —</text>
              </svg>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between;">
            <div class="hint">
              Historial (por importador) · se actualiza al guardar
            </div>
            <div class="row" style="margin:0;">
              <button class="btn" id="btnRefresh">Actualizar</button>
            </div>
          </div>

          <div class="tableWrap" style="margin-top:8px;">
            <table>
              <thead>
                <tr>
                  <th style="width:140px;">Fecha</th>
                  <th>Secuencial</th>
                  <th>Lote</th>
                  <th>Talla</th>
                  <th>Usuario</th>
                  <th style="width:220px;">Acciones</th>
                </tr>
              </thead>
              <tbody id="histBody">
                <tr><td colspan="6" class="small">Inicia sesión para cargar historial.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="small" style="margin-top:10px;">
            Nota: para máxima seguridad, aplica también reglas de Firestore por rol (admin/digitador) en Firebase Console.
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- PRINT ROOT (print-only) -->
  <div id="printRoot">
    <div style="width:100mm;height:150mm;">
      <!-- We clone SVG here before printing -->
      <div id="printHost"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- PDF helpers -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    /************************************************************
     *  CONFIGURACIÓN FIREBASE (REEMPLAZA CON TU PROPIO CONFIG)
     ************************************************************/
    const firebaseConfig = {
      apiKey: "REEMPLAZAR",
      authDomain: "REEMPLAZAR",
      projectId: "REEMPLAZAR",
      storageBucket: "REEMPLAZAR",
      messagingSenderId: "REEMPLAZAR",
      appId: "REEMPLAZAR"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /************************************************************
     *  ACCESOS / ROLES
     ************************************************************/
    const ALLOWED = {
      digitador: "davidballas@oceantreasure.local",
      admin: "jeffersonfigueroa@oceantreasure.local",
    };
    function getRole(email){
      if(!email) return null;
      const e = String(email).toLowerCase();
      if(e === ALLOWED.admin) return "admin";
      if(e === ALLOWED.digitador) return "digitador";
      return null;
    }
    function isAllowed(email){ return !!getRole(email); }

    /************************************************************
     *  IMPORTADORES (pestañas iniciales)
     ************************************************************/
    const DEFAULT_IMPORTERS = [
      { id:"nancy_dongxiandi", name:"NANCY - Dongxiandi Holdings" },
      { id:"nancy_shenzhen_yueshi", name:"NANCY - Shenzhen Yueshi" },
      { id:"criss_guangdong_hongbao", name:"CRISS - Guangdong Hongbao" },
      { id:"criss_guang_dong_lvh", name:"CRISS - Guang Dong LvHuan" },
      { id:"interatlantic", name:"InterAtlantic" },
      { id:"ancora7", name:"Áncora 7" },
      { id:"gambalia", name:"Gambalia" },
      { id:"nuevo", name:"Nuevo" },
    ];

    /************************************************************
     *  UI STATE
     ************************************************************/
    let currentUser = null;
    let currentRole = null;
    let currentImporterId = DEFAULT_IMPORTERS[0].id;
    let currentImporterName = DEFAULT_IMPORTERS[0].name;

    let currentTemplate = {
      bgDataUrl: null,    // image data url
      // You can evolve this later: positions, fonts, etc.
      version: 1,
    };

    let labelData = {
      secuencial: "",
      lote: "",
      fecha: "",
      talla: "",
      nota: "",
      savedBy: "",
    };

    /************************************************************
     *  HELPERS
     ************************************************************/
    const $ = (id)=>document.getElementById(id);
    function toast(msg, ms=2500){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>t.style.display="none", ms);
    }
    function setStatus(txt, kind=""){
      const p = $("pillStatus");
      p.textContent = txt;
      if(kind==="ok"){ p.style.background="#dcfce7"; p.style.borderColor="#86efac"; p.style.color="#14532d"; }
      else if(kind==="warn"){ p.style.background="#fef9c3"; p.style.borderColor="#fde047"; p.style.color="#713f12"; }
      else if(kind==="bad"){ p.style.background="#fee2e2"; p.style.borderColor="#fecaca"; p.style.color="#7f1d1d"; }
      else { p.style.background="#eef2ff"; p.style.borderColor="#c7d2fe"; p.style.color="#1f2937"; }
    }

    function padSec(s){
      const raw = String(s||"").trim();
      if(!raw) return "";
      // keep digits, pad to 8
      const digits = raw.replace(/\D/g,"");
      return digits ? digits.padStart(8,"0") : raw;
    }
    function fmtDateISOToES(iso){
      if(!iso) return "";
      // iso: yyyy-mm-dd
      const [y,m,d] = iso.split("-");
      if(!y||!m||!d) return iso;
      return `${d}/${m}/${y}`;
    }

    function normalizeText(s){ return String(s||"").trim(); }

    /************************************************************
     *  TABS
     ************************************************************/
    function renderTabs(extraDynamic=[]){
      const tabs = $("tabs");
      tabs.innerHTML = "";
      const all = [...DEFAULT_IMPORTERS.filter(x=>x.id!=="nuevo"), ...extraDynamic, DEFAULT_IMPORTERS.find(x=>x.id==="nuevo")];

      for(const imp of all){
        const b = document.createElement("div");
        b.className = "tab" + (imp.id===currentImporterId ? " active":"");
        b.textContent = imp.name;
        b.onclick = ()=>selectImporter(imp.id, imp.name);
        tabs.appendChild(b);
      }
    }

    async function selectImporter(id, name){
      currentImporterId = id;
      currentImporterName = name;
      $("lblImporter").textContent = name;
      setStatus("Cargando plantilla…");
      await loadTemplateForImporter();
      applyInputsToState(); // keep current inputs
      renderLabel();
      if(currentUser) await loadHistory();
      if(id === "nuevo"){
        // In tab "Nuevo", admin can create new tabs
        $("nuevoAdminRow").style.display = (currentRole==="admin") ? "flex" : "none";
      } else {
        $("nuevoAdminRow").style.display = "none";
      }
      // Update active tab
      await loadDynamicImportersAndRenderTabs();
      setStatus("Listo");
    }

    /************************************************************
     *  LABEL RENDER (SVG)
     ************************************************************/
    function renderLabel(){
      // Apply background
      const bg = $("bgImage");
      if(currentTemplate.bgDataUrl){
        bg.setAttribute("href", currentTemplate.bgDataUrl);
        bg.style.display = "block";
      }else{
        bg.setAttribute("href", "");
        bg.style.display = "none";
      }

      // Text scale (SVG transform)
      const ts = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--textScale")) || 1;
      const applyScale = (el)=>{
        // Keep anchor positions; scale about its own x/y (approx)
        const x = parseFloat(el.getAttribute("x")||"0");
        const y = parseFloat(el.getAttribute("y")||"0");
        el.setAttribute("transform", `translate(${x} ${y}) scale(${ts}) translate(${-x} ${-y})`);
      };

      const importerText = currentImporterName || "IMPORTADOR";
      $("tImporter").textContent = importerText;

      const sec = labelData.secuencial ? `SEC ${labelData.secuencial}` : "SEC 00000000";
      $("tSec").textContent = sec;

      $("tLote").textContent  = `LOTE: ${labelData.lote || "—"}`;
      $("tFecha").textContent = `FECHA: ${labelData.fecha ? fmtDateISOToES(labelData.fecha) : "—"}`;
      $("tTalla").textContent = `TALLA: ${labelData.talla || "—"}`;
      $("tNota").textContent  = labelData.nota ? labelData.nota : "—";
      $("tUser").textContent  = `Guardado por: ${labelData.savedBy || (currentUser?.email || "—")}`;

      // Apply text scaling to all class svgText
      document.querySelectorAll(".svgText").forEach(applyScale);
    }

    function getSVGString(){
      const svg = $("labelSVG");
      // ensure xmlns present
      svg.setAttribute("xmlns","http://www.w3.org/2000/svg");
      const clone = svg.cloneNode(true);
      // inline background href remains
      return new XMLSerializer().serializeToString(clone);
    }

    function setLabelScale(v){
      const x = Math.max(0.4, Math.min(1.8, Number(v||1)));
      document.documentElement.style.setProperty("--labelScale", x.toFixed(2));
      $("scaleRange").value = x.toFixed(2);
    }
    function setTextScale(v){
      const x = Math.max(0.7, Math.min(1.6, Number(v||1)));
      document.documentElement.style.setProperty("--textScale", x.toFixed(2));
      $("textRange").value = x.toFixed(2);
      renderLabel();
    }

    /************************************************************
     *  INPUTS
     ************************************************************/
    function applyInputsToState(){
      labelData.secuencial = padSec($("inSec").value);
      labelData.lote = normalizeText($("inLote").value);
      labelData.fecha = $("inFecha").value || "";
      labelData.talla = normalizeText($("inTalla").value);
      labelData.nota = normalizeText($("inNota").value);
      labelData.savedBy = currentUser?.email || "";
    }

    function fillInputsFromState(){
      $("inSec").value = labelData.secuencial || "";
      $("inLote").value = labelData.lote || "";
      $("inFecha").value = labelData.fecha || "";
      $("inTalla").value = labelData.talla || "";
      $("inNota").value = labelData.nota || "";
    }

    /************************************************************
     *  FIRESTORE: Templates & Labels
     *  Estructura sugerida:
     *    /importers/{importerId} { name }
     *    /importers/{importerId}/template/main { bgDataUrl, tplName, updatedAt, updatedBy, version }
     *    /importers/{importerId}/labels/{labelId} { secuencial, lote, fecha, talla, nota, createdAt, createdBy, svg }
     ************************************************************/
    function importerRef(id){
      return db.collection("importers").doc(id);
    }
    function templateRef(id){
      return importerRef(id).collection("template").doc("main");
    }
    function labelsCol(id){
      return importerRef(id).collection("labels");
    }

    async function ensureImporterDoc(id, name){
      if(!id || id==="nuevo") return;
      const ref = importerRef(id);
      const snap = await ref.get();
      if(!snap.exists){
        await ref.set({ name: name, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      }else{
        // keep name updated
        await ref.set({ name: name }, { merge:true });
      }
    }

    async function loadTemplateForImporter(){
      currentTemplate = { bgDataUrl:null, version: 1 };
      if(currentImporterId==="nuevo"){
        setStatus("Listo");
        return;
      }
      try{
        await ensureImporterDoc(currentImporterId, currentImporterName);
        const snap = await templateRef(currentImporterId).get();
        if(snap.exists){
          const d = snap.data() || {};
          currentTemplate.bgDataUrl = d.bgDataUrl || null;
          currentTemplate.version = d.version || 1;
        }
        setStatus("Plantilla lista", "ok");
      }catch(err){
        console.error(err);
        setStatus("Error plantilla", "bad");
        toast("No se pudo cargar plantilla (revisa config/permisos).");
      }
    }

    async function saveTemplateForImporter(){
      if(currentRole!=="admin"){
        toast("Solo administrador puede guardar plantilla.");
        return;
      }
      if(currentImporterId==="nuevo"){
        toast("Selecciona un importador real (no 'Nuevo') para guardar plantilla.");
        return;
      }
      setStatus("Guardando plantilla…");
      try{
        const tplName = normalizeText($("inTplName").value);
        await ensureImporterDoc(currentImporterId, currentImporterName);
        await templateRef(currentImporterId).set({
          tplName: tplName || null,
          bgDataUrl: currentTemplate.bgDataUrl || null,
          version: (currentTemplate.version||1) + 1,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: currentUser.email
        }, { merge:true });
        setStatus("Plantilla guardada", "ok");
        toast("Plantilla guardada.");
      }catch(err){
        console.error(err);
        setStatus("Error plantilla", "bad");
        toast("No se pudo guardar plantilla.");
      }
    }

    async function saveLabel(){
      if(!currentUser){ toast("Inicia sesión."); return; }
      if(currentImporterId==="nuevo"){
        toast("Selecciona un importador real antes de guardar.");
        return;
      }
      applyInputsToState();
      if(!labelData.secuencial){
        toast("Ingresa un secuencial.");
        return;
      }
      setStatus("Guardando…");
      try{
        await ensureImporterDoc(currentImporterId, currentImporterName);
        const doc = {
          importerId: currentImporterId,
          importerName: currentImporterName,
          secuencial: labelData.secuencial,
          lote: labelData.lote || "",
          fecha: labelData.fecha || "",
          talla: labelData.talla || "",
          nota: labelData.nota || "",
          templateVersion: currentTemplate.version || 1,
          svg: getSVGString(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser.email
        };
        const ref = await labelsCol(currentImporterId).add(doc);
        setStatus("Guardado", "ok");
        toast("Etiqueta guardada y agregada al historial.");
        await loadHistory();
      }catch(err){
        console.error(err);
        setStatus("Error al guardar", "bad");
        toast("No se pudo guardar (revisa permisos / reglas).");
      }
    }

    async function loadHistory(){
      const body = $("histBody");
      body.innerHTML = `<tr><td colspan="6" class="small">Cargando…</td></tr>`;
      if(!currentUser){
        body.innerHTML = `<tr><td colspan="6" class="small">Inicia sesión para ver historial.</td></tr>`;
        return;
      }
      if(currentImporterId==="nuevo"){
        body.innerHTML = `<tr><td colspan="6" class="small">En pestaña "Nuevo" no hay historial.</td></tr>`;
        return;
      }
      try{
        const q = await labelsCol(currentImporterId)
          .orderBy("createdAt","desc")
          .limit(60)
          .get();

        if(q.empty){
          body.innerHTML = `<tr><td colspan="6" class="small">Sin registros.</td></tr>`;
          return;
        }

        body.innerHTML = "";
        q.forEach(s=>{
          const d = s.data() || {};
          const tr = document.createElement("tr");

          const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
          const fecha = dt ? dt.toLocaleString("es-EC", { hour12:false }) : "—";

          tr.innerHTML = `
            <td>${escapeHtml(fecha)}</td>
            <td>${escapeHtml(d.secuencial||"")}</td>
            <td>${escapeHtml(d.lote||"")}</td>
            <td>${escapeHtml(d.talla||"")}</td>
            <td>${escapeHtml(d.createdBy||"")}</td>
            <td></td>
          `;

          const td = tr.querySelector("td:last-child");

          const btnLoad = document.createElement("button");
          btnLoad.className = "btn";
          btnLoad.textContent = "Cargar";
          btnLoad.onclick = ()=>loadLabelFromDoc(d);

          const btnPdf = document.createElement("button");
          btnPdf.className = "btn";
          btnPdf.textContent = "PDF";
          btnPdf.style.marginLeft = "6px";
          btnPdf.onclick = async ()=> {
            loadLabelFromDoc(d);
            await exportPDF();
          };

          td.appendChild(btnLoad);
          td.appendChild(btnPdf);

          if(currentRole==="admin"){
            const btnDel = document.createElement("button");
            btnDel.className = "btn danger";
            btnDel.textContent = "Eliminar";
            btnDel.style.marginLeft = "6px";
            btnDel.onclick = ()=>deleteLabel(s.id);
            td.appendChild(btnDel);
          }

          body.appendChild(tr);
        });

      }catch(err){
        console.error(err);
        body.innerHTML = `<tr><td colspan="6" class="small">Error cargando historial.</td></tr>`;
        toast("No se pudo cargar historial.");
      }
    }

    function loadLabelFromDoc(d){
      labelData = {
        secuencial: d.secuencial || "",
        lote: d.lote || "",
        fecha: d.fecha || "",
        talla: d.talla || "",
        nota: d.nota || "",
        savedBy: d.createdBy || "",
      };
      fillInputsFromState();
      // If doc has SVG, render it directly (to preserve exact saved design)
      if(d.svg){
        try{
          const parser = new DOMParser();
          const doc = parser.parseFromString(d.svg, "image/svg+xml");
          const svgEl = doc.documentElement;
          const current = $("labelSVG");
          current.parentNode.replaceChild(document.importNode(svgEl, true), current);
          // restore id and viewBox if missing
          const newSvg = document.querySelector("svg");
          newSvg.id = "labelSVG";
          if(!newSvg.getAttribute("viewBox")) newSvg.setAttribute("viewBox","0 0 1000 1500");
          // rebind bgImage pointer if id missing
          // then apply scaling
          renderLabel();
          toast("Etiqueta cargada.");
          return;
        }catch(e){
          console.warn("SVG load fallback", e);
        }
      }
      renderLabel();
      toast("Etiqueta cargada.");
    }

    async function deleteLabel(id){
      if(currentRole!=="admin"){ toast("Solo admin puede eliminar."); return; }
      if(!confirm("¿Eliminar este registro?")) return;
      try{
        await labelsCol(currentImporterId).doc(id).delete();
        toast("Eliminado.");
        await loadHistory();
      }catch(err){
        console.error(err);
        toast("No se pudo eliminar.");
      }
    }

    async function loadDynamicImportersAndRenderTabs(){
      // Load extra importers created by admin, excluding default ones
      const defaults = new Set(DEFAULT_IMPORTERS.map(x=>x.id));
      let extras = [];
      try{
        const snaps = await db.collection("importers").get();
        snaps.forEach(s=>{
          if(defaults.has(s.id)) return;
          const d = s.data()||{};
          if(!d.name) return;
          extras.push({ id:s.id, name:d.name });
        });
        // Stable sort
        extras.sort((a,b)=>a.name.localeCompare(b.name, "es"));
      }catch(err){
        // ignore if no session
      }
      renderTabs(extras);
      // Keep label
      $("lblImporter").textContent = currentImporterName;
    }

    /************************************************************
     *  ADMIN: upload background file as DataURL
     ************************************************************/
    function readFileAsDataURL(file){
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = ()=>resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /************************************************************
     *  PDF / PRINT
     ************************************************************/
    async function exportPDF(){
      try{
        setStatus("Generando PDF…");
        // Render canvas at high scale (better output)
        const stage = $("labelStage");
        const canvas = await html2canvas(stage, {
          backgroundColor: "#ffffff",
          scale: 4, // increase for sharpness
          useCORS: true
        });

        const imgData = canvas.toDataURL("image/png");

        const { jsPDF } = window.jspdf;
        // 100mm x 150mm
        const pdf = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: [100, 150]
        });

        // Fill page
        pdf.addImage(imgData, "PNG", 0, 0, 100, 150, undefined, "FAST");

        const sec = padSec($("inSec").value) || "00000000";
        const name = `${currentImporterId}_${sec}_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.pdf`;
        pdf.save(name);
        setStatus("PDF listo", "ok");
      }catch(err){
        console.error(err);
        setStatus("Error PDF", "bad");
        toast("No se pudo generar PDF.");
      }
    }

    async function printLabel(){
      try{
        setStatus("Preparando impresión…");
        // Clone SVG to print host
        const host = $("printHost");
        host.innerHTML = "";
        const svg = document.querySelector("#labelStage svg");
        const clone = svg.cloneNode(true);
        // Ensure fixed size in print
        clone.style.width = "100mm";
        clone.style.height = "150mm";
        clone.style.display = "block";
        host.appendChild(clone);

        // Force print
        setTimeout(()=> {
          window.print();
          setStatus("Listo");
        }, 60);
      }catch(err){
        console.error(err);
        toast("No se pudo imprimir.");
      }
    }

    /************************************************************
     *  SAFE HTML
     ************************************************************/
    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    /************************************************************
     *  EVENTS
     ************************************************************/
    function wireUI(){
      // Scale controls
      $("scaleRange").addEventListener("input", e=> setLabelScale(e.target.value));
      $("btnScaleDown").onclick = ()=> setLabelScale((parseFloat($("scaleRange").value)||1) - 0.06);
      $("btnScaleUp").onclick = ()=> setLabelScale((parseFloat($("scaleRange").value)||1) + 0.06);
      $("btnScaleFit").onclick = ()=> setLabelScale(1);

      $("textRange").addEventListener("input", e=> setTextScale(e.target.value));

      // Inputs: live preview
      ["inSec","inLote","inFecha","inTalla","inNota"].forEach(id=>{
        $(id).addEventListener("input", ()=>{ applyInputsToState(); renderLabel(); });
      });

      $("btnApplySec").onclick = ()=>{
        $("inSec").value = padSec($("inSec").value);
        applyInputsToState(); renderLabel();
        toast("Secuencial aplicado en esquina superior derecha.");
      };

      $("btnSave").onclick = saveLabel;
      $("btnPDF").onclick = exportPDF;
      $("btnPrint").onclick = printLabel;
      $("btnRefresh").onclick = loadHistory;

      $("btnSaveTemplate").onclick = saveTemplateForImporter;

      $("inBgFile").addEventListener("change", async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        try{
          const dataUrl = await readFileAsDataURL(file);
          currentTemplate.bgDataUrl = dataUrl;
          renderLabel();
          toast("Fondo cargado (aún no guardado).");
        }catch(err){
          console.error(err);
          toast("No se pudo leer el archivo.");
        }
      });

      $("btnCrearNuevo").onclick = createNewImporterFromNuevoTab;

      $("btnLogout").onclick = ()=>auth.signOut();
      $("btnLogin").onclick = doLogin;

      // Enter to login
      $("loginPass").addEventListener("keydown", (e)=>{
        if(e.key==="Enter") doLogin();
      });
    }

    async function doLogin(){
      const email = normalizeText($("loginEmail").value).toLowerCase();
      const pass = $("loginPass").value;
      if(!email || !pass){ toast("Email y contraseña."); return; }

      setStatus("Autenticando…");
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(err){
        console.error(err);
        setStatus("Login falló", "bad");
        toast("No se pudo iniciar sesión (credenciales).");
      }
    }

    function showLogin(show){
      $("loginBack").style.display = show ? "flex" : "none";
    }

    function applyUserToUI(){
      $("pillUser").textContent = currentUser ? currentUser.email : "Sin sesión";
      $("pillRole").textContent = "Rol: " + (currentRole || "—");
      $("btnLogout").style.display = currentUser ? "inline-block" : "none";

      // Admin-only template controls
      $("templateAdminRow").style.display = (currentRole==="admin" && currentImporterId!=="nuevo") ? "flex" : "none";
      $("nuevoAdminRow").style.display = (currentRole==="admin" && currentImporterId==="nuevo") ? "flex" : "none";
    }

    async function createNewImporterFromNuevoTab(){
      if(currentRole!=="admin"){ toast("Solo admin."); return; }
      const name = normalizeText($("inNuevoNombre").value);
      if(!name){ toast("Escribe un nombre."); return; }

      // Create safe id
      const id = name.toLowerCase()
        .replace(/[^\w]+/g, "_")
        .replace(/^_+|_+$/g,"")
        .slice(0, 50) || ("imp_" + Date.now());

      try{
        await importerRef(id).set({
          name,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser.email
        }, { merge:true });

        toast("Importador creado. Selecciónalo en pestañas.");
        $("inNuevoNombre").value = "";
        await loadDynamicImportersAndRenderTabs();
      }catch(err){
        console.error(err);
        toast("No se pudo crear importador.");
      }
    }

    /************************************************************
     *  INIT
     ************************************************************/
    function initDefaults(){
      // Default date: today (local)
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,"0");
      const dd = String(now.getDate()).padStart(2,"0");
      $("inFecha").value = `${yyyy}-${mm}-${dd}`;

      $("lblImporter").textContent = currentImporterName;
      setLabelScale(1);
      setTextScale(1);
      applyInputsToState();
      renderLabel();
    }

    auth.onAuthStateChanged(async (user)=>{
      if(user){
        const role = getRole(user.email);
        if(!role){
          // Not allowed
          toast("Usuario no autorizado.");
          await auth.signOut();
          return;
        }
        currentUser = user;
        currentRole = role;
        showLogin(false);
        applyUserToUI();
        setStatus("Sincronizando…");
        await loadDynamicImportersAndRenderTabs();
        await loadTemplateForImporter();
        renderLabel();
        await loadHistory();
        setStatus("Listo");
      }else{
        currentUser = null;
        currentRole = null;
        applyUserToUI();
        showLogin(true);
        $("histBody").innerHTML = `<tr><td colspan="6" class="small">Inicia sesión para ver historial.</td></tr>`;
        setStatus("Sin sesión", "warn");
      }
    });

    // Tabs click: need dynamic importers too, but can render defaults now
    document.addEventListener("DOMContentLoaded", async ()=>{
      wireUI();
      initDefaults();
      // Render defaults tabs immediately
      renderTabs([]);
      // Select first importer
      $("lblImporter").textContent = currentImporterName;
      // If already authed (rare), load tabs dynamic
      try{ await loadDynamicImportersAndRenderTabs(); }catch(e){}
      await selectImporter(currentImporterId, currentImporterName);
    });

  </script>
</body>
</html>
