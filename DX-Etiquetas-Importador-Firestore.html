<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Insertar Excel → Render</title>

  <!-- ExcelJS (lee .xlsx + estilos básicos) -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --line:rgba(255,255,255,.12);
      --text:#e5e7eb; --muted:#9ca3af; --accent:#2563eb;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:15px;font-weight:900}
    .wrap{max-width:1400px;margin:0 auto;padding:14px;display:grid;gap:12px}
    .card{background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:14px;padding:12px}
    .btn{border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:rgba(255,255,255,.06);border:1px solid var(--line);color:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}

    /* Preview */
    .previewWrap{
      background:#fff; color:#000;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      padding:14px;
      overflow:auto;
      max-height:75vh;
    }

    /* Tabla renderizada */
    table.xl{
      border-collapse:collapse;
      table-layout:fixed;
      width:max-content; /* permite ancho natural por columnas */
      background:#fff;
    }
    table.xl td{
      padding:2px 4px;
      vertical-align:middle;
      overflow:hidden;
      white-space:nowrap; /* Excel default */
    }
  </style>
</head>

<body>
<header>
  <h1>Renderizador Excel (.xlsx) — Vista fiel</h1>
  <div class="row">
    <button class="btn primary" id="btnPick">INSERTAR EXCEL</button>
    <button class="btn ghost" id="btnClear">LIMPIAR</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="muted">
      1) Presiona <b>INSERTAR EXCEL</b> y elige tu archivo .xlsx<br>
      2) Se renderiza la <b>primera hoja</b> manteniendo estilos (bordes, colores, fuentes, alineación, merges, anchos/altos).<br>
      Nota: elementos como gráficos/imagenes/figuras pueden no renderizarse igual.
    </div>
  </div>

  <div class="card">
    <div class="muted" id="status">Esperando archivo…</div>
  </div>

  <div class="previewWrap" id="preview">
    <div class="muted">Aquí aparecerá tu Excel renderizado.</div>
  </div>
</div>

<input id="file" type="file" accept=".xlsx" style="display:none" />

<script>
  const btnPick = document.getElementById("btnPick");
  const btnClear = document.getElementById("btnClear");
  const fileInp = document.getElementById("file");
  const preview = document.getElementById("preview");
  const statusEl = document.getElementById("status");

  btnPick.addEventListener("click", () => fileInp.click());
  btnClear.addEventListener("click", () => {
    preview.innerHTML = '<div class="muted">Aquí aparecerá tu Excel renderizado.</div>';
    statusEl.textContent = "Esperando archivo…";
    fileInp.value = "";
  });

  function argbToCss(argb){
    if(!argb) return "";
    // ARGB = AARRGGBB o RRGGBB (según fuente)
    let hex = String(argb).replace("#","").toUpperCase();
    if(hex.length === 8) hex = hex.slice(2); // quita AA
    if(hex.length !== 6) return "";
    return "#" + hex;
  }

  function borderToCss(b){
    if(!b) return "";
    // estilo básico: thin/medium/thick/double/dotted/dashed
    const styleMap = {
      thin: "1px solid",
      medium: "2px solid",
      thick: "3px solid",
      double: "3px double",
      dotted: "1px dotted",
      dashed: "1px dashed",
      hair: "1px solid"
    };
    const st = styleMap[b.style] || "1px solid";
    const col = argbToCss(b.color?.argb) || "#000000";
    return `${st} ${col}`;
  }

  function pxFromColWidth(w){
    // Excel width ~ caracteres. Aproximación a px:
    // 1 unidad ~ 7px + padding
    if(!w) return null;
    return Math.max(20, Math.round(w * 7 + 12));
  }

  function pxFromRowHeight(h){
    // Excel row height en points. 1pt ~ 1.333px
    if(!h) return null;
    return Math.max(12, Math.round(h * 1.333));
  }

  function buildMergeMap(ws){
    // ws._merges es interno, pero funciona en ExcelJS
    const map = new Map();
    const merges = ws._merges || new Map();
    merges.forEach((range) => {
      // range es tipo "A1:C3"
      const [start, end] = range.split(":");
      map.set(start, end);
    });
    return map;
  }

  function cellAddress(row, col){
    // ExcelJS tiene colToLetter interno; hacemos uno simple
    let c = col, s = "";
    while(c > 0){
      const m = (c - 1) % 26;
      s = String.fromCharCode(65 + m) + s;
      c = Math.floor((c - 1) / 26);
    }
    return s + row;
  }

  function parseAddress(addr){
    const m = String(addr).match(/^([A-Z]+)(\d+)$/);
    if(!m) return null;
    const letters = m[1];
    const row = parseInt(m[2], 10);
    let col = 0;
    for(const ch of letters){
      col = col * 26 + (ch.charCodeAt(0) - 64);
    }
    return {row, col};
  }

  function getSpan(startAddr, endAddr){
    const a = parseAddress(startAddr);
    const b = parseAddress(endAddr);
    if(!a || !b) return {rowspan:1, colspan:1};
    return { rowspan: (b.row - a.row + 1), colspan: (b.col - a.col + 1) };
  }

  async function renderExcel(arrayBuffer){
    const wb = new ExcelJS.Workbook();
    await wb.xlsx.load(arrayBuffer);

    const ws = wb.worksheets[0];
    if(!ws){
      preview.innerHTML = "<b>No hay hojas en este archivo.</b>";
      return;
    }

    statusEl.textContent = `Renderizando: Hoja "${ws.name}"…`;

    const mergeMap = buildMergeMap(ws);

    // Rango usado
    const maxRow = ws.actualRowCount || ws.rowCount || 1;
    const maxCol = ws.actualColumnCount || ws.columnCount || 1;

    // Matriz para saltar celdas cubiertas por merges (no master)
    const covered = new Set();

    // Tabla
    const table = document.createElement("table");
    table.className = "xl";

    // Colgroup (ancho columnas)
    const colgroup = document.createElement("colgroup");
    for(let c=1; c<=maxCol; c++){
      const col = document.createElement("col");
      const w = ws.getColumn(c).width;
      const px = pxFromColWidth(w);
      if(px) col.style.width = px + "px";
      colgroup.appendChild(col);
    }
    table.appendChild(colgroup);

    for(let r=1; r<=maxRow; r++){
      const tr = document.createElement("tr");
      const rowObj = ws.getRow(r);
      const rh = pxFromRowHeight(rowObj.height);
      if(rh) tr.style.height = rh + "px";

      for(let c=1; c<=maxCol; c++){
        const addr = cellAddress(r, c);
        if(covered.has(addr)) continue;

        const cell = ws.getCell(r, c);

        const td = document.createElement("td");

        // Merges
        const mergeEnd = mergeMap.get(addr);
        if(mergeEnd){
          const {rowspan, colspan} = getSpan(addr, mergeEnd);
          if(rowspan > 1) td.rowSpan = rowspan;
          if(colspan > 1) td.colSpan = colspan;

          // Marcar cubiertas (todas menos el master)
          const a = parseAddress(addr), b = parseAddress(mergeEnd);
          for(let rr=a.row; rr<=b.row; rr++){
            for(let cc=a.col; cc<=b.col; cc++){
              const a2 = cellAddress(rr, cc);
              if(a2 !== addr) covered.add(a2);
            }
          }
        }

        // Valor (texto)
        let value = cell.value;
        // Si es RichText
        if(value && typeof value === "object" && value.richText){
          value = value.richText.map(x => x.text).join("");
        }
        // Fórmulas (muestra resultado si existe)
        if(value && typeof value === "object" && value.formula){
          value = value.result ?? "";
        }
        td.textContent = (value ?? "").toString();

        // Estilos
        const st = cell.style || {};

        // Fuente
        if(st.font){
          const f = st.font;
          if(f.name) td.style.fontFamily = f.name;
          if(f.size) td.style.fontSize = f.size + "pt";
          if(f.bold) td.style.fontWeight = "700";
          if(f.italic) td.style.fontStyle = "italic";
          if(f.underline) td.style.textDecoration = "underline";
          const col = argbToCss(f.color?.argb);
          if(col) td.style.color = col;
        }

        // Relleno (fill)
        if(st.fill && st.fill.fgColor){
          const bg = argbToCss(st.fill.fgColor.argb);
          if(bg) td.style.background = bg;
        }

        // Alineación
        if(st.alignment){
          const al = st.alignment;
          if(al.horizontal) td.style.textAlign = al.horizontal; // left/center/right
          if(al.vertical) td.style.verticalAlign = al.vertical; // top/middle/bottom
          if(al.wrapText) td.style.whiteSpace = "normal";
        }

        // Bordes
        if(st.border){
          const b = st.border;
          if(b.top) td.style.borderTop = borderToCss(b.top);
          if(b.right) td.style.borderRight = borderToCss(b.right);
          if(b.bottom) td.style.borderBottom = borderToCss(b.bottom);
          if(b.left) td.style.borderLeft = borderToCss(b.left);
        }else{
          // Si no hay bordes, no forzamos (Excel muchas veces tiene celdas sin borde)
        }

        tr.appendChild(td);
      }
      table.appendChild(tr);
    }

    preview.innerHTML = "";
    preview.appendChild(table);

    statusEl.textContent = `Listo ✅ Hoja "${ws.name}" renderizada.`;
  }

  fileInp.addEventListener("change", async () => {
    const file = fileInp.files?.[0];
    if(!file) return;

    statusEl.textContent = "Leyendo archivo…";
    const reader = new FileReader();
    reader.onload = async (e) => {
      try{
        await renderExcel(e.target.result);
      }catch(err){
        console.error(err);
        statusEl.textContent = "Error al renderizar.";
        preview.innerHTML = `<div style="color:#b91c1c;font-weight:800">No se pudo renderizar el Excel. Revisa consola o envíame ese archivo para ajustarlo.</div>`;
      }
    };
    reader.readAsArrayBuffer(file);
  });
</script>
</body>
</html>
