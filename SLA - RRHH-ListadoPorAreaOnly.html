<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SLA | Listado por √Årea (RRHH)</title>
  <style>
    :root{
      --blue:#1e88e5;
      --navy:#0d2f4f;
      --green:#2e7d32;
      --graybtn:#d9d9d9;
      --lightblue:#cfefff;
      --border:#dcdcdc;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#000}
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .wrap{max-width:980px;margin:0 auto;padding:10px 12px 24px}
    .topline{text-align:left;font-size:14px;padding:6px 0 8px;border-bottom:1px solid #ddd}
    .topline .email{color:var(--blue);text-decoration:underline}
    .navrow{display:flex;justify-content:space-between;align-items:flex-start;font-size:14px;padding:10px 0;min-height:26px}
    .navrow .left a{display:block;color:var(--green);text-decoration:none;margin:0 0 4px;cursor:pointer}
    .center{text-align:center}
    .title{margin:14px 0 10px;font-size:18px;color:var(--blue);letter-spacing:.5px}
    .logo{width:86px;height:86px;margin:8px auto 6px;display:block;object-fit:contain}
    .brand{font-weight:700;letter-spacing:.5px;margin:0;font-size:14px}
    .tagline{margin:0 0 8px;font-size:10px;letter-spacing:1px}
    .form{margin:14px auto 0;width:100%;max-width:520px}
    .row{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center;margin:10px 0}
    .row label{font-size:16px}
    input[type="text"],input[type="password"],select{
      width:100%;padding:8px 10px;border:1px solid #ccc;background:#eee;outline:none;font-size:15px;min-height:38px
    }
    select{background:#fff}
    .btn{
      display:block;width:260px;margin:10px auto;padding:8px 10px;border:1px solid #555;background:var(--graybtn);
      color:#000;font-weight:700;text-align:center;cursor:pointer;user-select:none
    }
    .btn.blue{background:var(--lightblue);border-color:#2a2a2a;color:#0b5aa5}

    .btn.green{background:#cfe8cf;border-color:#2a2a2a;color:#135e13}
    .btn.disabled{opacity:.55;pointer-events:none}
    .hidden{display:none !important}
    .btn:active{transform:scale(.99)}
    .linkCenter{text-align:center;margin-top:16px;color:var(--blue);text-decoration:underline;cursor:pointer;font-size:14px}

    .view{display:none}
    .view.active{display:block}

    .tableWrap{width:100%;overflow:auto;border:1px solid var(--border);margin-top:12px}
    table{width:100%;border-collapse:collapse;font-size:13px;min-width:720px}
    thead th{background:var(--navy);color:#fff;padding:6px 8px;text-align:left;white-space:nowrap}
    tbody td{border-bottom:1px solid #eee;padding:6px 8px;vertical-align:middle;white-space:nowrap}
    tbody tr:hover{background:#fafafa}

    @media (max-width:520px){
      .row{grid-template-columns:120px 1fr}
      .btn{width:100%}
      .wrap{padding:10px 10px 20px}
      table{min-width:680px}
    }
  </style>
</head>

<body class="safe">
  <div class="wrap">

    <section id="vLogin" class="view active">
      <div class="center">
        <div class="title">INICIAR SESI√ìN</div>
        <img class="logo" src="logo.png" alt="Oceantreasure Logo" onerror="this.style.display='none'">
        <p class="brand">OCEANTREASURE S.A.</p>
        <p class="tagline">100% ECUADORIAN QUALITY</p>
      </div>

      <div class="form">
        <div class="row">
          <label>Usuario:</label>
          <input id="loginEmail" type="text" autocomplete="username" />
        </div>
        <div class="row">
          <label>Contrase√±a:</label>
          <input id="loginPass" type="password" autocomplete="current-password" />
        </div>

        <div class="btn" id="btnLogin">ACCEDER</div>
        <div class="center" id="loginMsg" style="color:#b00020;font-size:13px;min-height:18px;"></div>
      </div>
    </section>

    <div id="authHeader" style="display:none;">
      <div class="topline">Usuario: <span class="email" id="userEmail"></span></div>
    </div>

    <section id="vListado" class="view">
      <div class="navrow">
        <div class="left">
          <a id="lnkLogout">Cerrar sesi√≥n</a>
        </div>
        <div class="right"></div>
      </div>

      <div class="center">
        <img class="logo" src="logo.png" alt="Oceantreasure Logo" onerror="this.style.display='none'">
        <p class="brand">OCEANTREASURE S.A.</p>
        <p class="tagline">100% ECUADORIAN QUALITY</p>
        <div class="title" style="margin-top:8px;">LISTADO DE PERSONAL POR √ÅREA</div>
      </div>

      <div class="form" style="max-width:620px;">
        <div class="row">
          <label>√Årea:</label>
          <select id="selArea">
            <option value=""></option>
            <option>MAQUINA</option>
            <option>PRECAJAS</option>
            <option>CONGELACION</option>
            <option>CAMARA</option>
            <option>RECEPCION</option>
            <option>CALIDAD</option>
            <option>PRODUCCION</option>
            <option>BODEGA</option>
            <option>AVANCE PA√ëALEO</option>
            <option>AVANCE DESCABEZADO</option>
            <option>APOYO DESCABEZADO</option>
          </select>
        </div>

        <div class="btn blue" id="btnBuscar">CONSULTAR</div>

        <div class="btn green disabled" id="btnExport">EXPORTAR EXCEL</div>

        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:8px;">
          <div style="font-size:13px;">Registros: <b id="lblCount">0</b></div>
          <div style="font-size:13px;">Orden: <b>APELLIDOS (A‚ÜíZ)</b></div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:160px;">ID</th>
                <th>APELLIDOS</th>
                <th>NOMBRES</th>
                <th>AREA</th>
                <th class="col-cuadrilla hidden">CUADRILLA</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="linkCenter" id="lnkLogout2">Cerrar sesi√≥n</div>
      </div>
    </section>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, getDocs }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMoLkSnnLowMagRNL7O6ttPo1FXd1URac",
      authDomain: "oceantreasure-app.firebaseapp.com",
      projectId: "oceantreasure-app",
      storageBucket: "oceantreasure-app.firebasestorage.app",
      messagingSenderId: "553014659258",
      appId: "1:553014659258:web:cfc30844a88433b7b79a83",
      measurementId: "G-HMMQKJY8NJ"
    };

    const app = initializeApp(firebaseConfig);

    const isAvanceDescabezado = (area)=>String(area||"").trim().toUpperCase() === "AVANCE DESCABEZADO";
    const setCuadrillaVisible = (show)=>{
      document.querySelectorAll(".col-cuadrilla").forEach(el=>{
        el.classList.toggle("hidden", !show);
      });
    };

    let lastRows = [];
    let lastArea = "";
    let lastShowCuadrilla = false;

    const toCSV = (rows, showCuadrilla)=>{
      const sep = ";";
      const cols = showCuadrilla
        ? ["ID","APELLIDOS","NOMBRES","AREA","CUADRILLA"]
        : ["ID","APELLIDOS","NOMBRES","AREA"];
      const escCSV = (v)=>{
        const s = String(v ?? "");
        const needs = /[;"\n\r]/.test(s);
        const q = s.replaceAll('"','""');
        return needs ? `"${q}"` : q;
      };
      const lines = [];
      lines.push(cols.join(sep));
      for(const r of rows){
        const base = [r.id, r.apellidos, r.nombres, r.area];
        if(showCuadrilla) base.push(r.cuadrilla || "");
        lines.push(base.map(escCSV).join(sep));
      }
      // BOM para Excel (UTF-8)
      return "\ufeff" + lines.join("\r\n");
    };

    const exportExcel = ()=>{
      if(!lastRows || lastRows.length === 0){
        alert("No hay datos para exportar.");
        return;
      }
      const now = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      const stamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
      const areaSafe = (lastArea || "AREA").replaceAll(" ","_").replaceAll("/","-");
      const filename = `SLA_Listado_${areaSafe}_${stamp}.csv`;

      const csv = toCSV(lastRows, lastShowCuadrilla);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2500);
    };
    const auth = getAuth(app);
    const db = getFirestore(app);

    const COL_SRH = "rrhh_talento";

    // üîê Si quieres permitir m√°s correos, agr√©galos aqu√≠:
    const ALLOWED = new Set([
      "rrhh@oceantreasure.local"
    ]);

    const $ = (id) => document.getElementById(id);

    const views = { login: $("vLogin"), listado: $("vListado") };

    function showView(name){
      Object.values(views).forEach(v => v.classList.remove("active"));
      views[name].classList.add("active");
    }
    function setHeaderVisible(v){ $("authHeader").style.display = v ? "block" : "none"; }
    function setUserEmail(email){ $("userEmail").textContent = email || ""; }
    async function doLogout(){ await signOut(auth); }

    $("btnLogin").onclick = async () => {
      $("loginMsg").textContent = "";
      const email = $("loginEmail").value.trim();
      const pass  = $("loginPass").value;
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(e){
        $("loginMsg").textContent = "Error: usuario o contrase√±a incorrectos.";
      }
    };
    ["loginEmail","loginPass"].forEach(id=>{
      $(id).addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnLogin").click(); });
    });

    $("lnkLogout").onclick = doLogout;
    $("lnkLogout2").onclick = doLogout;
    $("btnExport").onclick = exportExcel;

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        const email = user.email || "";
        setHeaderVisible(true);
        setUserEmail(email);

        if(ALLOWED.size && !ALLOWED.has(email)){
          alert("Acceso no autorizado.");
          await doLogout();
          return;
        }

        $("tbody").innerHTML = "";
        $("lblCount").textContent = "0";
        $("selArea").value = "";
        showView("listado");
      } else {
        setHeaderVisible(false);
        setUserEmail("");
        showView("login");
    $("btnExport").classList.add("disabled");
    setCuadrillaVisible(false);
      }
    });

    $("btnBuscar").onclick = async () => {
      const area = $("selArea").value || "";
      if(!area){ alert("Seleccione un √ÅREA."); return; }

      $("tbody").innerHTML = "";
      $("lblCount").textContent = "0";

      const q = query(
        collection(db, COL_SRH),
        where("areaTrabajo","==", area),
        orderBy("apellidos","asc"),
        orderBy("nombres","asc")
      );

      let snap;
      try{
        snap = await getDocs(q);
      }catch(err){
        alert("Firestore pidi√≥ crear un √çNDICE para esta consulta. En la consola te aparecer√° un link 'Create index'.");
        throw err;
      }

      const rows = [];
      snap.forEach(d=>{
        const x = d.data() || {};
        rows.push({
          id: x.id || d.id,
          apellidos: x.apellidos || "",
          nombres: x.nombres || "",
          area: x.areaTrabajo || "",
          cuadrilla: x.cuadrilla || ""
        });
      });

      if(rows.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="${showCuadrilla ? 5 : 4}">No hay registros para esta √°rea.</td>`;
        $("tbody").appendChild(tr);
        return;
      }

      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(r.id)}</td>
          <td>${esc(r.apellidos)}</td>
          <td>${esc(r.nombres)}</td>
          <td>${esc(r.area)}</td>
          <td class="col-cuadrilla ${showCuadrilla ? "" : "hidden"}">${esc(r.cuadrilla || "")}</td>
        `;
        $("tbody").appendChild(tr);
      }

      $("lblCount").textContent = String(rows.length);
      lastRows = rows;
      $("btnExport").classList.toggle("disabled", rows.length === 0);
    };

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  </script>
</body>
</html>
