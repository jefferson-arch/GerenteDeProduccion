<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acceso — Oceantreasure</title>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;margin:0}
    .box{max-width:420px;margin:40px auto;background:#fff;border:1px solid #dde3ea;border-radius:12px;padding:16px}
    h2{margin:0 0 12px}
    input{width:100%;padding:10px;border:1px solid #dde3ea;border-radius:10px;margin:8px 0}
    button{width:100%;padding:10px;border:0;border-radius:10px;background:#0b2d4d;color:#fff;font-weight:800;cursor:pointer}
    .err{color:#b00020;font-size:12px;margin-top:10px}
  </style>

  <script type="module" src="firebase-init.js"></script>
</head>
<body>
  <div class="box">
    <h2>Iniciar sesión</h2>
    <form id="f">
      <input id="email" type="email" placeholder="Correo" required />
      <input id="pass" type="password" placeholder="Clave" required />
      <button type="submit">Ingresar</button>
      <div id="msg" class="err"></div>
    </form>
  </div>

  <script type="module">
    const V = "10.12.5";
    import { signInWithEmailAndPassword } from `https://www.gstatic.com/firebasejs/${V}/firebase-auth.js`;
    import { doc, getDoc } from `https://www.gstatic.com/firebasejs/${V}/firebase-firestore.js`;

    const params = new URLSearchParams(location.search);
    const next = params.get("next") || "index.html";

    // Al loguear, bajamos la nube y luego redirigimos
    async function pull(uid){
      const ref = doc(window.OT.db, "users", uid, "state", "localStorage");
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      const data = snap.data().data || {};
      // Restaurar solo llaves esperadas (si quieres añadir más, agrégalas aquí también)
      const allow = ["usuariosSistema","registrosCompra","catalogoCompradores","catalogoProveedores","catalogoSectores"];
      for (const k of allow){
        if (k in data) localStorage.setItem(k, data[k]);
      }
    }

    document.getElementById("f").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      const pass  = document.getElementById("pass").value;

      try {
        const cred = await signInWithEmailAndPassword(window.OT.auth, email, pass);

        // legacy session para tus módulos
        sessionStorage.setItem("authOk", "1");
        sessionStorage.setItem("authUser", email);
        sessionStorage.setItem("authRole", "ADMINISTRADOR");

        await pull(cred.user.uid);

        location.href = next;
      } catch (err) {
        document.getElementById("msg").textContent = "Error: " + (err?.message || "Login falló");
      }
    });
  </script>
</body>
</html>
