<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SAC | Análisis Organoléptico Materia Prima</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2f;
      --panel2:#0c1527;
      --line:rgba(255,255,255,.12);
      --txt:#e5e7eb;
      --muted:rgba(229,231,235,.75);
      --accent:#60a5fa;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:#111c32;
      --input:#0b1426;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background:linear-gradient(180deg, var(--bg), #050a14 70%);
      color:var(--txt);
    }
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    header{
      padding:14px 14px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.25);
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(8px);
    }
    header .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:16px;font-weight:800;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:4px}
    .wrap{max-width:1250px;margin:0 auto;padding:12px}
    .card{
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .grid{display:grid;gap:12px}
    .grid.cols2{grid-template-columns: 1fr 1fr}
    @media (max-width: 980px){ .grid.cols2{grid-template-columns:1fr} }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tabbtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--txt);
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .tabbtn.active{background:rgba(96,165,250,.18);border-color:rgba(96,165,250,.55)}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
    }
    .btn.primary{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.55)}
    .btn.danger{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.55)}
    .btn.accent{background:rgba(96,165,250,.16);border-color:rgba(96,165,250,.55)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .login{
      max-width:520px;margin:18px auto;
      padding:14px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
    }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:700}
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      outline:none;
      background:var(--input);
      color:var(--txt);
      font-size:13px;
    }
    input[type="time"]{padding:8px 10px}
    textarea{min-height:72px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > .field{flex:1;min-width:180px}
    .row > .field.sm{min-width:140px;flex:0 0 140px}
    .row > .field.md{min-width:220px}
    .row > .field.lg{min-width:320px}
    .help{font-size:12px;color:var(--muted);margin-top:6px}
    .err{color:#fecaca;font-size:12px;margin-top:8px;white-space:pre-wrap}
    .ok{color:#bbf7d0;font-size:12px;margin-top:8px;white-space:pre-wrap}

    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border:1px solid rgba(255,255,255,.12);padding:6px 6px;vertical-align:middle}
    th{background:rgba(255,255,255,.06);text-align:center;font-weight:900}
    td{background:rgba(0,0,0,.12)}
    .tcenter{text-align:center}
    .tright{text-align:right}
    .tleft{text-align:left}
    .tiny{font-size:11px;color:var(--muted)}
    .section-title{
      margin:0 0 8px 0;
      font-size:13px;
      font-weight:900;
      letter-spacing:.3px;
      color:#dbeafe;
      display:flex;align-items:center;gap:8px;
    }
    .pill{padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--muted);font-size:11px;font-weight:800}
    .split{
      display:grid;grid-template-columns: 1.2fr .8fr;gap:12px;
    }
    @media (max-width: 980px){ .split{grid-template-columns:1fr} }

    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* Print */
    @media print{
      body{background:#fff;color:#000}
      header, .no-print{display:none !important}
      .wrap{max-width:none;padding:0}
      .card{box-shadow:none;border:1px solid #bbb;background:#fff}
      th,td{border:1px solid #444;color:#000}
      th{background:#eaeaea}
      input,select,textarea{border:0;background:transparent;color:#000;padding:0}
      .pill{border:1px solid #666;background:#fff;color:#000}
    }
  </style>
</head>
<body>
  <div class="safe">
    <header class="no-print">
      <div class="row">
        <div>
          <h1>SAC | Análisis Organoléptico (Materia Prima)</h1>
          <div class="sub">Plantilla web basada en tu Excel/PDF • Firestore + Login</div>
        </div>
        <div class="top-actions">
          <button id="btnLogout" class="btn danger" style="display:none">Salir</button>
        </div>
      </div>
    </header>

    <div class="wrap">

      <!-- LOGIN -->
      <div id="loginBox" class="login">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:900;font-size:14px">Ingresar</div>
            <div class="help">Acceso restringido a usuarios autorizados.</div>
          </div>
          <div class="pill mono" id="envHint">Firestore</div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div class="field">
            <label for="email">Correo</label>
            <input id="email" type="email" autocomplete="username" placeholder="usuario@oceantreasure.local" />
          </div>
          <div class="field">
            <label for="password">Contraseña</label>
            <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />
          </div>
        </div>
        <div style="height:10px"></div>
        <button id="btnLogin" class="btn primary" style="width:100%">INGRESAR</button>
        <div id="loginMsg" class="err" style="display:none"></div>
      </div>

      <!-- APP -->
      <div id="app" style="display:none" class="grid">

        <div class="card no-print">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="tabs">
              <button class="tabbtn active" data-tab="crear">CREAR</button>
              <button class="tabbtn" data-tab="presentar">PRESENTAR TABLA</button>
            </div>
            <div class="top-actions">
              <button id="btnNuevo" class="btn">NUEVO</button>
              <button id="btnGuardar" class="btn primary">GUARDAR</button>
              <button id="btnPdf" class="btn accent">PDF</button>
            </div>
          </div>
          <div class="help">Tip: usa TAB y Enter sin miedo. Los cálculos se actualizan solos.</div>
          <div id="saveMsg" class="ok" style="display:none"></div>
          <div id="saveErr" class="err" style="display:none"></div>
        </div>

        <!-- TAB CREAR -->
        <div id="tab-crear" class="grid">
          <div class="card">
            <div class="section-title">ANÁLISIS ORGANOLÉPTICO <span class="pill">Encabezado</span></div>

            <div class="row">
              <div class="field sm">
                <label>Fecha</label>
                <input id="fecha" type="date">
              </div>
              <div class="field md">
                <label>Proveedor</label>
                <input id="proveedor" placeholder="Oceanmar">
              </div>
              <div class="field md">
                <label>Origen</label>
                <input id="origen" placeholder="Durán">
              </div>
              <div class="field sm">
                <label>Hora de llegada</label>
                <input id="horaLlegada" type="time">
              </div>
            </div>

            <div class="row">
              <div class="field sm">
                <label>Carta de garantía</label>
                <select id="cartaGarantia">
                  <option value="">—</option>
                  <option>Sí</option>
                  <option>No</option>
                </select>
              </div>
              <div class="field sm">
                <label>Temperatura</label>
                <input id="temperatura" placeholder="0,2°C">
              </div>
              <div class="field sm">
                <label>Hora de análisis</label>
                <input id="horaAnalisis" type="time">
              </div>
              <div class="field sm">
                <label>Número de guías</label>
                <input id="numGuias" inputmode="numeric" class="tright" placeholder="4455">
              </div>
              <div class="field sm">
                <label>Residual (ppm)</label>
                <input id="residual" inputmode="decimal" class="tright" placeholder="35">
              </div>
            </div>

            <div class="row">
              <div class="field sm">
                <label>Lote</label>
                <input id="lote" placeholder="0232">
              </div>
              <div class="field sm">
                <label>Secuencial</label>
                <input id="secuencial" inputmode="numeric" class="tright" placeholder="4460">
              </div>
              <div class="field sm">
                <label>Libras remitidas</label>
                <input id="librasRemitidas" inputmode="decimal" class="tright" placeholder="10000">
              </div>
              <div class="field sm">
                <label>Número de bines</label>
                <input id="numBines" inputmode="numeric" class="tright" placeholder="10">
              </div>
              <div class="field sm">
                <label>Número de piscina</label>
                <input id="numPiscina" placeholder="OM001">
              </div>
              <div class="field sm">
                <label>Color</label>
                <input id="color" placeholder="A3">
              </div>
            </div>

            <div class="row">
              <div class="field md">
                <label>Sabor</label>
                <input id="sabor" placeholder="NORMAL">
              </div>
              <div class="field md">
                <label>Olor</label>
                <input id="olor" placeholder="NORMAL">
              </div>
              <div class="field md">
                <label>Resultado</label>
                <input id="resultado" placeholder="Cola directa">
              </div>
              <div class="field lg">
                <label>Observación</label>
                <input id="observacion" placeholder="Variación de tallas">
              </div>
            </div>

            <div class="row">
              <div class="field md">
                <label>Controlador de pesca</label>
                <input id="controladorPesca" placeholder="Fulano de Tal">
              </div>
              <div class="field md">
                <label>Analista de Calidad</label>
                <input id="analistaCalidad" placeholder="Mengano Perengano">
              </div>
              <div class="field md">
                <label>Jefe de Calidad</label>
                <input id="jefeCalidad" placeholder="Pepe Pancho">
              </div>
              <div class="field md">
                <label>Jefe de Planta</label>
                <input id="jefePlanta" placeholder="Andrés Iniesta">
              </div>
              <div class="field md">
                <label>Gerente Producción</label>
                <input id="gerenteProduccion" placeholder="Lionel Messi">
              </div>
            </div>
          </div>

          <div class="card">
            <div class="section-title">ANÁLISIS CUALITATIVO <span class="pill">1C – 6C</span></div>
            <div class="help">Ingresa UNIDADES por muestra. El % se calcula con: unidades / total_muestra.</div>

            <div class="row">
              <div class="field"><label>Código 1C</label><input id="code1" value="GOE-7777"></div>
              <div class="field"><label>Código 2C</label><input id="code2" value="FOE-8888"></div>
              <div class="field"><label>Código 3C</label><input id="code3" value="GEE-9999"></div>
              <div class="field"><label>Código 4C</label><input id="code4" value="POE-3333"></div>
              <div class="field"><label>Código 5C</label><input id="code5" value="MEE-2222"></div>
              <div class="field"><label>Código 6C</label><input id="code6" value="GOI-5555"></div>
            </div>

            <div style="height:10px"></div>

            <div class="split">
              <div>
                <table id="tblCualitativo">
                  <thead>
                    <tr>
                      <th class="tleft">Descripción</th>
                      <th colspan="2">1C</th>
                      <th colspan="2">2C</th>
                      <th colspan="2">3C</th>
                      <th colspan="2">4C</th>
                      <th colspan="2">5C</th>
                      <th colspan="2">6C</th>
                    </tr>
                    <tr>
                      <th></th>
                      <th>Unid</th><th>%</th>
                      <th>Unid</th><th>%</th>
                      <th>Unid</th><th>%</th>
                      <th>Unid</th><th>%</th>
                      <th>Unid</th><th>%</th>
                      <th>Unid</th><th>%</th>
                    </tr>
                  </thead>
                  <tbody id="cualiBody"></tbody>
                  <tfoot>
                    <tr>
                      <th class="tleft">Defectos</th>
                      <th id="def1" class="tcenter"></th><th id="defp1" class="tcenter"></th>
                      <th id="def2" class="tcenter"></th><th id="defp2" class="tcenter"></th>
                      <th id="def3" class="tcenter"></th><th id="defp3" class="tcenter"></th>
                      <th id="def4" class="tcenter"></th><th id="defp4" class="tcenter"></th>
                      <th id="def5" class="tcenter"></th><th id="defp5" class="tcenter"></th>
                      <th id="def6" class="tcenter"></th><th id="defp6" class="tcenter"></th>
                    </tr>
                    <tr>
                      <th class="tleft">Buenos</th>
                      <th><input id="good1" class="tright" inputmode="numeric" value="75"></th><th id="goodp1" class="tcenter"></th>
                      <th><input id="good2" class="tright" inputmode="numeric" value="75"></th><th id="goodp2" class="tcenter"></th>
                      <th><input id="good3" class="tright" inputmode="numeric" value="75"></th><th id="goodp3" class="tcenter"></th>
                      <th><input id="good4" class="tright" inputmode="numeric" value="75"></th><th id="goodp4" class="tcenter"></th>
                      <th><input id="good5" class="tright" inputmode="numeric" value="75"></th><th id="goodp5" class="tcenter"></th>
                      <th><input id="good6" class="tright" inputmode="numeric" value="75"></th><th id="goodp6" class="tcenter"></th>
                    </tr>
                    <tr>
                      <th class="tleft">Total</th>
                      <th id="tot1" class="tcenter"></th><th class="tcenter">100%</th>
                      <th id="tot2" class="tcenter"></th><th class="tcenter">100%</th>
                      <th id="tot3" class="tcenter"></th><th class="tcenter">100%</th>
                      <th id="tot4" class="tcenter"></th><th class="tcenter">100%</th>
                      <th id="tot5" class="tcenter"></th><th class="tcenter">100%</th>
                      <th id="tot6" class="tcenter"></th><th class="tcenter">100%</th>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <div>
                <div class="card" style="padding:10px">
                  <div class="section-title" style="margin-bottom:6px">Resumen de muestra</div>
                  <div class="tiny">Estos valores alimentan el gramaje por muestra (2°C a 6°C) como en tu Excel.</div>

                  <div style="height:10px"></div>

                  <table>
                    <thead>
                      <tr><th class="tleft">Campo</th><th class="tcenter">1C</th><th class="tcenter">2C</th><th class="tcenter">3C</th><th class="tcenter">4C</th><th class="tcenter">5C</th><th class="tcenter">6C</th></tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="tleft">Kg muestra</td>
                        <td class="tcenter"><span id="kg1">—</span></td>
                        <td class="tcenter"><input id="kg2" class="tright" inputmode="decimal" value="2110"></td>
                        <td class="tcenter"><input id="kg3" class="tright" inputmode="decimal" value="2090"></td>
                        <td class="tcenter"><input id="kg4" class="tright" inputmode="decimal" value="2112"></td>
                        <td class="tcenter"><input id="kg5" class="tright" inputmode="decimal" value="2008"></td>
                        <td class="tcenter"><input id="kg6" class="tright" inputmode="decimal" value="2200"></td>
                      </tr>
                      <tr>
                        <td class="tleft">Total (unid)</td>
                        <td class="tcenter" id="totPieces1">—</td>
                        <td class="tcenter" id="totPieces2">—</td>
                        <td class="tcenter" id="totPieces3">—</td>
                        <td class="tcenter" id="totPieces4">—</td>
                        <td class="tcenter" id="totPieces5">—</td>
                        <td class="tcenter" id="totPieces6">—</td>
                      </tr>
                      <tr>
                        <td class="tleft">Gramaje</td>
                        <td class="tcenter" id="gram1">—</td>
                        <td class="tcenter" id="gram2">—</td>
                        <td class="tcenter" id="gram3">—</td>
                        <td class="tcenter" id="gram4">—</td>
                        <td class="tcenter" id="gram5">—</td>
                        <td class="tcenter" id="gram6">—</td>
                      </tr>
                      <tr>
                        <td class="tleft">Entero</td>
                        <td class="tcenter" id="ent1">—</td>
                        <td class="tcenter" id="ent2">—</td>
                        <td class="tcenter" id="ent3">—</td>
                        <td class="tcenter" id="ent4">—</td>
                        <td class="tcenter" id="ent5">—</td>
                        <td class="tcenter" id="ent6">—</td>
                      </tr>
                      <tr>
                        <td class="tleft">Cola</td>
                        <td class="tcenter" id="col1">—</td>
                        <td class="tcenter" id="col2">—</td>
                        <td class="tcenter" id="col3">—</td>
                        <td class="tcenter" id="col4">—</td>
                        <td class="tcenter" id="col5">—</td>
                        <td class="tcenter" id="col6">—</td>
                      </tr>
                    </tbody>
                  </table>

                  <div class="help">Nota: “Kg muestra 1C” se calcula desde el análisis cuantitativo: Σ(gramos × piezas).</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="section-title">ANÁLISIS CUANTITATIVO <span class="pill">Distribución por talla</span></div>
            <div class="help">Ingresa Gramos y Piezas. El sistema calcula Entero, Cola y el % por talla (SUMIFS / total piezas) igual al Excel.</div>

            <div style="overflow:auto">
              <table id="tblCuantitativo">
                <thead>
                  <tr>
                    <th>Gramos</th>
                    <th>Piezas</th>
                    <th>Entero</th>
                    <th>Cola</th>
                    <th>Talla (Entero)</th>
                    <th>%</th>
                    <th>Talla (Cola)</th>
                    <th>%</th>
                  </tr>
                </thead>
                <tbody id="cuantiBody"></tbody>
                <tfoot>
                  <tr>
                    <th class="tleft">Total</th>
                    <th id="qtTotalPiezas" class="tcenter"></th>
                    <th class="tcenter">VALORACIÓN</th>
                    <th></th>
                    <th id="valEntLabel" class="tcenter">Juvenil</th>
                    <th id="valEntPct" class="tcenter">—</th>
                    <th id="valColLabel" class="tcenter">Semilla</th>
                    <th id="valColPct" class="tcenter">—</th>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div style="height:10px"></div>

            <div class="card" style="padding:10px">
              <div class="section-title" style="margin-bottom:6px">Resumen general</div>
              <div class="row">
                <div class="field sm">
                  <label>Gramaje (1C)</label>
                  <input id="gramGeneral" class="tright" readonly>
                </div>
                <div class="field sm">
                  <label>Entero (1C)</label>
                  <input id="entGeneral" readonly>
                </div>
                <div class="field sm">
                  <label>Cola (1C)</label>
                  <input id="colGeneral" readonly>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- TAB PRESENTAR -->
        <div id="tab-presentar" style="display:none" class="grid">
          <div class="card no-print">
            <div class="section-title">PRESENTAR TABLA <span class="pill">Firestore</span></div>
            <div class="row">
              <div class="field sm">
                <label>Desde</label>
                <input id="fDesde" type="date">
              </div>
              <div class="field sm">
                <label>Hasta</label>
                <input id="fHasta" type="date">
              </div>
              <div class="field md">
                <label>Buscar (Secuencial / Lote / Proveedor)</label>
                <input id="fBuscar" placeholder="Ej: 4460">
              </div>
              <div class="field sm">
                <label>&nbsp;</label>
                <button id="btnRefrescar" class="btn">REFRESCAR</button>
              </div>
            </div>
            <div class="help">Click en un registro para cargarlo en CREAR.</div>
          </div>

          <div class="card" style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Secuencial</th>
                  <th>Lote</th>
                  <th>Proveedor</th>
                  <th>Origen</th>
                  <th>Lbs remitidas</th>
                  <th>Gramaje</th>
                  <th>Entero</th>
                  <th>Cola</th>
                  <th>Creado por</th>
                </tr>
              </thead>
              <tbody id="listBody"></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

<script type="module">
  /********************************************************************
   * 1) PEGA TU firebaseConfig AQUÍ (NO toco tu Database Config)
   ********************************************************************/
  const firebaseConfig = {
    // apiKey: "...",
    // authDomain: "...",
    // projectId: "...",
    // storageBucket: "...",
    // messagingSenderId: "...",
    // appId: "..."
  };

  /********************************************************************
   * 2) ACCESOS
   ********************************************************************/
  // Deja aquí los correos que SÍ pueden entrar.
  const ALLOWED_EMAILS = [
    // "analistamateriaprima@oceantreasure.local",
  ];

  /********************************************************************
   * 3) IMPORTS FIREBASE (v9 modular CDN)
   ********************************************************************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth, setPersistence, browserLocalPersistence,
    signInWithEmailAndPassword, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, doc, getDoc, getDocs, query, where, orderBy, limit,
    serverTimestamp, Timestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  /********************************************************************
   * 4) INIT
   ********************************************************************/
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Colección sugerida
  const COL = "sac_analisis_materia_prima";

  const $ = (id)=>document.getElementById(id);
  const loginBox = $("loginBox");
  const appBox = $("app");
  const loginMsg = $("loginMsg");
  const btnLogout = $("btnLogout");

  // Tabs
  document.querySelectorAll(".tabbtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      document.querySelectorAll(".tabbtn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      const t=b.dataset.tab;
      $("tab-crear").style.display = (t==="crear") ? "block" : "none";
      $("tab-presentar").style.display = (t==="presentar") ? "block" : "none";
      if(t==="presentar") refreshList();
    });
  });

  /********************************************************************
   * 5) UTILIDADES
   ********************************************************************/
  const toNum = (v)=> {
    if(v===null || v===undefined) return 0;
    const s = String(v).trim().replace(/\./g,"").replace(",",".");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };
  const fmtPct = (x)=>{
    if(!Number.isFinite(x)) return "";
    return Math.round(x*100) + "%";
  };
  const fmtNumEC = (n, dec=2)=>{
    if(!Number.isFinite(n)) return "";
    return n.toLocaleString("es-EC", {minimumFractionDigits:dec, maximumFractionDigits:dec});
  };
  const fmtIntEC = (n)=>{
    if(!Number.isFinite(n)) return "";
    return n.toLocaleString("es-EC", {maximumFractionDigits:0});
  };
  const todayISO = ()=>{
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,10);
  };

  function showMsg(okText="", errText=""){
    $("saveMsg").style.display = okText ? "block" : "none";
    $("saveErr").style.display = errText ? "block" : "none";
    $("saveMsg").textContent = okText || "";
    $("saveErr").textContent = errText || "";
  }

  /********************************************************************
   * 6) MAPEO DE TALLAS (igual al Excel)
   ********************************************************************/
  // Entero: basado en (1000 / gramaje)
  function tallaEnteroFromGram(gram){
    const x = 1000 / gram;
    if(!Number.isFinite(x) || x < 10) return "";
    if(x>=10 && x<=19.99) return "10-20";
    if(x>=20 && x<=29.99) return "20-30";
    if(x>=30 && x<=39.99) return "30-40";
    if(x>=40 && x<=49.99) return "40-50";
    if(x>=50 && x<=59.99) return "50-60";
    if(x>=60 && x<=69.99) return "60-70";
    if(x>=70 && x<=79.99) return "70-80";
    if(x>=80 && x<=99.99) return "80-100";
    if(x>=100 && x<=119.99) return "100-120";
    if(x>=120 && x<=149.99) return "120-150";
    if(x>=150 && x<=199.99) return "Juvenil";
    if(x>=200) return "Larva";
    return "";
  }

  // Cola: basado en (454 / (gramaje * 0.66))
  function tallaColaFromGram(gram){
    const x = 454 / (gram * 0.66);
    if(!Number.isFinite(x) || x <= 11.99) return "";
    if(x>=12 && x<15) return "U15";          // tal cual la fórmula del Excel
    if(x>=16 && x<20) return "16-20";
    if(x>=20 && x<25) return "21-25";
    if(x>=25 && x<30) return "26-30";
    if(x>=30 && x<35) return "31-35";
    if(x>=35 && x<40) return "36-40";
    if(x>=40 && x<50) return "41-50";
    if(x>=50 && x<60) return "51-60";
    if(x>=60 && x<70) return "61-70";
    if(x>=70 && x<90) return "71-90";
    if(x>=90 && x<110) return "91-110";
    if(x>=110 && x<130) return "111-130";
    if(x>=130 && x<150) return "Juvenil";
    if(x>=150) return "Larva";
    return "";
  }

  /********************************************************************
   * 7) TABLAS DINÁMICAS (cualitativo / cuantitativo)
   ********************************************************************/
  const CUALI_ITEMS = [
    "Flácido",
    "Mudado",
    "Cabezas rojas",
    "Cabezas flojas",
    "Cabezas estropeadas",
    "Cabezas descolgadas",
    "Cabezas anaranjadas",
    "Cabezas reventadas",
    "Picado",
    "Deshidratado",
    "Branquias sucias",
    "Quebrados",
    "Rosados",
    "Necrosis",
    "Ataque bacteriano",
    "Melanosis",
    "Deforme",
    "Camarón de leche",
  ];

  function buildCuali(){
    const tb = $("cualiBody");
    tb.innerHTML = "";
    CUALI_ITEMS.forEach((name, idx)=>{
      const tr=document.createElement("tr");
      const desc=document.createElement("td");
      desc.className="tleft";
      desc.textContent = name + ":";
      tr.appendChild(desc);

      for(let s=1;s<=6;s++){
        const tdU=document.createElement("td");
        tdU.className="tcenter";
        tdU.innerHTML = `<input data-cuali="${idx}" data-sample="${s}" class="tright" inputmode="numeric" value="${(name==="Flácido" && s===1)?5:""}" style="width:78px">`;
        const tdP=document.createElement("td");
        tdP.className="tcenter";
        tdP.innerHTML = `<span id="cualiP_${idx}_${s}" class="mono">—</span>`;
        tr.appendChild(tdU); tr.appendChild(tdP);
      }
      tb.appendChild(tr);
    });

    // listeners
    tb.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("input", recalcAll);
    });
    ["good1","good2","good3","good4","good5","good6","kg2","kg3","kg4","kg5","kg6"].forEach(id=>{
      $(id).addEventListener("input", recalcAll);
    });
  }

  const CUANTI_ROWS = [
    {g:17, p:20}, {g:16, p:10}, {g:15, p:25}, {g:14, p:10}, {g:13, p:10},
    {g:12, p:10}, {g:11, p:10}, {g:10, p:10}, {g:9, p:20}, {g:8, p:10}, {g:7, p:10},
  ];
  const TALLAS_ENTERO = ["10-20","20-30","30-40","40-50","50-60","60-70","70-80","80-100","100-120","120-150","Juvenil"];
  const TALLAS_COLA   = ["U15","16-20","21-25","26-30","31-35","36-40","41-50","51-60","61-70","71-90","91-110","111-130","Juvenil","Semilla"]; // "Semilla" se usa como etiqueta en el footer del Excel

  function buildCuanti(){
    const tb=$("cuantiBody");
    tb.innerHTML="";
    // Fila por talla (como Excel): una fila por GRAMOS/Piezas (inputs)
    CUANTI_ROWS.forEach((r,idx)=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td class="tcenter"><input data-q="g" data-i="${idx}" class="tright" inputmode="decimal" value="${r.g}" style="width:80px"></td>
        <td class="tcenter"><input data-q="p" data-i="${idx}" class="tright" inputmode="numeric" value="${r.p}" style="width:80px"></td>
        <td class="tcenter"><span id="qEnt_${idx}" class="mono">—</span></td>
        <td class="tcenter"><span id="qCol_${idx}" class="mono">—</span></td>
        <td class="tcenter"><select data-q="tEnt" data-i="${idx}" style="width:110px">${TALLAS_ENTERO.map(t=>`<option ${idx===0 && t==="10-20"?"selected":""}>${t}</option>`).join("")}</select></td>
        <td class="tcenter"><span id="qPctEnt_${idx}" class="mono">—</span></td>
        <td class="tcenter"><select data-q="tCol" data-i="${idx}" style="width:110px">${TALLAS_COLA.filter((t)=>t!=="Semilla").map(t=>`<option ${idx===0 && t==="16-20"?"selected":""}>${t}</option>`).join("")}</select></td>
        <td class="tcenter"><span id="qPctCol_${idx}" class="mono">—</span></td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("input,select").forEach(el=>el.addEventListener("input", recalcAll));
  }

  function getCuantiData(){
    const rows=[];
    for(let i=0;i<CUANTI_ROWS.length;i++){
      const g = toNum(document.querySelector(`input[data-q="g"][data-i="${i}"]`).value);
      const p = Math.max(0, Math.round(toNum(document.querySelector(`input[data-q="p"][data-i="${i}"]`).value)));
      const tEnt = document.querySelector(`select[data-q="tEnt"][data-i="${i}"]`).value;
      const tCol = document.querySelector(`select[data-q="tCol"][data-i="${i}"]`).value;
      rows.push({gramos:g, piezas:p, tallaEntTarget:tEnt, tallaColTarget:tCol});
    }
    return rows;
  }

  function sumPiezas(rows){ return rows.reduce((a,r)=>a+(Number.isFinite(r.piezas)?r.piezas:0),0); }

  /********************************************************************
   * 8) RECALC: cualitativo + cuantitativo + resumen muestra
   ********************************************************************/
  function recalcCuali(){
    // Totales por muestra
    const goods = [1,2,3,4,5,6].map(s=>Math.max(0, Math.round(toNum($("good"+s).value))));
    // Defectos por muestra
    const defects = [0,0,0,0,0,0];

    // recorre items
    CUALI_ITEMS.forEach((_, idx)=>{
      for(let s=1;s<=6;s++){
        const inp = document.querySelector(`input[data-cuali="${idx}"][data-sample="${s}"]`);
        const u = Math.max(0, Math.round(toNum(inp.value)));
        defects[s-1]+=u;
      }
    });

    // total = defects + goods
    const totals = defects.map((d,i)=>d + goods[i]);

    // set footer
    for(let s=1;s<=6;s++){
      const tot = totals[s-1];
      const def = defects[s-1];
      const good = goods[s-1];

      $("def"+s).textContent = def ? fmtIntEC(def) : "";
      $("tot"+s).textContent = tot ? fmtIntEC(tot) : "";

      $("defp"+s).textContent = (tot>0) ? fmtPct(def/tot) : "";
      $("goodp"+s).textContent = (tot>0) ? fmtPct(good/tot) : "";

      // cada línea %:
      CUALI_ITEMS.forEach((_, idx)=>{
        const inp = document.querySelector(`input[data-cuali="${idx}"][data-sample="${s}"]`);
        const u = Math.max(0, Math.round(toNum(inp.value)));
        const sp = $("cualiP_"+idx+"_"+s);
        sp.textContent = (tot>0 && u>0) ? fmtPct(u/tot) : "";
      });
    }

    // Totales de piezas por muestra (para gramaje)
    $("totPieces1").textContent = totals[0] ? fmtIntEC(totals[0]) : "—";
    $("totPieces2").textContent = totals[1] ? fmtIntEC(totals[1]) : "—";
    $("totPieces3").textContent = totals[2] ? fmtIntEC(totals[2]) : "—";
    $("totPieces4").textContent = totals[3] ? fmtIntEC(totals[3]) : "—";
    $("totPieces5").textContent = totals[4] ? fmtIntEC(totals[4]) : "—";
    $("totPieces6").textContent = totals[5] ? fmtIntEC(totals[5]) : "—";

    return {defects, goods, totals};
  }

  function recalcCuanti(){
    const rows=getCuantiData();
    const totalP = sumPiezas(rows);
    $("qtTotalPiezas").textContent = totalP ? fmtIntEC(totalP) : "";

    // calcula Entero/Cola por fila
    rows.forEach((r,i)=>{
      const ent = (r.gramos>0) ? tallaEnteroFromGram(r.gramos) : "";
      const col = (r.gramos>0) ? tallaColaFromGram(r.gramos) : "";
      $("qEnt_"+i).textContent = ent || "";
      $("qCol_"+i).textContent = col || "";
    });

    // calcula % por talla target (SUMIFS / total)
    rows.forEach((r,i)=>{
      const entTarget = r.tallaEntTarget || "";
      const colTarget = r.tallaColTarget || "";
      let sumEnt=0, sumCol=0;

      rows.forEach((rr,j)=>{
        const ent = $("qEnt_"+j).textContent;
        const col = $("qCol_"+j).textContent;
        if(entTarget && ent===entTarget) sumEnt += rr.piezas;
        if(colTarget && col===colTarget) sumCol += rr.piezas;
      });

      $("qPctEnt_"+i).textContent = (totalP>0 && sumEnt>0) ? fmtPct(sumEnt/totalP) : "";
      $("qPctCol_"+i).textContent = (totalP>0 && sumCol>0) ? fmtPct(sumCol/totalP) : "";
    });

    // Valorización (footer) como en Excel (suma de % de ciertas filas)
    // En el Excel: G51 = SUM(G43:G50) y I51 = SUM(I44:I50). Aquí replico con los targets:
    // - Entero: suma % de filas donde tallaEntTarget es "Juvenil"
    // - Cola:   suma % de filas donde tallaColTarget coincide con "Semilla" o "Juvenil" según tu ajuste
    // Para mantenerlo simple: mostramos el % de "Juvenil" en Entero y el % de "Semilla" en Cola (si existiera).
    const pctJuvenilEnt = (()=> {
      if(totalP<=0) return 0;
      let sum=0;
      rows.forEach((rr,j)=>{
        if($("qEnt_"+j).textContent==="Juvenil") sum += rr.piezas;
      });
      return sum/totalP;
    })();
    $("valEntPct").textContent = (pctJuvenilEnt>0) ? fmtPct(pctJuvenilEnt) : "";

    // "Semilla" no es una talla calculada en la fórmula Cola; se usa como etiqueta de valoración.
    // Mostramos el % total de Cola en rango 91-110 como referencia (puedes cambiarlo a tu criterio).
    const pctSemillaCol = (()=> {
      if(totalP<=0) return 0;
      let sum=0;
      rows.forEach((rr,j)=>{
        const col=$("qCol_"+j).textContent;
        if(col==="91-110") sum += rr.piezas;
      });
      return sum/totalP;
    })();
    $("valColPct").textContent = (pctSemillaCol>0) ? fmtPct(pctSemillaCol) : "";

    // Gramaje general (1C) = Σ(gramos*piezas) / totalP
    const totalGr = rows.reduce((a,rr)=>a + (rr.gramos*rr.piezas), 0);
    const gramGeneral = (totalP>0) ? (totalGr/totalP) : 0;
    $("gramGeneral").value = gramGeneral ? fmtNumEC(gramGeneral,2) : "";
    $("entGeneral").value = gramGeneral ? tallaEnteroFromGram(gramGeneral) : "";
    $("colGeneral").value = gramGeneral ? tallaColaFromGram(gramGeneral) : "";

    // Kg muestra 1C (en el Excel es totalGr en gramos)
    $("kg1").textContent = totalGr ? fmtNumEC(totalGr,2) : "—";

    // guarda para resumen
    return {rows, totalP, totalGr, gramGeneral};
  }

  function recalcMuestras(cuali){
    // gramaje por muestra: kgX / totX
    const kg = [
      toNum($("kg1").textContent),
      toNum($("kg2").value),
      toNum($("kg3").value),
      toNum($("kg4").value),
      toNum($("kg5").value),
      toNum($("kg6").value),
    ];
    const tot = cuali.totals;

    function setSample(i, gramEl, entEl, colEl){
      const g = (tot[i]>0) ? (kg[i]/tot[i]) : 0;
      $(gramEl).textContent = g ? fmtNumEC(g,2) : "—";
      $(entEl).textContent  = g ? tallaEnteroFromGram(g) : "—";
      $(colEl).textContent  = g ? tallaColaFromGram(g) : "—";
    }

    setSample(0,"gram1","ent1","col1");
    setSample(1,"gram2","ent2","col2");
    setSample(2,"gram3","ent3","col3");
    setSample(3,"gram4","ent4","col4");
    setSample(4,"gram5","ent5","col5");
    setSample(5,"gram6","ent6","col6");
  }

  function recalcAll(){
    const cuali = recalcCuali();
    recalcCuanti();
    recalcMuestras(cuali);
  }

  /********************************************************************
   * 9) NUEVO / PDF
   ********************************************************************/
  function clearForm(){
    showMsg();
    $("fecha").value = todayISO();
    ["proveedor","origen","temperatura","numPiscina","color","sabor","olor","resultado","observacion"].forEach(id=>$(id).value="");
    ["horaLlegada","horaAnalisis"].forEach(id=>$(id).value="");
    ["lote","secuencial","librasRemitidas","numBines","numGuias","residual"].forEach(id=>$(id).value="");

    $("cartaGarantia").value="";
    ["controladorPesca","analistaCalidad","jefeCalidad","jefePlanta","gerenteProduccion"].forEach(id=>$(id).value="");

    // cualitativo inputs
    document.querySelectorAll("#cualiBody input").forEach(i=>i.value="");
    ["good1","good2","good3","good4","good5","good6"].forEach(id=>$(id).value="");

    // cuantitativo inputs (mantener plantilla)
    document.querySelectorAll('input[data-q="g"]').forEach((el,idx)=>el.value = CUANTI_ROWS[idx].g);
    document.querySelectorAll('input[data-q="p"]').forEach((el,idx)=>el.value = CUANTI_ROWS[idx].p);

    // kg muestra otros
    $("kg2").value=""; $("kg3").value=""; $("kg4").value=""; $("kg5").value=""; $("kg6").value="";

    recalcAll();
  }

  $("btnNuevo").addEventListener("click", clearForm);

  $("btnPdf").addEventListener("click", ()=>{
    const sec = $("secuencial").value || "SN";
    const fecha = $("fecha").value || todayISO();
    const oldTitle = document.title;
    document.title = `ANALISIS_ORGANOLEPTICO_${sec}_${fecha}`;
    window.print();
    setTimeout(()=>document.title=oldTitle, 500);
  });

  /********************************************************************
   * 10) GUARDAR / LISTAR
   ********************************************************************/
  function collectPayload(userEmail){
    // cuali
    const cuali = CUALI_ITEMS.map((name, idx)=>{
      const samples = [];
      for(let s=1;s<=6;s++){
        const inp = document.querySelector(`input[data-cuali="${idx}"][data-sample="${s}"]`);
        samples.push(Math.max(0, Math.round(toNum(inp.value))));
      }
      return {name, samples};
    });

    const goods = [1,2,3,4,5,6].map(s=>Math.max(0, Math.round(toNum($("good"+s).value))));
    const kg = [
      toNum($("kg1").textContent),
      toNum($("kg2").value),
      toNum($("kg3").value),
      toNum($("kg4").value),
      toNum($("kg5").value),
      toNum($("kg6").value),
    ];

    const cuanti = getCuantiData().map((r,i)=>({
      gramos: r.gramos,
      piezas: r.piezas,
      entero: $("qEnt_"+i).textContent || "",
      cola: $("qCol_"+i).textContent || "",
      tallaEntTarget: r.tallaEntTarget || "",
      pctEnt: $("qPctEnt_"+i).textContent || "",
      tallaColTarget: r.tallaColTarget || "",
      pctCol: $("qPctCol_"+i).textContent || "",
    }));

    const meta = {
      fecha: $("fecha").value || todayISO(),
      proveedor: $("proveedor").value.trim(),
      origen: $("origen").value.trim(),
      horaLlegada: $("horaLlegada").value,
      cartaGarantia: $("cartaGarantia").value,
      temperatura: $("temperatura").value.trim(),
      horaAnalisis: $("horaAnalisis").value,
      numGuias: $("numGuias").value.trim(),
      residual: $("residual").value.trim(),
      lote: $("lote").value.trim(),
      secuencial: $("secuencial").value.trim(),
      librasRemitidas: $("librasRemitidas").value.trim(),
      numBines: $("numBines").value.trim(),
      numPiscina: $("numPiscina").value.trim(),
      color: $("color").value.trim(),
      sabor: $("sabor").value.trim(),
      olor: $("olor").value.trim(),
      resultado: $("resultado").value.trim(),
      observacion: $("observacion").value.trim(),

      controladorPesca: $("controladorPesca").value.trim(),
      analistaCalidad: $("analistaCalidad").value.trim(),
      jefeCalidad: $("jefeCalidad").value.trim(),
      jefePlanta: $("jefePlanta").value.trim(),
      gerenteProduccion: $("gerenteProduccion").value.trim(),

      codigos: {
        c1: $("code1").value.trim(),
        c2: $("code2").value.trim(),
        c3: $("code3").value.trim(),
        c4: $("code4").value.trim(),
        c5: $("code5").value.trim(),
        c6: $("code6").value.trim(),
      }
    };

    // resumen calculado
    const tot = {
      // totales cuali
      totalesMuestra: [1,2,3,4,5,6].map(s=>toNum($("tot"+s).textContent)),
      defects: [1,2,3,4,5,6].map(s=>toNum($("def"+s).textContent)),
      buenos: goods,
      kgMuestra: kg,
      gramajeMuestra: [1,2,3,4,5,6].map(s=>toNum($("gram"+s).textContent)),
      enteroMuestra: [1,2,3,4,5,6].map(s=>($("ent"+s).textContent==="—"?"":$("ent"+s).textContent)),
      colaMuestra:   [1,2,3,4,5,6].map(s=>($("col"+s).textContent==="—"?"":$("col"+s).textContent)),

      // general cuantitativo
      gramGeneral: $("gramGeneral").value,
      enteroGeneral: $("entGeneral").value,
      colaGeneral: $("colGeneral").value,

      valoracionEnt: $("valEntPct").textContent || "",
      valoracionCol: $("valColPct").textContent || "",
    };

    return {
      meta,
      cualitativo: {items:cuali, buenos:goods},
      cuantitativo: {rows: cuanti},
      resumen: tot,
      createdAt: serverTimestamp(),
      createdBy: userEmail
    };
  }

  async function saveCurrent(userEmail){
    showMsg();
    const sec = $("secuencial").value.trim();
    if(!sec){
      showMsg("", "Falta: Secuencial");
      return;
    }
    try{
      const payload = collectPayload(userEmail);
      await addDoc(collection(db, COL), payload);
      showMsg("Guardado correctamente ✅", "");
      // refresca lista si está en presentar
      const activeTab = document.querySelector(".tabbtn.active")?.dataset?.tab;
      if(activeTab==="presentar") refreshList();
    }catch(e){
      console.error(e);
      showMsg("", "Error al guardar:\n" + (e?.message || e));
    }
  }

  $("btnGuardar").addEventListener("click", async ()=>{
    const u = auth.currentUser;
    if(!u) return;
    await saveCurrent(u.email || "");
  });

  // Listado
  async function refreshList(){
    const tbody=$("listBody");
    tbody.innerHTML = `<tr><td colspan="10" class="tcenter muted">Cargando...</td></tr>`;

    try{
      const desde = $("fDesde").value;
      const hasta = $("fHasta").value;
      const buscar = ($("fBuscar").value || "").trim().toLowerCase();

      // query base: últimos 200
      const q1 = query(collection(db, COL), orderBy("createdAt","desc"), limit(200));
      const snap = await getDocs(q1);

      let rows=[];
      snap.forEach(d=>{
        const x=d.data();
        rows.push({id:d.id, ...x});
      });

      // filtros en cliente (simple y robusto)
      rows = rows.filter(r=>{
        const f = (r.meta?.fecha || "");
        if(desde && f && f < desde) return false;
        if(hasta && f && f > hasta) return false;

        if(buscar){
          const s = [
            r.meta?.secuencial, r.meta?.lote, r.meta?.proveedor
          ].join(" ").toLowerCase();
          if(!s.includes(buscar)) return false;
        }
        return true;
      });

      if(rows.length===0){
        tbody.innerHTML = `<tr><td colspan="10" class="tcenter muted">Sin resultados</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      rows.forEach(r=>{
        const tr=document.createElement("tr");
        tr.style.cursor="pointer";
        tr.title="Click para cargar";
        tr.innerHTML = `
          <td class="tcenter">${r.meta?.fecha || ""}</td>
          <td class="tcenter">${r.meta?.secuencial || ""}</td>
          <td class="tcenter">${r.meta?.lote || ""}</td>
          <td class="tleft">${r.meta?.proveedor || ""}</td>
          <td class="tleft">${r.meta?.origen || ""}</td>
          <td class="tright">${r.meta?.librasRemitidas || ""}</td>
          <td class="tcenter">${r.resumen?.gramGeneral || ""}</td>
          <td class="tcenter">${r.resumen?.enteroGeneral || ""}</td>
          <td class="tcenter">${r.resumen?.colaGeneral || ""}</td>
          <td class="tleft">${r.createdBy || ""}</td>
        `;
        tr.addEventListener("click", ()=> loadRecord(r));
        tbody.appendChild(tr);
      });
    }catch(e){
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="10" class="tcenter" style="color:#fecaca">Error: ${(e?.message||e)}</td></tr>`;
    }
  }

  $("btnRefrescar").addEventListener("click", refreshList);

  function loadRecord(r){
    showMsg("Registro cargado. Puedes imprimir PDF o guardar uno nuevo con otro secuencial.", "");

    // meta
    $("fecha").value = r.meta?.fecha || todayISO();
    $("proveedor").value = r.meta?.proveedor || "";
    $("origen").value = r.meta?.origen || "";
    $("horaLlegada").value = r.meta?.horaLlegada || "";
    $("cartaGarantia").value = r.meta?.cartaGarantia || "";
    $("temperatura").value = r.meta?.temperatura || "";
    $("horaAnalisis").value = r.meta?.horaAnalisis || "";
    $("numGuias").value = r.meta?.numGuias || "";
    $("residual").value = r.meta?.residual || "";
    $("lote").value = r.meta?.lote || "";
    $("secuencial").value = r.meta?.secuencial || "";
    $("librasRemitidas").value = r.meta?.librasRemitidas || "";
    $("numBines").value = r.meta?.numBines || "";
    $("numPiscina").value = r.meta?.numPiscina || "";
    $("color").value = r.meta?.color || "";
    $("sabor").value = r.meta?.sabor || "";
    $("olor").value = r.meta?.olor || "";
    $("resultado").value = r.meta?.resultado || "";
    $("observacion").value = r.meta?.observacion || "";

    $("controladorPesca").value = r.meta?.controladorPesca || "";
    $("analistaCalidad").value = r.meta?.analistaCalidad || "";
    $("jefeCalidad").value = r.meta?.jefeCalidad || "";
    $("jefePlanta").value = r.meta?.jefePlanta || "";
    $("gerenteProduccion").value = r.meta?.gerenteProduccion || "";

    $("code1").value = r.meta?.codigos?.c1 || "";
    $("code2").value = r.meta?.codigos?.c2 || "";
    $("code3").value = r.meta?.codigos?.c3 || "";
    $("code4").value = r.meta?.codigos?.c4 || "";
    $("code5").value = r.meta?.codigos?.c5 || "";
    $("code6").value = r.meta?.codigos?.c6 || "";

    // cuali
    const items = r.cualitativo?.items || [];
    items.forEach((it, idx)=>{
      for(let s=1;s<=6;s++){
        const inp = document.querySelector(`input[data-cuali="${idx}"][data-sample="${s}"]`);
        if(inp) inp.value = it.samples?.[s-1] ?? "";
      }
    });
    const buenos = r.cualitativo?.buenos || [];
    for(let s=1;s<=6;s++){
      $("good"+s).value = (buenos[s-1] ?? "");
    }

    // kg muestra 2..6
    const kg = r.resumen?.kgMuestra || [];
    $("kg2").value = kg[1] ?? "";
    $("kg3").value = kg[2] ?? "";
    $("kg4").value = kg[3] ?? "";
    $("kg5").value = kg[4] ?? "";
    $("kg6").value = kg[5] ?? "";

    // cuantitativo
    const qrows = r.cuantitativo?.rows || [];
    qrows.forEach((qr, i)=>{
      const gEl = document.querySelector(`input[data-q="g"][data-i="${i}"]`);
      const pEl = document.querySelector(`input[data-q="p"][data-i="${i}"]`);
      const tE = document.querySelector(`select[data-q="tEnt"][data-i="${i}"]`);
      const tC = document.querySelector(`select[data-q="tCol"][data-i="${i}"]`);
      if(gEl) gEl.value = qr.gramos ?? "";
      if(pEl) pEl.value = qr.piezas ?? "";
      if(tE && qr.tallaEntTarget) tE.value = qr.tallaEntTarget;
      if(tC && qr.tallaColTarget) tC.value = qr.tallaColTarget;
    });

    // volver a CREAR tab
    document.querySelector('.tabbtn[data-tab="crear"]').click();
    recalcAll();
  }

  /********************************************************************
   * 11) AUTH
   ********************************************************************/
  async function doLogin(){
    loginMsg.style.display="none";
    const email = $("email").value.trim();
    const pass = $("password").value;
    if(!email || !pass){
      loginMsg.textContent="Ingresa correo y contraseña.";
      loginMsg.style.display="block";
      return;
    }
    try{
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){
      console.error(e);
      loginMsg.textContent = "Error de login: " + (e?.message || e);
      loginMsg.style.display="block";
    }
  }

  $("btnLogin").addEventListener("click", doLogin);
  $("password").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  $("email").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

  btnLogout.addEventListener("click", async ()=>{
    await signOut(auth);
  });

  onAuthStateChanged(auth, (user)=>{
    if(!user){
      loginBox.style.display="block";
      appBox.style.display="none";
      btnLogout.style.display="none";
      return;
    }

    const email = (user.email || "").toLowerCase();
    const allowed = ALLOWED_EMAILS.length===0 || ALLOWED_EMAILS.map(x=>x.toLowerCase()).includes(email);
    if(!allowed){
      loginMsg.textContent = "Acceso denegado para: " + email;
      loginMsg.style.display="block";
      signOut(auth);
      return;
    }

    loginBox.style.display="none";
    appBox.style.display="grid";
    btnLogout.style.display="inline-block";

    // init
    if(!$("fecha").value) $("fecha").value=todayISO();
    recalcAll();
  });

  /********************************************************************
   * 12) BOOT
   ********************************************************************/
  buildCuali();
  buildCuanti();

  // fechas filtros por defecto
  const d = new Date();
  const iso = todayISO();
  $("fHasta").value = iso;
  const start = new Date(d.getTime() - 14*24*3600*1000);
  const off = start.getTimezoneOffset();
  const local = new Date(start.getTime() - off*60000);
  $("fDesde").value = local.toISOString().slice(0,10);

  // primera recalc
  recalcAll();
</script>
</body>
</html>
