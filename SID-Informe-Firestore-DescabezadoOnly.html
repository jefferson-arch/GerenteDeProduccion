<!doctype html>
<!-- SID - Informe-Firestore-DescabezadoOnly.html -->
<!-- BUILD_SID_INFORME_DESCABEZADO v1.6.6 FIX_PESO_COLA_LOAD_FROM_DB 2026-02-02 -->
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SID | Informe Descabezado</title>

  <link rel="icon" href="favicon.ico?v=1">

  <style>
    :root{
      --navy:#0d2f4f;
      --blue:#1e88e5;
      --grid:#b9c3cf;
      --hdr:#163a63;
      --hdr2:#1b4b7a;
      --white:#fff;
      --text:#111;
      --muted:#666;
      --danger:#b00020;
      --ok:#0b7a2a;
      --cellH:28px;
      --font: "Times New Roman", Times, serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:var(--text);font-family:var(--font)}
    .wrap{max-width:1180px;margin:0 auto;padding:10px 12px 18px}

    .view{display:none}
    .view.active{display:block}

    .topline{font-family:Arial,Helvetica,sans-serif;font-size:13px;padding:6px 0 10px;border-bottom:1px solid #ddd}
    .topline .email{color:var(--blue);text-decoration:underline}

    /* Banner conexión */
    #netBanner{display:none; position:sticky; top:0; z-index:9999; padding:10px 12px; font-family:Arial,Helvetica,sans-serif; font-weight:800; font-size:13px;}
    #netBanner.offline{background:#ffe5e5;color:#8a0016;border-bottom:1px solid #ffb3b3}
    #netBanner.online{background:#e8fff0;color:#0b5a2a;border-bottom:1px solid #b8f0c9}
    #netBanner .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle;}
    #netBanner.offline .dot{background:#d4001a}
    #netBanner.online .dot{background:#00a63a}

    /* Login */
    .loginBox{max-width:420px;margin:18px auto 0;border:1px solid #ddd;padding:14px}
    .loginTitle{font-family:Arial,Helvetica,sans-serif;text-align:center;color:var(--blue);font-weight:900;margin:0 0 10px}
    .row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center;margin:10px 0}
    label{font-family:Arial,Helvetica,sans-serif;font-size:14px}
    input[type="text"],input[type="password"],select,input[type="date"]{
      width:100%;padding:8px 10px;border:1px solid #ccc;background:#eee;outline:none;font-size:14px;min-height:38px;font-family:Arial,Helvetica,sans-serif;
    }
    select{background:#fff}
    .btn{
      display:inline-block;padding:8px 12px;border:1px solid #444;background:#efefef;cursor:pointer;
      font-family:Arial,Helvetica,sans-serif;font-weight:800;text-align:center;user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{background:#cfefff;color:#0b5aa5;border-color:#2a2a2a}
    .btn.danger{border-color:var(--danger);color:var(--danger)}
    .btn.disabled{opacity:.55;pointer-events:none;filter:grayscale(40%);}

    .pickBox{max-width:520px;margin:14px auto 0;border:1px solid #ddd;padding:14px}
    .brandCenter{text-align:center;margin:8px 0 12px}
    .logo{width:96px;height:96px;object-fit:contain;display:block;margin:0 auto}
    .brand{font-family:Arial,Helvetica,sans-serif;font-weight:900;margin:6px 0 0}
    .tagline{font-family:Arial,Helvetica,sans-serif;font-size:11px;letter-spacing:1px;margin:2px 0 0}

    /* Chips multi-cuadrilla */
    .chipWrap{margin-top:6px;display:flex;flex-wrap:wrap;gap:6px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid #999;background:#f7f7f7;
      padding:6px 10px;font-family:Arial,Helvetica,sans-serif;font-size:12px;font-weight:900;
      cursor:pointer; user-select:none;
    }
    .chip .x{
      display:inline-block;
      width:16px;height:16px;line-height:14px;
      border:1px solid #777;border-radius:3px;
      text-align:center;font-weight:900;
      background:#fff;
    }
    .chip:hover{background:#eee}
    .hint{margin-top:8px;line-height:1.35}

    .sheet{margin:10px auto 0;border:1px solid #ddd;padding:10px;background:#fff;}

    .topGrid{
      display:grid;
      grid-template-columns: 240px 1fr 120px 360px;
      gap:10px;
      align-items:start;
    }

    .logoBox{
      display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:flex-start;
      padding:4px 6px;
    }
    .logoBox .logoSmall{width:120px;height:70px;object-fit:contain;display:block}
    .logoBox .txt1{font-family:Arial,Helvetica,sans-serif;font-size:12px;font-weight:900;margin:0}
    .logoBox .txt2{font-family:Arial,Helvetica,sans-serif;font-size:10px;letter-spacing:1px;margin:0}

    .firmaBox{
      padding:4px 6px;
      min-height:90px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }
    .firmaImg{
      width:100%;
      max-width:520px;
      height:auto;
      display:none;
    }
    .firmaPlaceholder{
      width:100%;
      border:1px dashed #bbb;
      padding:10px;
      text-align:center;
      color:#666;
      font-family:Arial,Helvetica,sans-serif;
      font-size:12px;
    }

    .btnCol{display:flex;flex-direction:column;gap:10px;align-items:stretch}
    .btnCol .btn{width:100%;background:#efefef}

    .panel{border:1px solid #333;font-family:var(--font);}
    .panel table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:16px;}
    .panel td{border:1px solid #333;padding:4px 6px;height:var(--cellH);vertical-align:middle;}
    .panel .k{background:var(--hdr);color:#fff;font-weight:900}
    .panel .k2{background:#7d7d7d;color:#fff;font-weight:900}
    .panel .v{background:#fff;text-align:right;font-weight:900}
    .panel .vBlue{background:var(--hdr);color:#fff;text-align:right;font-weight:900}
    .panel .vRed{color:#d4001a;font-weight:900;text-align:right}
    .panel .small{font-size:14px}

    .metaRow{
      display:flex;justify-content:space-between;align-items:center;
      margin-top:6px;font-family:var(--font);font-size:18px;font-weight:900;
    }
    .metaRow .left{display:flex;gap:10px;align-items:center;}
    .metaRow .inf{font-weight:900}
    .metaRow .infNum{font-weight:900;letter-spacing:1px}
    .metaRow .right{
      font-family:Arial,Helvetica,sans-serif;
      font-size:13px;color:#333;display:flex;gap:10px;align-items:center;
    }

    /* LOTES PROCESADOS */
    .lotesBox{margin-top:10px;border:1px solid #333;padding:10px 10px 8px;background:#fff;}
    .lotesHead{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px}
    .lotesTitle{font-family:Arial,Helvetica,sans-serif;font-weight:900;color:#111;letter-spacing:.5px}
    .lotesHint{font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#666;line-height:1.35;margin:0 0 8px}
    .lotesTblWrap{border:1px solid #999;overflow:auto}
    table.lotes{width:100%;border-collapse:collapse;table-layout:fixed;min-width:760px;font-size:16px;font-family:var(--font);}
    table.lotes th, table.lotes td{border:1px solid #333;padding:4px 6px;height:var(--cellH);vertical-align:middle;}
    table.lotes th{background:var(--hdr);color:#fff;font-weight:900;text-align:center}
    .lSec{width:160px}
    .lProv{width:420px}
    .lLbs{width:140px}
    .lAct{width:120px}
    .btnMini{padding:4px 10px; font-size:13px; font-weight:900;}
    .lInput{
      width:100%;
      border:none; outline:none;
      background:#fff;
      font-family:Arial,Helvetica,sans-serif;
      font-size:14px;
      font-weight:900;
    }
    .lCellMut{font-family:Arial,Helvetica,sans-serif;font-size:13px;font-weight:900;}
    .lNum{text-align:right;font-weight:900;}
    .lockedRow{background:#f2f2f2}

    .tblWrap{margin-top:10px;overflow:auto;border:1px solid #999}
    table.report{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      min-width:1120px;
      font-size:16px;
      font-family:var(--font);
    }
    table.report th, table.report td{
      border:1px solid #333;
      padding:3px 6px;
      height:var(--cellH);
      vertical-align:middle;
    }
    table.report thead th{
      background:var(--hdr);
      color:#fff;
      font-weight:900;
      text-align:center;
    }
    table.report thead .subHdr{
      background:var(--hdr2);
      color:#fff;
      font-weight:900;
    }

    .colNo{width:48px;text-align:center;font-weight:900}
    .colNomina{width:240px;text-align:left;font-weight:900}
    .colCuadrilla{width:160px;text-align:center;font-weight:900}
    .num{text-align:right;font-weight:900}
    .descuentoNeg{color:#d4001a;font-weight:900}
    .muted{color:#666;font-family:Arial,Helvetica,sans-serif;font-size:12px}
    .subRow td{background:#f2f2f2;font-weight:900;}

    /* HISTORIAL */
    .histBox{max-width:1180px;margin:10px auto 0;border:1px solid #ddd;padding:12px;background:#fff;}
    .histTitle{font-family:Arial,Helvetica,sans-serif;font-weight:900;color:#333;margin:0 0 10px}
    .histFilters{
      display:grid;
      grid-template-columns: 120px 1fr 120px 1fr 120px;
      gap:10px;
      align-items:center;
      margin:6px 0 10px;
      font-family:Arial,Helvetica,sans-serif;
    }
    .histFilters .btn{width:100%}
    .histTblWrap{border:1px solid #999;overflow:auto}
    table.hist{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      min-width:1500px;
      font-size:14px;
      font-family:Arial,Helvetica,sans-serif;
    }
    table.hist th, table.hist td{
      border:1px solid #333;
      padding:6px 6px;
      vertical-align:middle;
    }
    table.hist th{
      background:var(--hdr);
      color:#fff;
      font-weight:900;
      text-align:center;
    }
    .hDate{width:110px}
    .hNum{width:120px}
    .hCuad{width:220px}
    .hW{width:140px}
    .hDesc{width:130px}
    .hTot{width:130px}
    .hOpen{width:100px}
    .hDel{width:110px}

    @media (max-width:980px){
      .topGrid{grid-template-columns: 200px 1fr 120px 320px;}
      table.report{min-width:1200px}
      table.hist{min-width:1600px}
      table.lotes{min-width:820px}
    }
    @media (max-width:720px){
      .topGrid{grid-template-columns: 1fr; }
      .btnCol{flex-direction:row}
      .btnCol .btn{width:auto;flex:1}
      .panel{margin-top:6px}
      .histFilters{grid-template-columns: 1fr; }
      .lotesHead{flex-direction:column;align-items:stretch}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- LOGIN -->
    <section id="vLogin" class="view active">
      <div class="loginBox">
        <div class="loginTitle">SID | INFORME DESCABEZADO</div>
        <div class="brandCenter">
          <img class="logo" src="logo.png" alt="Oceantreasure" onerror="this.style.display='none'">
          <p class="brand">OCEANTREASURE S.A.</p>
          <p class="tagline">100% ECUADORIAN QUALITY</p>
        </div>

        <div class="row">
          <label>Usuario:</label>
          <input id="loginEmail" type="text" autocomplete="username" />
        </div>
        <div class="row">
          <label>Contraseña:</label>
          <input id="loginPass" type="password" autocomplete="current-password" />
        </div>

        <div class="btn primary" id="btnLogin">ACCEDER</div>
        <div id="loginMsg" style="min-height:18px;margin-top:8px;color:#b00020;font-family:Arial,Helvetica,sans-serif;font-size:13px;"></div>
        <div id="bootMsg" style="min-height:18px;color:#555;font-family:Arial,Helvetica,sans-serif;font-size:12px;"></div>
      </div>
    </section>

    <!-- HEADER -->
    <div id="authHeader" style="display:none;">
      <div class="topline">
        Usuario: <span class="email" id="userEmail"></span>
        &nbsp; | &nbsp; <span class="muted" id="userNameLabel"></span>
      </div>
    </div>

    <!-- NET BANNER -->
    <div id="netBanner"><span class="dot"></span><span id="netText"></span></div>

    <!-- SELECCIÓN CUADRILLA -->
    <section id="vPick" class="view">
      <div class="pickBox">
        <div class="brandCenter">
          <img class="logo" src="logo.png" alt="Oceantreasure" onerror="this.style.display='none'">
          <p class="brand">OCEANTREASURE S.A.</p>
          <p class="tagline">100% ECUADORIAN QUALITY</p>
        </div>

        <!-- Cuadrilla + -->
        <div class="row" id="rowCuadrillaPick" style="grid-template-columns:120px 1fr 44px;">
          <label>Cuadrilla</label>
          <select id="selCuadrilla">
            <option value=""></option>
            <option>OCEANTREASURE</option>
            <option>MAREPREX</option>
            <option>FELESMAR</option>
          </select>
          <div class="btn" id="btnAddCuadrilla" title="Agregar cuadrilla">+</div>
        </div>

        <!-- Chips -->
        <div id="cuadrillaChips" class="chipWrap"></div>
        <div class="muted hint" id="cuadrillaHint">
          Nota: Selecciona una cuadrilla y presiona <b>+</b> para agregarla al informe (máx. 10).
          Si no agregas ninguna, se usará solo la cuadrilla del selector.
          <br>Tip: Haz clic en una etiqueta para quitarla.
        </div>

        <div class="row" id="rowFechaPick" style="grid-template-columns:120px 1fr;">
          <label>Fecha</label>
          <input id="selFecha" type="date" />
        </div>

        <div class="row" id="rowCircuitoPick" style="grid-template-columns:120px 1fr;">
          <label>Circuito</label>
          <select id="selCircuito">
            <option value="1" selected>Circuito 1</option>
            <option value="2">Circuito 2</option>
          </select>
        </div>

        <!-- BUSCAR INFORME (pantalla Pick) -->
        <div id="pickBuscarBox" style="margin-top:12px;border-top:1px dashed #cfcfcf;padding-top:10px;">
          <div style="font-family:Arial,Helvetica,sans-serif;font-weight:900;color:#333;margin-bottom:8px;">
            BUSCAR INFORME
          </div>

          <div class="row" id="rowFindNumero" style="grid-template-columns:120px 1fr;">
            <label>N° Informe</label>
            <input id="findNumero" type="text" inputmode="numeric" />
          </div>

          <div class="row" id="rowFindFecha" style="grid-template-columns:120px 1fr;">
            <label>Fecha</label>
            <input id="findFecha" type="date" />
          </div>

          <div class="row" id="rowFindCircuito" style="grid-template-columns:120px 1fr;">
            <label>Circuito</label>
            <select id="findCircuito">
              <option value="1" selected>Circuito 1</option>
              <option value="2">Circuito 2</option>
            </select>
          </div>

          <div class="btn" id="btnBuscarPick">BUSCAR</div>

          <div class="muted" id="pickBuscarHint" style="margin-top:8px;line-height:1.35;">
            Tip: Si llenas <b>N° Informe</b>, se busca por número. Si lo dejas vacío, se busca por <b>Fecha + Circuito</b>.
          </div>
        </div>

        <!-- ACCIONES -->
        <div style="display:flex;gap:10px;margin-top:12px;">
          <div class="btn primary" id="btnCrear" style="flex:1;">CREAR INFORME</div>
          <div class="btn" id="btnHistorial" style="width:140px;">HISTORIAL</div>
        </div>

        <div class="btn" id="btnLogoutPick" style="margin-top:10px;">CERRAR SESIÓN</div>

        <div class="muted" style="margin-top:10px;line-height:1.35;">
          Nota: El informe carga automáticamente las pesadas del día seleccionado desde SDA (Firestore).
        </div>
      </div>
    </section>

    <!-- HISTORIAL -->
    <section id="vHist" class="view">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px;font-family:Arial,Helvetica,sans-serif;">
        <div style="display:flex;gap:12px;align-items:center;">
          <span class="btn" id="btnHistBack">VOLVER</span>
          <span class="btn" id="btnHistLogout">CERRAR SESIÓN</span>
        </div>
        <div class="muted" id="histStatus">—</div>
      </div>

      <div class="histBox">
        <div class="histTitle">HISTORIAL DE INFORMES</div>

        <div class="histFilters">
          <label style="font-weight:900;">DESDE</label>
          <input id="histDesde" type="date" />
          <label style="font-weight:900;">HASTA</label>
          <input id="histHasta" type="date" />
          <div class="btn" id="btnHistFiltrar">APLICAR</div>
        </div>

        <div class="histTblWrap">
          <table class="hist" id="tblHist">
            <thead>
              <tr>
                <th class="hDate">FECHA</th>
                <th class="hNum">N° INFORME</th>
                <th class="hCuad">CUADRILLA(S)</th>
                <th class="hW">LIBRAS COLA</th>
                <th class="hW">LIBRAS ENTERO</th>
                <th class="hW">LIBRAS CABEZA</th>
                <th class="hDesc">DESCUENTO</th>
                <th class="hTot">TOTAL</th>
                <th class="hOpen">ABRIR</th>
                <th class="hDel">ELIMINAR</th>
              </tr>
            </thead>
            <tbody id="tbodyHist"></tbody>
          </table>
        </div>

        <div class="muted" style="margin-top:10px;line-height:1.35;">
          Nota: “ELIMINAR” solo está disponible para el administrador.
        </div>
      </div>
    </section>

    <!-- REPORTE -->
    <section id="vReport" class="view">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px;font-family:Arial,Helvetica,sans-serif;">
        <div style="display:flex;gap:12px;align-items:center;">
          <span class="btn" id="btnBackPick">VOLVER</span>
          <span class="btn" id="btnLogoutReport">CERRAR SESIÓN</span>
        </div>
        <div class="muted" id="reportStatus">—</div>
      </div>

      <!-- Área imprimible -->
      <div id="reportSheet" class="sheet">
        <div class="topGrid">

          <!-- Logo -->
          <div class="logoBox" id="logoBox">
            <img class="logoSmall" src="logo.png" alt="Oceantreasure" onerror="this.style.display='none'">
            <p class="txt1">OCEANTREASURE S.A.</p>
            <p class="txt2">100% ECUADORIAN QUALITY</p>
          </div>

          <!-- Firma -->
          <div class="firmaBox" id="firmaBox">
            <div id="firmaPlaceholder" class="firmaPlaceholder">
              FIRMA ELECTRÓNICA<br>
              (Presione <b>FIRMAR</b>)
            </div>
            <img id="firmaImg" class="firmaImg" alt="Firma electrónica" />
          </div>

          <!-- Botones -->
          <div class="btnCol" id="btnCol">
            <div class="btn" id="btnFirmar">FIRMAR</div>
            <div class="btn" id="btnGuardar">GUARDAR</div>
            <div class="btn" id="btnPdf">PDF</div>
            <div class="btn" id="btnXls">EXCEL</div>
            <div class="btn" id="btnBuscar">BUSCAR</div>
          </div>

          <!-- Panel derecho -->
          <div class="panel" id="panelRight">
            <table>
              <tr>
                <td class="k">Peso Cola:</td>
                <td class="v">
                  <input id="pesoCola" type="text"
                    style="width:100%;border:none;outline:none;text-align:right;font-weight:900;font-family:var(--font);font-size:16px;background:#fff" value="">
                </td>
              </tr>
              <tr><td class="k">Elevado a Entero:</td><td class="vBlue" id="elevadoEntero">0,000</td></tr>
              <tr><td class="k">Cabeza posible:</td><td class="vBlue" id="cabezaPosible">0,000</td></tr>
              <tr><td class="k">Pesada de Cabezas:</td><td class="vBlue" id="pesadaCabezas">0,000</td></tr>
              <tr><td class="k2">Descuento</td><td class="v" id="descuentoTotal">0</td></tr>
              <tr><td class="k2">N° personas:</td><td class="v" id="numPersonas">0</td></tr>
              <tr><td class="k2">Descuento individual:</td><td class="v" id="descuentoIndividual">0</td></tr>
              <tr><td class="k small">Informe:</td><td class="vBlue" id="infoCircuito">Circuito 1</td></tr>
              <tr><td class="k small">Responsable:</td><td class="vBlue" id="infoResponsable">—</td></tr>

              <!-- Firma meta -->
              <tr><td class="k small">Firmado por:</td><td class="vBlue" id="infoFirmadoPor">—</td></tr>
              <tr><td class="k small">Firmado el:</td><td class="vBlue" id="infoFirmadoCuando">—</td></tr>
              <tr>
                <td class="k small">Dispositivo:</td>
                <td class="vBlue" id="infoFirmadoDevice" style="font-family:Arial,Helvetica,sans-serif;font-size:11px;line-height:1.15;word-break:break-word;">
                  —
                </td>
              </tr>
            </table>
          </div>
        </div>

        <div class="metaRow">
          <div class="left">
            <span class="inf">Informe N°:</span>
            <span class="infNum" id="infoNumero">—</span>
          </div>
          <div class="right">
            <span><b>Cuadrilla:</b> <span id="metaCuadrilla">—</span></span>
            <span><b>Fecha:</b> <span id="metaFecha">—</span></span>
          </div>
        </div>

        <!-- LOTES PROCESADOS -->
        <div id="lotesBox" class="lotesBox">
          <div class="lotesHead">
            <div class="lotesTitle">LOTES PROCESADOS</div>
            <div class="btn" id="btnProcesoTerminado" title="Bloquear la tabla de lotes">PROCESO TERMINADO</div>
          </div>
          <p class="lotesHint" id="lotesHint">
            Ingrese el <b>SECUENCIAL</b> y presione <b>Enter</b> (o salga del campo) para buscar <b>Proveedor</b> y <b>Libras</b> desde SPC.
            Luego presione <b>+</b> para bloquear esa fila y agregar una nueva.
          </p>

          <div class="lotesTblWrap">
            <table class="lotes" id="tblLotes">
              <thead>
                <tr>
                  <th class="lSec">SECUENCIAL</th>
                  <th class="lProv">PROVEEDOR</th>
                  <th class="lLbs">LIBRAS</th>
                  <th class="lAct">ACCIONES</th>
                </tr>
              </thead>
              <tbody id="tbodyLotes"></tbody>
            </table>
          </div>

          <div class="muted" id="lotesStatus" style="margin-top:8px;">—</div>
        </div>

        <div class="tblWrap">
          <table class="report" id="tblReport">
            <thead id="theadReport"></thead>
            <tbody id="tbodyReport"></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <!-- JS libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, EmailAuthProvider, reauthenticateWithCredential }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs, doc, setDoc, getDoc, updateDoc, deleteDoc,
      runTransaction, serverTimestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMoLkSnnLowMagRNL7O6ttPo1FXd1URac",
      authDomain: "oceantreasure-app.firebaseapp.com",
      projectId: "oceantreasure-app",
      storageBucket: "oceantreasure-app.firebasestorage.app",
      messagingSenderId: "553014659258",
      appId: "1:553014659258:web:cfc30844a88433b7b79a83",
      measurementId: "G-HMMQKJY8NJ"
    };

    // Helpers
    const $ = (id)=>document.getElementById(id);
    const safe = (id)=>document.getElementById(id) || null;

    function uiError(msg){
      const el = safe("loginMsg") || safe("bootMsg");
      if(el) el.textContent = msg;
    }
    window.addEventListener("error", (e)=>{
      uiError("Error de la página. Abre F12 > Console para ver el detalle.");
      console.error("JS Error:", e.error || e.message, e);
    });
    window.addEventListener("unhandledrejection", (e)=>{
      uiError("Error inesperado. Abre F12 > Console para ver el detalle.");
      console.error("Promise rejection:", e.reason, e);
    });

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const COL_SDA = "sda_avance_cabezas";
    const COL_SID = "sid_informe_descabezado";
    const COL_SID_COUNTER = "sid_informe_counters";

    /**
     * SPC (Programación):
     * No tenemos aquí el archivo SPC-Programacion-Firestore-YanelaOnly.html para leer el nombre exacto de la colección,
     * por eso probamos varios nombres comunes. Si tu colección se llama diferente, agrega el nombre aquí.
     */
    const SPC_COLLECTIONS = [
      "spc_programacion",
      "spc_programacion_diario",
      "spc_programacion_diaria",
      "spc_programa",
      "spc_programacion_planta",
      "spc_programacion_2025",
      "SPC",
      "spc"
    ];

    // ✅ Permisos base (incluye proveedores)
    const ALLOWED = new Set([
      "aracellytomala@oceantreasure.local",
      "keniacruz@oceantreasure.local",
      "gingervaldiviezo@oceantreasure.local",
      "pesadoradesalojo@oceantreasure.local",
      "vanesapacheco@oceantreasure.local",
      "jeffersonfigueroa@oceantreasure.local",
      "angiemareprex@oceantreasure.local",
      "solangefelesmar@oceantreasure.local"
    ]);

    // Supervisores
    const SUPERVISORS = new Set([
      "gingervaldiviezo@oceantreasure.local",
      "aracellytomala@oceantreasure.local"
    ]);

    const SIGN_ADMIN = "jeffersonfigueroa@oceantreasure.local";

    // ✅ Proveedores → cuadrilla fija y vista limitada
    const PROVIDERS = new Map([
      ["angiemareprex@oceantreasure.local", "MAREPREX"],
      ["solangefelesmar@oceantreasure.local", "FELESMAR"]
    ]);

    /**
     * FIRMA:
     * Coloca "firma.png" en la misma carpeta del HTML (en tu repo).
     */
    const SIGNATURE_DATA_URI = "";
    const SIGNATURE_FALLBACK_URL = "firma.png";

    function todayKey(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function nowStamp(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    }
    function fmt3(n){
      const x = Number(n)||0;
      return x.toLocaleString("es-EC",{minimumFractionDigits:3,maximumFractionDigits:3});
    }
    function fmt0(n){
      const x = Number(n)||0;
      return x.toLocaleString("es-EC",{minimumFractionDigits:0,maximumFractionDigits:0});
    }
    function parseEsNumber(s){
      const raw = String(s||"").trim();
      if(!raw) return NaN;
      const norm = raw.replaceAll(".","").replaceAll(","," .").replace(" .",".").replaceAll(" ","");
      const v = Number(norm);
      return Number.isFinite(v) ? v : NaN;
    }
    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function dateAddDays(yyyyMmDd, deltaDays){
      const [y,m,d] = String(yyyyMmDd).split("-").map(x=>Number(x||0));
      const dt = new Date(y, (m||1)-1, d||1);
      dt.setDate(dt.getDate() + deltaDays);
      const pad = (n)=>String(n).padStart(2,"0");
      return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
    }

    function shortDevice(){
      const ua = navigator.userAgent || "";
      const platform = navigator.platform || "";
      let os = "PC";
      if(/Windows NT 10\.0/.test(ua)) os = "Windows 10/11";
      if(/Windows NT 6\./.test(ua)) os = "Windows";
      if(/Android/.test(ua)) os = "Android";
      if(/iPhone/.test(ua)) os = "iPhone";
      if(/iPad/.test(ua)) os = "iPad";
      if(/Mac OS X/.test(ua) && !/iPhone|iPad/.test(ua)) os = "macOS";
      if(/Linux/.test(platform) && !/Android/.test(ua)) os = "Linux";

      let browser = "Navegador";
      if(/Edg\//.test(ua)) browser = "Edge";
      else if(/OPR\//.test(ua) || /Opera/.test(ua)) browser = "Opera";
      else if(/Chrome\//.test(ua) && !/Edg\//.test(ua) && !/OPR\//.test(ua)) browser = "Chrome";
      else if(/Firefox\//.test(ua)) browser = "Firefox";
      else if(/Safari\//.test(ua) && !/Chrome\//.test(ua) && !/Edg\//.test(ua)) browser = "Safari";

      return `${os} | ${browser}`;
    }
    function prettyWhen(iso){
      if(!iso) return "—";
      const d = new Date(iso);
      if(!Number.isFinite(d.getTime())) return "—";
      return d.toLocaleString("es-EC", {
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit"
      });
    }

    const views = { login:$("vLogin"), pick:$("vPick"), hist:$("vHist"), report:$("vReport") };
    function showView(name){
      Object.values(views).forEach(v=>v.classList.remove("active"));
      views[name].classList.add("active");
    }

    let currentUserEmail = "";
    let currentUserName = "";

    // ✅ Provider mode
    let providerMode = false;
    let providerCuadrilla = "";

    // MULTI CUADRILLAS (normal users)
    let selectedCuadrillas = [];
    let currentCuadrillas = [];

    let currentFecha = "";
    let currentCircuito = "1";

    // Estados del flujo
    let reportSaved = false;
    let reportSigned = false;
    let reportNumber = "";
    let reportDocId = "";

    // Firma meta
    let signedBy = "";
    let signedByName = "";
    let signedAt = "";
    let signedDevice = "";
    let signedUA = "";

    // Datos reporte
    let pesadasCols = [];
    let rows = []; // rows del doc (todas las cuadrillas)
    let subtotalPorPesada = new Map();
    let subtotal2Total = 0;

    let pesoCola = 0;
    let elevadoEntero = 0;
    let cabezaPosible = 0;
    let pesadaCabezas = 0;
    let descuentoTotal = 0;
    let numPersonas = 0;
    let descuentoIndividual = 0;

    // LOTES PROCESADOS (SPC)
    let lotes = []; // {secuencial, proveedor, libras, locked}
    let lotesFinalizado = false;
    const lotesCache = new Map(); // secuencial -> {proveedor,libras}

    // Listener en vivo del informe
    let unsubReport = null;

    // Internet detector
    let hasInternet = true;
    let lastInternetState = null;

    function isAdmin(){ return currentUserEmail === SIGN_ADMIN; }
    function isSupervisor(){ return SUPERVISORS.has(currentUserEmail); }

    function setBtnEnabled(id, enabled){
      const el = safe(id);
      if(!el) return;
      el.classList.toggle("disabled", !enabled);
    }

    function getDisplayRows(){
      if(providerMode){
        return (rows||[]).filter(r => String(r.cuadrilla||"").trim().toUpperCase() === providerCuadrilla);
      }
      return rows || [];
    }

    function computeDisplaySubtotals(dispRows){
      const subMap = new Map();
      let sub2 = 0;
      for(const c of (pesadasCols||[])){
        subMap.set(Number(c.pesadaNumero||0), 0);
      }
      for(const r of dispRows){
        sub2 += Number(r.subtotal2||0);
        for(const c of (pesadasCols||[])){
          const n = Number(c.pesadaNumero||0);
          const v = Number((r.byPesada||{})[n] || 0);
          subMap.set(n, (subMap.get(n)||0) + v);
        }
      }
      return { subMap, sub2 };
    }

    function setSignMetaUI(){
      const por = safe("infoFirmadoPor");
      const cuando = safe("infoFirmadoCuando");
      const dev = safe("infoFirmadoDevice");

      if(por) por.textContent = reportSigned ? (signedByName || (signedBy||"").split("@")[0] || "—") : "—";
      if(cuando) cuando.textContent = reportSigned ? prettyWhen(signedAt) : "—";
      if(dev) dev.textContent = reportSigned ? (signedDevice || "—") : "—";
    }

    function updateButtons(){
      // Provider: solo BUSCAR + PDF/EXCEL si firmado
      if(providerMode){
        setBtnEnabled("btnBuscar", true);
        setBtnEnabled("btnGuardar", false);
        setBtnEnabled("btnFirmar", false);
        setBtnEnabled("btnPdf", reportSigned);
        setBtnEnabled("btnXls", reportSigned);
        return;
      }

      // Normal:
      setBtnEnabled("btnBuscar", true);
      setBtnEnabled("btnGuardar", !reportSaved && hasInternet);
      setBtnEnabled("btnFirmar", reportSaved && !reportSigned && isAdmin() && hasInternet);
      setBtnEnabled("btnPdf", reportSigned);
      setBtnEnabled("btnXls", reportSigned);
    }

    function applyPesoColaPermission(){
      const inp = safe("pesoCola");
      if(!inp) return;

      // Provider: oculto panel completo, así que no aplica
      if(providerMode){
        inp.readOnly = true;
        inp.style.background = "#f3f3f3";
        return;
      }

      // Normal: editable solo antes de guardar
      const can = isSupervisor() || isAdmin() || (currentUserEmail==="keniacruz@oceantreasure.local") || (currentUserEmail==="pesadoradesalojo@oceantreasure.local") || (currentUserEmail==="vanesapacheco@oceantreasure.local");
      inp.readOnly = !can || reportSaved || reportSigned;
      inp.style.background = (inp.readOnly ? "#f3f3f3" : "#fff");
      inp.title = inp.readOnly ? "Bloqueado" : "Ingrese Peso Cola";
    }

    function setSignatureImg(){
      const img = $("firmaImg");
      const ph  = $("firmaPlaceholder");
      if(!img || !ph) return;

      const src = (SIGNATURE_DATA_URI && SIGNATURE_DATA_URI.startsWith("data:image/"))
        ? SIGNATURE_DATA_URI
        : SIGNATURE_FALLBACK_URL;

      img.onerror = ()=>{
        img.style.display = "none";
        ph.style.display  = "block";
      };
      img.src = src;
    }

    function applySignatureUI(){
      if(reportSigned){
        setSignatureImg();
        $("firmaImg").style.display = "block";
        $("firmaPlaceholder").style.display = "none";
      }else{
        $("firmaImg").style.display = "none";
        $("firmaPlaceholder").style.display = "block";
      }
      setSignMetaUI();
    }

    function applyProviderUI(){
      // Pantalla Pick
      if(providerMode){
        // Selector cuadrilla: solo 1 opción
        const sel = $("selCuadrilla");
        sel.innerHTML = `<option>${providerCuadrilla}</option>`;
        sel.value = providerCuadrilla;
        sel.disabled = true;

        // ocultar +, chips, hint, circuito, crear
        safe("btnAddCuadrilla") && (safe("btnAddCuadrilla").style.display = "none");
        safe("cuadrillaChips") && (safe("cuadrillaChips").style.display = "none");
        safe("cuadrillaHint") && (safe("cuadrillaHint").style.display = "none");
        safe("rowCircuitoPick") && (safe("rowCircuitoPick").style.display = "none");
        safe("btnCrear") && (safe("btnCrear").style.display = "none");

        // Buscar box: solo Fecha + Botón buscar
        safe("rowFindNumero") && (safe("rowFindNumero").style.display = "none");
        safe("rowFindCircuito") && (safe("rowFindCircuito").style.display = "none");
        const hint = safe("pickBuscarHint");
        if(hint) hint.textContent = "Tip: Selecciona la FECHA y presiona BUSCAR para ver el informe de tu cuadrilla.";

        // Fecha default
        $("findFecha").value = $("selFecha").value || todayKey();
      }else{
        // Restaurar normal (si cambia usuario en misma sesión)
        safe("btnAddCuadrilla") && (safe("btnAddCuadrilla").style.display = "");
        safe("cuadrillaChips") && (safe("cuadrillaChips").style.display = "");
        safe("cuadrillaHint") && (safe("cuadrillaHint").style.display = "");
        safe("rowCircuitoPick") && (safe("rowCircuitoPick").style.display = "");
        safe("btnCrear") && (safe("btnCrear").style.display = "");
        safe("rowFindNumero") && (safe("rowFindNumero").style.display = "");
        safe("rowFindCircuito") && (safe("rowFindCircuito").style.display = "");
        const hint = safe("pickBuscarHint");
        if(hint) hint.textContent = "Tip: Si llenas N° Informe, se busca por número. Si lo dejas vacío, se busca por Fecha + Circuito.";
      }

      // Pantalla Report
      if(providerMode){
        // Ocultar firma/panel para no ver totales globales
        safe("firmaBox") && (safe("firmaBox").style.display = "none");
        safe("panelRight") && (safe("panelRight").style.display = "none");

        // Ocultar botones de firmar/guardar
        safe("btnFirmar") && (safe("btnFirmar").style.display = "none");
        safe("btnGuardar") && (safe("btnGuardar").style.display = "none");

        // Ocultar LOTES PROCESADOS a usuarios limitados
        safe("lotesBox") && (safe("lotesBox").style.display = "none");
      }else{
        safe("firmaBox") && (safe("firmaBox").style.display = "");
        safe("panelRight") && (safe("panelRight").style.display = "");
        safe("btnFirmar") && (safe("btnFirmar").style.display = "");
        safe("btnGuardar") && (safe("btnGuardar").style.display = "");

        safe("lotesBox") && (safe("lotesBox").style.display = "");
      }
    }

    function showNetBanner(state, msg){
      const b = $("netBanner");
      const t = $("netText");
      if(!b || !t) return;
      b.style.display = "block";
      b.classList.toggle("offline", state==="offline");
      b.classList.toggle("online", state==="online");
      t.textContent = msg;
    }
    function hideNetBanner(){
      const b = $("netBanner");
      if(b) b.style.display = "none";
    }
    async function pingInternet(){
      const url = `https://www.gstatic.com/generate_204?ts=${Date.now()}`;
      try{
        const controller = new AbortController();
        const to = setTimeout(()=>controller.abort(), 3500);
        await fetch(url, {method:"GET", mode:"no-cors", signal: controller.signal});
        clearTimeout(to);
        return true;
      }catch(_){
        return false;
      }
    }
    async function refreshInternetStatus(){
      const netUp = navigator.onLine;
      if(!netUp) hasInternet = false;
      else hasInternet = await pingInternet();

      if(lastInternetState === hasInternet) return;
      lastInternetState = hasInternet;

      if(!hasInternet){
        showNetBanner("offline","SIN CONEXIÓN A INTERNET.");
      }else{
        showNetBanner("online","CONEXIÓN RESTABLECIDA.");
        setTimeout(()=>hideNetBanner(), 1800);
      }
      updateButtons();
    }
    window.addEventListener("offline", ()=>refreshInternetStatus());
    window.addEventListener("online",  ()=>refreshInternetStatus());
    setInterval(()=>refreshInternetStatus(), 8000);

    // Chips (normal)
    function renderCuadrillaChips(){
      const wrap = $("cuadrillaChips");
      if(!wrap) return;
      wrap.innerHTML = "";
      selectedCuadrillas.forEach((c)=>{
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.innerHTML = `<span>${esc(c)}</span><span class="x">×</span>`;
        chip.title = "Quitar";
        chip.onclick = ()=>{
          selectedCuadrillas = selectedCuadrillas.filter(x=>x!==c);
          renderCuadrillaChips();
        };
        wrap.appendChild(chip);
      });
    }

    $("btnAddCuadrilla").onclick = ()=>{
      if(providerMode) return;
      const val = ($("selCuadrilla").value || "").trim();
      if(!val){ alert("Seleccione una CUADRILLA para agregar."); return; }
      if(selectedCuadrillas.length >= 10){
        alert("Máximo 10 cuadrillas por informe (límite Firestore 'in').");
        return;
      }
      if(selectedCuadrillas.includes(val)){
        alert("Esa cuadrilla ya fue agregada.");
        return;
      }
      selectedCuadrillas.push(val);
      renderCuadrillaChips();
    };

    // Login
    const boot = $("bootMsg");
    if(boot) boot.textContent = "Cargando Firebase…";

    $("btnLogin").onclick = async ()=>{
      $("loginMsg").textContent = "";
      try{
        const email = $("loginEmail").value.trim();
        const pass  = $("loginPass").value;
        if(!email || !pass){
          $("loginMsg").textContent = "Ingrese usuario y contraseña.";
          return;
        }
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(e){
        const code = (e && e.code) ? ` (${e.code})` : "";
        $("loginMsg").textContent = "Error: usuario o contraseña incorrectos." + code;
        console.error(e);
      }
    };
    ["loginEmail","loginPass"].forEach(id=>{
      $(id).addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("btnLogin").click(); });
    });

    async function doLogout(){ await signOut(auth); }
    $("btnLogoutPick").onclick = doLogout;
    $("btnLogoutReport").onclick = doLogout;
    $("btnHistLogout").onclick = doLogout;

    function resetAll(){
      if(unsubReport){ try{unsubReport();}catch(_){}
        unsubReport = null;
      }
      selectedCuadrillas = [];
      currentCuadrillas = [];
      renderCuadrillaChips();

      reportSaved = false;
      reportSigned = false;
      reportNumber = "";
      reportDocId = "";

      signedBy = "";
      signedByName = "";
      signedAt = "";
      signedDevice = "";
      signedUA = "";

      currentFecha = "";
      currentCircuito = "1";

      pesadasCols = [];
      rows = [];
      subtotalPorPesada = new Map();
      subtotal2Total = 0;

      descuentoIndividual = 0;

      // LOTES
      lotes = [];
      lotesFinalizado = false;
      lotesCache.clear();
      renderLotes();
      setLotesStatus("—");

      $("reportStatus").textContent = "—";
      $("infoNumero").textContent = "—";

      $("histStatus").textContent = "—";
      const hb = safe("tbodyHist");
      if(hb) hb.innerHTML = "";

      applySignatureUI();
      updateButtons();
    }

    function watchReportDoc(docId){
      if(!docId) return;
      if(unsubReport){ try{unsubReport();}catch(_){}
        unsubReport = null;
      }
      const ref = doc(db, COL_SID, docId);
      unsubReport = onSnapshot(ref, (snap)=>{
        if(!snap.exists()) return;
        const data = snap.data() || {};

        reportSigned = !!data.signed;
        signedBy = data.signedBy || "";
        signedByName = data.signedByName || "";
        signedAt = data.signedAt || "";
        signedDevice = data.signedDevice || "";
        signedUA = data.signedUA || "";

        applySignatureUI();

        if(reportSigned){
          $("reportStatus").textContent = "Firmado. PDF/EXCEL habilitados.";
        }else{
          $("reportStatus").textContent = "Pendiente de firma.";
        }
        updateButtons();
      });
    }

    // ====== LOTES PROCESADOS (SPC) ======
    function setLotesStatus(msg){ const el = safe("lotesStatus"); if(el) el.textContent = msg; }

    function sanitizeSecuencial(s){
      const raw = String(s||"").trim();
      if(!raw) return "";
      // conserva dígitos, pero permite también letras si el usuario usa formato especial
      const digits = raw.replace(/\D+/g,"");
      return digits || raw;
    }

    function lotesPayload(){
      const out = [];
      for(const r of (lotes||[])){
        const sec = sanitizeSecuencial(r.secuencial);
        if(!sec) continue;
        out.push({
          secuencial: sec,
          proveedor: String(r.proveedor||"").trim(),
          libras: Number(r.libras||0)
        });
      }
      return out;
    }

    function ensureLotesBase(){
      if(providerMode) return;
      if(!Array.isArray(lotes) || lotes.length===0){
        lotes = [{secuencial:"", proveedor:"", libras:0, locked:false}];
      }
    }

    function renderLotes(){
      const tb = safe("tbodyLotes");
      if(!tb) return;
      tb.innerHTML = "";
      if(providerMode) return;

      ensureLotesBase();

      lotes.forEach((r, idx)=>{
        const tr = document.createElement("tr");
        const locked = !!r.locked || !!lotesFinalizado;

        tr.className = (locked ? "lockedRow" : "");

        const provTxt = (r.proveedor && String(r.proveedor).trim()) ? String(r.proveedor).trim() : "";
        const lbsNum = Number(r.libras||0);
        const lbsTxt = (Number.isFinite(lbsNum) && lbsNum>0) ? fmt0(lbsNum) : "";

        tr.innerHTML = `
          <td class="lSec">
            <input class="lInput" data-sec="${idx}" value="${esc(r.secuencial||"")}"
              ${locked ? "disabled" : ""} inputmode="numeric" autocomplete="off" />
          </td>
          <td class="lProv lCellMut" data-prov="${idx}">${esc(provTxt)}</td>
          <td class="lLbs lNum" data-lbs="${idx}">${esc(lbsTxt)}</td>
          <td class="lAct" style="text-align:center;">
            <span class="btn btnMini ${locked ? "disabled" : ""}" data-plus="${idx}" title="Bloquear fila y agregar nueva">+</span>
            <span class="btn btnMini danger ${lotesFinalizado ? "disabled" : ""}" data-minus="${idx}" title="Eliminar fila">-</span>
          </td>
        `;
        tb.appendChild(tr);
      });

      // eventos input secuencial
      tb.querySelectorAll("[data-sec]").forEach(inp=>{
        inp.addEventListener("keydown", async (e)=>{
          if(e.key === "Enter"){
            e.preventDefault();
            const idx = Number(inp.getAttribute("data-sec")||0);
            await onSecuencialChanged(idx, inp.value, true);
          }
        });
        inp.addEventListener("blur", async ()=>{
          const idx = Number(inp.getAttribute("data-sec")||0);
          await onSecuencialChanged(idx, inp.value, false);
        });
      });

      // botones + / -
      tb.querySelectorAll("[data-plus]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          if(btn.classList.contains("disabled")) return;
          const idx = Number(btn.getAttribute("data-plus")||0);
          await onPlusRow(idx);
        });
      });
      tb.querySelectorAll("[data-minus]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          if(btn.classList.contains("disabled")) return;
          const idx = Number(btn.getAttribute("data-minus")||0);
          onMinusRow(idx);
        });
      });

      // botón proceso terminado
      const bt = safe("btnProcesoTerminado");
      if(bt){
        bt.classList.toggle("disabled", providerMode || lotesFinalizado);
      }
    }

    function focusLastSecuencial(){
      const tb = safe("tbodyLotes");
      if(!tb) return;
      const inputs = tb.querySelectorAll("input[data-sec]");
      if(inputs && inputs.length){
        const last = inputs[inputs.length-1];
        try{ last.focus(); last.select(); }catch(_){}
      }
    }

    function pickField(data, keys){
      for(const k of keys){
        if(data && Object.prototype.hasOwnProperty.call(data,k)){
          const v = data[k];
          if(v !== null && v !== undefined && String(v).trim()!=="") return v;
        }
      }
      return null;
    }

    function toNumberAny(v){
      if(v === null || v === undefined) return 0;
      if(typeof v === "number") return Number.isFinite(v) ? v : 0;
      const s = String(v).trim();
      if(!s) return 0;
      // Intenta parseo es-EC (1.234,56)
      try{
        if(typeof parseEsNumber === "function"){
          const p = parseEsNumber(s);
          if(Number.isFinite(p)) return p;
        }
      }catch(_){/* noop */}
      // Fallback: quitar miles y usar punto decimal
      const s2 = s.replace(/\s+/g, "").replace(/\./g, "").replace(",", ".");
      const n = Number(s2);
      return Number.isFinite(n) ? n : 0;
    }

    function extractSPC(data){
      const prov = pickField(data, [
        "proveedor","Proveedor","PROVEEDOR",
        "productor","Productor","PRODUCTOR",
        "nombreProveedor","NOMBRE_PROVEEDOR","proveedorNombre"
      ]);

      // ✅ En SPC las libras están en el campo "guiaLbs" (según tu HTML de SPC)
      const lbsRaw = pickField(data, [
        "guiaLbs","guia_lbs","GUIALBS","GUIA_LBS",
        "guiaLibras","guia_libras","GUIA_LIBRAS",
        "guiaLbsRemitidas","guiaLbsRem","guiaLbsTotal",
        // compatibilidad con nombres antiguos
        "libras","Libras","LIBRAS","peso","pesoLibras","PESO_LB","lb","lbs","LB"
      ]);

      const proveedor = String(prov || "").trim();
      const libras = toNumberAny(lbsRaw);
      return { proveedor, libras };
    }

        async function lookupSPCBySecuencial(secInput){
      // Busca por ID de documento y también por campo "secuencial" (fallback).
      const secRaw = sanitizeSecuencial(secInput);
      const secStr = (secRaw.replace(/^0+/,"") || "0");

      if(!secStr || secStr === "0") return null;

      // Cache por sesión (normalizado por secStr)
      const cacheKey = secStr;
      if(lotesCache.has(cacheKey)){
        return lotesCache.get(cacheKey);
      }

      // Colecciones candidatas (incluye la real de SPC: "programacion")
      const baseCols = Array.from(new Set([
        ...(SPC_COLLECTIONS || []),
        "programacion",
        "spc_programacion",
        "spc_programacion_diaria",
        "spc_programacion_diario"
      ]));

      let permDenied = false;

      // 1) Intento directo por docId = secuencial
      for(const colName of baseCols){
        try{
          const ref = doc(db, colName, secStr);
          const snap = await getDoc(ref);
          if(snap.exists()){
            const out = extractSPC(snap.data());
            if(out){
              lotesCache.set(cacheKey, out);
              return out;
            }
          }
        }catch(e){
          if(e?.code === "permission-denied") permDenied = true;
          console.warn("SPC lookup getDoc error:", colName, e?.code || e);
        }
      }

      // 2) Fallback: buscar por campo "secuencial" (puede estar como number o string)
      const secNum = Number(secStr);
      for(const colName of baseCols){
        try{
          // number
          if(Number.isFinite(secNum)){
            const qn = query(collection(db, colName), where("secuencial","==", secNum));
            const sn = await getDocs(qn);
            if(!sn.empty){
              const out = extractSPC(sn.docs[0].data());
              if(out){
                lotesCache.set(cacheKey, out);
                return out;
              }
            }
          }
          // string
          const qs = query(collection(db, colName), where("secuencial","==", secStr));
          const ss = await getDocs(qs);
          if(!ss.empty){
            const out = extractSPC(ss.docs[0].data());
            if(out){
              lotesCache.set(cacheKey, out);
              return out;
            }
          }
        }catch(e){
          if(e?.code === "permission-denied") permDenied = true;
          console.warn("SPC lookup query error:", colName, e?.code || e);
        }
      }

      if(permDenied){
        // Devuelve un objeto especial para mostrar mensaje claro en UI
        return { __error: "permission-denied" };
      }

      return null;
    }

async function onSecuencialChanged(idx, value, showAlert){
      if(providerMode) return;
      if(lotesFinalizado) return;
      ensureLotesBase();

      const sec = sanitizeSecuencial(value);
      lotes[idx].secuencial = sec;

      // limpiar si vacío
      if(!sec){
        lotes[idx].proveedor = "";
        lotes[idx].libras = 0;
        renderLotes();
        setLotesStatus("—");
        await maybePersistLotes();
        return;
      }

      await refreshInternetStatus();
      if(!hasInternet){
        setLotesStatus("Sin internet: no se puede buscar SPC.");
        if(showAlert) alert("Sin internet: no se puede buscar SPC.");
        return;
      }

      setLotesStatus("Buscando en SPC…");
      const found = await lookupSPCBySecuencial(sec);

      if(found && found.__error === "permission-denied"){
        lotes[idx].proveedor = "";
        lotes[idx].libras = 0;
        setLotesStatus("Sin permisos para leer SPC (programacion). Revisa reglas Firestore.");
        if(showAlert) alert("Sin permisos para leer SPC (programación). Revisa las reglas de Firestore.");
        renderLotes();
        await maybePersistLotes();
        return;
      }

      if(!found){
        lotes[idx].proveedor = "";
        lotes[idx].libras = 0;
        setLotesStatus(`No encontrado en SPC: ${sec}`);
        if(showAlert) alert("No se encontró ese SECUENCIAL en SPC.");
        renderLotes();
        await maybePersistLotes();
        return;
      }

      lotes[idx].proveedor = found.proveedor || "";
      lotes[idx].libras = Number(found.libras||0);
      setLotesStatus("Listo.");
      renderLotes();
      await maybePersistLotes();
    }

    async function onPlusRow(idx){
      if(providerMode) return;
      if(lotesFinalizado) return;
      ensureLotesBase();

      const row = lotes[idx];
      if(row.locked){
        // si por algún motivo el usuario le da + en una fila ya bloqueada, ignorar
        return;
      }

      const sec = sanitizeSecuencial(row.secuencial);
      if(!sec){
        alert("Ingrese el SECUENCIAL antes de agregar otra fila.");
        focusLastSecuencial();
        return;
      }

      // si no está resuelto, intenta buscar
      if(!(row.proveedor && String(row.proveedor).trim()) || !(Number(row.libras||0) > 0)){
        await onSecuencialChanged(idx, sec, false);
      }

      if(!(row.proveedor && String(row.proveedor).trim()) || !(Number(row.libras||0) > 0)){
        const st = (lotesStatusEl?.textContent || "");
        if(String(st).toLowerCase().includes("sin permisos")){
          alert("No se puede bloquear: sin permisos para leer SPC (programación). Revisa reglas Firestore.");
        }else{
          alert("No se puede bloquear: el SECUENCIAL no está válido o no se encontró en SPC.");
        }
        return;
      }

      // bloquear fila actual y agregar nueva
      row.locked = true;

      // agregar nueva fila editable
      lotes.push({secuencial:"", proveedor:"", libras:0, locked:false});

      renderLotes();
      setLotesStatus("Fila agregada.");
      focusLastSecuencial();
      await maybePersistLotes();
    }

    function onMinusRow(idx){
      if(providerMode) return;
      if(lotesFinalizado) return;
      ensureLotesBase();

      if(lotes.length === 1){
        lotes[0] = {secuencial:"", proveedor:"", libras:0, locked:false};
        renderLotes();
        setLotesStatus("—");
        maybePersistLotes();
        return;
      }
      lotes.splice(idx,1);
      if(lotes.length === 0){
        lotes = [{secuencial:"", proveedor:"", libras:0, locked:false}];
      }
      renderLotes();
      setLotesStatus("Fila eliminada.");
      maybePersistLotes();
    }

    function normalizeLotesBeforeFinalize(){
      // eliminar fila final vacía
      lotes = (lotes||[]).filter(r => sanitizeSecuencial(r.secuencial));
      // si quedó vacío, deja una fila en blanco (pero no finaliza)
      if(lotes.length === 0) return false;
      // bloquear todas
      lotes.forEach(r => r.locked = true);
      return true;
    }

    async function finalizeLotes(){
      if(providerMode) return;
      if(lotesFinalizado) return;

      const ok = normalizeLotesBeforeFinalize();
      if(!ok){
        alert("Ingrese al menos 1 SECUENCIAL válido antes de finalizar el proceso.");
        ensureLotesBase();
        renderLotes();
        focusLastSecuencial();
        return;
      }

      // Validación final: todos deben tener proveedor y libras
      for(const r of lotes){
        if(!(r.proveedor && String(r.proveedor).trim()) || !(Number(r.libras||0) > 0)){
          alert("Hay filas sin PROVEEDOR/LIBRAS válidas. Revise los secuenciales.");
          lotesFinalizado = false;
          renderLotes();
          return;
        }
      }

      lotesFinalizado = true;
      renderLotes();
      setLotesStatus("Proceso terminado. Tabla bloqueada.");
      await maybePersistLotes(true);
    }

    $("btnProcesoTerminado").onclick = async ()=>{
      if(providerMode) return;
      if(lotesFinalizado) return;
      const b = safe("btnProcesoTerminado");
      if(b && b.classList.contains("disabled")) return;

      const ok = confirm("¿Marcar PROCESO TERMINADO?\n\nEsto bloqueará toda la tabla de lotes (incluye + y -).");
      if(!ok) return;
      await finalizeLotes();
    };

    async function maybePersistLotes(force=false){
      // Solo normal users; persistir si ya existe doc guardado y no está firmado
      if(providerMode) return;
      if(!reportSaved || !reportDocId) return;
      if(reportSigned) return;
      if(!hasInternet) return;

      // Evitar escrituras muy frecuentes (solo cuando hay cambios "importantes" o force)
      const payload = lotesPayload();
      const data = {
        lotesProcesados: payload,
        lotesFinalizado: !!lotesFinalizado,
        lotesUpdatedAt: serverTimestamp()
      };

      try{
        await updateDoc(doc(db, COL_SID, reportDocId), data);
        if(force) setLotesStatus("Lotes guardados y bloqueados.");
      }catch(_){
        // No bloquear UI por permisos/reglas
      }
    }

    // ====== FIRESTORE SEARCH HELPERS FOR PROVIDERS ======
    async function findLatestReportByDateAndCuadrilla(fechaKey, cuad){
      let candidates = [];

      const q1 = query(
        collection(db, COL_SID),
        where("fecha","==", fechaKey),
        where("cuadrillas","array-contains", cuad)
      );

      const s1 = await getDocs(q1);
      s1.forEach(d=>{
        const data = d.data()||{};
        candidates.push({ id:d.id, data, rn:Number(data.reportNumber||0) });
      });

      const q2 = query(
        collection(db, COL_SID),
        where("fecha","==", fechaKey),
        where("cuadrilla","==", cuad)
      );
      const s2 = await getDocs(q2);
      s2.forEach(d=>{
        const data = d.data()||{};
        candidates.push({ id:d.id, data, rn:Number(data.reportNumber||0) });
      });

      if(!candidates.length) return null;

      candidates.sort((a,b)=> (b.rn||0)-(a.rn||0));
      const best = candidates[0];
      return { id: best.id, ...best.data };
    }

    // ====== HISTORIAL (RANGO) ======
    async function fetchHistorial(desde, hasta){
      // ✅ FIX: evitar índices compuestos en proveedores
      // Consultamos SOLO por rango de fecha (same que usuario normal) y filtramos localmente.
      const items = [];

      const qAll = query(
        collection(db, COL_SID),
        where("fecha", ">=", desde),
        where("fecha", "<=", hasta)
      );

      const snap = await getDocs(qAll);
      snap.forEach(d=>{
        const data = d.data() || {};

        if(providerMode){
          const c = String(data.cuadrilla||"").trim().toUpperCase();
          const arr = Array.isArray(data.cuadrillas)
            ? data.cuadrillas.map(a=>String(a||"").trim().toUpperCase())
            : [];
          if(!(c === providerCuadrilla || arr.includes(providerCuadrilla))){
            return;
          }
        }

        items.push({ id:d.id, ...data });
      });

      return items;
    }

    function histCuadrillasLabel(x){
      const arr = Array.isArray(x.cuadrillas) ? x.cuadrillas.filter(Boolean) : [];
      if(arr.length) return arr.join(" + ");
      return String(x.cuadrilla || "—");
    }

    function histTotalFinal(x){
      const pesada = Number(x.pesadaCabezas || 0);
      const di = Number(x.descuentoIndividual || 0);
      const n = Number(x.numPersonas || 0);
      if(Number.isFinite(di) && di < 0){
        return pesada + (di * n);
      }
      return pesada;
    }

    function renderHistorial(items){
      const tb = $("tbodyHist");
      tb.innerHTML = "";

      items.sort((a,b)=>
        String(b.fecha||"").localeCompare(String(a.fecha||"")) ||
        (Number(b.reportNumber||0) - Number(a.reportNumber||0))
      );

      for(const x of items){
        const fecha = String(x.fecha||"");
        const rn = String(x.reportNumber||"");
        const cuad = providerMode ? providerCuadrilla : histCuadrillasLabel(x);

        const cola = Number(x.pesoCola||0);
        const entero = Number(x.elevadoEntero||0);
        const cabeza = Number(x.cabezaPosible||0);

        const desc = Number(x.descuentoTotal||0);
        const tot = histTotalFinal(x);

        const tr = document.createElement("tr");

        const canDelete = isAdmin();
        const delCell = canDelete
          ? `<td class="hDel" style="text-align:center;">
               <span class="btn danger" data-del="${esc(x.id)}" style="padding:6px 10px;">ELIMINAR</span>
             </td>`
          : `<td class="hDel" style="text-align:center;color:#888;">—</td>`;

        tr.innerHTML = `
          <td class="hDate" style="text-align:center;font-weight:900;">${esc(fecha)}</td>
          <td class="hNum" style="text-align:center;font-weight:900;">${esc(rn)}</td>
          <td class="hCuad" style="text-align:left;font-weight:900;">${esc(cuad)}</td>
          <td class="hW" style="text-align:right;font-weight:900;">${fmt3(cola)}</td>
          <td class="hW" style="text-align:right;font-weight:900;">${fmt3(entero)}</td>
          <td class="hW" style="text-align:right;font-weight:900;">${fmt3(cabeza)}</td>
          <td class="hDesc" style="text-align:right;font-weight:900;${desc<0?'color:#d4001a;':''}">${fmt0(desc)}</td>
          <td class="hTot" style="text-align:right;font-weight:900;">${fmt0(tot)}</td>
          <td class="hOpen" style="text-align:center;">
            <span class="btn" data-open="${esc(x.id)}" style="padding:6px 10px;">ABRIR</span>
          </td>
          ${delCell}
        `;
        tb.appendChild(tr);
      }

      tb.querySelectorAll("[data-open]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-open");
          if(!id) return;

          await refreshInternetStatus();
          if(!hasInternet){
            alert("Sin internet: no se puede abrir.");
            return;
          }

          try{
            const snap = await getDoc(doc(db, COL_SID, id));
            if(!snap.exists()){
              alert("Ese informe ya no existe.");
              return;
            }
            loadReportFromDoc({ id, ...snap.data() });
          }catch(err){
            console.error(err);
            alert("No se pudo abrir el informe.");
          }
        });
      });

      tb.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          if(!isAdmin()){
            alert("Solo el administrador puede eliminar.");
            return;
          }
          const id = btn.getAttribute("data-del");
          if(!id) return;

          const ok = confirm("¿Eliminar este informe?\n\nEsta acción NO se puede deshacer.");
          if(!ok) return;

          await refreshInternetStatus();
          if(!hasInternet){
            alert("Sin internet: no se puede eliminar.");
            return;
          }

          try{
            await deleteDoc(doc(db, COL_SID, id));
            btn.closest("tr")?.remove();
            $("histStatus").textContent = "Informe eliminado.";
          }catch(err){
            console.error(err);
            alert("No se pudo eliminar. Revisa permisos.");
          }
        });
      });
    }

    async function openHistorial(){
      await refreshInternetStatus();
      if(!hasInternet){
        alert("Sin internet: no se puede cargar historial.");
        return;
      }

      const t = todayKey();
      if(!$("histHasta").value) $("histHasta").value = t;
      if(!$("histDesde").value) $("histDesde").value = dateAddDays(t, -14);

      showView("hist");
      await loadHistorial();
    }

    async function loadHistorial(){
      const desde = $("histDesde").value || todayKey();
      const hasta = $("histHasta").value || todayKey();

      if(desde > hasta){
        alert("Rango inválido: DESDE no puede ser mayor que HASTA.");
        return;
      }

      $("histStatus").textContent = "Cargando historial…";
      try{
        const items = await fetchHistorial(desde, hasta);
        renderHistorial(items);
        $("histStatus").textContent = `Listo. Registros: ${items.length}`;
      }catch(err){
        console.error(err);
        $("histStatus").textContent = "Error cargando historial.";
        alert("No se pudo cargar el historial.");
      }
    }

    $("btnHistorial").onclick = openHistorial;
    $("btnHistFiltrar").onclick = loadHistorial;
    $("btnHistBack").onclick = ()=>{ showView("pick"); };

    // ====== AUTH STATE ======
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUserEmail = (user.email||"").toLowerCase();
        if(!ALLOWED.has(currentUserEmail)){
          alert("Acceso no autorizado.");
          await doLogout();
          return;
        }

        providerCuadrilla = (PROVIDERS.get(currentUserEmail) || "").trim().toUpperCase();
        providerMode = !!providerCuadrilla;

        $("authHeader").style.display = "block";
        $("userEmail").textContent = currentUserEmail;

        currentUserName = (user.displayName || currentUserEmail.split("@")[0] || "").replaceAll("."," ");
        $("userNameLabel").textContent = `(${currentUserName})`;

        $("selFecha").value = todayKey();
        $("findFecha").value = todayKey();

        $("histHasta").value = todayKey();
        $("histDesde").value = dateAddDays(todayKey(), -14);

        applyProviderUI();

        showView("pick");
        await refreshInternetStatus();
        updateButtons();

        // init lotes
        if(!providerMode){
          lotes = [{secuencial:"", proveedor:"", libras:0, locked:false}];
          lotesFinalizado = false;
          renderLotes();
        }

        if(boot) boot.textContent = "";
      }else{
        currentUserEmail = "";
        providerMode = false;
        providerCuadrilla = "";
        $("authHeader").style.display = "none";
        hideNetBanner();
        resetAll();
        showView("login");
        if(boot) boot.textContent = "";
      }
    });

    // ====== CREAR (solo normal users) ======
    $("btnCrear").onclick = async ()=>{
      if(providerMode){
        alert("Acceso limitado: use BUSCAR por fecha.");
        return;
      }

      const cSingle = ($("selCuadrilla").value || "").trim();
      const effective = (selectedCuadrillas.length > 0)
        ? [...selectedCuadrillas]
        : (cSingle ? [cSingle] : []);

      if(effective.length === 0){
        alert("Seleccione la CUADRILLA (y/o agréguela con +).");
        return;
      }

      currentCuadrillas = effective;
      currentFecha = $("selFecha").value || todayKey();
      currentCircuito = $("selCircuito").value || "1";

      const labelCuadrilla = (effective.length === 1)
        ? effective[0]
        : effective.join(" + ");

      $("metaCuadrilla").textContent = labelCuadrilla;
      $("metaFecha").textContent = currentFecha;
      $("infoCircuito").textContent = `Circuito ${currentCircuito}`;
      $("infoResponsable").textContent = currentUserName || currentUserEmail;

      reportSaved = false;
      reportSigned = false;
      reportNumber = "";
      reportDocId = "";
      $("infoNumero").textContent = "—";

      // Reset lotes (nueva creación)
      lotes = [{secuencial:"", proveedor:"", libras:0, locked:false}];
      lotesFinalizado = false;
      lotesCache.clear();
      renderLotes();
      setLotesStatus("—");

      showView("report");
      $("reportStatus").textContent = "Cargando pesadas del día…";

      try{
        await loadFromSDA(currentCuadrillas, currentFecha);
        $("reportStatus").textContent = "Listo. Verifica y, si aplica, ingresa Peso Cola.";
      }catch(err){
        console.error(err);
        $("reportStatus").textContent = "No se pudo cargar SDA.";
        alert("No se pudo cargar la información de SDA.");
      }

      applyProviderUI();
      applyPesoColaPermission();
      updateButtons();
      focusLastSecuencial();
    };

    $("btnBackPick").onclick = ()=>{ showView("pick"); };

    // ====== LOAD SDA (normal create) ======
    async function loadFromSDA(cuadrillasArr, fechaKey){
      rows = [];
      pesadasCols = [];
      subtotalPorPesada = new Map();
      subtotal2Total = 0;

      const cuadrillas = (Array.isArray(cuadrillasArr) ? cuadrillasArr : [])
        .map(x=>String(x||"").trim()).filter(Boolean);

      let q;
      if(cuadrillas.length === 1){
        q = query(
          collection(db, COL_SDA),
          where("cuadrilla","==", cuadrillas[0]),
          where("fecha","==", fechaKey)
        );
      }else{
        if(cuadrillas.length > 10){
          throw new Error("Demasiadas cuadrillas (máx. 10 para where-in).");
        }
        q = query(
          collection(db, COL_SDA),
          where("cuadrilla","in", cuadrillas),
          where("fecha","==", fechaKey)
        );
      }

      const snap = await getDocs(q);

      const docs = [];
      snap.forEach(d=>{
        const x = d.data()||{};
        const lbs = (typeof x.libras === "number") ? x.libras : Number(x.libras||0);
        if(!(Number.isFinite(lbs) && lbs > 0)) return;

        docs.push({
          cuadrilla: String(x.cuadrilla || "").trim().toUpperCase(),
          pesadaNumero: Number(x.pesadaNumero||0),
          hora: x.hora || "",
          usuario: x.usuario || "",
          personId: x.personId || "",
          apellidos: x.apellidos || "",
          nombres: x.nombres || "",
          libras: lbs
        });
      });

      const pesadaMap = new Map();
      for(const r of docs){
        const n = r.pesadaNumero || 0;
        if(!pesadaMap.has(n)){
          pesadaMap.set(n, {hora:r.hora||"", usuario:r.usuario||""});
        }
      }

      const pesadaNums = Array.from(pesadaMap.keys()).filter(n=>n>0).sort((a,b)=>a-b);
      pesadasCols = pesadaNums.map(n=>{
        const m = pesadaMap.get(n)||{};
        return { pesadaNumero:n, hora:m.hora||"", usuario:m.usuario||"" };
      });

      const isMulti = (cuadrillas.length > 1);

      const personMap = new Map();
      for(const r of docs){
        const pid = String(r.personId || "");
        if(!pid) continue;

        const key = isMulti ? `${r.cuadrilla}::${pid}` : pid;
        if(!personMap.has(key)){
          personMap.set(key,{
            personId: pid,
            cuadrilla: r.cuadrilla || "",
            apellidos: r.apellidos||"",
            nombres: r.nombres||"",
            byPesada: {}
          });
        }
        personMap.get(key).byPesada[r.pesadaNumero] = r.libras;
      }

      rows = Array.from(personMap.values()).sort((a,b)=>
        (a.cuadrilla||"").localeCompare(b.cuadrilla||"","es") ||
        (a.apellidos||"").localeCompare(b.apellidos||"","es") ||
        (a.nombres||"").localeCompare(b.nombres||"","es")
      );

      for(const n of pesadaNums) subtotalPorPesada.set(n, 0);

      for(const row of rows){
        let s2 = 0;
        for(const n of pesadaNums){
          const v = Number(row.byPesada[n]||0);
          s2 += v;
          subtotalPorPesada.set(n, (subtotalPorPesada.get(n)||0) + v);
        }
        row.subtotal2 = s2;
      }

      subtotal2Total = rows.reduce((a,b)=>a+(Number(b.subtotal2||0)),0);

      renderReportTable();
      recalcAll();
    }

    // ====== TABLE RENDER (filters for providers) ======
    function renderReportTable(){
      const thead = $("theadReport");
      const tbody = $("tbodyReport");
      thead.innerHTML = "";
      tbody.innerHTML = "";

      const dispRows = getDisplayRows();
      const { subMap, sub2 } = computeDisplaySubtotals(dispRows);

      const tr1 = document.createElement("tr");
      tr1.innerHTML = `
        <th class="colNo" rowspan="2">N°</th>
        <th class="colNomina" rowspan="2">NOMINA</th>
        <th class="colCuadrilla" rowspan="2">CUADRILLA</th>
      `;

      for(const c of pesadasCols){
        tr1.innerHTML += `
          <th>
            <div style="font-weight:900;">${esc(c.hora||"—")}</div>
            <div class="subHdr" style="margin-top:3px;padding:3px 0;">${esc((c.usuario||"").split("@")[0]||"")}</div>
            <div style="margin-top:3px;">PESADA ${c.pesadaNumero}</div>
          </th>`;
      }

      tr1.innerHTML += `<th rowspan="2">SUBTOTAL 2</th><th rowspan="2">DESCUENTO</th><th rowspan="2">TOTAL</th>`;
      thead.appendChild(tr1);
      thead.appendChild(document.createElement("tr"));

      const descInd = Number(descuentoIndividual||0);
      const applyDesc = (Number.isFinite(descInd) && descInd < 0) ? descInd : 0;

      dispRows.forEach((r, idx)=>{
        const tr = document.createElement("tr");
        const nom = `${esc(r.apellidos)} ${esc(r.nombres)}`.trim();
        const cuad = esc((r.cuadrilla || "").trim());

        tr.innerHTML = `
          <td class="colNo">${idx+1}</td>
          <td class="colNomina">${nom}</td>
          <td class="colCuadrilla">${cuad}</td>
        `;

        for(const c of pesadasCols){
          const v = Number((r.byPesada||{})[c.pesadaNumero]||0);
          tr.innerHTML += `<td class="num">${v ? fmt0(v) : ""}</td>`;
        }

        const subtotal2 = Number(r.subtotal2||0);
        const dVal = applyDesc;
        const total = subtotal2 + dVal;

        tr.innerHTML += `<td class="num">${fmt0(subtotal2)}</td>`;
        tr.innerHTML += `<td class="num ${dVal<0?'descuentoNeg':''}">${dVal<0?fmt0(dVal):""}</td>`;
        tr.innerHTML += `<td class="num">${fmt0(total)}</td>`;
        tbody.appendChild(tr);
      });

      const trS = document.createElement("tr");
      trS.className = "subRow";
      trS.innerHTML = `<td class="colNo" colspan="3">SUBTOTAL 1</td>`;

      for(const c of pesadasCols){
        trS.innerHTML += `<td class="num">${fmt0(subMap.get(c.pesadaNumero)||0)}</td>`;
      }

      trS.innerHTML += `<td class="num">${fmt0(sub2)}</td>`;
      trS.innerHTML += `<td class="num ${applyDesc<0?'descuentoNeg':''}">${applyDesc<0?fmt0(applyDesc):""}</td>`;
      const totFinal = sub2 + (applyDesc * (dispRows.length||0));
      trS.innerHTML += `<td class="num">${fmt0(totFinal)}</td>`;
      tbody.appendChild(trS);
    }

    // ====== RECALC (normal create) ======
    function recalcAll(){
      if(providerMode) return;
      const inpVal = parseEsNumber($("pesoCola").value);
      pesoCola = Number.isFinite(inpVal) ? inpVal : 0;

      const dispRows = rows || [];
      const numP = dispRows.length || 0;
      const pesadaC = subtotal2Total || 0;

      elevadoEntero = (pesoCola > 0) ? (pesoCola / 0.66) : 0;
      cabezaPosible = (pesoCola > 0) ? (elevadoEntero - pesoCola) : 0;
      descuentoTotal = cabezaPosible - pesadaC;
      descuentoIndividual = (numP > 0) ? (descuentoTotal / numP) : 0;

      $("elevadoEntero").textContent = fmt3(elevadoEntero);
      $("cabezaPosible").textContent = fmt3(cabezaPosible);
      $("pesadaCabezas").textContent = fmt3(pesadaC);
      $("descuentoTotal").textContent = fmt0(descuentoTotal);
      $("numPersonas").textContent = fmt0(numP);

      const diEl = $("descuentoIndividual");
      diEl.textContent = fmt0(descuentoIndividual);
      diEl.classList.toggle("vRed", descuentoIndividual < 0);

      renderReportTable();
    }

    $("pesoCola").addEventListener("input", ()=>{
      if(providerMode) return;
      if(reportSaved || reportSigned) return;
      recalcAll();
    });

    // ====== SAVE NUMBER ======
    async function allocateNextReportNumber(){
      const yyyy = String(new Date().getFullYear());
      const ref = doc(db, COL_SID_COUNTER, yyyy);
      const n = await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        let last = 0;
        if(snap.exists()){
          last = Number((snap.data()||{}).last || 0);
          if(!Number.isFinite(last)) last = 0;
        }
        const next = last + 1;
        tx.set(ref, { last: next, year: yyyy, updatedAt: serverTimestamp() }, { merge:true });
        return next;
      });
      return String(n).padStart(7,"0");
    }

    // ====== GUARDAR ======
    $("btnGuardar").onclick = async ()=>{
      if(providerMode) return;

      await refreshInternetStatus();
      if(!hasInternet){
        alert("⚠️ Sin internet: no se puede GUARDAR.");
        return;
      }
      if(reportSaved){
        alert("Este informe ya fue guardado.");
        return;
      }
      if(!currentCuadrillas || currentCuadrillas.length === 0 || !currentFecha){
        alert("Falta cuadrilla(s) o fecha.");
        return;
      }

      // Asegurar que Peso Cola y cálculos estén actualizados antes de guardar
      recalcAll();

      const num = await allocateNextReportNumber();
      reportNumber = num;
      reportDocId = `SID_${reportNumber}`;
      $("infoNumero").textContent = reportNumber;

      const stamp = nowStamp();

      const data = {
        reportNumber,
        circuito: Number(currentCircuito||1),
        cuadrilla: (currentCuadrillas.length === 1) ? currentCuadrillas[0] : "MULTI",
        cuadrillas: currentCuadrillas,
        fecha: currentFecha,
        responsableEmail: currentUserEmail,
        responsableNombre: currentUserName,

        pesoCola,
        elevadoEntero,
        cabezaPosible,
        pesadaCabezas: subtotal2Total,
        descuentoTotal,
        numPersonas: (rows.length||0),
        descuentoIndividual,

        // LOTES
        lotesProcesados: lotesPayload(),
        lotesFinalizado: !!lotesFinalizado,

        pesadasCols,
        rows,

        signed: false,
        signedBy: "",
        signedByName: "",
        signedAt: "",
        signedDevice: "",
        signedUA: "",

        createdAt: serverTimestamp(),
        createdStamp: stamp
      };

      try{
        await setDoc(doc(db, COL_SID, reportDocId), data, { merge:false });

        reportSaved = true;
        reportSigned = false;

        $("reportStatus").textContent = "Guardado. Pendiente de firma (Jefferson).";
        watchReportDoc(reportDocId);
        updateButtons();

        alert(`Informe guardado: ${reportNumber}\nPendiente de firma (Jefferson).`);
      }catch(err){
        console.error(err);
        alert("No se pudo guardar el informe.");
      }
    };

    // ====== FIRMAR ======
    async function reauthForSensitiveAction(){
      const user = auth.currentUser;
      if(!user || !user.email) throw new Error("No hay sesión activa.");
      const pass = prompt("Para confirmar FIRMA, ingrese su contraseña de Firebase:");
      if(!pass) throw new Error("Acción cancelada.");
      const cred = EmailAuthProvider.credential(user.email, pass);
      await reauthenticateWithCredential(user, cred);
      return true;
    }

    $("btnFirmar").onclick = async ()=>{
      if(providerMode) return;

      await refreshInternetStatus();
      if(!hasInternet){
        alert("Sin internet: no se puede firmar.");
        return;
      }
      if(!isAdmin()){
        alert("Solo Jefferson puede firmar electrónicamente este informe.");
        return;
      }
      if(!reportSaved || !reportDocId){
        alert("Primero debe GUARDAR el informe o BUSCAR un informe guardado.");
        return;
      }
      if(reportSigned){
        alert("Este informe ya está firmado.");
        return;
      }

      try{
        await reauthForSensitiveAction();

        signedBy = currentUserEmail;
        signedByName = currentUserName || (currentUserEmail.split("@")[0] || "");
        signedAt = new Date().toISOString();
        signedDevice = shortDevice();
        signedUA = (navigator.userAgent || "").slice(0, 250);

        await updateDoc(doc(db, COL_SID, reportDocId), {
          signed: true,
          signedBy,
          signedByName,
          signedAt,
          signedDevice,
          signedUA,
          signedAtServer: serverTimestamp()
        });

        $("reportStatus").textContent = "Firmando…";
      }catch(err){
        console.error(err);
        alert("No se pudo firmar.");
      }
    };

    // ====== PDF ======
    $("btnPdf").onclick = async ()=>{
      if(!reportSigned){
        alert("Este informe aún NO está firmado. PDF se habilita después de la firma.");
        return;
      }

      const sheet = $("reportSheet");
      if(!sheet){ alert("No se encontró el reporte."); return; }

      const { jsPDF } = window.jspdf || {};
      if(!jsPDF){ alert("No se pudo cargar PDF."); return; }

      const tblWrapEl = sheet.querySelector(".tblWrap");
      const _old = tblWrapEl ? {overflow: tblWrapEl.style.overflow, maxHeight: tblWrapEl.style.maxHeight} : null;
      if(tblWrapEl){ tblWrapEl.style.overflow = "visible"; tblWrapEl.style.maxHeight = "none"; }

      const lotesTblWrap = sheet.querySelector(".lotesTblWrap");
      const _old2 = lotesTblWrap ? {overflow: lotesTblWrap.style.overflow, maxHeight: lotesTblWrap.style.maxHeight} : null;
      if(lotesTblWrap){ lotesTblWrap.style.overflow = "visible"; lotesTblWrap.style.maxHeight = "none"; }

      const canvas = await html2canvas(sheet, {scale:2, useCORS:true, backgroundColor:"#ffffff"});

      if(tblWrapEl && _old){ tblWrapEl.style.overflow = _old.overflow; tblWrapEl.style.maxHeight = _old.maxHeight; }
      if(lotesTblWrap && _old2){ lotesTblWrap.style.overflow = _old2.overflow; lotesTblWrap.style.maxHeight = _old2.maxHeight; }

      const pdf = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const margin = 18;
      const printableW = pageW - margin*2;
      const printableH = pageH - margin*2;

      const imgW = canvas.width;
      const imgH = canvas.height;

      const ratio = printableW / imgW;
      let sliceHpx = Math.floor(printableH / ratio);
      if(!Number.isFinite(sliceHpx) || sliceHpx <= 0) sliceHpx = imgH;

      let pageIndex = 0;
      for(let y=0; y<imgH; y += sliceHpx){
        const sliceCanvas = document.createElement("canvas");
        sliceCanvas.width = imgW;
        sliceCanvas.height = Math.min(sliceHpx, imgH - y);

        const ctx = sliceCanvas.getContext("2d");
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0,0,sliceCanvas.width,sliceCanvas.height);
        ctx.drawImage(canvas, 0, y, imgW, sliceCanvas.height, 0, 0, imgW, sliceCanvas.height);

        const imgData = sliceCanvas.toDataURL("image/png");
        const sliceHpt = sliceCanvas.height * ratio;

        if(pageIndex > 0) pdf.addPage();
        pdf.addImage(imgData, "PNG", margin, margin, printableW, sliceHpt);
        pageIndex++;
      }

      const who = (currentUserEmail || "usuario").split("@")[0];
      const fname = `SID_${(reportNumber||"SIN_NUMERO")}_${who}_${nowStamp()}.pdf`.replaceAll(" ","_");
      pdf.save(fname);
    };

    // ====== EXCEL ======
    $("btnXls").onclick = ()=>{
      if(!reportSigned){
        alert("Este informe aún NO está firmado. Excel se habilita después de la firma.");
        return;
      }

      try{
        const XLSX = window.XLSX;
        if(!XLSX){ alert("No se pudo cargar la librería de Excel."); return; }

        const dispRows = getDisplayRows();
        const { subMap, sub2 } = computeDisplaySubtotals(dispRows);

        const headers = ["N°","NOMINA","CUADRILLA"];
        for(const c of pesadasCols) headers.push(`PESADA ${c.pesadaNumero}`);
        headers.push("SUBTOTAL 2","DESCUENTO","TOTAL");

        const descInd = Number(descuentoIndividual||0);
        const applyDesc = (Number.isFinite(descInd) && descInd < 0) ? descInd : 0;

        const aoa = [];
        aoa.push(["SID | INFORME DESCABEZADO"]);
        aoa.push(["Informe N°", reportNumber||"", "Cuadrilla", (providerMode?providerCuadrilla:(currentCuadrillas.join(" + "))), "Fecha", currentFecha||""]);
        aoa.push(["Firmado por", signedByName || signedBy || "", "Firmado el", prettyWhen(signedAt), "Dispositivo", signedDevice || ""]);
        aoa.push([]);

        // LOTES en Excel (solo normal)
        if(!providerMode){
          const lp = lotesPayload();
          aoa.push(["LOTES PROCESADOS"]);
          aoa.push(["SECUENCIAL","PROVEEDOR","LIBRAS"]);
          lp.forEach(x=>{
            aoa.push([x.secuencial, x.proveedor, Number(x.libras||0)]);
          });
          aoa.push([]);
        }

        aoa.push(headers);

        dispRows.forEach((r, idx)=>{
          const nom = `${(r.apellidos||"").trim()} ${(r.nombres||"").trim()}`.trim();
          const cuad = (r.cuadrilla || "").trim();
          const line = [idx+1, nom, cuad];

          for(const c of pesadasCols){
            const v = Number((r.byPesada||{})[c.pesadaNumero] || 0);
            line.push(v ? v : "");
          }

          const subtotal2 = Number(r.subtotal2||0);
          const total = subtotal2 + applyDesc;

          line.push(subtotal2 || 0);
          line.push(applyDesc ? applyDesc : "");
          line.push(total || 0);
          aoa.push(line);
        });

        const sub = ["SUBTOTAL 1","", ""];
        for(const c of pesadasCols){
          sub.push(Number(subMap.get(c.pesadaNumero)||0) || 0);
        }
        sub.push(Number(sub2||0) || 0);
        sub.push(applyDesc ? applyDesc : "");
        sub.push(Number(sub2 + (applyDesc * (dispRows.length||0))) || 0);
        aoa.push(sub);

        const ws = XLSX.utils.aoa_to_sheet(aoa);

        const cols = [];
        cols.push({wch:6});
        cols.push({wch:32});
        cols.push({wch:16});
        for(let i=0;i<pesadasCols.length;i++) cols.push({wch:10});
        cols.push({wch:12},{wch:12},{wch:12});
        ws["!cols"] = cols;

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Informe");

        const who = (currentUserEmail || "usuario").split("@")[0];
        const fname = `SID_${(reportNumber||"SIN_NUMERO")}_${who}_${nowStamp()}.xlsx`.replaceAll(" ","_");
        XLSX.writeFile(wb, fname);
      }catch(err){
        console.error(err);
        alert("No se pudo exportar Excel.");
      }
    };

    // ====== BUSCAR (Report button) ======
    $("btnBuscar").onclick = async ()=>{
      await refreshInternetStatus();
      if(!hasInternet){
        alert("Sin internet: no se puede buscar.");
        return;
      }

      if(providerMode){
        const f = (currentFecha || $("metaFecha").textContent || $("findFecha").value || todayKey()).trim();
        const found = await findLatestReportByDateAndCuadrilla(f, providerCuadrilla);
        if(!found){ alert("No se encontró informe para esa fecha."); return; }
        loadReportFromDoc(found);
        return;
      }

      const n = prompt("Ingrese N° de Informe (7 dígitos).\n\nDeje vacío para buscar por FECHA + Circuito.");
      try{
        let foundDoc = null;

        if(n && n.trim()){
          const num = n.trim().replace(/\D+/g,"").padStart(7,"0");
          const id = `SID_${num}`;
          const snap = await getDoc(doc(db, COL_SID, id));
          if(snap.exists()){
            foundDoc = { id, ...snap.data() };
          }else{
            alert("No existe ese informe.");
            return;
          }
        }else{
          const f = prompt("Ingrese FECHA (YYYY-MM-DD):", todayKey());
          if(!f) return;
          const c = prompt("Ingrese Circuito (1 o 2):", "1");
          if(!c) return;

          const q = query(
            collection(db, COL_SID),
            where("fecha","==", f),
            where("circuito","==", Number(c))
          );

          const snap = await getDocs(q);
          if(snap.empty){
            alert("No se encontró informe para esa fecha+circuito.");
            return;
          }
          const d = snap.docs[0];
          foundDoc = { id: d.id, ...d.data() };
        }

        loadReportFromDoc(foundDoc);
      }catch(err){
        console.error(err);
        alert("Error buscando informe.");
      }
    };

    // ====== BUSCAR desde PICK ======
    $("btnBuscarPick").onclick = async ()=>{
      await refreshInternetStatus();
      if(!hasInternet){
        alert("Sin internet: no se puede buscar.");
        return;
      }

      try{
        if(providerMode){
          const f = ($("findFecha").value || $("selFecha").value || todayKey()).trim();
          currentFecha = f;

          const found = await findLatestReportByDateAndCuadrilla(f, providerCuadrilla);
          if(!found){ alert("No se encontró informe para esa fecha."); return; }
          loadReportFromDoc(found);
          return;
        }

        const nRaw = ($("findNumero").value || "").trim();
        let foundDoc = null;

        if(nRaw){
          const clean = nRaw.replace(/\D+/g,"");
          if(!clean){
            alert("Ingrese un N° de informe válido.");
            return;
          }
          const num = clean.padStart(7,"0");
          const id = `SID_${num}`;
          const snap = await getDoc(doc(db, COL_SID, id));
          if(!snap.exists()){
            alert("No existe ese informe.");
            return;
          }
          foundDoc = { id, ...snap.data() };
        }

        if(!foundDoc){
          const f = ($("findFecha").value || "").trim() || todayKey();
          const c = ($("findCircuito").value || "1");

          const q = query(
            collection(db, COL_SID),
            where("fecha","==", f),
            where("circuito","==", Number(c))
          );

          const snap = await getDocs(q);
          if(snap.empty){
            alert("No se encontró informe para esa fecha+circuito.");
            return;
          }

          let best = null;
          snap.forEach(d=>{
            const data = d.data() || {};
            const rn = Number(data.reportNumber || 0);
            if(!best || rn > best.rn){
              best = { rn, id: d.id, data };
            }
          });

          foundDoc = { id: best.id, ...best.data };
        }

        loadReportFromDoc(foundDoc);
      }catch(err){
        console.error(err);
        alert("Error buscando informe.");
      }
    };

    // ====== LOAD REPORT DOC ======
    function loadReportFromDoc(docData){
      reportDocId = docData.id;
      reportNumber = docData.reportNumber || "";
      reportSaved = true;
      reportSigned = !!docData.signed;

      signedBy = docData.signedBy || "";
      signedByName = docData.signedByName || "";
      signedAt = docData.signedAt || "";
      signedDevice = docData.signedDevice || "";
      signedUA = docData.signedUA || "";

      currentCuadrillas = Array.isArray(docData.cuadrillas) && docData.cuadrillas.length
        ? docData.cuadrillas
        : [docData.cuadrilla || ""].filter(Boolean);

      currentFecha = docData.fecha || "";
      currentCircuito = String(docData.circuito || "1");

      const cuadrillaLabel = providerMode ? providerCuadrilla : ((currentCuadrillas.length>1)? currentCuadrillas.join(" + "): (currentCuadrillas[0]||""));

      $("metaCuadrilla").textContent = cuadrillaLabel || "—";
      $("metaFecha").textContent = currentFecha;
      $("infoCircuito").textContent = `Circuito ${currentCircuito}`;
      $("infoResponsable").textContent = docData.responsableNombre || docData.responsableEmail || "—";
      $("infoNumero").textContent = reportNumber || "—";

      descuentoIndividual = Number(docData.descuentoIndividual||0);

      pesadasCols = docData.pesadasCols || [];
      rows = docData.rows || [];

      const fallbackCuad = (Array.isArray(docData.cuadrillas) && docData.cuadrillas.length)
        ? String(docData.cuadrillas[0]||"").trim().toUpperCase()
        : String(docData.cuadrilla || "").trim().toUpperCase();

      rows = rows.map(r => ({
        ...r,
        cuadrilla: String(r.cuadrilla || fallbackCuad || "").trim().toUpperCase()
      }));

      // LOTES desde doc
      if(!providerMode){
        const lp = Array.isArray(docData.lotesProcesados) ? docData.lotesProcesados : [];
        lotesFinalizado = !!docData.lotesFinalizado;

        lotes = lp.map(x=>({
          secuencial: sanitizeSecuencial(x.secuencial),
          proveedor: String(x.proveedor||"").trim(),
          libras: Number(x.libras||0),
          locked: true
        }));

        if(!lotesFinalizado){
          // permitir continuar agregando
          lotes.push({secuencial:"", proveedor:"", libras:0, locked:false});
        }

        renderLotes();
        setLotesStatus(lotesFinalizado ? "Proceso terminado. Tabla bloqueada." : "—");
      }

      // === Cargar valores guardados en BD (panel derecho) ===
      pesoCola = Number(docData.pesoCola || 0);
      elevadoEntero = Number(docData.elevadoEntero || 0);
      cabezaPosible = Number(docData.cabezaPosible || 0);
      pesadaCabezas = Number(docData.pesadaCabezas || 0);
      descuentoTotal = Number(docData.descuentoTotal || 0);
      numPersonas = Number(docData.numPersonas || (rows.length||0));
      descuentoIndividual = Number(docData.descuentoIndividual || 0);

      const pcInp = safe("pesoCola");
      if(pcInp) pcInp.value = (pesoCola ? fmt3(pesoCola) : "");

      const eeEl = safe("elevadoEntero"); if(eeEl) eeEl.textContent = fmt3(elevadoEntero);
      const cpEl = safe("cabezaPosible"); if(cpEl) cpEl.textContent = fmt3(cabezaPosible);
      const pchEl= safe("pesadaCabezas"); if(pchEl) pchEl.textContent = fmt3(pesadaCabezas);
      const dtEl = safe("descuentoTotal"); if(dtEl) dtEl.textContent = fmt0(descuentoTotal);
      const npEl = safe("numPersonas"); if(npEl) npEl.textContent = fmt0(numPersonas);

      const diEl = safe("descuentoIndividual");
      if(diEl){
        diEl.textContent = fmt0(descuentoIndividual);
        diEl.classList.toggle("vRed", descuentoIndividual < 0);
      }

      applySignatureUI();
      applyProviderUI();
      applyPesoColaPermission();

      if(reportSigned){
        $("reportStatus").textContent = "Firmado. PDF/EXCEL habilitados.";
      }else{
        $("reportStatus").textContent = "Pendiente de firma.";
      }

      showView("report");
      renderReportTable();
      watchReportDoc(reportDocId);
      updateButtons();
    }

    // Inicial
    $("selFecha").value = todayKey();
    $("findFecha").value = todayKey();
    $("histHasta").value = todayKey();
    $("histDesde").value = dateAddDays(todayKey(), -14);

    // init lotes base
    lotes = [{secuencial:"", proveedor:"", libras:0, locked:false}];
    lotesFinalizado = false;
    renderLotes();
    updateButtons();

  </script>
</body>
</html>
